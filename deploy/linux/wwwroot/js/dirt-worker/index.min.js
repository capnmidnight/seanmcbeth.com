function x(o){return o.splice(0)}function V(o,n){return o.splice(n,1)[0]}function A(o,n,e){return typeof o===n||o instanceof e}function h(o){return A(o,"function",Function)}function S(o){return A(o,"boolean",Boolean)}function D(o){return o instanceof Array}function g(o){return o==null}function p(o){return!g(o)}var w=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(n,e,t){if(h(e)){let r=this.listeners.get(n);r||(r=new Array,this.listeners.set(n,r)),r.find(i=>i===e)||(r.push(e),t&&this.listenerOptions.set(e,t))}}removeEventListener(n,e){if(h(e)){let t=this.listeners.get(n);t&&this.removeListener(t,e)}}clearEventListeners(n){for(let[e,t]of this.listeners)if(g(n)||n===e){for(let r of t)this.removeEventListener(n,r);x(t),this.listeners.delete(e)}}removeListener(n,e){let t=n.findIndex(r=>r===e);t>=0&&(V(n,t),this.listenerOptions.has(e)&&this.listenerOptions.delete(e))}dispatchEvent(n){let e=this.listeners.get(n.type);if(e)for(let t of e){let r=this.listenerOptions.get(t);p(r)&&!S(r)&&r.once&&this.removeListener(e,t),t.call(this,n)}return!n.defaultPrevented}},E=class extends Event{get type(){return super.type}constructor(n,e){super(n,e)}},b=class extends w{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(e){this.bubblers.add(e)}removeBubbler(e){this.bubblers.delete(e)}addEventListener(e,t,r){super.addEventListener(e,t,r)}removeEventListener(e,t){super.removeEventListener(e,t)}clearEventListeners(e){return super.clearEventListeners(e)}addScopedEventListener(e,t,r,i){this.scopes.has(e)||this.scopes.set(e,[]),this.scopes.get(e).push([t,r]),this.addEventListener(t,r,i)}removeScope(e){let t=this.scopes.get(e);if(t){this.scopes.delete(e);for(let[r,i]of t)this.removeEventListener(r,i)}}dispatchEvent(e){if(!super.dispatchEvent(e))return!1;if(!e.cancelBubble){for(let t of this.bubblers)if(!t.dispatchEvent(e))return!1}return!0}};var T=class extends b{constructor(){super(...arguments);this.attached=new Array;this.soFar=null;this.total=null;this.msg=null;this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(e,t,r,i){this.soFar=e,this.total=t,this.msg=r,this.est=i;for(let a of this.attached)a.report(e,t,r,i)}attach(e){this.attached.push(e),e.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(e){this.report(0,1,e||"starting")}end(e){this.report(1,1,e||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,x(this.attached)}};var P=class extends T{constructor(e,t){super();this.server=e;this.taskID=t}report(e,t,r,i){let a={type:"progress",taskID:this.taskID,soFar:e,total:t,msg:r,est:i};this.server.postMessage(a)}},v=class{constructor(n){this.self=n;this.methods=new Map;this.self.addEventListener("message",e=>{let t=e.data;this.callMethod(t)})}postMessage(n,e){p(e)?this.self.postMessage(n,e):this.self.postMessage(n)}callMethod(n){let e=this.methods.get(n.methodName);if(e)try{D(n.params)?e(n.taskID,...n.params):p(n.params)?e(n.taskID,n.params):e(n.taskID)}catch(t){this.onError(n.taskID,`method invocation error: ${n.methodName}(${t.message||t})`)}else this.onError(n.taskID,`method not found: ${n.methodName}`)}onError(n,e){let t={type:"error",taskID:n,errorMessage:e};this.postMessage(t)}onReturn(n,e,t){let r=null;if(e===void 0?r={type:"return",taskID:n}:r={type:"return",taskID:n,returnValue:e},p(t)){let i=t(e);this.postMessage(r,i)}else this.postMessage(r)}addMethodInternal(n,e,t){if(this.methods.has(n))throw new Error(`${n} method has already been mapped.`);this.methods.set(n,async(r,...i)=>{let a=new P(this,r);try{let u=await e(...i,a);this.onReturn(r,u,t)}catch(u){console.error(u),this.onError(r,u.message||u)}})}addFunction(n,e,t){this.addMethodInternal(n,e,t)}addVoidFunction(n,e){this.addMethodInternal(n,e)}addMethod(n,e,t,r){this.addFunction(e,t.bind(n),r)}addVoidMethod(n,e,t){this.addVoidFunction(e,t.bind(n))}addEvent(n,e,t,r){n.addEventListener(e,i=>{let a=null;if(p(t)?a={type:"event",eventName:e,data:t(i)}:a={type:"event",eventName:e},a.data!==void 0&&p(r)){let u=r(a.data);this.postMessage(a,u)}else this.postMessage(a)})}};function y(){return!0}var L=class{constructor(n,e,t=!0){this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._started=!1;this._errored=!1;this._finished=!1;h(n)?this.resolveTest=n:this.resolveTest=y,h(e)?this.rejectTest=e:this.rejectTest=y,S(n)?this.autoStart=n:S(e)?this.autoStart=e:p(t)?this.autoStart=t:this.autoStart=!1,this.resolve=r=>{if(this.running&&this.resolveTest(r)){this._result=r;for(let i of this.onThens)i(r);this.clear(),this._finished=!0}},this.reject=r=>{if(this.running&&this.rejectTest(r)){this._error=r,this._errored=!0;for(let i of this.onCatches)i(r);this.clear(),this._finished=!0}},this.autoStart&&this.start()}clear(){x(this.onThens),x(this.onCatches)}start(){this._started=!0}get result(){if(p(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}get running(){return this.started&&!this.finished}get errored(){return this._errored}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((n,e)=>{this.finished?this.errored?e(this.error):n(this.result):(this.onThens.push(n),this.onCatches.push(e))})}then(n,e){return this.project().then(n,e)}catch(n){return this.project().catch(n)}finally(n){return this.project().finally(n)}reset(){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._errored=!1,this._finished=!1,this._started=!1,this.autoStart&&this.start()}};var O=!1,G=!O&&"OffscreenCanvas"in globalThis,it=!O&&"createImageBitmap"in globalThis;function _(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var at=G&&_();function K(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var st=G&&K();function $(o,n,e,t=1){return n=Math.floor(n*t),e=Math.floor(e*t),o.width!=n||o.height!=e?(o.width=n,o.height=e,!0):!1}function U(o){return p(o.textBaseline)}function q(o,n,e,t=1){let r=o.imageSmoothingEnabled,i=o.textBaseline,a=o.textAlign,u=o.font,d=$(o.canvas,n,e,t);return d&&(o.imageSmoothingEnabled=r,o.textBaseline=i,o.textAlign=a,o.font=u),d}function z(o,n,e,t=1){return U(o)?q(o,n,e,t):$(o.canvas,n,e,t)}function W(o,n,e,t=1){return t*(o+e*n)}function j(o,n){let e=globalThis,t=e[o];if(g(t)){if(g(n))throw new Error(`No value ${o} found`);t=n(),e[o]=t}return t}var X=j("Juniper:Graphics2D:Dirt:StopTypes",()=>new Map([["mousedown","down"],["mouseenter","move"],["mouseleave","up"],["mousemove","move"],["mouseout","up"],["mouseover","move"],["mouseup","up"],["pointerdown","down"],["pointerenter","move"],["pointerleave","up"],["pointermove","move"],["pointerrawupdate","move"],["pointerout","up"],["pointerup","up"],["pointerover","move"],["touchcancel","up"],["touchend","up"],["touchmove","move"],["touchstart","down"]])),H=class extends E{constructor(){super("update")}},M=class extends b{constructor(){super();this.updateEvt=new H;this.canvas=null;this.transferCanvas=null;this.g=null;this.tg=null;this.pointerId=null;this.fr=null;this.pr=null;this.height=null;this.x=null;this.y=null;this.lx=null;this.ly=null;this.components=null;this.data=null;this.sub=new OffscreenCanvas(this.height,this.height),this.subg=this.sub.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!0})}init(e,t,r,i){this.transferCanvas=new OffscreenCanvas(e,t),this.tg=this.transferCanvas.getContext("2d"),this.canvas=new OffscreenCanvas(e,t),this.g=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.g.fillStyle="rgb(50%, 50%, 50%)",this.g.fillRect(0,0,this.canvas.width,this.canvas.height);let a=this.g.getImageData(0,0,this.canvas.width,this.canvas.height),{data:u}=a,d=u.length/(e*t);for(let f=0;f<u.length;f+=d){let s=Math.floor(50*(Math.random()-.5));for(let l=0;l<d-1;++l)u[f+l]+=s}return this.g.putImageData(a,0,0),this.fr=r,this.pr=i,this.height=2*(this.fr+this.pr)+1,this.onUpdate(),Promise.resolve()}onUpdate(){this.tg.drawImage(this.canvas,0,0),this.updateEvt.imgBmp=this.transferCanvas.transferToImageBitmap(),this.dispatchEvent(this.updateEvt)}I(e,t){return W(e,t+this.fr+this.pr,this.sub.width,this.components)}GET(e,t){return this.data[this.I(e,t)]/255}SET(e,t,r){return this.data[this.I(e,t)]=255*r}update(){if(this.pointerId!==null&&this.canvas){let e=this.lx-this.x,t=this.ly-this.y;if(Math.abs(e)+Math.abs(t)>0){let r=Math.atan2(t,e)+Math.PI,i=Math.round(Math.sqrt(e*e+t*t));z(this.subg,i+this.fr+this.pr,this.height),this.subg.save(),this.subg.translate(0,this.fr+this.pr),this.subg.rotate(-r),this.subg.translate(-this.lx,-this.ly),this.subg.drawImage(this.canvas,0,0),this.subg.restore();let a=this.subg.getImageData(0,0,this.sub.width,this.sub.height);this.data=a.data,this.components=this.data.length/(this.sub.width*this.height);let u=this.GET(0,0),d=Math.max(0,u-.25),f=0;for(let s=0;s<i;++s){f+=this.GET(s,0)-d,this.SET(s,0,d);for(let c=-this.fr;c<=this.fr;++c){let m=this.fr-Math.abs(c);f+=this.GET(s+m,c)-d,this.SET(s+m,c,d)}let C=d/(2*this.fr*this.pr);for(let c=-this.fr-this.pr;c<=this.fr+this.pr&&f>0;++c)if(c<-this.fr||this.fr<c){let m=this.fr-Math.abs(c),B=this.GET(s+m,c),R=Math.min(f,C);this.SET(s+m,c,B+R),f-=R}}if(f>0){let s=f/(2*this.fr*this.pr);for(let l=-this.fr-this.pr;l<=this.fr+this.pr&&f>0;++l)if(l<-this.fr||this.fr<l){let C=this.fr-Math.abs(l),c=this.GET(i+C,l),m=Math.min(f,s);this.SET(i+C,l,c+m),f-=m}}for(let s=0;s<this.data.length;s+=this.components){let l=this.data[s];this.data[s+1]=l,this.data[s+2]=l}this.subg.putImageData(a,0,0),this.g.save(),this.g.translate(this.lx,this.ly),this.g.rotate(r),this.g.translate(-0,-this.fr-this.pr),this.g.drawImage(this.sub,0,0),this.g.restore(),this.onUpdate()}}this.lx=this.x,this.ly=this.y}checkPointer(e,t,r,i){let a=X.get(i)||i;this.pointerId===null?a==="down"&&(this.pointerId=e,this.lx=this.x=t,this.ly=this.y=r,this.update()):e===this.pointerId&&(this.x=t,this.y=r,this.update(),a==="up"&&(this.pointerId=null))}checkPointerUV(e,t,r,i){this.checkPointer(e,t*this.canvas.width,(1-r)*this.canvas.height,i)}};var I=class extends v{constructor(n){super(n);let e=new M;this.addMethod(e,"init",e.init.bind(e)),this.addVoidMethod(e,"checkPointer",e.checkPointer.bind(e)),this.addVoidMethod(e,"checkPointerUV",e.checkPointerUV.bind(e)),this.addEvent(e,"update",t=>t.imgBmp,t=>[t])}};globalThis.server=new I(globalThis);
