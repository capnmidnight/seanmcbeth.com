function v(r,e){return r.splice(e,1)[0]}function x(r){return r.splice(0)}function M(r,e){let t=r.indexOf(e);return t>-1?(v(r,t),!0):!1}var X=class{constructor(e){this.items=new Map;this.defaultItems=new Array;if(i(e))for(let[t,n]of e)this.add(t,n)}add(e,t){if(l(e))this.defaultItems.push(t);else{let n=this.items.get(e);l(n)&&this.items.set(e,n=[]),n.push(t)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let e of this.defaultItems)yield e;for(let e of this.items.values())for(let t of e)yield t}has(e){return i(e)?this.items.has(e):this.defaultItems.length>0}get(e){return l(e)?this.defaultItems:this.items.get(e)||[]}count(e){if(l(e))return this.defaultItems.length;let t=this.get(e);return i(t)?t.length:0}get size(){let e=this.defaultItems.length;for(let t of this.items.values())e+=t.length;return e}delete(e){return l(e)?x(this.defaultItems).length>0:this.items.delete(e)}remove(e,t){if(l(e))M(this.defaultItems,t);else{let n=this.items.get(e);i(n)&&(M(n,t),n.length===0&&this.items.delete(e))}}clear(){this.items.clear(),x(this.defaultItems)}};var _=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(e,t,n){if(b(t)){let o=this.listeners.get(e);o||(o=new Array,this.listeners.set(e,o)),o.find(s=>s===t)||(o.push(t),n&&this.listenerOptions.set(t,n))}}removeEventListener(e,t){if(b(t)){let n=this.listeners.get(e);n&&this.removeListener(n,t)}}clearEventListeners(e){for(let[t,n]of this.listeners)if(l(e)||e===t){for(let o of n)this.removeEventListener(e,o);x(n),this.listeners.delete(t)}}removeListener(e,t){let n=e.findIndex(o=>o===t);n>=0&&(v(e,n),this.listenerOptions.has(t)&&this.listenerOptions.delete(t))}dispatchEvent(e){let t=this.listeners.get(e.type);if(t)for(let n of t){let o=this.listenerOptions.get(n);i(o)&&!T(o)&&o.once&&this.removeListener(t,n),n.call(this,e)}return!e.defaultPrevented}},R=class extends Event{get type(){return super.type}constructor(e){super(e)}},S=class extends _{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(t){this.bubblers.add(t)}removeBubbler(t){this.bubblers.delete(t)}addEventListener(t,n,o){super.addEventListener(t,n,o)}removeEventListener(t,n){super.removeEventListener(t,n)}clearEventListeners(t){return super.clearEventListeners(t)}addScopedEventListener(t,n,o,s){this.scopes.has(t)||this.scopes.set(t,[]),this.scopes.get(t).push([n,o]),this.addEventListener(n,o,s)}removeScope(t){let n=this.scopes.get(t);if(n){this.scopes.delete(t);for(let[o,s]of n)this.removeEventListener(o,s)}}dispatchEvent(t){if(!super.dispatchEvent(t))return!1;for(let n of this.bubblers)if(!n.dispatchEvent(t))return!1;return!0}};function P(){return!0}function Z(r,e,t){return typeof r===e||r instanceof t}function b(r){return Z(r,"function",Function)}function T(r){return Z(r,"boolean",Boolean)}function F(r){return r instanceof Array}function l(r){return r==null}function i(r){return!l(r)}var w=class{constructor(e,t,n=!0){this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._started=!1;this._errored=!1;this._finished=!1;b(e)?this.resolveTest=e:this.resolveTest=P,b(t)?this.rejectTest=t:this.rejectTest=P,T(e)?this.autoStart=e:T(t)?this.autoStart=t:i(n)?this.autoStart=n:this.autoStart=!1,this.resolve=o=>{if(this.running&&this.resolveTest(o)){this._result=o;for(let s of this.onThens)s(o);this.clear(),this._finished=!0}},this.reject=o=>{if(this.running&&this.rejectTest(o)){this._error=o,this._errored=!0;for(let s of this.onCatches)s(o);this.clear(),this._finished=!0}},this.autoStart&&this.start()}clear(){x(this.onThens),x(this.onCatches)}start(){this._started=!0}get result(){if(i(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}get running(){return this.started&&!this.finished}get errored(){return this._errored}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((e,t)=>{this.finished?this.errored?t(this.error):e(this.result):(this.onThens.push(e),this.onCatches.push(t))})}then(e,t){return this.project().then(e,t)}catch(e){return this.project().catch(e)}finally(e){return this.project().finally(e)}reset(){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._errored=!1,this._finished=!1,this._started=!1,this.autoStart&&this.start()}};var J=class{constructor(e,t,n){this.callback=null;this.promise=new Promise((o,s)=>{this.callback=(...u)=>{e(...u)?o(t(...u)):s(n(...u))}})}get[Symbol.toStringTag](){return this.promise.toString()}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}};var be=/OculusBrowser\/(\d+)\.(\d+)\.(\d+)/i,L=navigator.userAgent.match(be),k=!!L,ir=k&&{major:parseFloat(L[1]),minor:parseFloat(L[2]),patch:parseFloat(L[3])},sr=k&&/pacific/i.test(navigator.userAgent),ar=k&&/quest/i.test(navigator.userAgent),ur=k&&/quest 2/i.test(navigator.userAgent);var Ee="Worker"in globalThis;var Te=298.257223563,Se=6378137;var A=1/Te,O=1-A,a=A/(2-A),cr=Se/(1+a)*(1+a*a/4+a*a*a*a/64),H=Math.sqrt(1-O*O),h=1-O*O,pr=H*H/(1-H*H),mr=1-h*(.25+h*(3/64+5*h/256)),fr=h*(3/8+h*(3/32+45*h/1024)),dr=h*h*(15/256+h*45/1024),hr=h*h*h*(35/3072),gr=[a/2-2*a*a/3+37*a*a*a/96,a*a/48+a*a*a/15,17*a*a*a/480],xr=[2*a-2*a*a/3,7*a*a/3-8*a*a*a/5,56*a*a*a/15];var Dr=2*Math.PI;function Q(r,e,t,n=1){return n*(r+t*e)}var y=class extends S{constructor(){super(...arguments);this.attached=new Array;this.soFar=null;this.total=null;this.msg=null;this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(t,n,o,s){this.soFar=t,this.total=n,this.msg=o,this.est=s;for(let u of this.attached)u.report(t,n,o,s)}attach(t){this.attached.push(t),t.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(t){this.report(0,1,t||"starting")}end(t){this.report(1,1,t||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,x(this.attached)}};function ee(r,e){let t=globalThis,n=t[r];if(l(n)){if(l(e))throw new Error(`No value ${r} found`);n=e(),t[r]=n}return n}function z(r){let e=new Map;for(let[t,n]of r)e.set(n,t);return e}var Me=new Map([[1,"KiB"],[2,"MiB"],[3,"GiB"],[4,"TiB"]]),Re=new Map([[1,"KB"],[2,"MB"],[3,"GB"],[4,"TB"]]),Xi=z(Me),Zi=z(Re);var ne=304.79999999999995,Qi=ne*3,Ie=10*100,_e=ne*16.5,Pe=_e*40,es=Ie*1e3,ts=Pe*8,re=2.54*4,oe=re*3,ns=oe*3,Le=oe*16.5,ke=Le*40,rs=100*1e3,os=ke*8,K=4*3,He=K*3,G=100/2.54,Oe=K*16.5,Be=Oe*40,is=G*1e3,ss=Be*8,as=3*3,Ne=100/re,Ve=3*16.5,Fe=Ve*40,us=Ne*1e3,ls=Fe*8,ie=G/K,De=16.5*40,cs=ie*1e3,ps=De*8,Ae=G/He,Ue=16.5/3,ze=Ue*40,ms=Ae*1e3,fs=ze*8,se=16.5/ie,ae=se*40,ds=ae*8,hs=1e3/se,gs=40*8,Ke=1e3/ae,xs=8/Ke;function W(r){return i(r)&&r.length>0?parseFloat(r):null}var ue=class{constructor(e,t){this._url=null;this._base=void 0;this._protocol=null;this._host=null;this._hostName=null;this._userName=null;this._password=null;this._port=null;this._pathName=null;this._hash=null;this._query=new Map;e!==void 0&&(this._url=new URL(e,t),this.rehydrate())}rehydrate(){i(this._protocol)&&this._protocol!==this._url.protocol&&(this._url.protocol=this._protocol),i(this._host)&&this._host!==this._url.host&&(this._url.host=this._host),i(this._hostName)&&this._hostName!==this._url.hostname&&(this._url.hostname=this._hostName),i(this._userName)&&this._userName!==this._url.username&&(this._url.username=this._userName),i(this._password)&&this._password!==this._url.password&&(this._url.password=this._password),i(this._port)&&this._port.toFixed(0)!==this._url.port&&(this._url.port=this._port.toFixed(0)),i(this._pathName)&&this._pathName!==this._url.pathname&&(this._url.pathname=this._pathName),i(this._hash)&&this._hash!==this._url.hash&&(this._url.hash=this._hash);for(let[e,t]of this._query)this._url.searchParams.set(e,t);this._protocol=this._url.protocol,this._host=this._url.host,this._hostName=this._url.hostname,this._userName=this._url.username,this._password=this._url.password,this._port=W(this._url.port),this._pathName=this._url.pathname,this._hash=this._url.hash,this._url.searchParams.forEach((e,t)=>this._query.set(t,e))}refresh(){if(this._url===null){if(i(this._protocol)&&(i(this._host)||i(this._hostName))){if(i(this._host))return this._url=new URL(`${this._protocol}//${this._host}`,this._base),this._port=W(this._url.port),this.rehydrate(),!1;if(i(this._hostName))return this._url=new URL(`${this._protocol}//${this._hostName}`,this._base),this.rehydrate(),!1}else if(i(this._pathName)&&i(this._base))return this._url=new URL(this._pathName,this._base),this.rehydrate(),!1}return i(this._url)}base(e){if(this._url!==null)throw new Error("Cannot redefine base after defining the protocol and domain");return this._base=e,this.refresh(),this}protocol(e){return this._protocol=e,this.refresh()&&(this._url.protocol=e),this}host(e){return this._host=e,this.refresh()&&(this._url.host=e,this._hostName=this._url.hostname,this._port=W(this._url.port)),this}hostName(e){return this._hostName=e,this.refresh()&&(this._url.hostname=e,this._host=`${this._url.hostname}:${this._url.port}`),this}port(e){return this._port=e,this.refresh()&&(this._url.port=e.toFixed(0),this._host=`${this._url.hostname}:${this._url.port}`),this}userName(e){return this._userName=e,this.refresh()&&(this._url.username=e),this}password(e){return this._password=e,this.refresh()&&(this._url.password=e),this}path(e){return this._pathName=e,this.refresh()&&(this._url.pathname=e),this}pathPop(e){return e=e||/\/[^\/]+\/?$/,this.path(this._pathName.replace(e,""))}pathPush(e){let t=this._pathName;return t.endsWith("/")||(t+="/"),t+=e,this.path(t)}query(e,t){return this._query.set(e,t),this.refresh()&&this._url.searchParams.set(e,t),this}hash(e){return this._hash=e,this.refresh()&&(this._url.hash=e),this}toURL(){return this._url}toString(){return this._url.href}[Symbol.toStringTag](){return this.toString()}};var $=class extends y{constructor(t,n){super();this.server=t;this.taskID=n}report(t,n,o,s){let u={type:"progress",taskID:this.taskID,soFar:t,total:n,msg:o,est:s};this.server.postMessage(u)}},B=class{constructor(e){this.self=e;this.methods=new Map;this.self.addEventListener("message",t=>{let n=t.data;this.callMethod(n)})}postMessage(e,t){i(t)?this.self.postMessage(e,t):this.self.postMessage(e)}callMethod(e){let t=this.methods.get(e.methodName);if(t)try{F(e.params)?t(e.taskID,...e.params):i(e.params)?t(e.taskID,e.params):t(e.taskID)}catch(n){this.onError(e.taskID,`method invocation error: ${e.methodName}(${n.message||n})`)}else this.onError(e.taskID,`method not found: ${e.methodName}`)}onError(e,t){let n={type:"error",taskID:e,errorMessage:t};this.postMessage(n)}onReturn(e,t,n){let o=null;if(t===void 0?o={type:"return",taskID:e}:o={type:"return",taskID:e,returnValue:t},i(n)){let s=n(t);this.postMessage(o,s)}else this.postMessage(o)}addMethodInternal(e,t,n){if(this.methods.has(e))throw new Error(`${e} method has already been mapped.`);this.methods.set(e,async(o,...s)=>{let u=new $(this,o);try{let p=await t(...s,u);this.onReturn(o,p,n)}catch(p){console.error(p),this.onError(o,p.message||p)}})}addFunction(e,t,n){this.addMethodInternal(e,t,n)}addVoidFunction(e,t){this.addMethodInternal(e,t)}addMethod(e,t,n,o){this.addFunction(t,n.bind(e),o)}addVoidMethod(e,t,n){this.addVoidFunction(t,n.bind(e))}addEvent(e,t,n,o){e.addEventListener(t,s=>{let u=null;if(i(n)?u={type:"event",eventName:t,data:n(s)}:u={type:"event",eventName:t},u.data!==void 0&&i(o)){let p=o(u.data);this.postMessage(u,p)}else this.postMessage(u)})}};var le=!1,ce=!le&&"OffscreenCanvas"in globalThis,Aa=!le&&"createImageBitmap"in globalThis;function We(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var Ua=ce&&We();function $e(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var za=ce&&$e();function pe(r,e,t,n=1){return e=Math.floor(e*n),t=Math.floor(t*n),r.width!=e||r.height!=t?(r.width=e,r.height=t,!0):!1}function je(r){return i(r.textBaseline)}function qe(r,e,t,n=1){let o=r.imageSmoothingEnabled,s=r.textBaseline,u=r.textAlign,p=r.font,g=pe(r.canvas,e,t,n);return g&&(r.imageSmoothingEnabled=o,r.textBaseline=s,r.textAlign=u,r.font=p),g}function me(r,e,t,n=1){return je(r)?qe(r,e,t,n):pe(r.canvas,e,t,n)}var Ye=ee("Juniper:Graphics2D:Dirt:StopTypes",()=>new Map([["mousedown","down"],["mouseenter","move"],["mouseleave","up"],["mousemove","move"],["mouseout","up"],["mouseover","move"],["mouseup","up"],["pointerdown","down"],["pointerenter","move"],["pointerleave","up"],["pointermove","move"],["pointerrawupdate","move"],["pointerout","up"],["pointerup","up"],["pointerover","move"],["touchcancel","up"],["touchend","up"],["touchmove","move"],["touchstart","down"]])),j=class extends R{constructor(){super("update")}},N=class extends S{constructor(){super();this.updateEvt=new j;this.canvas=null;this.transferCanvas=null;this.g=null;this.tg=null;this.pointerId=null;this.fr=null;this.pr=null;this.height=null;this.x=null;this.y=null;this.lx=null;this.ly=null;this.components=null;this.data=null;this.sub=new OffscreenCanvas(this.height,this.height),this.subg=this.sub.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!0})}init(t,n,o,s){this.transferCanvas=new OffscreenCanvas(t,n),this.tg=this.transferCanvas.getContext("2d"),this.canvas=new OffscreenCanvas(t,n),this.g=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.g.fillStyle="rgb(50%, 50%, 50%)",this.g.fillRect(0,0,this.canvas.width,this.canvas.height);let u=this.g.getImageData(0,0,this.canvas.width,this.canvas.height),{data:p}=u,g=p.length/(t*n);for(let d=0;d<p.length;d+=g){let c=Math.floor(50*(Math.random()-.5));for(let m=0;m<g-1;++m)p[d+m]+=c}return this.g.putImageData(u,0,0),this.fr=o,this.pr=s,this.height=2*(this.fr+this.pr)+1,this.onUpdate(),Promise.resolve()}onUpdate(){this.tg.drawImage(this.canvas,0,0),this.updateEvt.imgBmp=this.transferCanvas.transferToImageBitmap(),this.dispatchEvent(this.updateEvt)}I(t,n){return Q(t,n+this.fr+this.pr,this.sub.width,this.components)}GET(t,n){return this.data[this.I(t,n)]/255}SET(t,n,o){return this.data[this.I(t,n)]=255*o}update(){if(this.pointerId!==null&&this.canvas){let t=this.lx-this.x,n=this.ly-this.y;if(Math.abs(t)+Math.abs(n)>0){let o=Math.atan2(n,t)+Math.PI,s=Math.round(Math.sqrt(t*t+n*n));me(this.subg,s+this.fr+this.pr,this.height),this.subg.save(),this.subg.translate(0,this.fr+this.pr),this.subg.rotate(-o),this.subg.translate(-this.lx,-this.ly),this.subg.drawImage(this.canvas,0,0),this.subg.restore();let u=this.subg.getImageData(0,0,this.sub.width,this.sub.height);this.data=u.data,this.components=this.data.length/(this.sub.width*this.height);let p=this.GET(0,0),g=Math.max(0,p-.25),d=0;for(let c=0;c<s;++c){d+=this.GET(c,0)-g,this.SET(c,0,g);for(let f=-this.fr;f<=this.fr;++f){let E=this.fr-Math.abs(f);d+=this.GET(c+E,f)-g,this.SET(c+E,f,g)}let I=g/(2*this.fr*this.pr);for(let f=-this.fr-this.pr;f<=this.fr+this.pr&&d>0;++f)if(f<-this.fr||this.fr<f){let E=this.fr-Math.abs(f),q=this.GET(c+E,f),Y=Math.min(d,I);this.SET(c+E,f,q+Y),d-=Y}}if(d>0){let c=d/(2*this.fr*this.pr);for(let m=-this.fr-this.pr;m<=this.fr+this.pr&&d>0;++m)if(m<-this.fr||this.fr<m){let I=this.fr-Math.abs(m),f=this.GET(s+I,m),E=Math.min(d,c);this.SET(s+I,m,f+E),d-=E}}for(let c=0;c<this.data.length;c+=this.components){let m=this.data[c];this.data[c+1]=m,this.data[c+2]=m}this.subg.putImageData(u,0,0),this.g.save(),this.g.translate(this.lx,this.ly),this.g.rotate(o),this.g.translate(-0,-this.fr-this.pr),this.g.drawImage(this.sub,0,0),this.g.restore(),this.onUpdate()}}this.lx=this.x,this.ly=this.y}checkPointer(t,n,o,s){let u=Ye.get(s)||s;this.pointerId===null?u==="down"&&(this.pointerId=t,this.lx=this.x=n,this.ly=this.y=o,this.update()):t===this.pointerId&&(this.x=n,this.y=o,this.update(),u==="up"&&(this.pointerId=null))}checkPointerUV(t,n,o,s){this.checkPointer(t,n*this.canvas.width,(1-o)*this.canvas.height,s)}};var V=class extends B{constructor(e){super(e);let t=new N;this.addMethod(t,"init",t.init.bind(t)),this.addVoidMethod(t,"checkPointer",t.checkPointer.bind(t)),this.addVoidMethod(t,"checkPointerUV",t.checkPointerUV.bind(t)),this.addEvent(t,"update",n=>n.imgBmp,n=>[n])}};globalThis.server=new V(globalThis);
