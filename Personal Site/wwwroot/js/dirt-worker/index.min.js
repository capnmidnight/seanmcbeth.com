function C(o,e){return o.splice(e,1)[0]}function d(o){return o.splice(0)}function w(o,e){let t=o.indexOf(e);return t>-1?(C(o,t),!0):!1}var Z=class{constructor(e){this.items=new Map;this.defaultItems=new Array;if(s(e))for(let[t,r]of e)this.add(t,r)}add(e,t){if(c(e))this.defaultItems.push(t);else{let r=this.items.get(e);c(r)&&this.items.set(e,r=[]),r.push(t)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let e of this.defaultItems)yield e;for(let e of this.items.values())for(let t of e)yield t}has(e){return s(e)?this.items.has(e):this.defaultItems.length>0}get(e){return c(e)?this.defaultItems:this.items.get(e)||[]}count(e){if(c(e))return this.defaultItems.length;let t=this.get(e);return s(t)?t.length:0}get size(){let e=this.defaultItems.length;for(let t of this.items.values())e+=t.length;return e}delete(e){return c(e)?d(this.defaultItems).length>0:this.items.delete(e)}remove(e,t){if(c(e))w(this.defaultItems,t);else{let r=this.items.get(e);s(r)&&(w(r,t),r.length===0&&this.items.delete(e))}}clear(){this.items.clear(),d(this.defaultItems)}};var L=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(e,t,r){if(E(t)){let n=this.listeners.get(e);n||(n=new Array,this.listeners.set(e,n)),n.find(i=>i===t)||(n.push(t),r&&this.listenerOptions.set(t,r))}}removeEventListener(e,t){if(E(t)){let r=this.listeners.get(e);r&&this.removeListener(r,t)}}clearEventListeners(e){for(let[t,r]of this.listeners)if(c(e)||e===t){for(let n of r)this.removeEventListener(e,n);d(r),this.listeners.delete(t)}}removeListener(e,t){let r=e.findIndex(n=>n===t);r>=0&&(C(e,r),this.listenerOptions.has(t)&&this.listenerOptions.delete(t))}dispatchEvent(e){let t=this.listeners.get(e.type);if(t)for(let r of t){let n=this.listenerOptions.get(r);s(n)&&!M(n)&&n.once&&this.removeListener(t,r),r.call(this,e)}return!e.defaultPrevented}},O=class extends Event{get type(){return super.type}constructor(e){super(e)}},R=class extends L{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(t){this.bubblers.add(t)}removeBubbler(t){this.bubblers.delete(t)}addEventListener(t,r,n){super.addEventListener(t,r,n)}removeEventListener(t,r){super.removeEventListener(t,r)}clearEventListeners(t){return super.clearEventListeners(t)}addScopedEventListener(t,r,n,i){this.scopes.has(t)||this.scopes.set(t,[]),this.scopes.get(t).push([r,n]),this.addEventListener(r,n,i)}removeScope(t){let r=this.scopes.get(t);if(r){this.scopes.delete(t);for(let[n,i]of r)this.removeEventListener(n,i)}}dispatchEvent(t){if(!super.dispatchEvent(t))return!1;for(let r of this.bubblers)if(!r.dispatchEvent(t))return!1;return!0}};function k(){return!0}function X(o,e,t){return typeof o===e||o instanceof t}function E(o){return X(o,"function",Function)}function M(o){return X(o,"boolean",Boolean)}function W(o){return o instanceof Array}function c(o){return o==null}function s(o){return!c(o)}var P=class{constructor(e,t,r=!0){this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._started=!1;this._errored=!1;this._finished=!1;E(e)?this.resolveTest=e:this.resolveTest=k,E(t)?this.rejectTest=t:this.rejectTest=k,M(e)?this.autoStart=e:M(t)?this.autoStart=t:s(r)?this.autoStart=r:this.autoStart=!1,this.resolve=n=>{if(this.running&&this.resolveTest(n)){this._result=n;for(let i of this.onThens)i(n);this.clear(),this._finished=!0}},this.reject=n=>{if(this.running&&this.rejectTest(n)){this._error=n,this._errored=!0;for(let i of this.onCatches)i(n);this.clear(),this._finished=!0}},this.autoStart&&this.start()}clear(){d(this.onThens),d(this.onCatches)}start(){this._started=!0}get result(){if(s(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}get running(){return this.started&&!this.finished}get errored(){return this._errored}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((e,t)=>{this.finished?this.errored?t(this.error):e(this.result):(this.onThens.push(e),this.onCatches.push(t))})}then(e,t){return this.project().then(e,t)}catch(e){return this.project().catch(e)}finally(e){return this.project().finally(e)}reset(){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._errored=!1,this._finished=!1,this._started=!1,this.autoStart&&this.start()}};var ee=class{constructor(e,t,r){this.callback=null;this.promise=new Promise((n,i)=>{this.callback=(...u)=>{e(...u)?n(t(...u)):i(r(...u))}})}get[Symbol.toStringTag](){return this.promise.toString()}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}};var Ee=/OculusBrowser\/(\d+)\.(\d+)\.(\d+)/i,A=navigator.userAgent.match(Ee),V=!!A,en=V&&{major:parseFloat(A[1]),minor:parseFloat(A[2]),patch:parseFloat(A[3])},tn=V&&/pacific/i.test(navigator.userAgent),rn=V&&/quest/i.test(navigator.userAgent),nn=V&&/quest 2/i.test(navigator.userAgent);var ge="Worker"in globalThis;var _e=298.257223563,Re=6378137;var G=1/_e,U=1-G,a=G/(2-G),on=Re/(1+a)*(1+a*a/4+a*a*a*a/64),D=Math.sqrt(1-U*U),f=1-U*U,an=D*D/(1-D*D),un=1-f*(.25+f*(3/64+5*f/256)),ln=f*(3/8+f*(3/32+45*f/1024)),cn=f*f*(15/256+f*45/1024),mn=f*f*f*(35/3072),hn=[a/2-2*a*a/3+37*a*a*a/96,a*a/48+a*a*a/15,17*a*a*a/480],pn=[2*a-2*a*a/3,7*a*a/3-8*a*a*a/5,56*a*a*a/15];var Fn=2*Math.PI;function re(o,e,t,r=1){return r*(o+t*e)}var I=class extends R{constructor(){super(...arguments);this.attached=new Array;this.soFar=null;this.total=null;this.msg=null;this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(t,r,n,i){this.soFar=t,this.total=r,this.msg=n,this.est=i;for(let u of this.attached)u.report(t,r,n,i)}attach(t){this.attached.push(t),t.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(t){this.report(0,1,t||"starting")}end(t){this.report(1,1,t||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,d(this.attached)}};function ne(o,e){let t=globalThis,r=t[o];if(c(r)){if(c(e))throw new Error(`No value ${o} found`);r=e(),t[o]=r}return r}function z(o){let e=new Map;for(let[t,r]of o)e.set(r,t);return e}var Pe=new Map([[1,"KiB"],[2,"MiB"],[3,"GiB"],[4,"TiB"]]),Ie=new Map([[1,"KB"],[2,"MB"],[3,"GB"],[4,"TB"]]),jo=z(Pe),$o=z(Ie);var oe=304.79999999999995,Yo=oe*3,Se=10*100,Ne=oe*16.5,Ce=Ne*40,Jo=Se*1e3,Qo=Ce*8,ie=2.54*4,ae=ie*3,Zo=ae*3,we=ae*16.5,Oe=we*40,Xo=100*1e3,ei=Oe*8,j=4*3,Le=j*3,$=100/2.54,ke=j*16.5,Fe=ke*40,ti=$*1e3,ri=Fe*8,ni=3*3,Ae=100/ie,Ve=3*16.5,De=Ve*40,si=Ae*1e3,oi=De*8,ue=$/j,Ue=16.5*40,ii=ue*1e3,ai=Ue*8,Ke=$/Le,Be=16.5/3,He=Be*40,ui=Ke*1e3,li=He*8,le=16.5/ue,ce=le*40,ci=ce*8,mi=1e3/le,hi=40*8,We=1e3/ce,pi=8/We;function q(o){return s(o)&&o.length>0?parseFloat(o):null}var me=class{constructor(e,t){this._url=null;this._base=void 0;this._protocol=null;this._host=null;this._hostName=null;this._userName=null;this._password=null;this._port=null;this._pathName=null;this._hash=null;this._query=new Map;e!==void 0&&(this._url=new URL(e,t),this.rehydrate())}rehydrate(){s(this._protocol)&&this._protocol!==this._url.protocol&&(this._url.protocol=this._protocol),s(this._host)&&this._host!==this._url.host&&(this._url.host=this._host),s(this._hostName)&&this._hostName!==this._url.hostname&&(this._url.hostname=this._hostName),s(this._userName)&&this._userName!==this._url.username&&(this._url.username=this._userName),s(this._password)&&this._password!==this._url.password&&(this._url.password=this._password),s(this._port)&&this._port.toFixed(0)!==this._url.port&&(this._url.port=this._port.toFixed(0)),s(this._pathName)&&this._pathName!==this._url.pathname&&(this._url.pathname=this._pathName),s(this._hash)&&this._hash!==this._url.hash&&(this._url.hash=this._hash);for(let[e,t]of this._query)this._url.searchParams.set(e,t);this._protocol=this._url.protocol,this._host=this._url.host,this._hostName=this._url.hostname,this._userName=this._url.username,this._password=this._url.password,this._port=q(this._url.port),this._pathName=this._url.pathname,this._hash=this._url.hash,this._url.searchParams.forEach((e,t)=>this._query.set(t,e))}refresh(){if(this._url===null){if(s(this._protocol)&&(s(this._host)||s(this._hostName))){if(s(this._host))return this._url=new URL(`${this._protocol}//${this._host}`,this._base),this._port=q(this._url.port),this.rehydrate(),!1;if(s(this._hostName))return this._url=new URL(`${this._protocol}//${this._hostName}`,this._base),this.rehydrate(),!1}else if(s(this._pathName)&&s(this._base))return this._url=new URL(this._pathName,this._base),this.rehydrate(),!1}return s(this._url)}base(e){if(this._url!==null)throw new Error("Cannot redefine base after defining the protocol and domain");return this._base=e,this.refresh(),this}protocol(e){return this._protocol=e,this.refresh()&&(this._url.protocol=e),this}host(e){return this._host=e,this.refresh()&&(this._url.host=e,this._hostName=this._url.hostname,this._port=q(this._url.port)),this}hostName(e){return this._hostName=e,this.refresh()&&(this._url.hostname=e,this._host=`${this._url.hostname}:${this._url.port}`),this}port(e){return this._port=e,this.refresh()&&(this._url.port=e.toFixed(0),this._host=`${this._url.hostname}:${this._url.port}`),this}userName(e){return this._userName=e,this.refresh()&&(this._url.username=e),this}password(e){return this._password=e,this.refresh()&&(this._url.password=e),this}path(e){return this._pathName=e,this.refresh()&&(this._url.pathname=e),this}pathPop(e){return e=e||/\/[^\/]+\/?$/,this.path(this._pathName.replace(e,""))}pathPush(e){let t=this._pathName;return t.endsWith("/")||(t+="/"),t+=e,this.path(t)}query(e,t){return this._query.set(e,t),this.refresh()&&this._url.searchParams.set(e,t),this}hash(e){return this._hash=e,this.refresh()&&(this._url.hash=e),this}toURL(){return this._url}toString(){return this._url.href}[Symbol.toStringTag](){return this.toString()}};var Y=class extends I{constructor(t,r){super();this.server=t;this.taskID=r}report(t,r,n,i){let u={type:"progress",taskID:this.taskID,soFar:t,total:r,msg:n,est:i};this.server.postMessage(u)}},K=class{constructor(e){this.self=e;this.methods=new Map;this.self.addEventListener("message",t=>{let r=t.data;this.callMethod(r)})}postMessage(e,t){s(t)?this.self.postMessage(e,t):this.self.postMessage(e)}callMethod(e){let t=this.methods.get(e.methodName);if(t)try{W(e.params)?t(e.taskID,...e.params):s(e.params)?t(e.taskID,e.params):t(e.taskID)}catch(r){this.onError(e.taskID,`method invocation error: ${e.methodName}(${r.message||r})`)}else this.onError(e.taskID,`method not found: ${e.methodName}`)}onError(e,t){let r={type:"error",taskID:e,errorMessage:t};this.postMessage(r)}onReturn(e,t,r){let n=null;if(t===void 0?n={type:"return",taskID:e}:n={type:"return",taskID:e,returnValue:t},s(r)){let i=r(t);this.postMessage(n,i)}else this.postMessage(n)}addMethodInternal(e,t,r){if(this.methods.has(e))throw new Error(`${e} method has already been mapped.`);this.methods.set(e,async(n,...i)=>{let u=new Y(this,n);try{let p=await t(...i,u);this.onReturn(n,p,r)}catch(p){console.error(p),this.onError(n,p.message||p)}})}addFunction(e,t,r){this.addMethodInternal(e,t,r)}addVoidFunction(e,t){this.addMethodInternal(e,t)}addMethod(e,t,r,n){this.addFunction(t,r.bind(e),n)}addVoidMethod(e,t,r){this.addVoidFunction(t,r.bind(e))}addEvent(e,t,r,n){e.addEventListener(t,i=>{let u=null;if(s(r)?u={type:"event",eventName:t,data:r(i)}:u={type:"event",eventName:t},u.data!==void 0&&s(n)){let p=n(u.data);this.postMessage(u,p)}else this.postMessage(u)})}};var Ge=ne("Juniper:Graphics2D:Dirt:StopTypes",()=>new Map([["mousedown","down"],["mouseenter","move"],["mouseleave","up"],["mousemove","move"],["mouseout","up"],["mouseover","move"],["mouseup","up"],["pointerdown","down"],["pointerenter","move"],["pointerleave","up"],["pointermove","move"],["pointerrawupdate","move"],["pointerout","up"],["pointerup","up"],["pointerover","move"],["touchcancel","up"],["touchend","up"],["touchmove","move"],["touchstart","down"]])),B=class extends R{constructor(){super();this.updateEvt=new O("update");this.canvas=null;this.g=null;this.pointerId=null;this.fr=null;this.pr=null;this.height=null;this.x=null;this.y=null;this.lx=null;this.ly=null;this.sub=new OffscreenCanvas(this.height,this.height),this.subg=this.sub.getContext("2d")}init(t,r,n){this.canvas=t,this.g=this.canvas.getContext("2d"),this.g.fillStyle="rgb(50%, 50%, 50%)",this.g.fillRect(0,0,this.canvas.width,this.canvas.height);let i=this.g.getImageData(0,0,this.canvas.width,this.canvas.height),{data:u,width:p,height:T}=i,S=u.length/(p*T);for(let v=0;v<u.length;v+=S){let x=Math.floor(50*(Math.random()-.5));for(let g=0;g<S-1;++g)u[v+g]+=x}return this.g.putImageData(i,0,0),this.fr=r,this.pr=n,this.height=2*(this.fr+this.pr)+1,Promise.resolve()}update(){if(this.pointerId!==null&&this.canvas){let t=this.lx-this.x,r=this.ly-this.y;if(Math.abs(t)+Math.abs(r)>0){let n=Math.atan2(r,t)+Math.PI,i=Math.round(Math.sqrt(t*t+r*r)),u=i+this.fr+this.pr;this.sub.width=u,this.sub.height=this.height,this.subg.save(),this.subg.translate(0,this.fr+this.pr),this.subg.rotate(-n),this.subg.translate(-this.lx,-this.ly),this.subg.drawImage(this.canvas,0,0),this.subg.restore();let p=this.subg.getImageData(0,0,this.sub.width,this.sub.height),{data:T}=p,S=T.length/(u*this.height),v=(l,m)=>re(l,m+this.fr+this.pr,u,S),x=(l,m)=>T[v(l,m)]/255,g=(l,m,y)=>T[v(l,m)]=255*y,he=x(0,0),N=Math.max(0,he-.25),b=0;for(let l=0;l<i;++l){b+=x(l,0)-N,g(l,0,N);for(let h=-this.fr;h<=this.fr;++h){let _=this.fr-Math.abs(h);b+=x(l+_,h)-N,g(l+_,h,N)}let y=N/(2*this.fr*this.pr);for(let h=-this.fr-this.pr;h<=this.fr+this.pr&&b>0;++h)if(h<-this.fr||this.fr<h){let _=this.fr-Math.abs(h),J=x(l+_,h),Q=Math.min(b,y);g(l+_,h,J+Q),b-=Q}}if(b>0){let l=b/(2*this.fr*this.pr);for(let m=-this.fr-this.pr;m<=this.fr+this.pr&&b>0;++m)if(m<-this.fr||this.fr<m){let y=this.fr-Math.abs(m),h=x(i+y,m),_=Math.min(b,l);g(i+y,m,h+_),b-=_}}for(let l=0;l<T.length;l+=S){let m=T[l];T[l+1]=m,T[l+2]=m}this.subg.putImageData(p,0,0),this.g.save(),this.g.translate(this.lx,this.ly),this.g.rotate(n),this.g.translate(-0,-this.fr-this.pr),this.g.drawImage(this.sub,0,0),this.g.restore(),this.dispatchEvent(this.updateEvt)}}this.lx=this.x,this.ly=this.y}checkPointer(t,r,n,i){let u=Ge.get(i)||i;this.pointerId===null?u==="down"&&(this.pointerId=t,this.lx=this.x=r,this.ly=this.y=n,this.update()):t===this.pointerId&&(this.x=r,this.y=n,this.update(),u==="up"&&(this.pointerId=null))}checkPointerUV(t,r,n,i){this.checkPointer(t,r*this.canvas.width,n*this.canvas.height,i)}};var H=class extends K{constructor(e){super(e);let t=new B;this.addMethod(t,"init",t.init.bind(t)),this.addVoidMethod(t,"checkPointer",t.checkPointer.bind(t)),this.addEvent(t,"update")}};globalThis.server=new H(globalThis);
