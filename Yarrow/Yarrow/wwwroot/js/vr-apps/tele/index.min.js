var xs=Object.create;var Ao=Object.defineProperty;var Fs=Object.getOwnPropertyDescriptor;var ws=Object.getOwnPropertyNames;var fs=Object.getPrototypeOf,Ss=Object.prototype.hasOwnProperty;var We=(n=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(n,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):n)(function(n){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+n+'" is not supported')});var _s=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports),rt=(n,t)=>{for(var e in t)Ao(n,e,{get:t[e],enumerable:!0})},Ts=(n,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ws(t))!Ss.call(n,r)&&r!==e&&Ao(n,r,{get:()=>t[r],enumerable:!(o=Fs(t,r))||o.enumerable});return n};var ei=(n,t,e)=>(e=n!=null?xs(fs(n)):{},Ts(t||!n||!n.__esModule?Ao(e,"default",{value:n,enumerable:!0}):e,n));var Pr=_s((bk,Rr)=>{"use strict";var m={};m.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)};m.localCName=m.generateIdentifier();m.splitLines=function(n){return n.trim().split(`
`).map(t=>t.trim())};m.splitSections=function(n){return n.split(`
m=`).map((e,o)=>(o>0?"m="+e:e).trim()+`\r
`)};m.getDescription=function(n){let t=m.splitSections(n);return t&&t[0]};m.getMediaSections=function(n){let t=m.splitSections(n);return t.shift(),t};m.matchPrefix=function(n,t){return m.splitLines(n).filter(e=>e.indexOf(t)===0)};m.parseCandidate=function(n){let t;n.indexOf("a=candidate:")===0?t=n.substring(12).split(" "):t=n.substring(10).split(" ");let e={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let o=8;o<t.length;o+=2)switch(t[o]){case"raddr":e.relatedAddress=t[o+1];break;case"rport":e.relatedPort=parseInt(t[o+1],10);break;case"tcptype":e.tcpType=t[o+1];break;case"ufrag":e.ufrag=t[o+1],e.usernameFragment=t[o+1];break;default:e[t[o]]===void 0&&(e[t[o]]=t[o+1]);break}return e};m.writeCandidate=function(n){let t=[];t.push(n.foundation);let e=n.component;e==="rtp"?t.push(1):e==="rtcp"?t.push(2):t.push(e),t.push(n.protocol.toUpperCase()),t.push(n.priority),t.push(n.address||n.ip),t.push(n.port);let o=n.type;return t.push("typ"),t.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(t.push("raddr"),t.push(n.relatedAddress),t.push("rport"),t.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(t.push("tcptype"),t.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(t.push("ufrag"),t.push(n.usernameFragment||n.ufrag)),"candidate:"+t.join(" ")};m.parseIceOptions=function(n){return n.substring(14).split(" ")};m.parseRtpMap=function(n){let t=n.substring(9).split(" "),e={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),e.name=t[0],e.clockRate=parseInt(t[1],10),e.channels=t.length===3?parseInt(t[2],10):1,e.numChannels=e.channels,e};m.writeRtpMap=function(n){let t=n.payloadType;n.preferredPayloadType!==void 0&&(t=n.preferredPayloadType);let e=n.channels||n.numChannels||1;return"a=rtpmap:"+t+" "+n.name+"/"+n.clockRate+(e!==1?"/"+e:"")+`\r
`};m.parseExtmap=function(n){let t=n.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}};m.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`};m.parseFmtp=function(n){let t={},e,o=n.substring(n.indexOf(" ")+1).split(";");for(let r=0;r<o.length;r++)e=o[r].trim().split("="),t[e[0].trim()]=e[1];return t};m.writeFmtp=function(n){let t="",e=n.payloadType;if(n.preferredPayloadType!==void 0&&(e=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){let o=[];Object.keys(n.parameters).forEach(r=>{n.parameters[r]!==void 0?o.push(r+"="+n.parameters[r]):o.push(r)}),t+="a=fmtp:"+e+" "+o.join(";")+`\r
`}return t};m.parseRtcpFb=function(n){let t=n.substring(n.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};m.writeRtcpFb=function(n){let t="",e=n.payloadType;return n.preferredPayloadType!==void 0&&(e=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{t+="a=rtcp-fb:"+e+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),t};m.parseSsrcMedia=function(n){let t=n.indexOf(" "),e={ssrc:parseInt(n.substring(7,t),10)},o=n.indexOf(":",t);return o>-1?(e.attribute=n.substring(t+1,o),e.value=n.substring(o+1)):e.attribute=n.substring(t+1),e};m.parseSsrcGroup=function(n){let t=n.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(e=>parseInt(e,10))}};m.getMid=function(n){let t=m.matchPrefix(n,"a=mid:")[0];if(t)return t.substring(6)};m.parseFingerprint=function(n){let t=n.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}};m.getDtlsParameters=function(n,t){return{role:"auto",fingerprints:m.matchPrefix(n+t,"a=fingerprint:").map(m.parseFingerprint)}};m.writeDtlsParameters=function(n,t){let e="a=setup:"+t+`\r
`;return n.fingerprints.forEach(o=>{e+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),e};m.parseCryptoLine=function(n){let t=n.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}};m.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?m.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`};m.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;let t=n.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}};m.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")};m.getCryptoParameters=function(n,t){return m.matchPrefix(n+t,"a=crypto:").map(m.parseCryptoLine)};m.getIceParameters=function(n,t){let e=m.matchPrefix(n+t,"a=ice-ufrag:")[0],o=m.matchPrefix(n+t,"a=ice-pwd:")[0];return e&&o?{usernameFragment:e.substring(12),password:o.substring(10)}:null};m.writeIceParameters=function(n){let t="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(t+=`a=ice-lite\r
`),t};m.parseRtpParameters=function(n){let t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=m.splitLines(n)[0].split(" ");t.profile=o[2];for(let i=3;i<o.length;i++){let a=o[i],s=m.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(s){let c=m.parseRtpMap(s),u=m.matchPrefix(n,"a=fmtp:"+a+" ");switch(c.parameters=u.length?m.parseFmtp(u[0]):{},c.rtcpFeedback=m.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(m.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase());break;default:break}}}m.matchPrefix(n,"a=extmap:").forEach(i=>{t.headerExtensions.push(m.parseExtmap(i))});let r=m.matchPrefix(n,"a=rtcp-fb:* ").map(m.parseRtcpFb);return t.codecs.forEach(i=>{r.forEach(a=>{i.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||i.rtcpFeedback.push(a)})}),t};m.writeRtpDescription=function(n,t){let e="";e+="m="+n+" ",e+=t.codecs.length>0?"9":"0",e+=" "+(t.profile||"UDP/TLS/RTP/SAVPF")+" ",e+=t.codecs.map(r=>r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType).join(" ")+`\r
`,e+=`c=IN IP4 0.0.0.0\r
`,e+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,t.codecs.forEach(r=>{e+=m.writeRtpMap(r),e+=m.writeFmtp(r),e+=m.writeRtcpFb(r)});let o=0;return t.codecs.forEach(r=>{r.maxptime>o&&(o=r.maxptime)}),o>0&&(e+="a=maxptime:"+o+`\r
`),t.headerExtensions&&t.headerExtensions.forEach(r=>{e+=m.writeExtmap(r)}),e};m.parseRtpEncodingParameters=function(n){let t=[],e=m.parseRtpParameters(n),o=e.fecMechanisms.indexOf("RED")!==-1,r=e.fecMechanisms.indexOf("ULPFEC")!==-1,i=m.matchPrefix(n,"a=ssrc:").map(p=>m.parseSsrcMedia(p)).filter(p=>p.attribute==="cname"),a=i.length>0&&i[0].ssrc,s,c=m.matchPrefix(n,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(h=>parseInt(h,10)));c.length>0&&c[0].length>1&&c[0][0]===a&&(s=c[0][1]),e.codecs.forEach(p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let l={ssrc:a,codecPayloadType:parseInt(p.parameters.apt,10)};a&&s&&(l.rtx={ssrc:s}),t.push(l),o&&(l=JSON.parse(JSON.stringify(l)),l.fec={ssrc:a,mechanism:r?"red+ulpfec":"red"},t.push(l))}}),t.length===0&&a&&t.push({ssrc:a});let u=m.matchPrefix(n,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substring(5),10)*1e3*.95-50*40*8:u=void 0,t.forEach(p=>{p.maxBitrate=u})),t};m.parseRtcpParameters=function(n){let t={},e=m.matchPrefix(n,"a=ssrc:").map(i=>m.parseSsrcMedia(i)).filter(i=>i.attribute==="cname")[0];e&&(t.cname=e.value,t.ssrc=e.ssrc);let o=m.matchPrefix(n,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=o.length===0;let r=m.matchPrefix(n,"a=rtcp-mux");return t.mux=r.length>0,t};m.writeRtcpParameters=function(n){let t="";return n.reducedSize&&(t+=`a=rtcp-rsize\r
`),n.mux&&(t+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(t+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),t};m.parseMsid=function(n){let t,e=m.matchPrefix(n,"a=msid:");if(e.length===1)return t=e[0].substring(7).split(" "),{stream:t[0],track:t[1]};let o=m.matchPrefix(n,"a=ssrc:").map(r=>m.parseSsrcMedia(r)).filter(r=>r.attribute==="msid");if(o.length>0)return t=o[0].value.split(" "),{stream:t[0],track:t[1]}};m.parseSctpDescription=function(n){let t=m.parseMLine(n),e=m.matchPrefix(n,"a=max-message-size:"),o;e.length>0&&(o=parseInt(e[0].substring(19),10)),isNaN(o)&&(o=65536);let r=m.matchPrefix(n,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:t.fmt,maxMessageSize:o};let i=m.matchPrefix(n,"a=sctpmap:");if(i.length>0){let a=i[0].substring(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:o}}};m.writeSctpDescription=function(n,t){let e=[];return n.protocol!=="DTLS/SCTP"?e=["m="+n.kind+" 9 "+n.protocol+" "+t.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+t.port+`\r
`]:e=["m="+n.kind+" 9 "+n.protocol+" "+t.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+t.port+" "+t.protocol+` 65535\r
`],t.maxMessageSize!==void 0&&e.push("a=max-message-size:"+t.maxMessageSize+`\r
`),e.join("")};m.generateSessionId=function(){return Math.random().toString().substr(2,22)};m.writeSessionBoilerplate=function(n,t,e){let o,r=t!==void 0?t:2;return n?o=n:o=m.generateSessionId(),`v=0\r
o=`+(e||"thisisadapterortc")+" "+o+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`};m.getDirection=function(n,t){let e=m.splitLines(n);for(let o=0;o<e.length;o++)switch(e[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return e[o].substring(2);default:}return t?m.getDirection(t):"sendrecv"};m.getKind=function(n){return m.splitLines(n)[0].split(" ")[0].substring(2)};m.isRejected=function(n){return n.split(" ",2)[1]==="0"};m.parseMLine=function(n){let e=m.splitLines(n)[0].substring(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}};m.parseOLine=function(n){let e=m.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}};m.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;let t=m.splitLines(n);for(let e=0;e<t.length;e++)if(t[e].length<2||t[e].charAt(1)!=="=")return!1;return!0};typeof Rr=="object"&&(Rr.exports=m)});function it(n,t,e){return typeof n===t||n instanceof e}function q(n){return it(n,"function",Function)}function de(n){return it(n,"string",String)}function me(n){return it(n,"boolean",Boolean)}function Y(n){return it(n,"number",Number)}function at(n){return g(n)&&it(n,"object",Object)}function st(n){return n instanceof Array}function E(n){return n==null}function g(n){return!E(n)}function ti(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}var ni=/([^\/]+)\/(.+)/,ks=/(?:([^\.]+)\.)?([^\+;]+)(?:\+([^;]+))?((?:; *([^=]+)=([^;]+))*)/;var he=class{constructor(t,e,o){this._type=t;this._fullSubType=e;this._primaryExtension=null;this.depMessage=null;let r=new Map;this._parameters=r;let i=this._fullSubType.match(ks);this._tree=i[1],this._subType=i[2],this._suffix=i[3];let a=i[4];if(this._value=this._fullValue=this._type+"/",g(this._tree)&&(this._value=this._fullValue+=this._tree+"."),this._value=this._fullValue+=this._subType,g(this._suffix)&&(this._value=this._fullValue+="+"+this._suffix),g(a)){let s=a.split(";").map(c=>c.trim()).filter(c=>c.length>0).map(c=>c.split("="));for(let[c,...u]of s){let p=u.join("=");r.set(c,p);let l=`; ${c}=${p}`;this._fullValue+=l,c!=="q"&&(this._value+=l)}}this._extensions=o||[],this._primaryExtension=this._extensions[0]||null}static parse(t){if(!t)return null;let e=t.match(ni);if(!e)return null;let o=e[1],r=e[2];return new he(o,r)}deprecate(t){return this.depMessage=t,this}check(){g(this.depMessage)&&console.warn(`${this._value} is deprecated ${this.depMessage}`)}matches(t){if(E(t))return!1;if(this.typeName==="*"&&this.subTypeName==="*")return!0;let e=null,o=null;if(de(t)){let r=t.match(ni);if(!r)return!1;e=r[1],o=r[2]}else e=t.typeName,o=t._fullSubType;return this.typeName===e&&(this._fullSubType==="*"||this._fullSubType===o)}withParameter(t,e){let o=`${this._fullSubType}; ${t}=${e}`;return new he(this.typeName,o,this.extensions)}get typeName(){return this.check(),this._type}get tree(){return this.check(),this._tree}get suffix(){return this._suffix}get subTypeName(){return this.check(),this._subType}get value(){return this.check(),this._value}__getValueUnsafe(){return this._value}get fullValue(){return this.check(),this._fullValue}get parameters(){return this.check(),this._parameters}get extensions(){return this.check(),this._extensions}__getExtensionsUnsafe(){return this._extensions}get primaryExtension(){return this.check(),this._primaryExtension}toString(){return this.parameters.get("q")==="1"?this.value:this.fullValue}addExtension(t){if(!t)throw new Error("File name is not defined");if(this.primaryExtension){let e=t.lastIndexOf(".");if(e>-1){let o=t.substring(e+1);this.extensions.indexOf(o)>-1&&(t=t.substring(0,e))}t=`${t}.${this.primaryExtension}`}return t}};function vs(n,t,...e){return new he(n,t,e)}function H(n){return vs.bind(null,n)}var bs=H("audio");var Eo=bs("mpeg","mp3","mp2","mp2a","mpga","m2a","m3a");var oi=H("model");var Ht=oi("gltf-binary","glb"),ri=oi("gltf+json","gltf");function ii(n){if(n.status>=400)throw new Error("Resource could not be retrieved: "+n.requestPath);return n}function ai(n){let{content:t}=ii(n);return t}var Co=class{constructor(t,e){this.path=t;this.type=e;this._result=null;this._error=null;this._started=!1;this._finished=!1;this.resolve=null;this.reject=null;this.promise=new Promise((o,r)=>{this.resolve=i=>{this._result=i,this._finished=!0,o(i)},this.reject=i=>{this._error=i,this._finished=!0,r(i)}})}get result(){if(g(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}async getSize(t){try{let{contentLength:e}=await t.head(this.path).accept(this.type).exec();return[this,e||1]}catch(e){return console.warn(e),[this,1]}}async fetch(t,e){try{let o=await this.getResult(t,e);this.resolve(o)}catch(o){this.reject(o)}}get[Symbol.toStringTag](){return this.promise.toString()}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}};var ct=class extends Co{constructor(e,o,r){let i;me(o)?r=o:i=o;super(e,i);this.useCache=!!r}getResult(e,o){return this.getRequest(e,o).then(ai)}getRequest(e,o){let r=e.get(this.path).useCache(this.useCache).progress(o);return this.getResponse(r)}};var ut=class extends ct{getResponse(t){return t.file(this.type)}};function As(n){return n}function Es(n,t,e){let o=0,r=n.length,i=Math.floor((o+r)/2),a=!1;for(;o<r&&i<n.length;){let s=n[i],c=E(s)?null:e(s);g(c)&&t<c?r=i:(t===c&&(a=!0),o=i+1),i=Math.floor((o+r)/2)}return a||(i+=.5),i}function Cs(n,t,e){e=e||As;let o=e(t);return Es(n,o,e)}function Ae(n){return n.splice(0)}function si(n,t){for(let e=0;e<n.length;++e)if(n[e]!==t[e])return e;return-1}function Ms(n,t,e){n.splice(e,0,t)}function Z(n,t){let e=n.indexOf(t);return e>-1?(Mo(n,e),!0):!1}function Mo(n,t){return n.splice(t,1)[0]}function Ds(n,t,e){let o=n?0:t.length-1,r=n?t.length:-1,i=n?1:-1;for(let a of e)for(let s=o;s!=r;s+=i){let c=t[s];if(a(c))return c}return null}function pt(n,...t){return Ds(!0,n,t)}function Do(n,t,e,o){let r;return q(e)?r=e:me(e)&&(o=e),E(o)&&(o=!0),ys(n,t,r,o)}function ys(n,t,e,o){let r=Cs(n,t,e),i=r%1===0;return r=r|0,(!i||o)&&Ms(n,t,r),r}function ci(...n){return Promise.all(n)}var Ot=1e-6,lt=typeof Float32Array<"u"?Float32Array:Array,yo=Math.random;var Vp=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});var Nt={};rt(Nt,{add:()=>Is,angle:()=>ic,bezier:()=>Qs,ceil:()=>Ws,clone:()=>Bs,copy:()=>Ps,create:()=>ui,cross:()=>qs,dist:()=>mc,distance:()=>hi,div:()=>dc,divide:()=>mi,dot:()=>Fi,equals:()=>uc,exactEquals:()=>cc,floor:()=>Hs,forEach:()=>Fc,fromValues:()=>Rs,hermite:()=>$s,inverse:()=>zs,len:()=>gc,length:()=>pi,lerp:()=>Ks,max:()=>Ns,min:()=>Os,mul:()=>lc,multiply:()=>di,negate:()=>Xs,normalize:()=>Js,random:()=>Ys,rotateX:()=>nc,rotateY:()=>oc,rotateZ:()=>rc,round:()=>js,scale:()=>Us,scaleAndAdd:()=>Gs,set:()=>Vs,sqrDist:()=>hc,sqrLen:()=>xc,squaredDistance:()=>gi,squaredLength:()=>xi,str:()=>sc,sub:()=>pc,subtract:()=>li,transformMat3:()=>ec,transformMat4:()=>Zs,transformQuat:()=>tc,zero:()=>ac});function ui(){var n=new lt(3);return lt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Bs(n){var t=new lt(3);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function pi(n){var t=n[0],e=n[1],o=n[2];return Math.hypot(t,e,o)}function Rs(n,t,e){var o=new lt(3);return o[0]=n,o[1]=t,o[2]=e,o}function Ps(n,t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n}function Vs(n,t,e,o){return n[0]=t,n[1]=e,n[2]=o,n}function Is(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function li(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}function di(n,t,e){return n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}function mi(n,t,e){return n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n}function Ws(n,t){return n[0]=Math.ceil(t[0]),n[1]=Math.ceil(t[1]),n[2]=Math.ceil(t[2]),n}function Hs(n,t){return n[0]=Math.floor(t[0]),n[1]=Math.floor(t[1]),n[2]=Math.floor(t[2]),n}function Os(n,t,e){return n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n}function Ns(n,t,e){return n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n}function js(n,t){return n[0]=Math.round(t[0]),n[1]=Math.round(t[1]),n[2]=Math.round(t[2]),n}function Us(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n}function Gs(n,t,e,o){return n[0]=t[0]+e[0]*o,n[1]=t[1]+e[1]*o,n[2]=t[2]+e[2]*o,n}function hi(n,t){var e=t[0]-n[0],o=t[1]-n[1],r=t[2]-n[2];return Math.hypot(e,o,r)}function gi(n,t){var e=t[0]-n[0],o=t[1]-n[1],r=t[2]-n[2];return e*e+o*o+r*r}function xi(n){var t=n[0],e=n[1],o=n[2];return t*t+e*e+o*o}function Xs(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function zs(n,t){return n[0]=1/t[0],n[1]=1/t[1],n[2]=1/t[2],n}function Js(n,t){var e=t[0],o=t[1],r=t[2],i=e*e+o*o+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n}function Fi(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function qs(n,t,e){var o=t[0],r=t[1],i=t[2],a=e[0],s=e[1],c=e[2];return n[0]=r*c-i*s,n[1]=i*a-o*c,n[2]=o*s-r*a,n}function Ks(n,t,e,o){var r=t[0],i=t[1],a=t[2];return n[0]=r+o*(e[0]-r),n[1]=i+o*(e[1]-i),n[2]=a+o*(e[2]-a),n}function $s(n,t,e,o,r,i){var a=i*i,s=a*(2*i-3)+1,c=a*(i-2)+i,u=a*(i-1),p=a*(3-2*i);return n[0]=t[0]*s+e[0]*c+o[0]*u+r[0]*p,n[1]=t[1]*s+e[1]*c+o[1]*u+r[1]*p,n[2]=t[2]*s+e[2]*c+o[2]*u+r[2]*p,n}function Qs(n,t,e,o,r,i){var a=1-i,s=a*a,c=i*i,u=s*a,p=3*i*s,l=3*c*a,h=c*i;return n[0]=t[0]*u+e[0]*p+o[0]*l+r[0]*h,n[1]=t[1]*u+e[1]*p+o[1]*l+r[1]*h,n[2]=t[2]*u+e[2]*p+o[2]*l+r[2]*h,n}function Ys(n,t){t=t||1;var e=yo()*2*Math.PI,o=yo()*2-1,r=Math.sqrt(1-o*o)*t;return n[0]=Math.cos(e)*r,n[1]=Math.sin(e)*r,n[2]=o*t,n}function Zs(n,t,e){var o=t[0],r=t[1],i=t[2],a=e[3]*o+e[7]*r+e[11]*i+e[15];return a=a||1,n[0]=(e[0]*o+e[4]*r+e[8]*i+e[12])/a,n[1]=(e[1]*o+e[5]*r+e[9]*i+e[13])/a,n[2]=(e[2]*o+e[6]*r+e[10]*i+e[14])/a,n}function ec(n,t,e){var o=t[0],r=t[1],i=t[2];return n[0]=o*e[0]+r*e[3]+i*e[6],n[1]=o*e[1]+r*e[4]+i*e[7],n[2]=o*e[2]+r*e[5]+i*e[8],n}function tc(n,t,e){var o=e[0],r=e[1],i=e[2],a=e[3],s=t[0],c=t[1],u=t[2],p=r*u-i*c,l=i*s-o*u,h=o*c-r*s,x=r*h-i*l,F=i*p-o*h,f=o*l-r*p,M=a*2;return p*=M,l*=M,h*=M,x*=2,F*=2,f*=2,n[0]=s+p+x,n[1]=c+l+F,n[2]=u+h+f,n}function nc(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[0],i[1]=r[1]*Math.cos(o)-r[2]*Math.sin(o),i[2]=r[1]*Math.sin(o)+r[2]*Math.cos(o),n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function oc(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[2]*Math.sin(o)+r[0]*Math.cos(o),i[1]=r[1],i[2]=r[2]*Math.cos(o)-r[0]*Math.sin(o),n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function rc(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[0]*Math.cos(o)-r[1]*Math.sin(o),i[1]=r[0]*Math.sin(o)+r[1]*Math.cos(o),i[2]=r[2],n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function ic(n,t){var e=n[0],o=n[1],r=n[2],i=t[0],a=t[1],s=t[2],c=Math.sqrt(e*e+o*o+r*r),u=Math.sqrt(i*i+a*a+s*s),p=c*u,l=p&&Fi(n,t)/p;return Math.acos(Math.min(Math.max(l,-1),1))}function ac(n){return n[0]=0,n[1]=0,n[2]=0,n}function sc(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function cc(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}function uc(n,t){var e=n[0],o=n[1],r=n[2],i=t[0],a=t[1],s=t[2];return Math.abs(e-i)<=Ot*Math.max(1,Math.abs(e),Math.abs(i))&&Math.abs(o-a)<=Ot*Math.max(1,Math.abs(o),Math.abs(a))&&Math.abs(r-s)<=Ot*Math.max(1,Math.abs(r),Math.abs(s))}var pc=li,lc=di,dc=mi,mc=hi,hc=gi,gc=pi,xc=xi,Fc=function(){var n=ui();return function(t,e,o,r,i,a){var s,c;for(e||(e=3),o||(o=0),r?c=Math.min(r*e+o,t.length):c=t.length,s=o;s<c;s+=e)n[0]=t[s],n[1]=t[s+1],n[2]=t[s+2],i(n,n,a),t[s]=n[0],t[s+1]=n[1],t[s+2]=n[2];return t}}();var wi=Nt.fromValues(0,0,-1),dt=Math.PI,mt=.5*dt,ce=2*dt;var wc=864e13,jp=-wc;function fi(n){return(n%ce+ce)%ce}function Si(n,t,e){return Math.min(e,Math.max(t,n))}function _i(n){return n*ce/360}function Ti(...n){let t=Number.MAX_VALUE;for(let e of n)Math.abs(e)<t&&(t=e);return t}function ki(n,t,e){return n*(e-t)+t}function vi(n,t,e){return(1-e)*n+e*t}async function bi(n,t){let{status:e,requestPath:o,responsePath:r,content:i,contentType:a,contentLength:s,fileName:c,headers:u,date:p}=n;return{status:e,requestPath:o,responsePath:r,content:g(t)?await t(i):void 0,contentType:a,contentLength:s,fileName:c,headers:u,date:p}}var jt=class extends ct{constructor(e,o,r,i){if(!Ht.matches(r)&&!ri.matches(r))throw new Error("Only GLTF model types are currently supported");super(o,r,i);this.env=e}async getResponse(e){let o=await e.file();return bi(o,r=>this.env.loadGltf(r))}};var Ut=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(t,e,o){if(q(e)){let r=this.listeners.get(t);r||(r=new Array,this.listeners.set(t,r)),r.find(i=>i===e)||(r.push(e),o&&this.listenerOptions.set(e,o))}}removeEventListener(t,e){if(q(e)){let o=this.listeners.get(t);o&&this.removeListener(o,e)}}clearEventListeners(t){for(let[e,o]of this.listeners)if(E(t)||t===e){for(let r of o)this.removeEventListener(t,r);Ae(o),this.listeners.delete(e)}}removeListener(t,e){let o=t.findIndex(r=>r===e);o>=0&&(Mo(t,o),this.listenerOptions.has(e)&&this.listenerOptions.delete(e))}dispatchEvent(t){let e=this.listeners.get(t.type);if(e)for(let o of e){let r=this.listenerOptions.get(o);g(r)&&!me(r)&&r.once&&this.removeListener(e,o),o.call(this,t)}return!t.defaultPrevented}},T=class extends Event{get type(){return super.type}constructor(t,e){super(t,e)}},B=class extends Ut{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(e){this.bubblers.add(e)}removeBubbler(e){this.bubblers.delete(e)}addEventListener(e,o,r){super.addEventListener(e,o,r)}removeEventListener(e,o){super.removeEventListener(e,o)}clearEventListeners(e){return super.clearEventListeners(e)}addScopedEventListener(e,o,r,i){this.scopes.has(e)||this.scopes.set(e,[]),this.scopes.get(e).push([o,r]),this.addEventListener(o,r,i)}removeScope(e){let o=this.scopes.get(e);if(o){this.scopes.delete(e);for(let[r,i]of o)this.removeEventListener(r,i)}}dispatchEvent(e){if(!super.dispatchEvent(e))return!1;if(!e.cancelBubble){for(let o of this.bubblers)if(!o.dispatchEvent(e))return!1}return!0}};function Lo(n){return g(n)&&"_resolveInput"in n}function Ai(n){return Lo(n)&&"_resolveOutput"in n}var Gt=class extends B{constructor(e,o){super();this.nodeType=e;this.context=o;this._name=null;this.disposed=!1}get name(){return this._name}set name(e){this._name=e,this.context._name(this,e)}dispose(){this.disposed||(this.disposed=!0,this.onDisposing())}onDisposing(){}isConnected(e,o,r){return this.context._isConnected(this,e,o,r)}resolveOutput(e){let o={source:this,output:e};for(;Ai(o.source);)o=o.source._resolveOutput(o.output);return o}resolveInput(e){let o={destination:this,input:e};for(;Lo(o.destination);)o=o.destination._resolveInput(o.input);return o}toggle(e,o,r){this._toggle(e,o,r)}_toggle(e,o,r){if(this.isConnected(e,o,r))this._disconnect(e,o,r);else return this._connect(e,o,r)}connect(e,o,r){return this._connect(e,o,r)}_connect(e,o,r){return this.context._connect(this,e,o,r)}disconnect(e,o,r){this._disconnect(e,o,r)}_disconnect(e,o,r){this.context._disconnect(this,e,o,r)}};var Xt=class extends Gt{constructor(e,o,r){super(e,o);this._node=r;this.context._init(this._node,this.nodeType)}onDisposing(){this.disconnect(),this.context._dispose(this._node),super.onDisposing()}parent(e){this.context._parent(this,e)}get channelCount(){return this._node.channelCount}set channelCount(e){this._node.channelCount=e}get channelCountMode(){return this._node.channelCountMode}set channelCountMode(e){this._node.channelCountMode=e}get channelInterpretation(){return this._node.channelInterpretation}set channelInterpretation(e){this._node.channelInterpretation=e}get numberOfInputs(){return this._node.numberOfInputs}get numberOfOutputs(){return this._node.numberOfOutputs}_resolveInput(e){return{destination:this._node,input:e}}_resolveOutput(e){return{source:this._node,output:e}}};var zt=class extends Xt{constructor(t,e){super("analyser",t,new AnalyserNode(t,e))}get fftSize(){return this._node.fftSize}set fftSize(t){this._node.fftSize=t}get frequencyBinCount(){return this._node.frequencyBinCount}get maxDecibels(){return this._node.maxDecibels}set maxDecibels(t){this._node.maxDecibels=t}get minDecibels(){return this._node.minDecibels}set minDecibels(t){this._node.minDecibels=t}get smoothingTimeConstant(){return this._node.smoothingTimeConstant}set smoothingTimeConstant(t){this._node.smoothingTimeConstant=t}getByteFrequencyData(t){this._node.getByteFrequencyData(t)}getByteTimeDomainData(t){this._node.getByteTimeDomainData(t)}getFloatFrequencyData(t){this._node.getFloatFrequencyData(t)}getFloatTimeDomainData(t){this._node.getFloatTimeDomainData(t)}};var Bo=class extends T{constructor(){super("update");this.t=0;this.dt=0;this.sdt=0;this.fps=0}set(e,o){this.t=e,this.dt=o,this.sdt=vi(this.sdt,o,.01),o>0&&(this.fps=1e3/o)}},Jt=class extends Bo{constructor(){super(),Object.seal(this)}};var qt=class{constructor(t){this.timer=null;this.lt=-1;this.tickHandlers=new Array;this._targetFPS=null;this.targetFPS=t;let e=new Jt,o=0;this.onTick=r=>{this.lt>=0&&(o=r-this.lt,e.set(r,o),this.tick(e)),this.lt=r}}get targetFPS(){return this._targetFPS}set targetFPS(t){this._targetFPS=t}addTickHandler(t){this.tickHandlers.push(t)}removeTickHandler(t){Z(this.tickHandlers,t)}tick(t){for(let e of this.tickHandlers)e(t)}restart(){this.stop(),this.start()}get isRunning(){return this.timer!=null}stop(){this.timer=null,this.lt=-1}get targetFrameTime(){return 1e3/this.targetFPS}};var Kt=class extends qt{constructor(t){super(t)}start(){this.timer=setInterval(()=>this.onTick(performance.now()),this.targetFrameTime)}stop(){this.timer&&(clearInterval(this.timer),super.stop())}get targetFPS(){return super.targetFPS}set targetFPS(t){super.targetFPS=t,this.isRunning&&this.restart()}};var Ro=class extends T{constructor(){super("activity");this.level=0}},He=class extends zt{constructor(e){super(e,{fftSize:32,minDecibels:-70});this._level=0;this.maxLevel=0;this.activityEvt=new Ro;this.timer=new Kt(30);let o=new Uint8Array(this.frequencyBinCount);this.timer.addTickHandler(()=>{this.getByteFrequencyData(o),this._level=Math.max(...o),isFinite(this._level)&&(this.maxLevel=Math.max(this.maxLevel,this._level),this.maxLevel>0&&(this._level/=this.maxLevel)),this.activityEvt.level=this.level,this.dispatchEvent(this.activityEvt)})}get level(){return this._level}start(){this.timer.start()}stop(){this.timer.stop()}};function Ei(n){return n}var ge=class{constructor(t,e,o,...r){this.key=t;this.value=e;this.bySetAttribute=o;this.tags=r.map(i=>i.toLocaleUpperCase()),Object.freeze(this)}applyToElement(t){let e=this.key.startsWith("data-");if(!(this.tags.length===0||this.tags.indexOf(t.tagName)>-1||e))console.warn(`Element ${t.tagName} does not support Attribute ${this.key}`);else if(e){let r=this.key.substring(5);t.dataset[r]=this.value}else if(this.key==="style")Object.assign(t.style,this.value);else if(this.key==="classList"){let r=this.value.filter(Ei);r.length>0&&r.forEach(i=>t.classList.add(i))}else this.bySetAttribute?t.setAttribute(this.key,this.value):this.key in t?t[this.key]=this.value:this.value===!1?t.removeAttribute(this.key):this.value===!0?t.setAttribute(this.key,""):t.setAttribute(this.key,this.value)}};function Ci(n){return new ge("autoplay",n,!1,"audio","video")}function Mi(n){return new ge("height",n,!1,"canvas","embed","iframe","img","input","object","video")}function Di(n){return new ge("srcObject",n,!1,"audio","video")}function yi(n){return new ge("width",n,!1,"canvas","embed","iframe","img","input","object","video")}function Li(n){return`${n}px`}function Bi(){return"ui-monospace, 'Droid Sans Mono', 'Cascadia Mono', 'Segoe UI Mono', 'Ubuntu Mono', 'Roboto Mono', Menlo, Monaco, Consolas, monospace"}var xe=class{constructor(t=!0){this.autoStart=t;this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._executionState="waiting";this._resultState="none";this.resolve=e=>{if(this.running){this._result=e,this._resultState="resolved";for(let o of this.onThens)o(e);this.clear(),this._executionState="finished"}},this.reject=e=>{if(this.running){this._error=e,this._resultState="errored";for(let o of this.onCatches)o(e);this.clear(),this._executionState="finished"}},this.autoStart&&this.start()}clear(){Ae(this.onThens),Ae(this.onCatches)}start(){this._executionState="running"}resolver(t){return()=>this.resolve(t)}resolveOn(t,e,o){let r=this.resolver(o);t.addEventListener(e,r),this.finally(()=>t.removeEventListener(e,r))}get result(){if(g(this.error))throw this.error;return this._result}get error(){return this._error}get executionState(){return this._executionState}get waiting(){return this.executionState==="waiting"}get started(){return this.executionState!=="waiting"}get running(){return this.executionState==="running"}get finished(){return this.executionState==="finished"}get resultState(){return this._resultState}get resolved(){return this.resultState==="resolved"}get errored(){return this.resultState==="errored"}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((t,e)=>{this.finished?this.errored?e(this.error):t(this.result):(this.onThens.push(t),this.onCatches.push(e))})}then(t,e){return this.project().then(t,e)}catch(t){return this.project().catch(t)}finally(t){return this.project().finally(t)}reset(){this._reset(this.autoStart)}restart(){this._reset(!0)}_reset(t){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._executionState="waiting",this._resultState="none",t&&this.start()}};function Ri(n){return at(n)?n.element instanceof Element:!1}function $t(n){return Ri(n)?n.element:de(n)?Tc(n):n}function Sc(n){return at(n)&&"applyToElement"in n&&q(n.applyToElement)}function Pi(n,t,e=""){n=$t(n),n.style.display=t?e:"none"}function Vi(n){return n=$t(n),n.style.display!=="none"}function _c(n,...t){n=$t(n);for(let e of t)g(e)&&(e instanceof Node?n.append(e):Ri(e)?n.append($t(e)):Sc(e)?e.applyToElement(n):n.append(document.createTextNode(e.toLocaleString())));return n}function Tc(n){return document.querySelector(n)}function Ii(n,...t){let e=null;for(let o of t)if(o instanceof ge&&o.key==="id"){e=document.getElementById(o.value);break}return e==null&&(e=document.createElement(n)),_c(e,...t),e}function Wi(...n){return Ii("canvas",...n)}function Hi(...n){return Ii("video",...n)}var Oe=class{constructor(t,e,o=null){this.value=t;this.desc=e;this.value=t,this.desc=e,this.props=o||{}}contains(t){return t instanceof Oe?this.contains(t.value):this.value.indexOf(t)>=0}changeStyle(t,e){let o=this.value;return o.endsWith(t)&&(o=o.substring(0,o.length-t.length)),o+=e,o}get textStyle(){return this.changeStyle("\uFE0F","\uFE0E")}get emojiStyle(){return this.changeStyle("\uFE0E","\uFE0F")}};var Oi=new Oe("\u2B50","Star");function Po(n,...t){if(!at(n))return!1;n=n;for(let e of t){if(!(e in n))return!1;let o=n[e];if(!q(o))return!1}return!0}function kc(n){return Po(n,"dispose")}function vc(n){return Po(n,"destroy")}function bc(n){return Po(n,"close")}function W(n){kc(n)&&n.dispose(),bc(n)&&n.close(),vc(n)&&n.destroy()}var{ACESFilmicToneMapping:ud,AddEquation:pd,AddOperation:ld,AdditiveAnimationBlendMode:dd,AdditiveBlending:md,AlphaFormat:hd,AlwaysDepth:gd,AlwaysStencilFunc:xd,AmbientLight:Fd,AmbientLightProbe:wd,AnimationClip:fd,AnimationLoader:Sd,AnimationMixer:_d,AnimationObjectGroup:Td,AnimationUtils:kd,ArcCurve:vd,ArrayCamera:bd,ArrowHelper:Ad,Audio:Ed,AudioAnalyser:Cd,AudioContext:Md,AudioListener:Dd,AudioLoader:yd,AxesHelper:Ld,BackSide:Bd,BasicDepthPacking:Rd,BasicShadowMap:Pd,Bone:Vd,BooleanKeyframeTrack:Id,Box2:Wd,Box3:ht,Box3Helper:Hd,BoxBufferGeometry:Od,BoxGeometry:Ni,BoxHelper:Nd,BufferAttribute:jd,BufferGeometry:Ud,BufferGeometryLoader:Gd,ByteType:Xd,Cache:zd,Camera:Jd,CameraHelper:qd,CanvasTexture:Kd,CapsuleBufferGeometry:$d,CapsuleGeometry:Qd,CatmullRomCurve3:Yd,CineonToneMapping:Zd,CircleBufferGeometry:em,CircleGeometry:tm,ClampToEdgeWrapping:nm,Clock:om,Color:Fe,ColorKeyframeTrack:rm,ColorManagement:im,CompressedArrayTexture:am,CompressedTexture:sm,CompressedTextureLoader:cm,ConeBufferGeometry:um,ConeGeometry:pm,CubeCamera:lm,CubeReflectionMapping:dm,CubeRefractionMapping:mm,CubeTexture:hm,CubeTextureLoader:gm,CubeUVReflectionMapping:xm,CubicBezierCurve:Fm,CubicBezierCurve3:wm,CubicInterpolant:fm,CullFaceBack:Sm,CullFaceFront:_m,CullFaceFrontBack:Tm,CullFaceNone:km,Curve:vm,CurvePath:bm,CustomBlending:Am,CustomToneMapping:Em,CylinderBufferGeometry:Cm,CylinderGeometry:Mm,Cylindrical:Dm,Data3DTexture:ym,DataArrayTexture:Lm,DataTexture:Bm,DataTextureLoader:Rm,DataUtils:Pm,DecrementStencilOp:Vm,DecrementWrapStencilOp:Im,DefaultLoadingManager:Wm,DepthFormat:Hm,DepthStencilFormat:Om,DepthTexture:Nm,DirectionalLight:jm,DirectionalLightHelper:Um,DiscreteInterpolant:Gm,DisplayP3ColorSpace:Xm,DodecahedronBufferGeometry:zm,DodecahedronGeometry:Jm,DoubleSide:qm,DstAlphaFactor:Km,DstColorFactor:$m,DynamicCopyUsage:Qm,DynamicDrawUsage:Ym,DynamicReadUsage:Zm,EdgesGeometry:eh,EllipseCurve:th,EqualDepth:nh,EqualStencilFunc:oh,EquirectangularReflectionMapping:rh,EquirectangularRefractionMapping:ih,Euler:ah,EventDispatcher:sh,ExtrudeBufferGeometry:ch,ExtrudeGeometry:uh,FileLoader:ph,Float16BufferAttribute:lh,Float32BufferAttribute:Vo,Float64BufferAttribute:dh,FloatType:mh,Fog:hh,FogExp2:gh,FramebufferTexture:xh,FrontSide:ji,Frustum:Fh,GLBufferAttribute:wh,GLSL1:fh,GLSL3:Sh,GreaterDepth:_h,GreaterEqualDepth:Th,GreaterEqualStencilFunc:kh,GreaterStencilFunc:vh,GridHelper:bh,Group:Ah,HalfFloatType:Eh,HemisphereLight:Ch,HemisphereLightHelper:Mh,HemisphereLightProbe:Dh,IcosahedronBufferGeometry:yh,IcosahedronGeometry:Lh,ImageBitmapLoader:Bh,ImageLoader:Rh,ImageUtils:Ph,IncrementStencilOp:Vh,IncrementWrapStencilOp:Ih,InstancedBufferAttribute:Wh,InstancedBufferGeometry:Ui,InstancedInterleavedBuffer:gt,InstancedMesh:Hh,Int16BufferAttribute:Oh,Int32BufferAttribute:Nh,Int8BufferAttribute:jh,IntType:Uh,InterleavedBuffer:Gh,InterleavedBufferAttribute:we,Interpolant:Xh,InterpolateDiscrete:zh,InterpolateLinear:Jh,InterpolateSmooth:qh,InvertStencilOp:Kh,KeepStencilOp:$h,KeyframeTrack:Qh,LOD:Yh,LatheBufferGeometry:Zh,LatheGeometry:eg,Layers:tg,LessDepth:ng,LessEqualDepth:og,LessEqualStencilFunc:rg,LessStencilFunc:ig,Light:ag,LightProbe:sg,Line:cg,Line3:Gi,LineBasicMaterial:Ac,LineCurve:ug,LineCurve3:pg,LineDashedMaterial:lg,LineLoop:dg,LineSegments:mg,LinearEncoding:hg,LinearFilter:gg,LinearInterpolant:xg,LinearMipMapLinearFilter:Fg,LinearMipMapNearestFilter:wg,LinearMipmapLinearFilter:fg,LinearMipmapNearestFilter:Sg,LinearSRGBColorSpace:_g,LinearToneMapping:Tg,Loader:kg,LoaderUtils:vg,LoadingManager:bg,LoopOnce:Ag,LoopPingPong:Eg,LoopRepeat:Cg,LuminanceAlphaFormat:Mg,LuminanceFormat:Dg,MOUSE:yg,Material:Lg,MaterialLoader:Bg,MathUtils:Xi,Matrix3:Rg,Matrix4:K,MaxEquation:Pg,Mesh:Ee,MeshBasicMaterial:Io,MeshDepthMaterial:Vg,MeshDistanceMaterial:Ig,MeshLambertMaterial:Wg,MeshMatcapMaterial:Hg,MeshNormalMaterial:Og,MeshPhongMaterial:Wo,MeshPhysicalMaterial:Ng,MeshStandardMaterial:jg,MeshToonMaterial:Ug,MinEquation:Gg,MirroredRepeatWrapping:Xg,MixOperation:zg,MultiplyBlending:Jg,MultiplyOperation:qg,NearestFilter:Kg,NearestMipMapLinearFilter:$g,NearestMipMapNearestFilter:Qg,NearestMipmapLinearFilter:Yg,NearestMipmapNearestFilter:Zg,NeverDepth:ex,NeverStencilFunc:tx,NoBlending:nx,NoColorSpace:ox,NoToneMapping:rx,NormalAnimationBlendMode:ix,NormalBlending:ax,NotEqualDepth:sx,NotEqualStencilFunc:cx,NumberKeyframeTrack:ux,Object3D:U,ObjectLoader:px,ObjectSpaceNormalMap:lx,OctahedronBufferGeometry:dx,OctahedronGeometry:mx,OneFactor:hx,OneMinusDstAlphaFactor:gx,OneMinusDstColorFactor:xx,OneMinusSrcAlphaFactor:Fx,OneMinusSrcColorFactor:wx,OrthographicCamera:fx,PCFShadowMap:Sx,PCFSoftShadowMap:_x,PMREMGenerator:Tx,Path:kx,PerspectiveCamera:vx,Plane:bx,PlaneBufferGeometry:Ax,PlaneGeometry:zi,PlaneHelper:Ex,PointLight:Cx,PointLightHelper:Mx,Points:Dx,PointsMaterial:yx,PolarGridHelper:Lx,PolyhedronBufferGeometry:Bx,PolyhedronGeometry:Rx,PositionalAudio:Px,PropertyBinding:Vx,PropertyMixer:Ix,QuadraticBezierCurve:Wx,QuadraticBezierCurve3:Hx,Quaternion:ee,QuaternionKeyframeTrack:Ox,QuaternionLinearInterpolant:Nx,RED_GREEN_RGTC2_Format:jx,RED_RGTC1_Format:Ux,REVISION:Gx,RGBADepthPacking:Xx,RGBAFormat:zx,RGBAIntegerFormat:Jx,RGBA_ASTC_10x10_Format:qx,RGBA_ASTC_10x5_Format:Kx,RGBA_ASTC_10x6_Format:$x,RGBA_ASTC_10x8_Format:Qx,RGBA_ASTC_12x10_Format:Yx,RGBA_ASTC_12x12_Format:Zx,RGBA_ASTC_4x4_Format:eF,RGBA_ASTC_5x4_Format:tF,RGBA_ASTC_5x5_Format:nF,RGBA_ASTC_6x5_Format:oF,RGBA_ASTC_6x6_Format:rF,RGBA_ASTC_8x5_Format:iF,RGBA_ASTC_8x6_Format:aF,RGBA_ASTC_8x8_Format:sF,RGBA_BPTC_Format:cF,RGBA_ETC2_EAC_Format:uF,RGBA_PVRTC_2BPPV1_Format:pF,RGBA_PVRTC_4BPPV1_Format:lF,RGBA_S3TC_DXT1_Format:dF,RGBA_S3TC_DXT3_Format:mF,RGBA_S3TC_DXT5_Format:hF,RGB_ETC1_Format:gF,RGB_ETC2_Format:xF,RGB_PVRTC_2BPPV1_Format:FF,RGB_PVRTC_4BPPV1_Format:wF,RGB_S3TC_DXT1_Format:fF,RGFormat:SF,RGIntegerFormat:_F,RawShaderMaterial:TF,Ray:kF,Raycaster:vF,RectAreaLight:bF,RedFormat:AF,RedIntegerFormat:EF,ReinhardToneMapping:CF,RepeatWrapping:MF,ReplaceStencilOp:DF,ReverseSubtractEquation:yF,RingBufferGeometry:LF,RingGeometry:BF,SIGNED_RED_GREEN_RGTC2_Format:RF,SIGNED_RED_RGTC1_Format:PF,SRGBColorSpace:VF,Scene:IF,ShaderChunk:WF,ShaderLib:xt,ShaderMaterial:Ji,ShadowMaterial:HF,Shape:OF,ShapeBufferGeometry:NF,ShapeGeometry:jF,ShapePath:UF,ShapeUtils:GF,ShortType:XF,Skeleton:zF,SkeletonHelper:JF,SkinnedMesh:qF,Source:KF,Sphere:Qt,SphereBufferGeometry:$F,SphereGeometry:QF,Spherical:YF,SphericalHarmonics3:ZF,SplineCurve:ew,SpotLight:tw,SpotLightHelper:nw,Sprite:ow,SpriteMaterial:Ec,SrcAlphaFactor:rw,SrcAlphaSaturateFactor:iw,SrcColorFactor:aw,StaticCopyUsage:sw,StaticDrawUsage:cw,StaticReadUsage:uw,StereoCamera:pw,StreamCopyUsage:lw,StreamDrawUsage:dw,StreamReadUsage:mw,StringKeyframeTrack:hw,SubtractEquation:gw,SubtractiveBlending:xw,TOUCH:Fw,TangentSpaceNormalMap:ww,TetrahedronBufferGeometry:fw,TetrahedronGeometry:Sw,Texture:qi,TextureLoader:_w,TorusBufferGeometry:Tw,TorusGeometry:kw,TorusKnotBufferGeometry:vw,TorusKnotGeometry:bw,Triangle:Aw,TriangleFanDrawMode:Ew,TriangleStripDrawMode:Cw,TrianglesDrawMode:Mw,TubeBufferGeometry:Dw,TubeGeometry:yw,TwoPassDoubleSide:Lw,UVMapping:Bw,Uint16BufferAttribute:Rw,Uint32BufferAttribute:Pw,Uint8BufferAttribute:Vw,Uint8ClampedBufferAttribute:Iw,Uniform:Ww,UniformsGroup:Hw,UniformsLib:Ft,UniformsUtils:Ho,UnsignedByteType:Ow,UnsignedInt248Type:Nw,UnsignedIntType:jw,UnsignedShort4444Type:Uw,UnsignedShort5551Type:Gw,UnsignedShortType:Xw,VSMShadowMap:zw,Vector2:Ki,Vector3:w,Vector4:Ce,VectorKeyframeTrack:Jw,VideoTexture:$i,WebGL1Renderer:qw,WebGL3DRenderTarget:Kw,WebGLArrayRenderTarget:$w,WebGLCubeRenderTarget:Qw,WebGLMultipleRenderTargets:Yw,WebGLRenderTarget:Zw,WebGLRenderer:ef,WebGLUtils:tf,WireframeGeometry:Qi,WrapAroundEnding:nf,ZeroCurvatureEnding:of,ZeroFactor:rf,ZeroSlopeEnding:af,ZeroStencilOp:sf,_SRGBAFormat:cf,sRGBEncoding:uf}=THREE;var wt=new w;function Yt(n){return wt.copy(n),wt.y=0,wt.normalize(),fi(Math.atan2(wt.x,wt.z))}var Ne=new w,Yi=0,Cc=new w,Zt=new w,Oo=new w,en=new ee,Zi=0,Mc=0;function Dc(n,t){let e=n-t,o=e+ce,r=e-ce;return Ti(e,o,r)}var tn=class extends U{constructor(e,o,r,i,a=1){super();this.minDistance=o;this.heightOffset=i;this.speed=a;this.name=e,this.lerp=this.minHeadingRadians>0||this.minDistance>0,this.maxDistance=this.minDistance*5,this.minHeadingRadians=_i(r),this.maxHeadingRadians=dt-this.minHeadingRadians,Object.seal(this)}copy(e,o=!0){return super.copy(e,o),this.name=e.name+ ++Mc,this.lerp=e.lerp,this.maxDistance=e.maxDistance,this.minHeadingRadians=e.minHeadingRadians,this.maxHeadingRadians=e.maxHeadingRadians,this}update(e,o,r,i){i*=.001,this.clampTo(this.lerp,e,o,this.minDistance,this.maxDistance,r,this.minHeadingRadians,this.maxHeadingRadians,i)}reset(e,o,r){this.clampTo(!1,e,o,0,0,r,0,0,0)}clampTo(e,o,r,i,a,s,c,u,p){Ne.copy(r),Ne.y-=this.heightOffset*o,Yi=s,this.getWorldPosition(Zt),this.getWorldDirection(Oo),Oo.negate(),Zi=Yt(Oo),en.identity();let l=!e,h=!e;if(e){let x=Cc.copy(Ne).sub(Zt).length();i<x&&(x<a&&Ne.lerpVectors(Zt,Ne,this.speed*p),l=!0);let F=Dc(Yi,Zi),f=Math.abs(F);c<f&&(f<u?en.setFromAxisAngle(this.up,F*this.speed*p):en.setFromAxisAngle(this.up,F),h=!0)}(l||h)&&(l&&this.position.add(Ne.sub(Zt)),h&&this.quaternion.multiply(en))}};var nn=class{constructor(t=!1){this.littleEndian=t;this.i=0;this._length=-1;this.length=0}get length(){return this._length}set length(t){t!==this.length&&(this._length=t,this.dataView=new DataView(new ArrayBuffer(this.length)),this.i=0)}get buffer(){return this.dataView.buffer}set buffer(t){t!==this.buffer&&(this._length=t.byteLength,this.dataView=new DataView(t),this.i=0)}get position(){return this.i}set position(t){this.i=t}get left(){return this.length-this.i}readUint8(){let t=this.dataView.getUint8(this.i);return this.i+=1,t}writeUint8(t){this.dataView.setUint8(this.i,t),this.i+=1}readUint16(){let t=this.dataView.getUint16(this.i,this.littleEndian);return this.i+=2,t}writeUint16(t){this.dataView.setUint16(this.i,t,this.littleEndian),this.i+=2}readUint32(){let t=this.dataView.getUint32(this.i,this.littleEndian);return this.i+=4,t}writeUint32(t){this.dataView.setUint32(this.i,t,this.littleEndian),this.i+=4}readUint64(){let t=this.dataView.getBigUint64(this.i,this.littleEndian);return this.i+=8,t}writeUint64(t){this.dataView.setBigUint64(this.i,t,this.littleEndian),this.i+=8}readInt64(){let t=this.dataView.getInt8(this.i);return this.i+=1,t}writeInt64(t){this.dataView.setInt8(this.i,t),this.i+=1}readInt16(){let t=this.dataView.getInt16(this.i,this.littleEndian);return this.i+=2,t}writeInt16(t){this.dataView.setInt16(this.i,t,this.littleEndian),this.i+=2}readInt32(){let t=this.dataView.getInt32(this.i,this.littleEndian);return this.i+=4,t}writeInt32(t){this.dataView.setInt32(this.i,t,this.littleEndian),this.i+=4}readInt8(){let t=this.dataView.getBigInt64(this.i,this.littleEndian);return this.i+=8,t}writeInt8(t){this.dataView.setBigInt64(this.i,t,this.littleEndian),this.i+=8}readFloat32(){let t=this.dataView.getFloat32(this.i,this.littleEndian);return this.i+=4,t}writeFloat32(t){this.dataView.setFloat32(this.i,t,this.littleEndian),this.i+=4}readFloat64(){let t=this.dataView.getFloat64(this.i,this.littleEndian);return this.i+=8,t}writeFloat64(t){this.dataView.setFloat64(this.i,t,this.littleEndian),this.i+=8}readEnum8(t){let e=this.readUint8();return t[e]}writeEnum8(t,e){let o=e.indexOf(t);this.writeUint8(o)}};var je=class extends nn{readVector48(t){t.set(this.readFloat32(),this.readFloat32(),this.readFloat32())}writeVector48(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}readMatrix512(t){t.elements[0]=this.readFloat32(),t.elements[1]=this.readFloat32(),t.elements[2]=this.readFloat32(),t.elements[3]=this.readFloat32(),t.elements[4]=this.readFloat32(),t.elements[5]=this.readFloat32(),t.elements[6]=this.readFloat32(),t.elements[7]=this.readFloat32(),t.elements[8]=this.readFloat32(),t.elements[9]=this.readFloat32(),t.elements[10]=this.readFloat32(),t.elements[11]=this.readFloat32(),t.elements[12]=this.readFloat32(),t.elements[13]=this.readFloat32(),t.elements[14]=this.readFloat32(),t.elements[15]=this.readFloat32()}writeMatrix512(t){this.writeFloat32(t.elements[0]),this.writeFloat32(t.elements[1]),this.writeFloat32(t.elements[2]),this.writeFloat32(t.elements[3]),this.writeFloat32(t.elements[4]),this.writeFloat32(t.elements[5]),this.writeFloat32(t.elements[6]),this.writeFloat32(t.elements[7]),this.writeFloat32(t.elements[8]),this.writeFloat32(t.elements[9]),this.writeFloat32(t.elements[10]),this.writeFloat32(t.elements[11]),this.writeFloat32(t.elements[12]),this.writeFloat32(t.elements[13]),this.writeFloat32(t.elements[14]),this.writeFloat32(t.elements[15])}};var ft="HTMLCanvasElement"in globalThis,Df="HTMLImageElement"in globalThis,ea=!1,No=!ea&&"OffscreenCanvas"in globalThis,yc=!ea&&"createImageBitmap"in globalThis;function St(n){return ft&&n instanceof HTMLCanvasElement}function jo(n){return No&&n instanceof OffscreenCanvas}function ta(n){return yc&&n instanceof ImageBitmap}function na(n){return n instanceof ImageData}function Lc(n){return St(n)||jo(n)}function oa(n,t){let e=n.getContext("2d");if(E(e))throw new Error("Could not create 2d context for canvas");e.drawImage(t,0,0)}function ra(n,t){let e=n.getContext("2d");if(E(e))throw new Error("Could not create 2d context for canvas");e.putImageData(t,0,0)}function Bc(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var Uo=No&&Bc(),Go=Uo&&Xo||ft&&on||null,ia=ft?on:Go;function Rc(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var yf=No&&Rc();function Xo(n,t){return new OffscreenCanvas(n,t)}function on(n,t){return Wi(yi(n),Mi(t))}function Pc(n){let t=Xo(n.width,n.height);return oa(t,n),t}function Vc(n){let t=on(n.width,n.height);return oa(t,n),t}var aa=Uo&&Pc||ft&&Vc||null;function Ic(n){let t=Xo(n.width,n.height);return ra(t,n),t}function Wc(n){let t=on(n.width,n.height);return ra(t,n),t}var sa=Uo&&Ic||ft&&Wc||null;function ca(n,t,e,o=1){return t=Math.floor(t*o),e=Math.floor(e*o),n.width!=t||n.height!=e?(n.width=t,n.height=e,!0):!1}function Hc(n){return g(n.textBaseline)}function Oc(n,t,e,o=1){let r=n.imageSmoothingEnabled,i=n.textBaseline,a=n.textAlign,s=n.font,c=ca(n.canvas,t,e,o);return c&&(n.imageSmoothingEnabled=r,n.textBaseline=i,n.textAlign=a,n.font=s),c}function zo(n,t,e,o=1){return Hc(n)?Oc(n,t,e,o):ca(n.canvas,t,e,o)}function Ue(n){Lc(n)?n.width=n.height=0:W(n)}function fe(n,t){let e=globalThis,o=e[n];if(E(o)){if(E(t))throw new Error(`No value ${n} found`);o=t(),e[n]=o}return o}function Me(n){return g(n)&&n.isMesh}function Jo(n){return g(n)&&n.isMaterial}function Nc(n,t){return Jo(t)&&t.type===n}function ua(n){return Nc("MeshBasicMaterial",n)}function pa(n){return g(n)&&n.isObject3D}function jc(n){return g(n)&&pa(n.object)}function Se(n){return jc(n)?n.object:n}function De(n,t){return n=Se(n),n.visible=t,t}function la(n){return n=Se(n),n.visible}function rn(n){if(!n)return!1;for(n=Se(n);n;){if(!n.visible)return!1;n=n.parent}return!0}function k(n,...t){let e=t.filter(g).map(Se);return e.length>0&&Se(n).add(...e),n}function Ge(n,...t){let e=new U;return e.name=n,k(e,...t),e}function da(n,t,e){let o=new Ee(t,e);return o.name=n,o}var ma=fe("Juniper:ScaledItems",()=>new Map);function ha(n){let t=ma.get(n);t&&(ma.delete(n),W(t))}function ue(n){let t=new Array,e=new Set;for(t.push(n);t.length>0;){let o=t.shift();o&&!e.has(o)&&(e.add(o),o.isMesh&&t.push(o.material,o.geometry),o.isMaterial&&t.push(...Object.values(o)),o.isObject3D&&(t.push(...o.children),o.clear(),ha(o)),st(o)&&t.push(...o),Ue(o))}e.clear()}function ga(n){let t=n.attributes.position,e=n.attributes.normal,o=n.attributes.uv;for(let r=0;r<e.count;++r){let i=r*e.itemSize,a=r*e.itemSize+1,s=r*e.itemSize+2,c=e.array[i],u=e.array[a],p=e.array[s],l=Math.abs(c),h=Math.abs(u),x=Math.abs(p),F=t.array[i],f=t.array[a],M=t.array[s],ve=Math.abs(F),j=Math.abs(f),be=Math.abs(M),O=r*o.itemSize,Ie=r*o.itemSize+1,L=o.array[O],C=o.array[Ie],Q=0,J=l,A=ve;h>J&&(Q=1,J=h,A=j),x>J&&(Q=2,J=x,A=be),Q===0?F<0?(L=-M,C=f):(L=M,C=f):Q===1?f<0?(L=F,C=-M):(L=F,C=M):M<0?(L=F,C=f):(L=-F,C=f),L=(L/A+1)/8,C=(C/A+1)/6,Q===0?F<0?(L+=0,C+=1/3):(L+=.5,C+=1/3):Q===1?f<0?(L+=.25,C+=0):(L+=.25,C+=2/3):M<0?(L+=.25,C+=1/3):(L+=.75,C+=1/3);let N=o.array;N[O]=L,N[Ie]=C}}var _t=new Ni(1,1,1,1,1,1);_t.name="CubeGeom";_t.computeBoundingBox();_t.computeBoundingSphere();var xa=_t.clone();xa.name="InvertedCubeGeom";ga(xa);var G=class extends Ee{constructor(t,e,o,r){super(_t,r),this.scale.set(t,e,o)}};Ft.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new Ki(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};xt.line={uniforms:Ho.merge([Ft.common,Ft.fog,Ft.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segements overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <encodings_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};var pe=class extends Ji{constructor(t){super({type:"LineMaterial",uniforms:Ho.clone(xt.line.uniforms),vertexShader:xt.line.vertexShader,fragmentShader:xt.line.fragmentShader,clipping:!0}),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(e){!!e!="USE_DASH"in this.defines&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){!!e!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),e===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(t)}};pe.prototype.isLineMaterial=!0;var qo=fe("Juniper:Three:Materials",()=>new Map);function Uc(n,t){t in n&&delete n[t]}function an(n,t,e){let o=`${n}_${Object.keys(e).map(r=>`${r}:${e[r]}`).join(",")}`;return qo.has(o)||(Uc(e,"name"),qo.set(o,new t(e))),qo.get(o)}function Gc(n){return Object.assign(n,{transparent:!0})}function Tt(n){return an("solid",Io,n)}function Fa(n){return an("solidTransparent",Io,Gc(n))}function sn(n){return an("lit",Wo,n)}function wa(n){return an("line2",pe,n)}function fa(n,t){let e=new Set;n.traverse(o=>{if(Me(o)&&Jo(o.material)){let r=o.material,i=t(r);r!==i&&(e.add(r),o.material=i)}});for(let o of e)Ue(o)}function Sa(n){if(n.type!=="MeshStandardMaterial")throw new Error("Input material is not MeshStandardMaterial");let t={alphaMap:n.alphaMap,alphaTest:n.alphaTest,alphaToCoverage:n.alphaToCoverage,aoMap:n.aoMap,aoMapIntensity:n.aoMapIntensity,blendDst:n.blendDst,blendDstAlpha:n.blendDstAlpha,blendEquation:n.blendEquation,blendEquationAlpha:n.blendEquationAlpha,blending:n.blending,blendSrc:n.blendSrc,blendSrcAlpha:n.blendSrcAlpha,bumpMap:n.bumpMap,bumpScale:n.bumpScale,clipIntersection:n.clipIntersection,clippingPlanes:n.clippingPlanes,clipShadows:n.clipShadows,color:n.color,colorWrite:n.colorWrite,depthFunc:n.depthFunc,depthTest:n.depthTest,depthWrite:n.depthWrite,displacementBias:n.displacementBias,displacementMap:n.displacementMap,displacementScale:n.displacementScale,dithering:n.dithering,emissive:n.emissive,emissiveIntensity:n.emissiveIntensity,emissiveMap:n.emissiveMap,envMap:n.envMap,flatShading:n.flatShading,fog:n.fog,lightMap:n.lightMap,lightMapIntensity:n.lightMapIntensity,map:n.map,name:n.name+"-Standard-To-Phong",normalMap:n.normalMap,normalMapType:n.normalMapType,normalScale:n.normalScale,opacity:n.opacity,polygonOffset:n.polygonOffset,polygonOffsetFactor:n.polygonOffsetFactor,polygonOffsetUnits:n.polygonOffsetUnits,precision:n.precision,premultipliedAlpha:n.premultipliedAlpha,shadowSide:n.shadowSide,side:n.side,stencilFail:n.stencilFail,stencilFunc:n.stencilFunc,stencilFuncMask:n.stencilFuncMask,stencilRef:n.stencilRef,stencilWrite:n.stencilWrite,stencilWriteMask:n.stencilWriteMask,stencilZFail:n.stencilZFail,stencilZPass:n.stencilZPass,toneMapped:n.toneMapped,transparent:n.transparent,userData:n.userData,vertexColors:n.vertexColors,visible:n.visible,wireframe:n.wireframe,wireframeLinecap:n.wireframeLinecap,wireframeLinejoin:n.wireframeLinejoin,wireframeLinewidth:n.wireframeLinewidth};for(let[e,o]of Object.entries(t))E(o)&&delete t[e];return new Wo(t)}var Xc=255,Ko=65280;var zc=16711680;var _a=16776960,Jc=12632256;var Ta=Tt({color:Xc}),ka=Tt({color:Ko});var va=Tt({color:zc});var ba=sn({color:Jc});var Xe=new w;function cn(n,t,e,o){Xe.crossVectors(t,n),n.crossVectors(Xe,t),Xe.normalize(),n.normalize(),t.normalize(),o.set(Xe.x,n.x,-t.x,e.x,Xe.y,n.y,-t.y,e.y,Xe.z,n.z,-t.z,e.z,0,0,0,1)}var ze=class{constructor(){this._visible=!0;this._style="default"}get style(){return this._style}set style(t){this._style=t}get visible(){return this._visible}set visible(t){this._visible=t}};var Je=class extends ze{constructor(e){super();this.env=e;this._object=null;this.T=new w;this.V=new w;this.Q=new ee;this._side=-1;this.f=new w;this.up=new w;this.right=new w}get side(){return this._side}set side(e){this._side=e}get object(){return this._object}set object(e){this._object=e}get position(){return this.object.position}update(e,o,r,i,a,s,c,u,p,l,h){r&&r.face?(this.position.copy(r.point),r.object.getWorldQuaternion(this.Q),this.T.copy(r.face.normal).applyQuaternion(this.Q),this.V.copy(this.T).multiplyScalar(.02),this.position.add(this.V),this.V.copy(this.T).multiplyScalar(10).add(this.position)):(s?this.position.copy(l).multiplyScalar(2).add(p).sub(this.env.avatar.worldPos).normalize().multiplyScalar(a).add(this.env.avatar.worldPos):(this.V.copy(p).add(o).sub(e).multiplyScalar(2),this.position.copy(l).multiplyScalar(a).add(this.V).add(this.env.avatar.worldPos)),this.V.copy(this.env.avatar.worldPos)),this.lookAt(this.position,this.V),this.style=!i||i.navigable&&!u?c?h?"grabbing":"grab":"default":i.enabled?i.draggable?h?"grabbing":"move":i.navigable?"cell":i.clickable?"pointer":"default":"not-allowed"}lookAt(e,o){this.f.copy(o).sub(e).normalize(),this.up.set(0,1,0).applyQuaternion(this.env.avatar.worldQuat),this.right.crossVectors(this.up,this.f),this.up.crossVectors(this.f,this.right),cn(this.up,this.f,e,this.object.matrixWorld),this.object.matrix.copy(this.object.parent.matrixWorld).invert().multiply(this.object.matrixWorld),this.object.matrix.decompose(this.object.position,this.object.quaternion,this.object.scale),this.object.scale.x*=this.side,this.object.matrix.compose(this.object.position,this.object.quaternion,this.object.scale)}};var qe=class extends Je{constructor(e){super(e);this.material=Tt({name:"CursorMat",color:16776960}),this.object=new G(.01,.01,.01,this.material)}get style(){return this._currentStyle}set style(e){if(this._currentStyle=e,Me(this.object)&&!st(this.object.material))switch(this._currentStyle){case"pointer":this.material.color=new Fe(65280),this.material.needsUpdate=!0;break;case"not-allowed":this.material.color=new Fe(16711680),this.material.needsUpdate=!0;break;case"move":this.material.color=new Fe(255),this.material.needsUpdate=!0;break;case"grab":this.material.color=new Fe(16711935),this.material.needsUpdate=!0;break;case"grabbing":this.material.color=new Fe(65535),this.material.needsUpdate=!0;break;default:this._currentStyle="default",this.material.color=new Fe(16776960),this.material.needsUpdate=!0;break}}get visible(){return la(this)}set visible(e){De(this,e)}};var Aa=new ht,un=new w,ye=class extends Ui{constructor(){super(),this.type="LineSegmentsGeometry";let t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],e=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],o=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(o),this.setAttribute("position",new Vo(t,3)),this.setAttribute("uv",new Vo(e,2))}applyMatrix4(t){let e=this.attributes.instanceStart,o=this.attributes.instanceEnd;return e!==void 0&&(e.applyMatrix4(t),o.applyMatrix4(t),e.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));let o=new gt(e,6,1);return this.setAttribute("instanceStart",new we(o,3,0)),this.setAttribute("instanceEnd",new we(o,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));let o=new gt(e,6,1);return this.setAttribute("instanceColorStart",new we(o,3,0)),this.setAttribute("instanceColorEnd",new we(o,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new Qi(t.geometry)),this}fromLineSegments(t){let e=t.geometry;if(e.isGeometry){console.error("LineSegmentsGeometry no longer supports Geometry. Use BufferGeometry instead.");return}else e.isBufferGeometry&&this.setPositions(e.attributes.position.array);return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new ht);let t=this.attributes.instanceStart,e=this.attributes.instanceEnd;t!==void 0&&e!==void 0&&(this.boundingBox.setFromBufferAttribute(t),Aa.setFromBufferAttribute(e),this.boundingBox.union(Aa))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Qt),this.boundingBox===null&&this.computeBoundingBox();let t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(t!==void 0&&e!==void 0){let o=this.boundingSphere.center;this.boundingBox.getCenter(o);let r=0;for(let i=0,a=t.count;i<a;i++)un.fromBufferAttribute(t,i),r=Math.max(r,o.distanceToSquared(un)),un.fromBufferAttribute(e,i),r=Math.max(r,o.distanceToSquared(un));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(t){return console.warn("LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}};ye.prototype.isLineSegmentsGeometry=!0;var Ea=new w,Ca=new w,P=new Ce,V=new Ce,te=new Ce,$o=new w,Qo=new K,X=new Gi,Ma=new w,le=new ht,pn=new Qt,ne=new Ce;function Da(n,t,e,o){return ne.set(0,0,-t,1).applyMatrix4(n.projectionMatrix),ne.multiplyScalar(1/ne.w),ne.x=e/o.width,ne.y=e/o.height,ne.applyMatrix4(n.projectionMatrixInverse),ne.multiplyScalar(1/ne.w),Math.abs(Math.max(ne.x,ne.y))}var kt=class extends Ee{constructor(t=new ye,e=new pe({color:Math.random()*16777215})){super(t,e),this.type="LineSegments2"}computeLineDistances(){let t=this.geometry,e=t.attributes.instanceStart,o=t.attributes.instanceEnd,r=new Float32Array(2*e.count);for(let a=0,s=0,c=e.count;a<c;a++,s+=2)Ea.fromBufferAttribute(e,a),Ca.fromBufferAttribute(o,a),r[s]=s===0?0:r[s-1],r[s+1]=r[s]+Ea.distanceTo(Ca);let i=new gt(r,2,1);return t.setAttribute("instanceDistanceStart",new we(i,1,0)),t.setAttribute("instanceDistanceEnd",new we(i,1,1)),this}raycast(t,e){t.camera===null&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');let o=t.params.Line2!==void 0&&t.params.Line2.threshold||0,r=t.ray,i=t.camera,a=i.projectionMatrix,s=this.matrixWorld,c=this.geometry,u=this.material,p=u.resolution,l=u.linewidth+o,h=c.attributes.instanceStart,x=c.attributes.instanceEnd,F=-i.near;c.boundingSphere===null&&c.computeBoundingSphere(),pn.copy(c.boundingSphere).applyMatrix4(s);let f=Math.max(i.near,pn.distanceToPoint(r.origin)),M=Da(i,f,l,p);if(pn.radius+=M,t.ray.intersectsSphere(pn)===!1)return;c.boundingBox===null&&c.computeBoundingBox(),le.copy(c.boundingBox).applyMatrix4(s);let ve=Math.max(i.near,le.distanceToPoint(r.origin)),j=Da(i,ve,l,p);if(le.max.x+=j,le.max.y+=j,le.max.z+=j,le.min.x-=j,le.min.y-=j,le.min.z-=j,t.ray.intersectsBox(le)!==!1){r.at(1,te),te.w=1,te.applyMatrix4(i.matrixWorldInverse),te.applyMatrix4(a),te.multiplyScalar(1/te.w),te.x*=p.x/2,te.y*=p.y/2,te.z=0,$o.copy(te),Qo.multiplyMatrices(i.matrixWorldInverse,s);for(let O=0,Ie=h.count;O<Ie;O++){P.fromBufferAttribute(h,O),V.fromBufferAttribute(x,O),P.w=1,V.w=1,P.applyMatrix4(Qo),V.applyMatrix4(Qo);var be=P.z>F&&V.z>F;if(be)continue;if(P.z>F){let A=P.z-V.z,N=(P.z-F)/A;P.lerp(V,N)}else if(V.z>F){let A=V.z-P.z,N=(V.z-F)/A;V.lerp(P,N)}P.applyMatrix4(a),V.applyMatrix4(a),P.multiplyScalar(1/P.w),V.multiplyScalar(1/V.w),P.x*=p.x/2,P.y*=p.y/2,V.x*=p.x/2,V.y*=p.y/2,X.start.copy(P),X.start.z=0,X.end.copy(V),X.end.z=0;let L=X.closestPointToPointParameter($o,!0);X.at(L,Ma);let C=Xi.lerp(P.z,V.z,L),Q=C>=-1&&C<=1,J=$o.distanceTo(Ma)<l*.5;if(Q&&J){X.start.fromBufferAttribute(h,O),X.end.fromBufferAttribute(x,O),X.start.applyMatrix4(s),X.end.applyMatrix4(s);let A=new w,N=new w;r.distanceSqToSegment(X.start,X.end,N,A),e.push({point:N,pointOnLine:A,distance:r.origin.distanceTo(N),object:this,face:null,faceIndex:O,uv:null,uv2:null})}}}}};kt.prototype.isLineSegments2=!0;var Le=class extends ye{constructor(){super(),this.type="LineGeometry"}setPositions(t){for(var e=t.length-3,o=new Float32Array(2*e),r=0;r<e;r+=3)o[2*r]=t[r],o[2*r+1]=t[r+1],o[2*r+2]=t[r+2],o[2*r+3]=t[r+3],o[2*r+4]=t[r+4],o[2*r+5]=t[r+5];return super.setPositions(o),this}setColors(t){for(var e=t.length-3,o=new Float32Array(2*e),r=0;r<e;r+=3)o[2*r]=t[r],o[2*r+1]=t[r+1],o[2*r+2]=t[r+2],o[2*r+3]=t[r+3],o[2*r+4]=t[r+4],o[2*r+5]=t[r+5];return super.setColors(o),this}fromLine(t){var e=t.geometry;if(e.isGeometry){console.error("LineGeometry no longer supports Geometry. Use BufferGeometry instead.");return}else e.isBufferGeometry&&this.setPositions(e.attributes.position.array);return this}};Le.prototype.isLineGeometry=!0;var vt=class extends kt{constructor(t=new Le,e=new pe({color:Math.random()*16777215})){super(t,e),this.type="Line2"}};vt.prototype.isLine2=!0;var ya=new Le;ya.setPositions([0,0,0,0,0,-1]);var ln=class extends U{constructor(e,o,r){super();this._length=1;this.line=new vt(ya,wa({color:e,transparent:o<1,opacity:o,linewidth:r})),this.line.computeLineDistances(),k(this,this.line)}get length(){return this._length}set length(e){this._length=e,this.line.scale.set(1,1,e)}};var bt=(p=>(p[p.LocalUser=0]="LocalUser",p[p.Mouse=1]="Mouse",p[p.Pen=2]="Pen",p[p.Touch=3]="Touch",p[p.Gamepad=4]="Gamepad",p[p.MotionController=5]="MotionController",p[p.MotionControllerLeft=6]="MotionControllerLeft",p[p.MotionControllerRight=7]="MotionControllerRight",p[p.Nose=8]="Nose",p[p.RemoteUser=9]="RemoteUser",p))(bt||{});function La(n){switch(n){case 1:return"mouse";case 2:return"pen";case 3:return"touch";case 4:return"gamepad";case 5:case 6:case 7:return"hand";case 8:return"nose";case 9:return"remote";default:return null}}var dn=class extends ze{constructor(e){super();this.element=e;this._hidden=!1;this.visible=!0,this.style="default",document.addEventListener("pointerlockchange",()=>{this._hidden=!!document.pointerLockElement,this.refresh()})}get style(){return super.style}set style(e){super.style=e,this.refresh()}get visible(){return super.visible&&!this._hidden}set visible(e){super.visible=e,this.refresh()}refresh(){this.element.style.cursor=this.visible?this.style:"none"}};var mn=class extends Je{constructor(e){super(e);this.xr=e.cursor3D&&e.cursor3D.clone()||new qe(this.env),this.system=new dn(this.env.renderer.domElement),this.xr.side=this.side,this.visible=!1,Object.seal(this)}get object(){return this.xr.object}get side(){return this.xr.side}set side(e){this.xr.side=e}get cursor(){return this.xr}set cursor(e){this.xr=e,this._refresh()}get style(){return this.system.style}get visible(){return super.visible}set visible(e){super.visible=e,this._refresh()}set style(e){this.system.style=e,this.xr.style=e,this._refresh()}_refresh(){let e=this.env.eventSys&&this.env.eventSys.mouse&&this.env.eventSys.mouse.isPointerLocked,o=this.env.renderer.xr.isPresenting||e;De(this.xr,this.visible&&o),this.system.visible=this.visible&&!o}lookAt(e,o){this.xr.lookAt(e,o)}};var hn="Juniper:ThreeJS:EventSystem:RayTarget",Yo=class extends B{constructor(e){super();this.object=e;this.meshes=new Array;this._disabled=!1;this._clickable=!1;this._draggable=!1;this._navigable=!1;this.object.userData[hn]=this}addMesh(e){return e.userData[hn]=this,this.meshes.push(e),this}removeMesh(e){return Z(this.meshes,e)&&delete e.userData[hn],this}addMeshes(...e){for(let o of e)this.addMesh(o);return this}removeMeshes(...e){for(let o of e)this.removeMesh(o);return this}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get enabled(){return!this.disabled}set enabled(e){this.disabled=!e}get clickable(){return this._clickable}set clickable(e){this._clickable=e}get draggable(){return this._draggable}set draggable(e){this._draggable=e}get navigable(){return this._navigable}set navigable(e){this._navigable=e}};function qc(n){return n instanceof Yo}function Zo(n){let t=null;return n&&(qc(n)?t=n:(n=Se(n),n&&(t=n.userData[hn])),t&&!rn(t)&&(t=null)),t}var gn=class extends T{constructor(e,o){super(e);this.pointer=o;this._hit=null;this._point=null;this._distance=Number.POSITIVE_INFINITY;this._rayTarget=null;Object.seal(this)}set(e,o){e!==this.hit&&(this._hit=e,e?(this._point=e.point,this._distance=e.distance):(this._point=null,this._distance=Number.POSITIVE_INFINITY)),this._rayTarget=o}get hit(){return this._hit}get rayTarget(){return this._rayTarget}get point(){return this._point}get distance(){return this._distance}};var Kc=5,$c=new w,xn=class extends B{constructor(e,o,r,i){super();this.type=e;this.id=o;this.env=r;this.origin=new w;this.direction=new w;this.up=new w(0,1,0);this.canMoveView=!1;this.mayTeleport=!1;this.buttons=0;this._isActive=!1;this.moveDistance=0;this.pointerEvents=new Map;this.lastButtons=0;this.canClick=!1;this.dragDistance=0;this._enabled=!1;this._cursor=null;this._curHit=null;this._curTarget=null;this._hoveredHit=null;this._hoveredTarget=null;this._cursor=i,this.cursor&&(this.cursor.visible=!1)}get isActive(){return this._isActive}get canSend(){return this.enabled&&this.isActive}get curHit(){return this._curHit}get curTarget(){return this._curTarget}get hoveredHit(){return this._hoveredHit}set hoveredHit(e){if(e!==this.hoveredHit){let o=Zo(e);this._hoveredHit=e,this._hoveredTarget=o}}get name(){return bt[this.id]}get rayTarget(){return this._hoveredTarget}get cursor(){return this._cursor}set cursor(e){if(e!==this.cursor){let o=this.cursor,r=this.cursor&&this.cursor.object&&this.cursor.object.name||"cursor",i=o&&o.object&&o.object.parent;i&&o.object.removeFromParent(),e&&(e.object.name=r,o instanceof mn?(o.cursor=e,i&&k(i,o)):(this._cursor=e,o&&(i&&k(i,e),e.style=o.style,e.visible=o.visible)))}}get needsUpdate(){return this.enabled&&this._isActive}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.cursor&&(this.cursor.visible=e)}setButton(e,o){this.lastButtons=this.buttons;let r=1<<e;if(o?this.buttons|=r:this.buttons&=~r,o)this.canClick=!0,this.dragDistance=0,this.env.avatar.setMode(this),this.setEventState("down");else{if(this.canClick){let i=this.buttons;this.buttons=this.lastButtons,this.setEventState("click"),this.buttons=i}this.setEventState("up")}}isPressed(e){let o=1<<e;return(this.buttons&o)!==0}wasPressed(e){let o=1<<e;return(this.lastButtons&o)!==0}fireRay(e,o){let r=this.env.eventSys.fireRay(e,o);if(r!==this.curHit){let i=Zo(r);this._curHit=r,this._curTarget=i}}getEvent(e){this.pointerEvents.has(e)||this.pointerEvents.set(e,new gn(e,this));let o=this.pointerEvents.get(e);if(this.hoveredHit?o.set(this.hoveredHit,this.rayTarget):this.curHit?o.set(this.curHit,this.curTarget):o.set(null,null),o.hit){let r=this.curHit||this.hoveredHit;r&&o.hit!==r&&(o.hit.uv=r.uv)}return o}update(){this.needsUpdate&&this.onUpdate()}onUpdate(){this.updatePointerOrientation();let e=this.isPressed(0);(this.moveDistance>0||e)&&(e&&(this.dragDistance+=this.moveDistance,this.dragDistance>Kc&&(this.canClick=!1)),this.setEventState("move")),this.moveDistance=0}setEventState(e){if(this.fireRay(this.origin,this.direction),this.curTarget===this.rayTarget)this.hoveredHit=this.curHit;else{let r=this.isPressed(0),i=this.wasPressed(0);if(e==="move"&&!r||e==="down"&&r&&!i||e==="up"&&!r&&i){if(this.rayTarget){let u=this.getEvent("up");this.rayTarget.dispatchEvent(u);let p=this.getEvent("exit");this.dispatchEvent(p),this.rayTarget.dispatchEvent(p)}if(this.hoveredHit=this.curHit,this.rayTarget){let u=this.getEvent("enter");this.dispatchEvent(u),this.rayTarget.dispatchEvent(u)}}this.hoveredHit&&this.hoveredHit.point.copy(this.direction).multiplyScalar(this.hoveredHit.distance).add(this.origin)}let o=this.getEvent(e);this.dispatchEvent(o),o.rayTarget&&(e!=="click"||o.rayTarget.clickable||o.rayTarget.navigable)&&(e==="click"&&o.rayTarget.clickable&&this.vibrate(),o.rayTarget.enabled&&o.rayTarget.dispatchEvent(o)),this.updateCursor(this.env.avatar.worldPos,$c,!0,2)}get canDragView(){return this.canMoveView}get canTeleport(){return this.mayTeleport}updateCursor(e,o,r,i){this.cursor&&this.cursor.update(e,o,this.hoveredHit||this.curHit,this.rayTarget||this.curTarget,i,r,this.canDragView,this.canTeleport,this.origin,this.direction,this.isPressed(0))}get bufferSize(){return 37}writeState(e){e.writeUint8(this.id),e.writeVector48(this.origin),e.writeVector48(this.direction),e.writeVector48(this.up)}};var Ra=.2,Qc=.5*Ra-.025,Ba=.05,Fn=class extends xn{constructor(e,o,r){let i=o.cursor3D&&o.cursor3D.clone()||new qe(o);super("remote",9,o,i);this.avatar=e;this.remoteID=r;this.laser=null;this.D=new w;this.P=new w;this.visualOffset=new w;this.M=new K;this.MW=new K;this.originTarget=new w;this.directionTarget=new w;this.upTarget=new w;this.visualOffsetTarget=new w;this._hand=null;this.killTimeout=null;this.remoteType=La(this.remoteID),this.object=Ge(`remote:${this.avatar.userName}:${this.name}`,this.laser=new ln(this.avatar.isInstructor?Ko:_a,this.avatar.isInstructor?1:.5,.002),this.handCube=new G(Ba,Ba,Ra,ba)),this.cursor.object.name=`${this.object.name}:cursor`,this.cursor.visible=!0,this.handCube.position.set(0,0,-Qc),this.laser.length=30,Object.seal(this)}get hand(){return this._hand}set hand(e){e!==this.hand&&(this.hand&&(this.hand.removeFromParent(),ue(this.hand)),this._hand=e,this.hand?(this.handCube.removeFromParent(),k(this.avatar.stage,this.hand)):k(this.avatar.stage,this.handCube))}readState(e){if(e.readVector48(this.originTarget),e.readVector48(this.directionTarget),e.readVector48(this.upTarget),this.remoteID===1||this.remoteID===3?this.visualOffsetTarget.set(.25,-.55,.05).applyQuaternion(this.avatar.bodyQuaternion):this.visualOffsetTarget.setScalar(0),this.visualOffsetTarget.add(this.avatar.comfortOffset),5<=this.remoteID&&this.remoteID<=7){let o=e.readEnum8(Pa),r=e.readUint8();if(r===0)this.hand&&(this.hand=null);else{this.hand||(this.hand=this.env.handModelFactory.createHandModel(o)),this.hand.count=r;for(let i=0;i<r;++i)e.readMatrix512(this.M),this.hand.setMatrixAt(i,this.M);this.hand.updateMesh(),this.deferExecution(1,()=>this.hand=null)}}}deferExecution(e,o){this.killTimeout!==null&&(clearTimeout(this.killTimeout),this.killTimeout=null),this.killTimeout=setTimeout(()=>{this.killTimeout=null,o()},e*1e3)}writeState(e){}onUpdate(){}animate(e){let o=e*.01;this.origin.lerp(this.originTarget,o),this.direction.lerp(this.directionTarget,o).normalize(),this.up.lerp(this.upTarget,o).normalize(),this.visualOffset.lerp(this.visualOffsetTarget,o),this.cursor.visible=this.env.avatar.worldPos.distanceTo(this.origin)<10,this.cursor.visible&&(this.fireRay(this.origin,this.direction),this.updateCursor(this.avatar.worldPos,this.avatar.comfortOffset,!1,4)),this.P.copy(this.origin).add(this.visualOffset),this.cursor.visible?(this.cursor.object.getWorldPosition(this.D).sub(this.P),this.laser.length=this.D.length()-.1,this.D.normalize()):(this.D.copy(this.direction),this.laser.length=10),cn(this.up,this.D,this.P,this.MW),this.M.copy(this.object.parent.matrixWorld).invert().multiply(this.MW).decompose(this.object.position,this.object.quaternion,this.object.scale)}updatePointerOrientation(){}vibrate(){}};var Va=304.79999999999995,a1=Va*3,Yc=10*100,Zc=Va*16.5,eu=Zc*40,s1=Yc*1e3,c1=eu*8,Ia=2.54*4,Wa=Ia*3,u1=Wa*3,tu=Wa*16.5,nu=tu*40,p1=100*1e3,l1=nu*8,er=4*3,ou=er*3,At=100/2.54,ru=er*16.5,iu=ru*40,d1=At*1e3,m1=iu*8,h1=3*3,au=100/Ia,su=3*16.5,cu=su*40,g1=au*1e3,x1=cu*8,Ha=At/er,uu=16.5*40,F1=Ha*1e3,w1=uu*8,pu=At/ou,lu=16.5/3,du=lu*40,f1=pu*1e3,S1=du*8,Oa=16.5/Ha,Na=Oa*40,_1=Na*8,T1=1e3/Oa,k1=40*8,mu=1e3/Na,v1=8/mu;function ja(n){return n/At}function Ua(n){return n*At}var hu=new K,wn=new w,Ga=new Ce,Xa=new ee;function tr(n,t,e){return hu.copy(n.matrixWorld).invert().multiply(t.matrixWorld).decompose(wn,Xa,e),Ga.set(wn.x,wn.y,wn.z,1),new XRRigidTransform(Ga,Xa)}var nr=new zi(1,1,1,1);nr.name="PlaneGeom";var Ke=new w,gu=0,$e=class extends U{constructor(e,o,r,i=null){super();this.webXRLayerType=r;this.lastMatrixWorld=new K;this._imageWidth=0;this._imageHeight=0;this.forceUpdate=!1;this.wasUsingLayer=!1;this.layer=null;this.curImage=null;this.lastImage=null;this.lastWidth=null;this.lastHeight=null;this.env=null;this.mesh=null;this.stereoLayoutName="mono";this.sizeMode="none";if(e){this.setEnvAndName(e,o);let a=ua(i)?i:Fa(Object.assign({},i,{name:this.name}));k(this,this.mesh=da(o+"-Mesh",nr,a))}}copy(e,o=!0){return super.copy(e,o),this.webXRLayerType=e.webXRLayerType,this.setImageSize(e.imageWidth,e.imageHeight),this.setEnvAndName(e.env,e.name+ ++gu),this.mesh=pt(this.children,Me),E(this.mesh)&&(this.mesh=e.mesh.clone(),k(this,this.mesh)),this.setTextureMap(e.curImage),this}dispose(){this.env.removeScope(this),this.disposeImage(),ue(this.mesh)}disposeImage(){this.removeWebXRLayer(),ue(this.mesh.material.map),this.curImage=null}setImageSize(e,o){if(e!==this.imageWidth||o!==this.imageHeight){let{objectWidth:r,objectHeight:i}=this;this._imageWidth=e,this._imageHeight=o,this.sizeMode!=="none"&&(this.sizeMode==="fixed-width"?this.objectWidth=r:this.objectHeight=i)}}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get imageAspectRatio(){return this.imageWidth/this.imageHeight}get objectWidth(){return this.scale.x}set objectWidth(e){this.scale.set(e,this.scale.y=e/this.imageAspectRatio,1)}get objectHeight(){return this.scale.y}set objectHeight(e){this.scale.set(this.imageAspectRatio*e,e,1)}get pixelDensity(){let e=Ua(this.objectWidth);return this.imageWidth/e}set pixelDensity(e){let o=this.imageWidth/e,r=ja(o);this.objectWidth=r}setEnvAndName(e,o){this.env=e,this.name=o,this.env.addScopedEventListener(this,"update",r=>this.checkWebXRLayer(r.frame))}get needsLayer(){return!rn(this)||E(this.mesh.material.map)||E(this.curImage)?!1:this.curImage instanceof HTMLVideoElement?!this.curImage.paused||this.curImage.currentTime>0:!0}removeWebXRLayer(){if(g(this.layer)){this.wasUsingLayer=!1,this.env.removeWebXRLayer(this.layer),this.mesh.visible=!0;let e=this.layer;this.layer=null,setTimeout(()=>Ue(e),100)}}setTextureMap(e){this.curImage&&this.disposeImage(),e&&(ta(e)?e=aa(e):na(e)&&(e=sa(e)),jo(e)&&(e=e),this.curImage=e,e instanceof HTMLVideoElement?(this.setImageSize(e.videoWidth,e.videoHeight),this.mesh.material.map=new $i(e)):(this.setImageSize(e.width,e.height),this.mesh.material.map=new qi(e),this.mesh.material.map.needsUpdate=!0)),this.mesh.material.needsUpdate=!0}get isVideo(){return this.curImage instanceof HTMLVideoElement}updateTexture(){if(g(this.curImage)){let e=this.curImage,o=this.isVideo?e.videoWidth:this.curImage.width,r=this.isVideo?e.videoHeight:this.curImage.height;if(this.imageWidth!==o||this.imageHeight!==r){let i=this.curImage;this.disposeImage(),this.setTextureMap(i)}else this.mesh.material.map.needsUpdate=this.forceUpdate=!0}}checkWebXRLayer(e){if(this.mesh.material.map&&this.curImage){let r=this.webXRLayerType!=="none"&&this.env.hasXRCompositionLayers&&this.env.showWebXRLayers&&g(e)&&(this.isVideo&&g(this.env.xrMediaBinding)||!this.isVideo&&g(this.env.xrBinding))&&this.needsLayer,i=r!==this.wasUsingLayer,a=this.curImage!==this.lastImage||this.mesh.material.needsUpdate||this.mesh.material.map.needsUpdate||this.forceUpdate,s=this.imageWidth!==this.lastWidth||this.imageHeight!==this.lastHeight;if(this.wasUsingLayer=r,this.lastImage=this.curImage,this.lastWidth=this.imageWidth,this.lastHeight=this.imageHeight,(i||s)&&((!r||s)&&this.layer&&this.removeWebXRLayer(),r)){let c=this.env.referenceSpace,u=tr(this.env.stage,this.mesh,Ke);this.lastMatrixWorld.copy(this.matrixWorld);let p=Ke.x/2,l=Ke.y/2,h=this.stereoLayoutName==="mono"?"mono":this.stereoLayoutName==="left-right"||this.stereoLayoutName==="right-left"?"stereo-left-right":"stereo-top-bottom";if(this.isVideo){let x=this.stereoLayoutName==="right-left"||this.stereoLayoutName==="bottom-top";this.layer=this.env.xrMediaBinding.createQuadLayer(this.curImage,{space:c,layout:h,invertStereo:x,transform:u,width:p,height:l})}else this.layer=this.env.xrBinding.createQuadLayer({space:c,layout:h,textureType:"texture",isStatic:this.webXRLayerType==="static",viewPixelWidth:this.curImage.width,viewPixelHeight:this.curImage.height,transform:u,width:p,height:l});this.env.addWebXRLayer(this.layer,500),this.mesh.visible=!1}if(this.layer){if(a||this.layer.needsRedraw){let c=this.env.gl,u=this.env.xrBinding.getSubImage(this.layer,e);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.bindTexture(c.TEXTURE_2D,u.colorTexture),c.texSubImage2D(c.TEXTURE_2D,0,0,0,c.RGBA,c.UNSIGNED_BYTE,this.curImage),c.generateMipmap(c.TEXTURE_2D),c.bindTexture(c.TEXTURE_2D,null),this.forceUpdate=!1}si(this.matrixWorld.elements,this.lastMatrixWorld.elements)>=0&&(this.layer.transform=tr(this.env.stage,this.mesh,Ke),this.lastMatrixWorld.copy(this.matrixWorld),this.layer.width=Ke.x/2,this.layer.height=Ke.y/2)}else this.forceUpdate=!1}}};var $1=fe("juniper::loadedFonts",()=>[]);function za(n){let t=[];return n.fontStyle&&n.fontStyle!=="normal"&&t.push(n.fontStyle),n.fontVariant&&n.fontVariant!=="normal"&&t.push(n.fontVariant),n.fontWeight&&n.fontWeight!=="normal"&&t.push(n.fontWeight),t.push(Li(n.fontSize)),t.push(n.fontFamily),t.join(" ")}var fn=class extends B{constructor(e,o,r){super();this._scale=250;this._visible=!0;this.wasVisible=null;this.redrawnEvt=new T("redrawn");this.element=null;g(r)&&g(r.scale)&&(this._scale=r.scale),this._canvas=ia(e,o),this._g=this.canvas.getContext("2d"),St(this._canvas)&&(this.element=this._canvas)}fillRect(e,o,r,i,a,s){this.g.fillStyle=e,this.g.fillRect(o+s,r+s,i-2*s,a-2*s)}drawText(e,o,r,i){this.g.textAlign=i,this.g.strokeText(e,o,r),this.g.fillText(e,o,r)}redraw(){(this.visible||this.wasVisible)&&this.onRedraw()&&(this.wasVisible=this.visible,this.dispatchEvent(this.redrawnEvt))}onClear(){this.g.clearRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.onClear(),this.dispatchEvent(this.redrawnEvt)}get canvas(){return this._canvas}get g(){return this._g}get imageWidth(){return this.canvas.width}get imageHeight(){return this.canvas.height}get aspectRatio(){return this.imageWidth/this.imageHeight}get width(){return this.imageWidth/this.scale}get height(){return this.imageHeight/this.scale}get scale(){return this._scale}set scale(e){this.scale!==e&&(this._scale=e,this.redraw())}get visible(){return this._visible}set visible(e){this.visible!==e&&(this.wasVisible=this._visible,this._visible=e,this.redraw())}};var Et=class extends fn{constructor(e){super(10,10,e);this.trueWidth=null;this.trueHeight=null;this.trueFontSize=null;this.dx=null;this._minWidth=null;this._maxWidth=null;this._minHeight=null;this._maxHeight=null;this._freezeDimensions=!1;this._dimensionsFrozen=!1;this._bgFillColor=null;this._bgStrokeColor=null;this._bgStrokeSize=null;this._textStrokeColor=null;this._textStrokeSize=null;this._textFillColor="black";this._textDirection="horizontal";this._fontStyle="normal";this._fontVariant="normal";this._fontWeight="normal";this._fontFamily="sans-serif";this._fontSize=20;this._value=null;this.lastValue=null;g(e)&&(g(e.minWidth)&&(this._minWidth=e.minWidth),g(e.maxWidth)&&(this._maxWidth=e.maxWidth),g(e.minHeight)&&(this._minHeight=e.minHeight),g(e.maxHeight)&&(this._maxHeight=e.maxHeight),g(e.freezeDimensions)&&(this._freezeDimensions=e.freezeDimensions),g(e.textStrokeColor)&&(this._textStrokeColor=e.textStrokeColor),g(e.textStrokeSize)&&(this._textStrokeSize=e.textStrokeSize),g(e.bgFillColor)&&(this._bgFillColor=e.bgFillColor),g(e.bgStrokeColor)&&(this._bgStrokeColor=e.bgStrokeColor),g(e.bgStrokeSize)&&(this._bgStrokeSize=e.bgStrokeSize),g(e.value)&&(this._value=e.value),g(e.textFillColor)&&(this._textFillColor=e.textFillColor),g(e.textDirection)&&(this._textDirection=e.textDirection),g(e.fontStyle)&&(this._fontStyle=e.fontStyle),g(e.fontVariant)&&(this._fontVariant=e.fontVariant),g(e.fontWeight)&&(this._fontWeight=e.fontWeight),g(e.fontFamily)&&(this._fontFamily=e.fontFamily),g(e.fontSize)&&(this._fontSize=e.fontSize),g(e.padding)&&(Y(e.padding)?this._padding={left:e.padding,right:e.padding,top:e.padding,bottom:e.padding}:this._padding=e.padding)),E(this._padding)&&(this._padding={top:0,right:0,bottom:0,left:0}),this.redraw()}get minWidth(){return this._minWidth}set minWidth(e){this.minWidth!==e&&(this._minWidth=e,this.redraw())}get maxWidth(){return this._maxWidth}set maxWidth(e){this.maxWidth!==e&&(this._maxWidth=e,this.redraw())}get minHeight(){return this._minHeight}set minHeight(e){this.minHeight!==e&&(this._minHeight=e,this.redraw())}get maxHeight(){return this._maxHeight}set maxHeight(e){this.maxHeight!==e&&(this._maxHeight=e,this.redraw())}get padding(){return this._padding}set padding(e){if(e instanceof Array)throw new Error("Invalid padding");(this.padding.top!==e.top||this.padding.right!=e.right||this.padding.bottom!=e.bottom||this.padding.left!=e.left)&&(this._padding=e,this.redraw())}get textDirection(){return this._textDirection}set textDirection(e){this.textDirection!==e&&(this._textDirection=e,this.redraw())}get fontStyle(){return this._fontStyle}set fontStyle(e){this.fontStyle!==e&&(this._fontStyle=e,this.redraw())}get fontVariant(){return this._fontVariant}set fontVariant(e){this.fontVariant!==e&&(this._fontVariant=e,this.redraw())}get fontWeight(){return this._fontWeight}set fontWeight(e){this.fontWeight!==e&&(this._fontWeight=e,this.redraw())}get fontSize(){return this._fontSize}set fontSize(e){this.fontSize!==e&&(this._fontSize=e,this.redraw())}get fontFamily(){return this._fontFamily}set fontFamily(e){this.fontFamily!==e&&(this._fontFamily=e,this.redraw())}get textFillColor(){return this._textFillColor}set textFillColor(e){this.textFillColor!==e&&(this._textFillColor=e,this.redraw())}get textStrokeColor(){return this._textStrokeColor}set textStrokeColor(e){this.textStrokeColor!==e&&(this._textStrokeColor=e,this.redraw())}get textStrokeSize(){return this._textStrokeSize}set textStrokeSize(e){this.textStrokeSize!==e&&(this._textStrokeSize=e,this.redraw())}get bgFillColor(){return this._bgFillColor}set bgFillColor(e){this.bgFillColor!==e&&(this._bgFillColor=e,this.redraw())}get bgStrokeColor(){return this._bgStrokeColor}set bgStrokeColor(e){this.bgStrokeColor!==e&&(this._bgStrokeColor=e,this.redraw())}get bgStrokeSize(){return this._bgStrokeSize}set bgStrokeSize(e){this.bgStrokeSize!==e&&(this._bgStrokeSize=e,this.redraw())}get value(){return this._value}set value(e){this.value!==e&&(this._value=e,this.redraw())}split(e){return e.replace(/\r\n/g,`
`).split(`
`)}unfreeze(){this._dimensionsFrozen=!1}onRedraw(){if(this.onClear(),this.visible&&this.fontFamily&&this.fontSize&&(this.textFillColor||this.textStrokeColor&&this.textStrokeSize)&&this.value&&this.value!==this.lastValue){let e=this.split(this.value),o=this.textDirection&&this.textDirection.indexOf("vertical")===0;if(this.trueWidth===null||this.trueHeight===null||this.dx===null||this.trueFontSize===null||!this._dimensionsFrozen){this._dimensionsFrozen=this._freezeDimensions;let i=this.minWidth!=null||this.maxWidth!=null||this.minHeight!=null||this.maxHeight!=null,a=((this.minWidth||0)-this.padding.right-this.padding.left)*this.scale,s=((this.maxWidth||4096)-this.padding.right-this.padding.left)*this.scale,c=((this.minHeight||0)-this.padding.top-this.padding.bottom)*this.scale,u=((this.maxHeight||4096)-this.padding.top-this.padding.bottom)*this.scale,p=o?c:a,l=o?u:s,h=o?a:c,x=o?s:u,F=[];this.trueWidth=0,this.trueHeight=0,this.dx=0;let f=!1,M=!1,ve=1e4,j=0;this.trueFontSize=Si(this.fontSize*this.scale,j,ve);let be=null,O=Number.MAX_VALUE;do{let C=this.fontSize;this._fontSize=this.trueFontSize;let Q=za(this);this._fontSize=C,this.g.textAlign="center",this.g.textBaseline="middle",this.g.font=Q,this.trueWidth=0,this.trueHeight=0;for(let J of e){let A=this.g.measureText(J);this.trueWidth=Math.max(this.trueWidth,A.width),this.trueHeight+=this.trueFontSize,Y(A.actualBoundingBoxLeft)&&Y(A.actualBoundingBoxRight)&&Y(A.actualBoundingBoxAscent)&&Y(A.actualBoundingBoxDescent)&&(i||(this.trueWidth=A.actualBoundingBoxLeft+A.actualBoundingBoxRight,this.trueHeight=A.actualBoundingBoxAscent+A.actualBoundingBoxDescent,this.dx=(A.actualBoundingBoxLeft-this.trueWidth/2)/2))}if(i){let J=this.trueWidth-p,A=this.trueWidth-l,N=this.trueHeight-h,Yr=this.trueHeight-x,ds=Math.abs(J),ms=Math.abs(A),hs=Math.abs(N),gs=Math.abs(Yr);f=A>1||Yr>1,M=J<-1&&N<-1;let Zr=Math.min(ds,Math.min(ms,Math.min(hs,gs)));Zr<O&&(O=Zr,be=this.g.font),(f||M)&&F.indexOf(this.g.font)>-1&&be&&(this.g.font=be,f=!1,M=!1),f?(ve=this.trueFontSize,this.trueFontSize=(j+this.trueFontSize)/2):M&&(j=this.trueFontSize,this.trueFontSize=(this.trueFontSize+ve)/2)}F.push(this.g.font)}while(f||M);i&&(this.trueWidth<p?this.trueWidth=p:this.trueWidth>l&&(this.trueWidth=l),this.trueHeight<h?this.trueHeight=h:this.trueHeight>x&&(this.trueHeight=x));let Ie=this.trueWidth+this.scale*(this.padding.right+this.padding.left),L=this.trueHeight+this.scale*(this.padding.top+this.padding.bottom);try{zo(this.g,Ie,L)}catch(C){throw console.error(C),C}}this.bgFillColor?(this.g.fillStyle=this.bgFillColor,this.g.fillRect(0,0,this.canvas.width,this.canvas.height)):this.g.clearRect(0,0,this.canvas.width,this.canvas.height),this.textStrokeColor&&this.textStrokeSize&&(this.g.lineWidth=this.textStrokeSize*this.scale,this.g.strokeStyle=this.textStrokeColor),this.textFillColor&&(this.g.fillStyle=this.textFillColor);let r=.5*(e.length-1);for(let i=0;i<e.length;++i){let a=e[i],s=(i-r)*this.trueFontSize,c=this.dx+this.trueWidth/2+this.scale*this.padding.left,u=s+this.trueHeight/2+this.scale*this.padding.top;this.textStrokeColor&&this.textStrokeSize&&this.g.strokeText(a,c,u),this.textFillColor&&this.g.fillText(a,c,u)}if(this.bgStrokeColor&&this.bgStrokeSize){this.g.strokeStyle=this.bgStrokeColor,this.g.lineWidth=this.bgStrokeSize*this.scale;let i=this.bgStrokeSize/2;this.g.strokeRect(i,i,this.canvas.width-this.bgStrokeSize,this.canvas.height-this.bgStrokeSize)}if(o){let i=Go(this.canvas.height,this.canvas.width),a=i.getContext("2d");a?(a.translate(i.width/2,i.height/2),this.textDirection==="vertical"||this.textDirection==="vertical-left"?a.rotate(mt):this.textDirection==="vertical-right"&&a.rotate(-mt),a.translate(-this.canvas.width/2,-this.canvas.height/2),a.drawImage(this.canvas,0,0),zo(this.g,i.width,i.height)):console.warn("Couldn't rotate the TextImage"),this.g.drawImage(i,0,0)}return this.lastValue=this.value,!0}else{let e=this.value!==this.lastValue;return this.lastValue=this.value,e}}};var xu={type:"redrawn"},Sn=class extends $e{constructor(e,o,r,i,a){super(e,o,r,a);this._image=null;this.image=i}get object(){return this}get element(){return St(this.image.canvas)?this.image.canvas:null}onRedrawn(){this.updateTexture(),this.dispatchEvent(xu)}get image(){return this._image}set image(e){this.image&&this.image.removeScope(this),this._image=e,this.image&&(this.image.addScopedEventListener(this,"redrawn",()=>this.onRedrawn()),this.setTextureMap(this.image.canvas),this.onRedrawn())}get imageWidth(){return this.image.width}get imageHeight(){return this.image.height}copy(e,o=!0){return super.copy(e,o),this.image=e.image,this}get isVisible(){return Vi(this)}set isVisible(e){Pi(this,e,"inline-block"),De(this,e),De(this.mesh,e),this.image.visible=e}};var Ct=class extends Sn{constructor(t,e,o,r,i){let a;r instanceof Et?a=r:a=new Et(r),super(t,e,o,a,i)}onRedrawn(){this.objectHeight=this.imageHeight,super.onRedrawn()}};var Ja={fontFamily:Bi(),fontSize:20,fontWeight:"bold",textFillColor:"white",textStrokeColor:"black",textStrokeSize:.01,padding:{top:.025,right:.05,bottom:.025,left:.05},maxHeight:.2},_n=class{constructor(t,e,o,r,i,a){this.env=t;this.avatar=r;this.defaultAvatarHeight=i;this._isInstructor=!1;this.pointers=new Map;this.stage=new U;this.stagePositionTarget=new w;this.stageOrientationTarget=new ee().identity();this.headPositionTarget=new w;this.headOrientationTarget=new ee().identity();this.worldPos=new w;this.worldQuat=new ee;this.F=new w;this.M=new K;this._headSize=1;this._headPulse=1;this.comfortOffset=new w;this.videoElement=null;this.videoMesh=null;this._videoStream=null;this.clearChatTimer=null;if(this.height=this.defaultAvatarHeight,E(r))throw new Error("Avatar is required");this.avatar=r;let s=[this.avatar];for(;s.length>0;){let u=s.shift();if(u.name==="Head"?this.head=u:u.name==="Body"&&(this.body=u),this.head&&this.body)break;s.push(...u.children)}if(!this.head||!this.body)throw new Error("Avatar doesn't have a Head or Body element");this.userID=e.userID,this.avatar.name=e.userName,this.billboard=Ge("billboard"),this.nameTag=new Ct(this.env,`nameTag-${e.userName}-${e.userID}`,"none",Object.assign({},Ja,a)),this.nameTag.position.y=-.25,this.userName=e.userName,this.chatBox=new Ct(this.env,`chat-${e.userName}-${e.userID}`,"none",Object.assign({},Ja,a)),this.chatBox.position.y=-.4,e.addEventListener("chat",u=>this.chatText=u.text);let c=new je;e.addEventListener("userState",u=>{c.buffer=u.buffer,this.readState(c)}),e.addEventListener("chat",u=>{this.chatText=u.text}),this.activity=new He(this.env.audio.context),this.activity.name=`remote-user-activity-${e.userName}-${e.userID}`,o.addEventListener("sourceadded",u=>{u.source.connect(this.activity),u.source.name=`remote-user-stream-${e.userName}-${e.userID}`}),this.headFollower=new tn("AvatarBody",.05,mt,0,5),k(this.avatar,this.stage,k(this.headFollower,k(this.body,k(this.billboard,this.nameTag,this.chatBox)))),this.activity.addEventListener("activity",u=>{this.headPulse=.2*u.level+1}),this.activity.start()}get object(){return this.avatar}get bodyQuaternion(){return this.headFollower.quaternion}get audioStream(){let t=this.env.audio.getUser(this.userID);return t&&t.stream||null}set audioStream(t){this.env.audio.setUserStream(this.userID,t)}get videoStream(){return this._videoStream}set videoStream(t){t!==this.videoStream&&(this.videoMesh&&(this.videoMesh.removeFromParent(),ue(this.videoMesh),this.videoMesh=null),this.videoElement&&(this.videoElement.pause(),this.videoElement=null),this._videoStream=t,this.videoStream&&(this.videoElement=Hi(Di(this.videoStream),Ci(!0)),this.videoElement.play(),this.videoMesh=new $e(this.env,`webcam-${this.userID}`,"none",{side:ji}),this.videoMesh.sizeMode="fixed-height",this.videoMesh.scale.setScalar(.25),this.videoMesh.position.z=.25,this.videoMesh.setTextureMap(this.videoElement)))}dispose(){for(let t of this.pointers.keys())this.removePointer(t);this.activity.stop(),W(this.activity)}get isInstructor(){return this._isInstructor}get headSize(){return this._headSize}set headSize(t){this._headSize=t,this.refreshHead()}get headPulse(){return this._headPulse}set headPulse(t){this._headPulse=t,this.refreshHead()}refreshHead(){this.head&&this.head.scale.setScalar(this.headSize*this.headPulse)}get userName(){return this.nameTag.image.value}set userName(t){if(t){let e=t.match(/^(?:((?:student|instructor))_)?([^<>{}"]+)$/i);e&&(e.length===2?this.nameTag.image.value=e[1]:e.length===3?(this._isInstructor=e[1]&&e[1].toLocaleLowerCase()==="instructor",this.isInstructor?this.nameTag.image.value=Oi.value+e[2]:this.nameTag.image.value=e[2]):this.nameTag.image.value="???")}}get chatText(){return this.chatBox.image.value}set chatText(t){this.chatBox.image.value=t||"",this.clearChatTimer!==null&&(clearTimeout(this.clearChatTimer),this.clearChatTimer=null),t&&t.length>0&&(this.clearChatTimer=setTimeout(()=>{this.chatText=null},3e3))}refreshCursors(){for(let t of this.pointers.values())t.cursor&&(t.cursor=this.env.cursor3D.clone())}update(t){let e=t*.01;this.stage.position.lerp(this.stagePositionTarget,e),this.stage.quaternion.slerp(this.stageOrientationTarget,e),this.head.position.lerp(this.headPositionTarget,e),this.head.quaternion.slerp(this.headOrientationTarget,e),this.head.getWorldPosition(this.worldPos),this.head.getWorldQuaternion(this.worldQuat),this.F.fromArray(wi).applyQuaternion(this.worldQuat);let o=Yt(this.F);this.env.audio.setUserPose(this.userID,this.worldPos.x,this.worldPos.y,this.worldPos.z,this.worldQuat.x,this.worldQuat.y,this.worldQuat.z,this.worldQuat.w),this.headFollower.update(this.worldPos.y-this.avatar.parent.position.y,this.worldPos,o,t);let r=this.height/this.defaultAvatarHeight;this.headSize=r,this.body.scale.setScalar(r),this.F.copy(this.env.avatar.worldPos),this.body.worldToLocal(this.F),this.F.sub(this.body.position).normalize().multiplyScalar(.25),this.billboard.position.copy(this.F);for(let i of this.pointers.values())i.animate(t);this.billboard.lookAt(this.env.avatar.worldPos),this.videoMesh&&(this.videoStream&&!this.videoStream.active&&this.videoMesh.parent&&(this.videoStream=null),this.videoStream&&this.videoStream.active&&this.videoElement.videoWidth>0&&!this.videoMesh.parent&&this.billboard.add(this.videoMesh),this.videoMesh&&this.videoMesh.updateTexture())}assurePointer(t){let e=this.pointers.get(t);return e||(e=new Fn(this,this.env,t),this.pointers.set(t,e),k(this.body,e),e.cursor&&k(this.env.stage,e.cursor),t===6||t===7?this.removePointersExcept(6,7):this.removePointersExcept(t)),e.deferExecution(3,()=>this.removePointer(t)),e}removePointersExcept(...t){for(let e of this.pointers.keys())t.indexOf(e)===-1&&this.removePointer(e)}removePointer(t){let e=this.pointers.get(t);e&&(e.object.removeFromParent(),this.pointers.delete(t),e.cursor&&e.cursor.object.removeFromParent())}readState(t){t.position=0,this.height=t.readFloat32(),t.readMatrix512(this.M),this.M.decompose(this.stagePositionTarget,this.stageOrientationTarget,this.stage.scale),this.stagePositionTarget.add(this.comfortOffset),t.readMatrix512(this.M),this.M.decompose(this.headPositionTarget,this.headOrientationTarget,this.avatar.scale),this.headPositionTarget.add(this.comfortOffset);let e=t.readUint8();for(let o=0;o<e;++o){let r=t.readUint8();this.assurePointer(r).readState(t)}}};var Tn=class extends U{constructor(e){super();this.color=e;this.center=null;g(this.color)&&(this.center=new G(.5,.5,.5,sn({color:this.color})),k(this,this.center)),this.xp=new G(1,.1,.1,va),this.yp=new G(.1,1,.1,ka),this.zn=new G(.1,.1,1,Ta),this.xp.position.x=1,this.yp.position.y=1,this.zn.position.z=-1,k(this,this.xp,this.yp,this.zn)}copy(e,o=!0){return super.copy(e,o),this.color=e.color,this.center=new G(.5,.5,.5,sn({color:e.color})),this}get size(){return this.xp.scale.x}set size(e){g(this.center)&&this.center.scale.setScalar(e),this.xp.scale.setScalar(.1*e),this.yp.scale.setScalar(.1*e),this.zn.scale.setScalar(.1*e),this.xp.scale.x=this.yp.scale.y=this.zn.scale.z=e,this.xp.position.x=this.yp.position.y=e,this.zn.position.z=-e}};var Qe=class extends T{constructor(e,o){super(e);this.app=o}},or=class extends Qe{constructor(e,o){super("joinroom",e);this.roomName=o}},rr=class extends Qe{constructor(t){super("quit",t)}},ir=class extends Qe{constructor(t){super("shown",t)}},ar=class extends Qe{constructor(t){super("hidden",t)}},kn=class extends B{constructor(e){super();this.env=e;this.dataLogger=null}quit(){this.dispatchEvent(new rr(this))}join(e){this.dispatchEvent(new or(this,e)),this.env.avatar.reset()}async show(e){await this.showing(e),this.dispatchEvent(new ir(this))}hide(){this.hiding(),this.dispatchEvent(new ar(this))}init(e){return this.dataLogger=e.get("dataLogger"),Promise.resolve()}log(e,o){g(this.dataLogger)&&this.dataLogger.log(e,o)}error(e,o,r){g(this.dataLogger)&&this.dataLogger.error(e,o,r)}onError(e,o){return this.error.bind(this,e,o)}};var Pa=["none","right","left"],vn=class extends kn{constructor(e){super(e);this.sortedUserIDs=new Array;this.avatars=new Map;this.remoteUsers=Ge("RemoteUsers");this.conference=null;this.avatarModel=null;this.avatarNameTagFont=null;this.userType=null;this.userName=null;this.meetingID=null;this.roomName=null;this._offsetRadius=0;this.doorOpenSound=new ut("/audio/door_open.mp3",Eo,!this.env.DEBUG),this.doorCloseSound=new ut("/audio/door_close.mp3",Eo,!this.env.DEBUG),this.avatarModelAsset=new jt(this.env,"/models/Avatar.glb",Ht,!this.env.DEBUG),this.assets=[this.doorOpenSound,this.doorCloseSound,this.avatarModelAsset],this.env.addScopedEventListener(this,"update",o=>{for(let r of this.avatars.values())r.update(o.dt)})}async init(e){if(this.avatarNameTagFont=e.get("nameTagFont"),!this.avatarNameTagFont)throw new Error("Missing nameTagFont parameter");this.env.addScopedEventListener(this,"newcursorloaded",()=>{for(let s of this.avatars.values())s.refreshCursors()}),this.env.addScopedEventListener(this,"roomjoined",s=>{this.join(s.roomName)}),this.env.addScopedEventListener(this,"sceneclearing",()=>this.hiding()),this.env.addScopedEventListener(this,"scenecleared",()=>k(this.env.foreground,this.remoteUsers)),this.env.muteMicButton.visible=!0,this.env.muteCamButton.visible=!0,this.remoteUsers.name="Remote Users",this.offsetRadius=1.25,this.conference=this.createConference();let o=33,r=0,i=new je;this.env.addScopedEventListener(this,"update",s=>{r+=s.dt,r>=o&&(r-=o,this.env.avatar.writeState(i),this.conference.sendUserState(i.buffer))});let a=s=>{Z(this.sortedUserIDs,this.env.avatar.name),this.env.avatar.name=s.userID,Do(this.sortedUserIDs,this.env.avatar.name),this.updateUserOffsets()};return this.conference.addScopedEventListener(this,"roomJoined",a),this.conference.addScopedEventListener(this,"roomLeft",a),this.conference.addScopedEventListener(this,"userJoined",s=>{let c=this.avatarModel?this.avatarModel.clone():new Tn(16776960),u=new _n(this.env,s.user,s.source,c,this.env.defaultAvatarHeight,this.avatarNameTagFont);u.userName=s.user.userName,this.avatars.set(s.user.userID,u),Do(this.sortedUserIDs,s.user.userID),k(this.remoteUsers,u),this.updateUserOffsets(),this.env.audio.playClip("join")}),this.conference.addScopedEventListener(this,"trackAdded",s=>{if(s.stream.getAudioTracks().length>0&&this.env.audio.setUserStream(s.user.userID,s.stream),s.stream.getVideoTracks().length>0){let c=this.avatars.get(s.user.userID);c&&(c.videoStream=s.stream)}}),this.conference.addScopedEventListener(this,"trackRemoved",s=>{if(s.stream.getAudioTracks().length>0&&this.env.audio.setUserStream(s.user.userID,null),s.stream.getVideoTracks().length>0){let c=this.avatars.get(s.user.userID);c&&(c.videoStream=null)}}),this.conference.addScopedEventListener(this,"userNameChanged",s=>{let c=this.avatars.get(s.user.userID);c&&(c.userName=s.newUserName)}),this.conference.addScopedEventListener(this,"userLeft",s=>{let c=this.avatars.get(s.user.userID);c&&(c.object.removeFromParent(),this.avatars.delete(s.user.userID),Z(this.sortedUserIDs,s.user.userID),ue(c),this.updateUserOffsets(),this.env.audio.playClip("leave"))}),this.env.speech&&this.env.speech.addScopedEventListener(this,"result",s=>{this.visible&&this.conference.sendChat(s.results)}),await super.init(e)}async load(e){await this.env.fetcher.assets(e,...this.assets),await ci(this.env.audio.createBasicClip("join",this.doorOpenSound,.25),this.env.audio.createBasicClip("leave",this.doorCloseSound,.25)),this.avatarModel=this.avatarModelAsset.result.scene.children[0],fa(this.avatarModel,Sa)}async showing(e){k(this.env.foreground,this.remoteUsers),g(this.env.currentRoom)&&await this.join(this.env.currentRoom)}dispose(){this.hiding(),this.env.speech&&this.env.speech.removeScope(this),this.env.avatar.removeScope(this),this.env.eventSys.removeScope(this),this.env.removeScope(this),this.conference.removeScope(this),W(this.conference)}hiding(){this.remoteUsers.removeFromParent()}get visible(){return g(this.remoteUsers.parent)}async setConferenceInfo(e,o,r){this.userType=e,this.userName=o,this.meetingID=r,await this.checkConference()}async join(e){this.roomName=e,await this.checkConference()}withUser(e,o){if(this.avatars.has(e)){let r=this.avatars.get(e);if(g(r))return o(r)}return null}get offsetRadius(){return this._offsetRadius}set offsetRadius(e){this._offsetRadius=e,this.updateUserOffsets()}updateUserOffsets(){if(this.offsetRadius>0){let e=this.sortedUserIDs.indexOf(this.env.avatar.name),o=ce/this.sortedUserIDs.length,r=(e+1)*o,i=this.offsetRadius*Math.sin(r),a=this.offsetRadius*(Math.cos(r)-1);for(let s=0;s<this.sortedUserIDs.length;++s){let c=this.sortedUserIDs[s],u=(s+1)*o,p=this.offsetRadius*Math.sin(u)-i,l=this.offsetRadius*(Math.cos(u)-1)-a;this.setUserOffset(c,p,0,l)}}}setUserOffset(e,o,r,i){this.withUser(e,a=>a.comfortOffset.set(o,r,i))}getUserOffset(e){return this.withUser(e,o=>o.comfortOffset)}async checkConference(){if(g(this.userType)&&g(this.userName)&&g(this.meetingID)&&g(this.roomName)){let e=`${this.roomName}_${this.meetingID}`.toLocaleLowerCase(),o=`${this.userType}_${this.userName}`;this.conference.roomName!==e&&(await this.conference.connect(),await this.conference.identify(o),await this.conference.join(e))}}};var bn=class extends B{constructor(){super();this.event=new T("quitting");let e=()=>this.dispatchEvent(this.event);window.addEventListener("beforeunload",e),window.addEventListener("unload",e),window.addEventListener("pagehide",e)}};var Ka=!0,$a=!0;function Mt(n,t,e){let o=n.match(t);return o&&o.length>=e&&parseInt(o[e],10)}function oe(n,t,e){if(!n.RTCPeerConnection)return;let o=n.RTCPeerConnection.prototype,r=o.addEventListener;o.addEventListener=function(a,s){if(a!==t)return r.apply(this,arguments);let c=u=>{let p=e(u);p&&(s.handleEvent?s.handleEvent(p):s(p))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(s,c),r.apply(this,[a,c])};let i=o.removeEventListener;o.removeEventListener=function(a,s){if(a!==t||!this._eventMap||!this._eventMap[t])return i.apply(this,arguments);if(!this._eventMap[t].has(s))return i.apply(this,arguments);let c=this._eventMap[t].get(s);return this._eventMap[t].delete(s),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,i.apply(this,[a,c])},Object.defineProperty(o,"on"+t,{get(){return this["_on"+t]},set(a){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),a&&this.addEventListener(t,this["_on"+t]=a)},enumerable:!0,configurable:!0})}function Qa(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Ka=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Ya(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):($a=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function An(){if(typeof window=="object"){if(Ka)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Ye(n,t){$a&&console.warn(n+" is deprecated, please use "+t+" instead.")}function Za(n){let t={browser:null,version:null};if(typeof n>"u"||!n.navigator)return t.browser="Not a browser.",t;let{navigator:e}=n;if(e.mozGetUserMedia)t.browser="firefox",t.version=Mt(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)t.browser="chrome",t.version=Mt(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=Mt(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function qa(n){return Object.prototype.toString.call(n)==="[object Object]"}function cr(n){return qa(n)?Object.keys(n).reduce(function(t,e){let o=qa(n[e]),r=o?cr(n[e]):n[e],i=o&&!Object.keys(r).length;return r===void 0||i?t:Object.assign(t,{[e]:r})},{}):n}function sr(n,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(o=>{o.endsWith("Id")?sr(n,n.get(t[o]),e):o.endsWith("Ids")&&t[o].forEach(r=>{sr(n,n.get(r),e)})}))}function ur(n,t,e){let o=e?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;let i=[];return n.forEach(a=>{a.type==="track"&&a.trackIdentifier===t.id&&i.push(a)}),i.forEach(a=>{n.forEach(s=>{s.type===o&&s.trackId===a.id&&sr(n,s,r)})}),r}var Mn={};rt(Mn,{fixNegotiationNeeded:()=>xr,shimAddTrackRemoveTrack:()=>gr,shimAddTrackRemoveTrackWithNative:()=>ns,shimGetDisplayMedia:()=>ts,shimGetSendersWithDtmf:()=>dr,shimGetStats:()=>mr,shimGetUserMedia:()=>En,shimMediaStream:()=>pr,shimOnTrack:()=>lr,shimPeerConnection:()=>Cn,shimSenderReceiverGetStats:()=>hr});var es=An;function En(n,t){let e=n&&n.navigator;if(!e.mediaDevices)return;let o=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let c={};return Object.keys(s).forEach(u=>{if(u==="require"||u==="advanced"||u==="mediaSource")return;let p=typeof s[u]=="object"?s[u]:{ideal:s[u]};p.exact!==void 0&&typeof p.exact=="number"&&(p.min=p.max=p.exact);let l=function(h,x){return h?h+x.charAt(0).toUpperCase()+x.slice(1):x==="deviceId"?"sourceId":x};if(p.ideal!==void 0){c.optional=c.optional||[];let h={};typeof p.ideal=="number"?(h[l("min",u)]=p.ideal,c.optional.push(h),h={},h[l("max",u)]=p.ideal,c.optional.push(h)):(h[l("",u)]=p.ideal,c.optional.push(h))}p.exact!==void 0&&typeof p.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[l("",u)]=p.exact):["min","max"].forEach(h=>{p[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[l(h,u)]=p[h])})}),s.advanced&&(c.optional=(c.optional||[]).concat(s.advanced)),c},r=function(s,c){if(t.version>=61)return c(s);if(s=JSON.parse(JSON.stringify(s)),s&&typeof s.audio=="object"){let u=function(p,l,h){l in p&&!(h in p)&&(p[h]=p[l],delete p[l])};s=JSON.parse(JSON.stringify(s)),u(s.audio,"autoGainControl","googAutoGainControl"),u(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=o(s.audio)}if(s&&typeof s.video=="object"){let u=s.video.facingMode;u=u&&(typeof u=="object"?u:{ideal:u});let p=t.version<66;if(u&&(u.exact==="user"||u.exact==="environment"||u.ideal==="user"||u.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!p)){delete s.video.facingMode;let l;if(u.exact==="environment"||u.ideal==="environment"?l=["back","rear"]:(u.exact==="user"||u.ideal==="user")&&(l=["front"]),l)return e.mediaDevices.enumerateDevices().then(h=>{h=h.filter(F=>F.kind==="videoinput");let x=h.find(F=>l.some(f=>F.label.toLowerCase().includes(f)));return!x&&h.length&&l.includes("back")&&(x=h[h.length-1]),x&&(s.video.deviceId=u.exact?{exact:x.deviceId}:{ideal:x.deviceId}),s.video=o(s.video),es("chrome: "+JSON.stringify(s)),c(s)})}s.video=o(s.video)}return es("chrome: "+JSON.stringify(s)),c(s)},i=function(s){return t.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},a=function(s,c,u){r(s,p=>{e.webkitGetUserMedia(p,c,l=>{u&&u(i(l))})})};if(e.getUserMedia=a.bind(e),e.mediaDevices.getUserMedia){let s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(c){return r(c,u=>s(u).then(p=>{if(u.audio&&!p.getAudioTracks().length||u.video&&!p.getVideoTracks().length)throw p.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return p},p=>Promise.reject(i(p))))}}}function ts(n,t){if(!(n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices)&&n.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}n.navigator.mediaDevices.getDisplayMedia=function(o){return t(o).then(r=>{let i=o.video&&o.video.width,a=o.video&&o.video.height,s=o.video&&o.video.frameRate;return o.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:s||3}},i&&(o.video.mandatory.maxWidth=i),a&&(o.video.mandatory.maxHeight=a),n.navigator.mediaDevices.getUserMedia(o)})}}}function pr(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function lr(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});let t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=o=>{o.stream.addEventListener("addtrack",r=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(s=>s.track&&s.track.id===r.track.id):i={track:r.track};let a=new Event("track");a.track=r.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[o.stream],this.dispatchEvent(a)}),o.stream.getTracks().forEach(r=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(s=>s.track&&s.track.id===r.id):i={track:r};let a=new Event("track");a.track=r,a.receiver=i,a.transceiver={receiver:i},a.streams=[o.stream],this.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else oe(n,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function dr(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){let t=function(r,i){return{track:i,get dtmf(){return this._dtmf===void 0&&(i.kind==="audio"?this._dtmf=r.createDTMFSender(i):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(s,c){let u=r.apply(this,arguments);return u||(u=t(this,s),this._senders.push(u)),u};let i=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(s){i.apply(this,arguments);let c=this._senders.indexOf(s);c!==-1&&this._senders.splice(c,1)}}let e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],e.apply(this,[i]),i.getTracks().forEach(a=>{this._senders.push(t(this,a))})};let o=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],o.apply(this,[i]),i.getTracks().forEach(a=>{let s=this._senders.find(c=>c.track===a);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){let t=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){let o=t.apply(this,[]);return o.forEach(r=>r._pc=this),o},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function mr(n){if(!n.RTCPeerConnection)return;let t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[o,r,i]=arguments;if(arguments.length>0&&typeof o=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof o!="function"))return t.apply(this,[]);let a=function(c){let u={};return c.result().forEach(l=>{let h={id:l.id,timestamp:l.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[l.type]||l.type};l.names().forEach(x=>{h[x]=l.stat(x)}),u[h.id]=h}),u},s=function(c){return new Map(Object.keys(c).map(u=>[u,c[u]]))};if(arguments.length>=2){let c=function(u){r(s(a(u)))};return t.apply(this,[c,o])}return new Promise((c,u)=>{t.apply(this,[function(p){c(s(a(p)))},u])}).then(r,i)}}function hr(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){let e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(a=>a._pc=this),i});let o=n.RTCPeerConnection.prototype.addTrack;o&&(n.RTCPeerConnection.prototype.addTrack=function(){let i=o.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){let i=this;return this._pc.getStats().then(a=>ur(a,i.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){let e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){let r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r}),oe(n,"track",o=>(o.receiver._pc=o.srcElement,o)),n.RTCRtpReceiver.prototype.getStats=function(){let r=this;return this._pc.getStats().then(i=>ur(i,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;let t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){let o=arguments[0],r,i,a;return this.getSenders().forEach(s=>{s.track===o&&(r?a=!0:r=s)}),this.getReceivers().forEach(s=>(s.track===o&&(i?a=!0:i=s),s.track===o)),a||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function ns(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};let t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,s){if(!s)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let c=t.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(c)===-1&&this._shimmedLocalStreams[s.id].push(c):this._shimmedLocalStreams[s.id]=[s,c],c};let e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(u=>{if(this.getSenders().find(l=>l.track===u))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();e.apply(this,arguments);let c=this.getSenders().filter(u=>s.indexOf(u)===-1);this._shimmedLocalStreams[a.id]=[a].concat(c)};let o=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],o.apply(this,arguments)};let r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let c=this._shimmedLocalStreams[s].indexOf(a);c!==-1&&this._shimmedLocalStreams[s].splice(c,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function gr(n,t){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&t.version>=65)return ns(n);let e=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){let p=e.apply(this);return this._reverseStreams=this._reverseStreams||{},p.map(l=>this._reverseStreams[l.id])};let o=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(p){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},p.getTracks().forEach(l=>{if(this.getSenders().find(x=>x.track===l))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[p.id]){let l=new n.MediaStream(p.getTracks());this._streams[p.id]=l,this._reverseStreams[l.id]=p,p=l}o.apply(this,[p])};let r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(p){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[p.id]||p]),delete this._reverseStreams[this._streams[p.id]?this._streams[p.id].id:p.id],delete this._streams[p.id]},n.RTCPeerConnection.prototype.addTrack=function(p,l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(f=>f===p))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(f=>f.track===p))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let F=this._streams[l.id];if(F)F.addTrack(p),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let f=new n.MediaStream([p]);this._streams[l.id]=f,this._reverseStreams[f.id]=l,this.addStream(f)}return this.getSenders().find(f=>f.track===p)};function i(u,p){let l=p.sdp;return Object.keys(u._reverseStreams||[]).forEach(h=>{let x=u._reverseStreams[h],F=u._streams[x.id];l=l.replace(new RegExp(F.id,"g"),x.id)}),new RTCSessionDescription({type:p.type,sdp:l})}function a(u,p){let l=p.sdp;return Object.keys(u._reverseStreams||[]).forEach(h=>{let x=u._reverseStreams[h],F=u._streams[x.id];l=l.replace(new RegExp(x.id,"g"),F.id)}),new RTCSessionDescription({type:p.type,sdp:l})}["createOffer","createAnswer"].forEach(function(u){let p=n.RTCPeerConnection.prototype[u],l={[u](){let h=arguments;return arguments.length&&typeof arguments[0]=="function"?p.apply(this,[F=>{let f=i(this,F);h[0].apply(null,[f])},F=>{h[1]&&h[1].apply(null,F)},arguments[2]]):p.apply(this,arguments).then(F=>i(this,F))}};n.RTCPeerConnection.prototype[u]=l[u]});let s=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?s.apply(this,arguments):(arguments[0]=a(this,arguments[0]),s.apply(this,arguments))};let c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){let u=c.get.apply(this);return u.type===""?u:i(this,u)}}),n.RTCPeerConnection.prototype.removeTrack=function(p){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!p._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(p._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(x=>{this._streams[x].getTracks().find(f=>p.track===f)&&(h=this._streams[x])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(p.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Cn(n,t){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){let o=n.RTCPeerConnection.prototype[e],r={[e](){return arguments[0]=new(e==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};n.RTCPeerConnection.prototype[e]=r[e]})}function xr(n,t){oe(n,"negotiationneeded",e=>{let o=e.target;if(!((t.version<72||o.getConfiguration&&o.getConfiguration().sdpSemantics==="plan-b")&&o.signalingState!=="stable"))return e})}var Ln={};rt(Ln,{shimAddTransceiver:()=>Tr,shimCreateAnswer:()=>br,shimCreateOffer:()=>vr,shimGetDisplayMedia:()=>os,shimGetParameters:()=>kr,shimGetUserMedia:()=>Dn,shimOnTrack:()=>Fr,shimPeerConnection:()=>yn,shimRTCDataChannel:()=>_r,shimReceiverGetStats:()=>fr,shimRemoveStream:()=>Sr,shimSenderGetStats:()=>wr});function Dn(n,t){let e=n&&n.navigator,o=n&&n.MediaStreamTrack;if(e.getUserMedia=function(r,i,a){Ye("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(r).then(i,a)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){let r=function(a,s,c){s in a&&!(c in a)&&(a[c]=a[s],delete a[s])},i=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a.audio,"autoGainControl","mozAutoGainControl"),r(a.audio,"noiseSuppression","mozNoiseSuppression")),i(a)},o&&o.prototype.getSettings){let a=o.prototype.getSettings;o.prototype.getSettings=function(){let s=a.apply(this,arguments);return r(s,"mozAutoGainControl","autoGainControl"),r(s,"mozNoiseSuppression","noiseSuppression"),s}}if(o&&o.prototype.applyConstraints){let a=o.prototype.applyConstraints;o.prototype.applyConstraints=function(s){return this.kind==="audio"&&typeof s=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s,"autoGainControl","mozAutoGainControl"),r(s,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[s])}}}}function os(n,t){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(o){if(!(o&&o.video)){let r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return o.video===!0?o.video={mediaSource:t}:o.video.mediaSource=t,n.navigator.mediaDevices.getUserMedia(o)})}function Fr(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function yn(n,t){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let i=n.RTCPeerConnection.prototype[r],a={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=a[r]});let e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[i,a,s]=arguments;return o.apply(this,[i||null]).then(c=>{if(t.version<53&&!a)try{c.forEach(u=>{u.type=e[u.type]||u.type})}catch(u){if(u.name!=="TypeError")throw u;c.forEach((p,l)=>{c.set(l,Object.assign({},p,{type:e[p.type]||p.type}))})}return c}).then(a,s)}}function wr(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;let t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){let r=t.apply(this,[]);return r.forEach(i=>i._pc=this),r});let e=n.RTCPeerConnection.prototype.addTrack;e&&(n.RTCPeerConnection.prototype.addTrack=function(){let r=e.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function fr(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;let t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){let o=t.apply(this,[]);return o.forEach(r=>r._pc=this),o}),oe(n,"track",e=>(e.receiver._pc=e.srcElement,e)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Sr(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(e){Ye("removeStream","removeTrack"),this.getSenders().forEach(o=>{o.track&&e.getTracks().includes(o.track)&&this.removeTrack(o)})})}function _r(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function Tr(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.addTransceiver;t&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let o=arguments[1]&&arguments[1].sendEncodings;o===void 0&&(o=[]),o=[...o];let r=o.length>0;r&&o.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let i=t.apply(this,arguments);if(r){let{sender:a}=i,s=a.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=o,a.sendEncodings=o,this.setParametersPromises.push(a.setParameters(s).then(()=>{delete a.sendEncodings}).catch(()=>{delete a.sendEncodings})))}return i})}function kr(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;let t=n.RTCRtpSender.prototype.getParameters;t&&(n.RTCRtpSender.prototype.getParameters=function(){let o=t.apply(this,arguments);return"encodings"in o||(o.encodings=[].concat(this.sendEncodings||[{}])),o})}function vr(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function br(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var Bn={};rt(Bn,{shimAudioContext:()=>Br,shimCallbacksAPI:()=>Cr,shimConstraints:()=>rs,shimCreateOfferLegacy:()=>Lr,shimGetUserMedia:()=>Mr,shimLocalStreamsAPI:()=>Ar,shimRTCIceServerUrls:()=>Dr,shimRemoteStreamsAPI:()=>Er,shimTrackEventTransceiver:()=>yr});function Ar(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){let t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(o){this._localStreams||(this._localStreams=[]),this._localStreams.includes(o)||this._localStreams.push(o),o.getAudioTracks().forEach(r=>t.call(this,r,o)),o.getVideoTracks().forEach(r=>t.call(this,r,o))},n.RTCPeerConnection.prototype.addTrack=function(o,...r){return r&&r.forEach(i=>{this._localStreams?this._localStreams.includes(i)||this._localStreams.push(i):this._localStreams=[i]}),t.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let o=this._localStreams.indexOf(e);if(o===-1)return;this._localStreams.splice(o,1);let r=e.getTracks();this.getSenders().forEach(i=>{r.includes(i.track)&&this.removeTrack(i)})})}}function Er(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=o=>{o.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);let i=new Event("addstream");i.stream=r,this.dispatchEvent(i)})})}});let t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){let o=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(i=>{if(o._remoteStreams||(o._remoteStreams=[]),o._remoteStreams.indexOf(i)>=0)return;o._remoteStreams.push(i);let a=new Event("addstream");a.stream=i,o.dispatchEvent(a)})}),t.apply(o,arguments)}}}function Cr(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let t=n.RTCPeerConnection.prototype,e=t.createOffer,o=t.createAnswer,r=t.setLocalDescription,i=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(u,p){let l=arguments.length>=2?arguments[2]:arguments[0],h=e.apply(this,[l]);return p?(h.then(u,p),Promise.resolve()):h},t.createAnswer=function(u,p){let l=arguments.length>=2?arguments[2]:arguments[0],h=o.apply(this,[l]);return p?(h.then(u,p),Promise.resolve()):h};let s=function(c,u,p){let l=r.apply(this,[c]);return p?(l.then(u,p),Promise.resolve()):l};t.setLocalDescription=s,s=function(c,u,p){let l=i.apply(this,[c]);return p?(l.then(u,p),Promise.resolve()):l},t.setRemoteDescription=s,s=function(c,u,p){let l=a.apply(this,[c]);return p?(l.then(u,p),Promise.resolve()):l},t.addIceCandidate=s}function Mr(n){let t=n&&n.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){let e=t.mediaDevices,o=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=r=>o(rs(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(o,r,i){t.mediaDevices.getUserMedia(o).then(r,i)}.bind(t))}function rs(n){return n&&n.video!==void 0?Object.assign({},n,{video:cr(n.video)}):n}function Dr(n){if(!n.RTCPeerConnection)return;let t=n.RTCPeerConnection;n.RTCPeerConnection=function(o,r){if(o&&o.iceServers){let i=[];for(let a=0;a<o.iceServers.length;a++){let s=o.iceServers[a];s.urls===void 0&&s.url?(Ye("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,i.push(s)):i.push(o.iceServers[a])}o.iceServers=i}return new t(o,r)},n.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function yr(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Lr(n){let t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(o){if(o){typeof o.offerToReceiveAudio<"u"&&(o.offerToReceiveAudio=!!o.offerToReceiveAudio);let r=this.getTransceivers().find(a=>a.receiver.track.kind==="audio");o.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):o.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof o.offerToReceiveVideo<"u"&&(o.offerToReceiveVideo=!!o.offerToReceiveVideo);let i=this.getTransceivers().find(a=>a.receiver.track.kind==="video");o.offerToReceiveVideo===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):o.offerToReceiveVideo===!0&&!i&&this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Br(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var Vr={};rt(Vr,{removeExtmapAllowMixed:()=>Vn,shimAddIceCandidateNullOrEmpty:()=>Bt,shimConnectionState:()=>Pn,shimMaxMessageSize:()=>yt,shimParameterlessSetLocalDescription:()=>Rt,shimRTCIceCandidate:()=>Dt,shimRTCIceCandidateRelayProtocol:()=>Rn,shimSendThrowTypeError:()=>Lt});var Ze=ei(Pr());function Dt(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;let t=n.RTCIceCandidate;n.RTCIceCandidate=function(o){if(typeof o=="object"&&o.candidate&&o.candidate.indexOf("a=")===0&&(o=JSON.parse(JSON.stringify(o)),o.candidate=o.candidate.substring(2)),o.candidate&&o.candidate.length){let r=new t(o),i=Ze.default.parseCandidate(o.candidate);for(let a in i)a in r||Object.defineProperty(r,a,{value:i[a]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(o)},n.RTCIceCandidate.prototype=t.prototype,oe(n,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new n.RTCIceCandidate(e.candidate),writable:"false"}),e))}function Rn(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||oe(n,"icecandidate",t=>{if(t.candidate){let e=Ze.default.parseCandidate(t.candidate.candidate);e.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t})}function yt(n,t){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});let e=function(s){if(!s||!s.sdp)return!1;let c=Ze.default.splitSections(s.sdp);return c.shift(),c.some(u=>{let p=Ze.default.parseMLine(u);return p&&p.kind==="application"&&p.protocol.indexOf("SCTP")!==-1})},o=function(s){let c=s.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;let u=parseInt(c[1],10);return u!==u?-1:u},r=function(s){let c=65536;return t.browser==="firefox"&&(t.version<57?s===-1?c=16384:c=2147483637:t.version<60?c=t.version===57?65535:65536:c=2147483637),c},i=function(s,c){let u=65536;t.browser==="firefox"&&t.version===57&&(u=65535);let p=Ze.default.matchPrefix(s.sdp,"a=max-message-size:");return p.length>0?u=parseInt(p[0].substring(19),10):t.browser==="firefox"&&c!==-1&&(u=2147483637),u},a=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){let{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){let c=o(arguments[0]),u=r(c),p=i(arguments[0],c),l;u===0&&p===0?l=Number.POSITIVE_INFINITY:u===0||p===0?l=Math.max(u,p):l=Math.min(u,p);let h={};Object.defineProperty(h,"maxMessageSize",{get(){return l}}),this._sctp=h}return a.apply(this,arguments)}}function Lt(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function t(o,r){let i=o.send;o.send=function(){let s=arguments[0],c=s.length||s.size||s.byteLength;if(o.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return i.apply(o,arguments)}}let e=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){let r=e.apply(this,arguments);return t(r,this),r},oe(n,"datachannel",o=>(t(o.channel,o.target),o))}function Pn(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;let t=n.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{let o=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let i=r.target;if(i._lastConnectionState!==i.connectionState){i._lastConnectionState=i.connectionState;let a=new Event("connectionstatechange",r);i.dispatchEvent(a)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),o.apply(this,arguments)}})}function Vn(n,t){if(!n.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;let e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let i=r.sdp.split(`
`).filter(a=>a.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:i}):r.sdp=i}return e.apply(this,arguments)}}function Bt(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;let e=n.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Rt(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;let e=n.RTCPeerConnection.prototype.setLocalDescription;!e||e.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return e.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?e.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(a=>e.apply(this,[a]))})}var Fu=ei(Pr());function is({window:n}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let e=An,o=Za(n),r={browserDetails:o,commonShim:Vr,extractVersion:Mt,disableLog:Qa,disableWarnings:Ya,sdp:Fu};switch(o.browser){case"chrome":if(!Mn||!Cn||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),r;if(o.version===null)return e("Chrome shim can not determine version, not shimming."),r;e("adapter.js shimming chrome."),r.browserShim=Mn,Bt(n,o),Rt(n,o),En(n,o),pr(n,o),Cn(n,o),lr(n,o),gr(n,o),dr(n,o),mr(n,o),hr(n,o),xr(n,o),Dt(n,o),Rn(n,o),Pn(n,o),yt(n,o),Lt(n,o),Vn(n,o);break;case"firefox":if(!Ln||!yn||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),r;e("adapter.js shimming firefox."),r.browserShim=Ln,Bt(n,o),Rt(n,o),Dn(n,o),yn(n,o),Fr(n,o),Sr(n,o),wr(n,o),fr(n,o),_r(n,o),Tr(n,o),kr(n,o),vr(n,o),br(n,o),Dt(n,o),Pn(n,o),yt(n,o),Lt(n,o);break;case"safari":if(!Bn||!t.shimSafari)return e("Safari shim is not included in this adapter release."),r;e("adapter.js shimming safari."),r.browserShim=Bn,Bt(n,o),Rt(n,o),Dr(n,o),Lr(n,o),Cr(n,o),Ar(n,o),Er(n,o),yr(n,o),Mr(n,o),Br(n,o),Dt(n,o),Rn(n,o),yt(n,o),Lt(n,o),Vn(n,o);break;default:e("Unsupported browser!");break}return r}var Ck=is({window:typeof window>"u"?void 0:window});var Re=class extends Event{constructor(e){super(e);this.eventType=e}},In=class extends Re{constructor(e){super("error");this.error=e}};var Wn=class extends Re{constructor(){super("serverConnected")}},Hn=class extends Re{constructor(){super("serverDisconnected")}};var On=class extends Re{constructor(e,o){super(e);this.userID=o}},Nn=class extends On{constructor(e,o){super("roomJoined",e);this.pose=o}},jn=class extends On{constructor(t){super("roomLeft",t)}},et=class extends Re{constructor(e,o){super(e);this.user=o}},Un=class extends et{constructor(e,o){super("userJoined",e);this.source=o}},tt=class extends et{constructor(t){super("userLeft",t)}};var Gn=class extends et{constructor(e){super("userState",e);this.buffer=null}},Xn=class extends et{constructor(e){super("chat",e);this.text=null}};function Ir(n){let t=new xe,e=setInterval(()=>{n()&&(clearInterval(e),t.resolve())},100);return t}async function as(n,t,e,o,r,i,a){t()===r?await Ir(()=>t()===o):(t()===i&&await Ir(()=>t()===a),t()===a&&await e())}function Wr(n,t,e){return as(n,t,e,"Connected","Connecting","Disconnecting","Disconnected")}function Hr(n,t,e){return as(n,t,e,"Disconnected","Disconnecting","Connecting","Connected")}var zn="local-user";var Jn=class extends He{constructor(e,o,r,i,a,s,c,u,p,l){super(e);this.control=o;this.min=r;this.max=i;this.threshold=a;this.attack=s;this.decay=c;this.sustain=u;this.hold=p;this.release=l;this.curLength=0;this._enabled=!0;this.shouldRun=!1;this.name="remote-audio-activity";let h=null;this.addEventListener("activity",x=>{let F=performance.now();if(h!=null){let f=F-h;if(this.enabled){let M=x.level;M>=this.threshold&&this.time>=this.length&&(this.time=0),this.time+=f,this.time>this.length&&(this.time=this.length),M>=this.threshold&&this.holding&&(this.time=this.holdStart),this.control.gain.value=this.gain}}h=F})}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.refresh()}start(){this.shouldRun=!0,this.refresh()}stop(){this.shouldRun=!1,this.refresh()}refresh(){let e=this.shouldRun&&this.enabled;e!==this.timer.isRunning&&(e?this.timer.start():(this.timer.stop(),this.control.gain.value=1))}get length(){return this.attack+this.decay+this.hold+this.release}get time(){return this.length-this.curLength}set time(e){this.curLength=this.length-e}get attackStart(){return 0}get attackEnd(){return this.attackStart+this.attack}get decayStart(){return this.attackEnd}get decayEnd(){return this.decayStart+this.decay}get holdStart(){return this.decayEnd}get holdEnd(){return this.holdStart+this.hold}get releaseStart(){return this.holdEnd}get releaseEnd(){return this.releaseStart+this.release}get attacking(){return this.attackStart<=this.time&&this.time<this.attackEnd}get decaying(){return this.decayStart<=this.time&&this.time<this.decayEnd}get holding(){return this.holdStart<=this.time&&this.time<this.holdEnd}get releasing(){return this.releaseStart<this.time&&this.time<this.releaseEnd}get pAttack(){return(this.time-this.attackStart)/this.attack}get pDecay(){return(this.time-this.decayStart)/this.decay}get pRelease(){return(this.time-this.releaseStart)/this.release}get value(){return this.attacking?1-this.pAttack:this.decaying?this.sustain*this.pDecay:this.holding?this.sustain:this.releasing?this.sustain+(1-this.sustain)*this.pRelease:1}get gain(){return ki(this.value,this.min,this.max)}};var Or=class{constructor(){this.locks=new Set}isLocked(t){return this.locks.has(t)}isUnlocked(t){return!this.locks.has(t)}lock(t){this.locks.add(t)}unlock(t){this.locks.delete(t)}async withSkipLock(t,e){if(this.isUnlocked(t)){this.lock(t);try{await e()}finally{this.unlock(t)}}}},re=class extends T{constructor(e,o){super(e);this.user=o}},Nr=class extends re{constructor(e,o){super("iceError",e);this.address=o.address,this.errorCode=o.errorCode,this.errorText=o.errorText,this.port=o.port,this.url=o.url,Object.seal(this)}},jr=class extends re{constructor(e,o){super("iceCandidate",e);this.candidate=o}},Ur=class extends re{constructor(e,o){super("offer",e);this.offer=o}},Gr=class extends re{constructor(e,o){super("answer",e);this.answer=o}},Xr=class extends re{constructor(t){super("streamNeeded",t)}},zr=class extends re{constructor(e,o,r){super("trackAdded",e);this.track=o;this.stream=r}},Jr=class extends re{constructor(e,o){super("trackMuted",e);this.track=o}},qr=class extends re{constructor(e,o,r){super("trackRemoved",e);this.track=o;this.stream=r}},ss=new Set,qn=class extends B{constructor(e,o,r){super();this.userID=e;this.userName=o;this.userStateEvt=new Gn(this);this.userChatEvt=new Xn(this);this.transceivers=new Array;this.tasks=new Map;this.locks=new Or;this.channel=null;this.gotOffer=!1;this.disposed=!1;this.trackSent=!1;this.connection=new RTCPeerConnection(r),this.connection.addEventListener("icecandidateerror",a=>{this.dispatchEvent(new Nr(this,a))}),this.connection.addEventListener("icecandidate",async a=>{a.candidate&&this.dispatchEvent(new jr(this,a.candidate))}),this.connection.addEventListener("negotiationneeded",async()=>{if(this.trackSent||this.gotOffer){let a=ss.has(this.userID),s=await this.connection.createOffer({iceRestart:a});a||ss.add(this.userID),await this.connection.setLocalDescription(s),this.dispatchEvent(new Ur(this,this.connection.localDescription.toJSON()))}}),this.connection.addEventListener("datachannel",a=>{this.setChannel(a.channel)}),this.connection.addEventListener("track",async a=>{let s=a.transceiver,c=a.track,u=pt(a.streams,h=>{let x=h.getTracks();for(let F of x)if(F===c)return!0;return!1});this.transceivers.indexOf(s)===-1&&this.transceivers.push(s);let p=()=>{this.dispatchEvent(new Jr(this,c))},l=()=>{c.removeEventListener("ended",l),c.removeEventListener("mute",p),Z(this.transceivers,s),this.dispatchEvent(new qr(this,c,u))};c.addEventListener("ended",l),c.addEventListener("mute",p),this.dispatchEvent(new zr(this,c,u)),this.trackSent?this.setChannel(this.connection.createDataChannel("poses",{ordered:!1,maxRetransmits:0})):this.start()});let i=!1;this.connection.addEventListener("connectionstatechange",()=>{this.connection.connectionState==="failed"&&i?this.dispatchEvent(new tt(this)):this.connection.connectionState==="connected"&&(i=!0)}),Object.seal(this)}dispose(){if(!this.disposed){this.channel&&(W(this.channel),this.channel=null);for(let e of this.transceivers)e.stop();Ae(this.transceivers),W(this.connection),this.disposed=!0}}setChannel(e){this.channel=e,this.channel.binaryType="arraybuffer",this.channel.addEventListener("message",o=>{ti(o.data)&&this.recvUserState(o)})}recvChat(e){this.userChatEvt.text=e,this.dispatchEvent(this.userChatEvt)}async sendUserState(e){if(this.channel&&this.channel.readyState==="open"){let o="sendUserState";this.tasks.has(o)||this.tasks.set(o,new xe),await this.locks.withSkipLock(o,async()=>{this.channel.send(e)})}}recvUserState(e){this.userStateEvt.buffer=e.data,this.dispatchEvent(this.userStateEvt)}async addIceCandidate(e){await this.connection.addIceCandidate(e)}async acceptOffer(e){await this.connection.setRemoteDescription(e),this.gotOffer=!0;let o=await this.connection.createAnswer();await this.connection.setLocalDescription(o),this.dispatchEvent(new Gr(this,this.connection.localDescription.toJSON()))}async acceptAnswer(e){await this.connection.setRemoteDescription(e)}start(){this.trackSent||this.dispatchEvent(new Xr(this))}removeStream(e){let o=this.connection.getSenders(),r=new Map(o.map(i=>[i.track,i]));for(let i of e.getTracks())if(r.has(i)){let a=r.get(i);this.connection.removeTrack(a)}}sendStream(...e){for(let o of e)if(o)for(let r of o.getTracks())this.trackSent?this.connection.addTrack(r,o):(this.trackSent=!0,this.transceivers.push(this.connection.addTransceiver(r,{streams:[o]})))}};var Kr=fe("Juniper:Sockets",()=>new Array);function $n(...n){let t=new WebSocket(...n);return Kr.push(t),t}$n.CLOSED=WebSocket.CLOSED;$n.CLOSING=WebSocket.CLOSING;$n.CONNECTING=WebSocket.CONNECTING;$n.OPEN=WebSocket.OPEN;Object.assign(window,{sockets:{list:()=>Kr,kill:()=>{Kr.forEach(W)}}});var Kn=class extends B{constructor(e,o,r,i){super();this.audio=e;this.microphones=o;this.webcams=r;this.hub=i;this._isAudioMuted=null;this._isVideoMuted=null;this._localUserID=zn;this._localUserName=null;this._roomName=null;this._conferenceState="Disconnected";this._hasAudioPermission=!1;this._hasVideoPermission=!1;this.lastRoom=null;this.lastUserID=null;this.users=new Map;this.windowQuitter=new bn;this.heartbeatTimer=null;this.disposed=!1;let a=s=>{for(let c of this.users.values())s.oldStream&&c.removeStream(s.oldStream),s.newStream&&c.sendStream(s.newStream)};this.microphones.addEventListener("streamchanged",a),this.webcams.addEventListener("streamchanged",a),this.hub.addEventListener("close",this.onClose.bind(this)),this.hub.addEventListener("reconnecting",this.onReconnecting.bind(this)),this.hub.addEventListener("reconnected",this.onReconnected.bind(this)),this.hub.addEventListener("userJoined",this.onUserJoined.bind(this)),this.hub.addEventListener("iceReceived",this.onIceReceived.bind(this)),this.hub.addEventListener("offerReceived",this.onOfferReceived.bind(this)),this.hub.addEventListener("answerReceived",this.onAnswerReceived.bind(this)),this.hub.addEventListener("userLeft",this.onUserLeft.bind(this)),this.hub.addEventListener("chat",this.onChat.bind(this)),this.remoteGainDecay=new Jn(this.audio.context,this.microphones.autoGainNode,.05,1,.25,0,250,.25,1e3,250),this.audio.destination.remoteUserInput.connect(this.remoteGainDecay),this.remoteGainDecay.enabled=!this.audio.useHeadphones,this.audio.addEventListener("useheadphonestoggled",()=>{this.remoteGainDecay.enabled=!this.audio.useHeadphones}),this.windowQuitter.addScopedEventListener(this,"quitting",()=>{this.conferenceState==="Connected"&&this.toRoom("leave")})}get isAudioMuted(){return this._isAudioMuted}get isVideoMuted(){return this._isVideoMuted}get localUserID(){return this._localUserID}get localUserName(){return this._localUserName}get roomName(){return this._roomName}get hasAudioPermission(){return this._hasAudioPermission}get hasVideoPermission(){return this._hasVideoPermission}get connectionState(){return this.hub.connectionState}get echoControl(){return this.remoteGainDecay}get isConnected(){return this.connectionState==="Connected"}get conferenceState(){return this._conferenceState}get isConferenced(){return this.conferenceState==="Connected"}setConferenceState(e){this._conferenceState=e}dispose(){this.disposed||(this.leave(),this.disconnect(),this.windowQuitter.removeScope(this),W(this.remoteGainDecay),this.disposed=!0)}err(e,...o){console.warn(e,...o)}async toServer(e,...o){return await this.hub.invoke(e,...o)}async toRoom(e,...o){this.isConnected&&await this.hub.invoke(e,this.localUserID,this.roomName,...o)}async toUser(e,o,...r){this.isConnected&&await this.hub.invoke(e,this.localUserID,o,...r)}async connect(){await Wr("Connecting",()=>this.connectionState,async()=>{await this.hub.start(),this.heartbeatTimer=setInterval(()=>{this.hub.connectionState==="Connected"&&this.hub.invoke("heartbeat",this.localUserID)},2500),this.dispatchEvent(new Wn)})}async join(e){this.lastRoom!==null&&e!==this.lastRoom&&await this.leave(),await Wr(`Joining room ${e}`,()=>this.conferenceState,async()=>{this.setConferenceState("Connecting"),this._roomName=e,await this.toServer("join",this.roomName),this.lastRoom=this.roomName,this.setConferenceState("Connected");let o=this.audio.setLocalUserID(this.localUserID);this.dispatchEvent(new Nn(this.localUserID,o.pose)),await this.toRoom("greetEveryone",this.localUserName)})}async identify(e){this.localUserID===zn&&(this._localUserID=null),this._localUserID=this.localUserID||await this.toServer("getNewUserID"),this._localUserName=e,this.localUserID&&this.localUserID!==this.lastUserID&&this.isConnected&&(this.lastUserID=this.localUserID,await this.toServer("identify",this.localUserID))}async leave(){await Hr(`Leaving room ${this.lastRoom}`,()=>this.conferenceState,async()=>{this.setConferenceState("Disconnecting"),await this.toRoom("leave")});for(let e of this.users.values())this.removeUser(e);this._roomName=this.lastRoom=null,this.setConferenceState("Disconnected"),this.dispatchEvent(new jn(this.localUserID))}async disconnect(){g(this.heartbeatTimer)&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.conferenceState!=="Disconnected"&&await this.leave(),await Hr("Disconnecting",()=>this.connectionState,async()=>{await this.hub.stop(),this._localUserID=this.lastUserID=zn,this.audio.setLocalUserID(this.localUserID),this.dispatchEvent(new Hn)})}onClose(){this.lastRoom=null,this.lastUserID=null,this.setConferenceState("Disconnected")}onReconnecting(e){this.dispatchEvent(new In(e.error))}async onReconnected(){this.lastRoom=null,this.lastUserID=null,this.setConferenceState("Disconnected"),await this.identify(this.localUserName),await this.join(this.roomName)}async onUserJoined(e){if(this.users.has(e.fromUserID))this.users.get(e.fromUserID).start();else{this.users.size===0&&this.remoteGainDecay.start();let o=await this.getRTCConfiguration(),r=new qn(e.fromUserID,e.fromUserName,o);this.users.set(r.userID,r),r.addEventListener("iceError",this.onIceError.bind(this)),r.addEventListener("iceCandidate",this.onIceCandidate.bind(this)),r.addEventListener("offer",this.onOfferCreated.bind(this)),r.addEventListener("answer",this.onAnswerCreated.bind(this)),r.addEventListener("streamNeeded",this.onStreamNeeded.bind(this)),r.addEventListener("trackAdded",this.onTrackAdded.bind(this)),r.addEventListener("trackMuted",this.onTrackMuted.bind(this)),r.addEventListener("trackRemoved",this.onTrackRemoved.bind(this)),r.addEventListener("userLeft",a=>this.removeUser(a.user)),this.toUser("greet",r.userID,this.localUserName);let i=this.audio.createUser(r.userID,r.userName);this.dispatchEvent(new Un(r,i))}}async getRTCConfiguration(){return await this.toServer("getRTCConfiguration",this.localUserID)}onIceError(e){this.err("icecandidateerror",this.localUserName,e.user.userName,`${e.url} [${e.errorCode}]: ${e.errorText}`)}async onIceCandidate(e){await this.sendIce(e.user.userID,e.candidate)}async onIceReceived(e){try{let o=this.users.get(e.fromUserID);if(o){let r=JSON.parse(e.candidateJSON);await o.addIceCandidate(r)}}catch(o){this.err("iceReceived",`${o.message} [${e.fromUserID}] (${e.candidateJSON})`)}}async onOfferCreated(e){await this.sendOffer(e.user.userID,e.offer)}async onOfferReceived(e){try{let o=this.users.get(e.fromUserID);if(o){let r=JSON.parse(e.offerJSON);await o.acceptOffer(r)}}catch(o){this.err("offerReceived",o.message)}}async onAnswerCreated(e){await this.sendAnswer(e.user.userID,e.answer)}async onAnswerReceived(e){try{let o=this.users.get(e.fromUserID);if(o){let r=JSON.parse(e.answerJSON);await o.acceptAnswer(r)}}catch(o){this.err("answerReceived",o.message)}}onStreamNeeded(e){e.user.sendStream(this.microphones.outStream,this.webcams.outStream)}onTrackAdded(e){this.dispatchEvent(e)}onTrackMuted(e){this.dispatchEvent(e)}onTrackRemoved(e){this.dispatchEvent(e)}onUserLeft(e){this.removeUser(this.users.get(e.fromUserID))}removeUser(e){g(e)&&(W(e),this.users.delete(e.userID),this.users.size===0&&this.remoteGainDecay.stop(),this.audio.removeUser(e.userID),this.dispatchEvent(new tt(e)))}onChat(e){let o=this.users.get(e.fromUserID);o&&o.recvChat(e.text)}sendChat(e){this.conferenceState==="Connected"&&this.toRoom("chat",e)}async sendIce(e,o){await this.toUser("sendIce",e,JSON.stringify(o))}async sendOffer(e,o){await this.toUser("sendOffer",e,JSON.stringify(o))}async sendAnswer(e,o){await this.toUser("sendAnswer",e,JSON.stringify(o))}async forEachUser(e){this.conferenceState==="Connected"&&await Promise.all(Array.from(this.users.values()).map(e))}async sendUserState(e){await this.forEachUser(o=>o.sendUserState(e))}userExists(e){return this.users.has(e)}getUserNames(){return Array.from(this.users.values()).map(e=>[e.userID,e.userName])}};var Qn=class extends T{constructor(){super("close")}},Yn=class extends T{constructor(e){super("reconnecting");this.error=e}},Zn=class extends T{constructor(){super("reconnected")}},eo=class extends T{constructor(e,o){super("userJoined");this.fromUserID=e;this.fromUserName=o}},to=class extends T{constructor(e,o){super("iceReceived");this.fromUserID=e;this.candidateJSON=o}},no=class extends T{constructor(e,o){super("offerReceived");this.fromUserID=e;this.offerJSON=o}},oo=class extends T{constructor(e,o){super("answerReceived");this.fromUserID=e;this.answerJSON=o}},ro=class extends T{constructor(e){super("userLeft");this.fromUserID=e}},io=class extends T{constructor(){super("chat");this.fromUserID=null;this.text=null}set(e,o){this.fromUserID=e,this.text=o}};var z=class extends Error{constructor(t,e){let o=new.target.prototype;super(`${t}: Status code '${e}'`),this.statusCode=e,this.__proto__=o}},_e=class extends Error{constructor(t="A timeout occurred."){let e=new.target.prototype;super(t),this.__proto__=e}},R=class extends Error{constructor(t="An abort occurred."){let e=new.target.prototype;super(t),this.__proto__=e}},ao=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="UnsupportedTransportError",this.__proto__=o}},so=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="DisabledTransportError",this.__proto__=o}},co=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="FailedToStartTransportError",this.__proto__=o}},uo=class extends Error{constructor(t){let e=new.target.prototype;super(t),this.errorType="FailedToNegotiateWithServerError",this.__proto__=e}},po=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.innerErrors=e,this.__proto__=o}};var nt=class{constructor(t,e,o){this.statusCode=t,this.statusText=e,this.content=o}},ie=class{get(t,e){return this.send({...e,method:"GET",url:t})}post(t,e){return this.send({...e,method:"POST",url:t})}delete(t,e){return this.send({...e,method:"DELETE",url:t})}getCookieString(t){return""}};var d;(function(n){n[n.Trace=0]="Trace",n[n.Debug=1]="Debug",n[n.Information=2]="Information",n[n.Warning=3]="Warning",n[n.Error=4]="Error",n[n.Critical=5]="Critical",n[n.None=6]="None"})(d||(d={}));var ae=class{constructor(){}log(t,e){}};ae.instance=new ae;var fu="7.0.5",v=class{static isRequired(t,e){if(t==null)throw new Error(`The '${e}' argument is required.`)}static isNotEmpty(t,e){if(!t||t.match(/^\s*$/))throw new Error(`The '${e}' argument should not be empty.`)}static isIn(t,e,o){if(!(t in e))throw new Error(`Unknown ${o} value: ${t}.`)}},b=class{static get isBrowser(){return typeof window=="object"&&typeof window.document=="object"}static get isWebWorker(){return typeof self=="object"&&"importScripts"in self}static get isReactNative(){return typeof window=="object"&&typeof window.document>"u"}static get isNode(){return!this.isBrowser&&!this.isWebWorker&&!this.isReactNative}};function Te(n,t){let e="";return ke(n)?(e=`Binary data of length ${n.byteLength}`,t&&(e+=`. Content: '${Su(n)}'`)):typeof n=="string"&&(e=`String data of length ${n.length}`,t&&(e+=`. Content: '${n}'`)),e}function Su(n){let t=new Uint8Array(n),e="";return t.forEach(o=>{let r=o<16?"0":"";e+=`0x${r}${o.toString(16)} `}),e.substr(0,e.length-1)}function ke(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}async function mo(n,t,e,o,r,i){let a={},[s,c]=se();a[s]=c,n.log(d.Trace,`(${t} transport) sending data. ${Te(r,i.logMessageContent)}.`);let u=ke(r)?"arraybuffer":"text",p=await e.post(o,{content:r,headers:{...a,...i.headers},responseType:u,timeout:i.timeout,withCredentials:i.withCredentials});n.log(d.Trace,`(${t} transport) request complete. Response status: ${p.statusCode}.`)}function cs(n){return n===void 0?new Pe(d.Information):n===null?ae.instance:n.log!==void 0?n:new Pe(n)}var lo=class{constructor(t,e){this._subject=t,this._observer=e}dispose(){let t=this._subject.observers.indexOf(this._observer);t>-1&&this._subject.observers.splice(t,1),this._subject.observers.length===0&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}},Pe=class{constructor(t){this._minLevel=t,this.out=console}log(t,e){if(t>=this._minLevel){let o=`[${new Date().toISOString()}] ${d[t]}: ${e}`;switch(t){case d.Critical:case d.Error:this.out.error(o);break;case d.Warning:this.out.warn(o);break;case d.Information:this.out.info(o);break;default:this.out.log(o);break}}}};function se(){let n="X-SignalR-User-Agent";return b.isNode&&(n="User-Agent"),[n,_u(fu,Tu(),vu(),ku())]}function _u(n,t,e,o){let r="Microsoft SignalR/",i=n.split(".");return r+=`${i[0]}.${i[1]}`,r+=` (${n}; `,t&&t!==""?r+=`${t}; `:r+="Unknown OS; ",r+=`${e}`,o?r+=`; ${o}`:r+="; Unknown Runtime Version",r+=")",r}function Tu(){if(b.isNode)switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}else return""}function ku(){if(b.isNode)return process.versions.node}function vu(){return b.isNode?"NodeJS":"Browser"}function $r(n){return n.stack?n.stack:n.message?n.message:`${n}`}function us(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("could not find global")}var ho=class extends ie{constructor(t){if(super(),this._logger=t,typeof fetch>"u"){let e=typeof __webpack_require__=="function"?__non_webpack_require__:We;this._jar=new(e("tough-cookie")).CookieJar,this._fetchType=e("node-fetch"),this._fetchType=e("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind(us());if(typeof AbortController>"u"){let e=typeof __webpack_require__=="function"?__non_webpack_require__:We;this._abortControllerType=e("abort-controller")}else this._abortControllerType=AbortController}async send(t){if(t.abortSignal&&t.abortSignal.aborted)throw new R;if(!t.method)throw new Error("No method defined.");if(!t.url)throw new Error("No url defined.");let e=new this._abortControllerType,o;t.abortSignal&&(t.abortSignal.onabort=()=>{e.abort(),o=new R});let r=null;if(t.timeout){let c=t.timeout;r=setTimeout(()=>{e.abort(),this._logger.log(d.Warning,"Timeout from HTTP request."),o=new _e},c)}t.content===""&&(t.content=void 0),t.content&&(t.headers=t.headers||{},ke(t.content)?t.headers["Content-Type"]="application/octet-stream":t.headers["Content-Type"]="text/plain;charset=UTF-8");let i;try{i=await this._fetchType(t.url,{body:t.content,cache:"no-cache",credentials:t.withCredentials===!0?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...t.headers},method:t.method,mode:"cors",redirect:"follow",signal:e.signal})}catch(c){throw o||(this._logger.log(d.Warning,`Error from HTTP request. ${c}.`),c)}finally{r&&clearTimeout(r),t.abortSignal&&(t.abortSignal.onabort=null)}if(!i.ok){let c=await ps(i,"text");throw new z(c||i.statusText,i.status)}let s=await ps(i,t.responseType);return new nt(i.status,i.statusText,s)}getCookieString(t){let e="";return b.isNode&&this._jar&&this._jar.getCookies(t,(o,r)=>e=r.join("; ")),e}};function ps(n,t){let e;switch(t){case"arraybuffer":e=n.arrayBuffer();break;case"text":e=n.text();break;case"blob":case"document":case"json":throw new Error(`${t} is not supported.`);default:e=n.text();break}return e}var go=class extends ie{constructor(t){super(),this._logger=t}send(t){return t.abortSignal&&t.abortSignal.aborted?Promise.reject(new R):t.method?t.url?new Promise((e,o)=>{let r=new XMLHttpRequest;r.open(t.method,t.url,!0),r.withCredentials=t.withCredentials===void 0?!0:t.withCredentials,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.content===""&&(t.content=void 0),t.content&&(ke(t.content)?r.setRequestHeader("Content-Type","application/octet-stream"):r.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));let i=t.headers;i&&Object.keys(i).forEach(a=>{r.setRequestHeader(a,i[a])}),t.responseType&&(r.responseType=t.responseType),t.abortSignal&&(t.abortSignal.onabort=()=>{r.abort(),o(new R)}),t.timeout&&(r.timeout=t.timeout),r.onload=()=>{t.abortSignal&&(t.abortSignal.onabort=null),r.status>=200&&r.status<300?e(new nt(r.status,r.statusText,r.response||r.responseText)):o(new z(r.response||r.responseText||r.statusText,r.status))},r.onerror=()=>{this._logger.log(d.Warning,`Error from HTTP request. ${r.status}: ${r.statusText}.`),o(new z(r.statusText,r.status))},r.ontimeout=()=>{this._logger.log(d.Warning,"Timeout from HTTP request."),o(new _e)},r.send(t.content)}):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}};var xo=class extends ie{constructor(t){if(super(),typeof fetch<"u"||b.isNode)this._httpClient=new ho(t);else if(typeof XMLHttpRequest<"u")this._httpClient=new go(t);else throw new Error("No usable HttpClient found.")}send(t){return t.abortSignal&&t.abortSignal.aborted?Promise.reject(new R):t.method?t.url?this._httpClient.send(t):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}getCookieString(t){return this._httpClient.getCookieString(t)}};var I=class{static write(t){return`${t}${I.RecordSeparator}`}static parse(t){if(t[t.length-1]!==I.RecordSeparator)throw new Error("Message is incomplete.");let e=t.split(I.RecordSeparator);return e.pop(),e}};I.RecordSeparatorCode=30;I.RecordSeparator=String.fromCharCode(I.RecordSeparatorCode);var Fo=class{writeHandshakeRequest(t){return I.write(JSON.stringify(t))}parseHandshakeResponse(t){let e,o;if(ke(t)){let s=new Uint8Array(t),c=s.indexOf(I.RecordSeparatorCode);if(c===-1)throw new Error("Message is incomplete.");let u=c+1;e=String.fromCharCode.apply(null,Array.prototype.slice.call(s.slice(0,u))),o=s.byteLength>u?s.slice(u).buffer:null}else{let s=t,c=s.indexOf(I.RecordSeparator);if(c===-1)throw new Error("Message is incomplete.");let u=c+1;e=s.substring(0,u),o=s.length>u?s.substring(u):null}let r=I.parse(e),i=JSON.parse(r[0]);if(i.type)throw new Error("Expected a handshake response from the server.");return[o,i]}};var _;(function(n){n[n.Invocation=1]="Invocation",n[n.StreamItem=2]="StreamItem",n[n.Completion=3]="Completion",n[n.StreamInvocation=4]="StreamInvocation",n[n.CancelInvocation=5]="CancelInvocation",n[n.Ping=6]="Ping",n[n.Close=7]="Close"})(_||(_={}));var wo=class{constructor(){this.observers=[]}next(t){for(let e of this.observers)e.next(t)}error(t){for(let e of this.observers)e.error&&e.error(t)}complete(){for(let t of this.observers)t.complete&&t.complete()}subscribe(t){return this.observers.push(t),new lo(this,t)}};var bu=30*1e3,Au=15*1e3,S;(function(n){n.Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Disconnecting="Disconnecting",n.Reconnecting="Reconnecting"})(S||(S={}));var Ve=class{constructor(t,e,o,r){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(d.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://docs.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},v.isRequired(t,"connection"),v.isRequired(e,"logger"),v.isRequired(o,"protocol"),this.serverTimeoutInMilliseconds=bu,this.keepAliveIntervalInMilliseconds=Au,this._logger=e,this._protocol=o,this.connection=t,this._reconnectPolicy=r,this._handshakeProtocol=new Fo,this.connection.onreceive=i=>this._processIncomingData(i),this.connection.onclose=i=>this._connectionClosed(i),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=S.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:_.Ping})}static create(t,e,o,r){return new Ve(t,e,o,r)}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(t){if(this._connectionState!==S.Disconnected&&this._connectionState!==S.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!t)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=t}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==S.Disconnected)return Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=S.Connecting,this._logger.log(d.Debug,"Starting HubConnection.");try{await this._startInternal(),b.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=S.Connected,this._connectionStarted=!0,this._logger.log(d.Debug,"HubConnection connected successfully.")}catch(t){return this._connectionState=S.Disconnected,this._logger.log(d.Debug,`HubConnection failed to start successfully because of error '${t}'.`),Promise.reject(t)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let t=new Promise((e,o)=>{this._handshakeResolver=e,this._handshakeRejecter=o});await this.connection.start(this._protocol.transferFormat);try{let e={protocol:this._protocol.name,version:this._protocol.version};if(this._logger.log(d.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(e)),this._logger.log(d.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await t,this._stopDuringStartError)throw this._stopDuringStartError;this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(e){throw this._logger.log(d.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){let t=this._startPromise;this._stopPromise=this._stopInternal(),await this._stopPromise;try{await t}catch{}}_stopInternal(t){return this._connectionState===S.Disconnected?(this._logger.log(d.Debug,`Call to HubConnection.stop(${t}) ignored because it is already in the disconnected state.`),Promise.resolve()):this._connectionState===S.Disconnecting?(this._logger.log(d.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):(this._connectionState=S.Disconnecting,this._logger.log(d.Debug,"Stopping HubConnection."),this._reconnectDelayHandle?(this._logger.log(d.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=t||new R("The connection was stopped before the hub handshake could complete."),this.connection.stop(t)))}stream(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._createStreamInvocation(t,e,r),a,s=new wo;return s.cancelCallback=()=>{let c=this._createCancelInvocation(i.invocationId);return delete this._callbacks[i.invocationId],a.then(()=>this._sendWithProtocol(c))},this._callbacks[i.invocationId]=(c,u)=>{if(u){s.error(u);return}else c&&(c.type===_.Completion?c.error?s.error(new Error(c.error)):s.complete():s.next(c.item))},a=this._sendWithProtocol(i).catch(c=>{s.error(c),delete this._callbacks[i.invocationId]}),this._launchStreams(o,a),s}_sendMessage(t){return this._resetKeepAliveInterval(),this.connection.send(t)}_sendWithProtocol(t){return this._sendMessage(this._protocol.writeMessage(t))}send(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._sendWithProtocol(this._createInvocation(t,e,!0,r));return this._launchStreams(o,i),i}invoke(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._createInvocation(t,e,!1,r);return new Promise((s,c)=>{this._callbacks[i.invocationId]=(p,l)=>{if(l){c(l);return}else p&&(p.type===_.Completion?p.error?c(new Error(p.error)):s(p.result):c(new Error(`Unexpected message type: ${p.type}`)))};let u=this._sendWithProtocol(i).catch(p=>{c(p),delete this._callbacks[i.invocationId]});this._launchStreams(o,u)})}on(t,e){!t||!e||(t=t.toLowerCase(),this._methods[t]||(this._methods[t]=[]),this._methods[t].indexOf(e)===-1&&this._methods[t].push(e))}off(t,e){if(!t)return;t=t.toLowerCase();let o=this._methods[t];if(o)if(e){let r=o.indexOf(e);r!==-1&&(o.splice(r,1),o.length===0&&delete this._methods[t])}else delete this._methods[t]}onclose(t){t&&this._closedCallbacks.push(t)}onreconnecting(t){t&&this._reconnectingCallbacks.push(t)}onreconnected(t){t&&this._reconnectedCallbacks.push(t)}_processIncomingData(t){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(t=this._processHandshakeResponse(t),this._receivedHandshakeResponse=!0),t){let e=this._protocol.parseMessages(t,this._logger);for(let o of e)switch(o.type){case _.Invocation:this._invokeClientMethod(o);break;case _.StreamItem:case _.Completion:{let r=this._callbacks[o.invocationId];if(r){o.type===_.Completion&&delete this._callbacks[o.invocationId];try{r(o)}catch(i){this._logger.log(d.Error,`Stream callback threw error: ${$r(i)}`)}}break}case _.Ping:break;case _.Close:{this._logger.log(d.Information,"Close message received from server.");let r=o.error?new Error("Server returned an error on close: "+o.error):void 0;o.allowReconnect===!0?this.connection.stop(r):this._stopPromise=this._stopInternal(r);break}default:this._logger.log(d.Warning,`Invalid message type: ${o.type}.`);break}}this._resetTimeoutPeriod()}_processHandshakeResponse(t){let e,o;try{[o,e]=this._handshakeProtocol.parseHandshakeResponse(t)}catch(r){let i="Error parsing handshake response: "+r;this._logger.log(d.Error,i);let a=new Error(i);throw this._handshakeRejecter(a),a}if(e.error){let r="Server returned handshake error: "+e.error;this._logger.log(d.Error,r);let i=new Error(r);throw this._handshakeRejecter(i),i}else this._logger.log(d.Debug,"Server handshake complete.");return this._handshakeResolver(),o}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),this._pingServerHandle===void 0)){let t=this._nextKeepAlive-new Date().getTime();t<0&&(t=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===S.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},t)}}serverTimeout(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(t){let e=t.target.toLowerCase(),o=this._methods[e];if(!o){this._logger.log(d.Warning,`No client method with the name '${e}' found.`),t.invocationId&&(this._logger.log(d.Warning,`No result given for '${e}' method and invocation ID '${t.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(t.invocationId,"Client didn't provide a result.",null)));return}let r=o.slice(),i=!!t.invocationId,a,s,c;for(let u of r)try{let p=a;a=await u.apply(this,t.arguments),i&&a&&p&&(this._logger.log(d.Error,`Multiple results provided for '${e}'. Sending error to server.`),c=this._createCompletionMessage(t.invocationId,"Client provided multiple results.",null)),s=void 0}catch(p){s=p,this._logger.log(d.Error,`A callback for the method '${e}' threw error '${p}'.`)}c?await this._sendWithProtocol(c):i?(s?c=this._createCompletionMessage(t.invocationId,`${s}`,null):a!==void 0?c=this._createCompletionMessage(t.invocationId,null,a):(this._logger.log(d.Warning,`No result given for '${e}' method and invocation ID '${t.invocationId}'.`),c=this._createCompletionMessage(t.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(c)):a&&this._logger.log(d.Error,`Result given for '${e}' method but server is not expecting a result.`)}_connectionClosed(t){this._logger.log(d.Debug,`HubConnection.connectionClosed(${t}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||t||new R("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(t||new Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===S.Disconnecting?this._completeClose(t):this._connectionState===S.Connected&&this._reconnectPolicy?this._reconnect(t):this._connectionState===S.Connected&&this._completeClose(t)}_completeClose(t){if(this._connectionStarted){this._connectionState=S.Disconnected,this._connectionStarted=!1,b.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(e=>e.apply(this,[t]))}catch(e){this._logger.log(d.Error,`An onclose callback called with error '${t}' threw error '${e}'.`)}}}async _reconnect(t){let e=Date.now(),o=0,r=t!==void 0?t:new Error("Attempting to reconnect due to a unknown error."),i=this._getNextRetryDelay(o++,0,r);if(i===null){this._logger.log(d.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(t);return}if(this._connectionState=S.Reconnecting,t?this._logger.log(d.Information,`Connection reconnecting because of error '${t}'.`):this._logger.log(d.Information,"Connection reconnecting."),this._reconnectingCallbacks.length!==0){try{this._reconnectingCallbacks.forEach(a=>a.apply(this,[t]))}catch(a){this._logger.log(d.Error,`An onreconnecting callback called with error '${t}' threw error '${a}'.`)}if(this._connectionState!==S.Reconnecting){this._logger.log(d.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.");return}}for(;i!==null;){if(this._logger.log(d.Information,`Reconnect attempt number ${o} will start in ${i} ms.`),await new Promise(a=>{this._reconnectDelayHandle=setTimeout(a,i)}),this._reconnectDelayHandle=void 0,this._connectionState!==S.Reconnecting){this._logger.log(d.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");return}try{if(await this._startInternal(),this._connectionState=S.Connected,this._logger.log(d.Information,"HubConnection reconnected successfully."),this._reconnectedCallbacks.length!==0)try{this._reconnectedCallbacks.forEach(a=>a.apply(this,[this.connection.connectionId]))}catch(a){this._logger.log(d.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${a}'.`)}return}catch(a){if(this._logger.log(d.Information,`Reconnect attempt failed because of error '${a}'.`),this._connectionState!==S.Reconnecting){this._logger.log(d.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===S.Disconnecting&&this._completeClose();return}r=a instanceof Error?a:new Error(a.toString()),i=this._getNextRetryDelay(o++,Date.now()-e,r)}}this._logger.log(d.Information,`Reconnect retries have been exhausted after ${Date.now()-e} ms and ${o} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(t,e,o){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:e,previousRetryCount:t,retryReason:o})}catch(r){return this._logger.log(d.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${t}, ${e}) threw error '${r}'.`),null}}_cancelCallbacksWithError(t){let e=this._callbacks;this._callbacks={},Object.keys(e).forEach(o=>{let r=e[o];try{r(null,t)}catch(i){this._logger.log(d.Error,`Stream 'error' callback called with '${t}' threw error: ${$r(i)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(t,e,o,r){if(o)return r.length!==0?{arguments:e,streamIds:r,target:t,type:_.Invocation}:{arguments:e,target:t,type:_.Invocation};{let i=this._invocationId;return this._invocationId++,r.length!==0?{arguments:e,invocationId:i.toString(),streamIds:r,target:t,type:_.Invocation}:{arguments:e,invocationId:i.toString(),target:t,type:_.Invocation}}}_launchStreams(t,e){if(t.length!==0){e||(e=Promise.resolve());for(let o in t)t[o].subscribe({complete:()=>{e=e.then(()=>this._sendWithProtocol(this._createCompletionMessage(o)))},error:r=>{let i;r instanceof Error?i=r.message:r&&r.toString?i=r.toString():i="Unknown error",e=e.then(()=>this._sendWithProtocol(this._createCompletionMessage(o,i)))},next:r=>{e=e.then(()=>this._sendWithProtocol(this._createStreamItemMessage(o,r)))}})}}_replaceStreamingParams(t){let e=[],o=[];for(let r=0;r<t.length;r++){let i=t[r];if(this._isObservable(i)){let a=this._invocationId;this._invocationId++,e[a]=i,o.push(a.toString()),t.splice(r,1)}}return[e,o]}_isObservable(t){return t&&t.subscribe&&typeof t.subscribe=="function"}_createStreamInvocation(t,e,o){let r=this._invocationId;return this._invocationId++,o.length!==0?{arguments:e,invocationId:r.toString(),streamIds:o,target:t,type:_.StreamInvocation}:{arguments:e,invocationId:r.toString(),target:t,type:_.StreamInvocation}}_createCancelInvocation(t){return{invocationId:t,type:_.CancelInvocation}}_createStreamItemMessage(t,e){return{invocationId:t,item:e,type:_.StreamItem}}_createCompletionMessage(t,e,o){return e?{error:e,invocationId:t,type:_.Completion}:{invocationId:t,result:o,type:_.Completion}}};var Eu=[0,2e3,1e4,3e4,null],Pt=class{constructor(t){this._retryDelays=t!==void 0?[...t,null]:Eu}nextRetryDelayInMilliseconds(t){return this._retryDelays[t.previousRetryCount]}};var $=class{};$.Authorization="Authorization";$.Cookie="Cookie";var fo=class extends ie{constructor(t,e){super(),this._innerClient=t,this._accessTokenFactory=e}async send(t){let e=!0;this._accessTokenFactory&&(!this._accessToken||t.url&&t.url.indexOf("/negotiate?")>0)&&(e=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(t);let o=await this._innerClient.send(t);return e&&o.statusCode===401&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(t),await this._innerClient.send(t)):o}_setAuthorizationHeader(t){t.headers||(t.headers={}),this._accessToken?t.headers[$.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&t.headers[$.Authorization]&&delete t.headers[$.Authorization]}getCookieString(t){return this._innerClient.getCookieString(t)}};var D;(function(n){n[n.None=0]="None",n[n.WebSockets=1]="WebSockets",n[n.ServerSentEvents=2]="ServerSentEvents",n[n.LongPolling=4]="LongPolling"})(D||(D={}));var y;(function(n){n[n.Text=1]="Text",n[n.Binary=2]="Binary"})(y||(y={}));var So=class{constructor(){this._isAborted=!1,this.onabort=null}abort(){this._isAborted||(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}};var Vt=class{constructor(t,e,o){this._httpClient=t,this._logger=e,this._pollAbort=new So,this._options=o,this._running=!1,this.onreceive=null,this.onclose=null}get pollAborted(){return this._pollAbort.aborted}async connect(t,e){if(v.isRequired(t,"url"),v.isRequired(e,"transferFormat"),v.isIn(e,y,"transferFormat"),this._url=t,this._logger.log(d.Trace,"(LongPolling transport) Connecting."),e===y.Binary&&typeof XMLHttpRequest<"u"&&typeof new XMLHttpRequest().responseType!="string")throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[o,r]=se(),i={[o]:r,...this._options.headers},a={abortSignal:this._pollAbort.signal,headers:i,timeout:1e5,withCredentials:this._options.withCredentials};e===y.Binary&&(a.responseType="arraybuffer");let s=`${t}&_=${Date.now()}`;this._logger.log(d.Trace,`(LongPolling transport) polling: ${s}.`);let c=await this._httpClient.get(s,a);c.statusCode!==200?(this._logger.log(d.Error,`(LongPolling transport) Unexpected response code: ${c.statusCode}.`),this._closeError=new z(c.statusText||"",c.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,a)}async _poll(t,e){try{for(;this._running;)try{let o=`${t}&_=${Date.now()}`;this._logger.log(d.Trace,`(LongPolling transport) polling: ${o}.`);let r=await this._httpClient.get(o,e);r.statusCode===204?(this._logger.log(d.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):r.statusCode!==200?(this._logger.log(d.Error,`(LongPolling transport) Unexpected response code: ${r.statusCode}.`),this._closeError=new z(r.statusText||"",r.statusCode),this._running=!1):r.content?(this._logger.log(d.Trace,`(LongPolling transport) data received. ${Te(r.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(r.content)):this._logger.log(d.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(o){this._running?o instanceof _e?this._logger.log(d.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=o,this._running=!1):this._logger.log(d.Trace,`(LongPolling transport) Poll errored after shutdown: ${o.message}`)}}finally{this._logger.log(d.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(t){return this._running?mo(this._logger,"LongPolling",this._httpClient,this._url,t,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(d.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(d.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let t={},[e,o]=se();t[e]=o;let r={headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};await this._httpClient.delete(this._url,r),this._logger.log(d.Trace,"(LongPolling transport) DELETE request sent.")}finally{this._logger.log(d.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let t="(LongPolling transport) Firing onclose event.";this._closeError&&(t+=" Error: "+this._closeError),this._logger.log(d.Trace,t),this.onclose(this._closeError)}}};var _o=class{constructor(t,e,o,r){this._httpClient=t,this._accessToken=e,this._logger=o,this._options=r,this.onreceive=null,this.onclose=null}async connect(t,e){return v.isRequired(t,"url"),v.isRequired(e,"transferFormat"),v.isIn(e,y,"transferFormat"),this._logger.log(d.Trace,"(SSE transport) Connecting."),this._url=t,this._accessToken&&(t+=(t.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((o,r)=>{let i=!1;if(e!==y.Text){r(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"));return}let a;if(b.isBrowser||b.isWebWorker)a=new this._options.EventSource(t,{withCredentials:this._options.withCredentials});else{let s=this._httpClient.getCookieString(t),c={};c.Cookie=s;let[u,p]=se();c[u]=p,a=new this._options.EventSource(t,{withCredentials:this._options.withCredentials,headers:{...c,...this._options.headers}})}try{a.onmessage=s=>{if(this.onreceive)try{this._logger.log(d.Trace,`(SSE transport) data received. ${Te(s.data,this._options.logMessageContent)}.`),this.onreceive(s.data)}catch(c){this._close(c);return}},a.onerror=s=>{i?this._close():r(new Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},a.onopen=()=>{this._logger.log(d.Information,`SSE connected to ${this._url}`),this._eventSource=a,i=!0,o()}}catch(s){r(s);return}})}async send(t){return this._eventSource?mo(this._logger,"SSE",this._httpClient,this._url,t,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(t){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(t))}};var To=class{constructor(t,e,o,r,i,a){this._logger=o,this._accessTokenFactory=e,this._logMessageContent=r,this._webSocketConstructor=i,this._httpClient=t,this.onreceive=null,this.onclose=null,this._headers=a}async connect(t,e){v.isRequired(t,"url"),v.isRequired(e,"transferFormat"),v.isIn(e,y,"transferFormat"),this._logger.log(d.Trace,"(WebSockets transport) Connecting.");let o;return this._accessTokenFactory&&(o=await this._accessTokenFactory()),new Promise((r,i)=>{t=t.replace(/^http/,"ws");let a,s=this._httpClient.getCookieString(t),c=!1;if(b.isNode||b.isReactNative){let u={},[p,l]=se();u[p]=l,o&&(u[$.Authorization]=`Bearer ${o}`),s&&(u[$.Cookie]=s),a=new this._webSocketConstructor(t,void 0,{headers:{...u,...this._headers}})}else o&&(t+=(t.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(o)}`);a||(a=new this._webSocketConstructor(t)),e===y.Binary&&(a.binaryType="arraybuffer"),a.onopen=u=>{this._logger.log(d.Information,`WebSocket connected to ${t}.`),this._webSocket=a,c=!0,r()},a.onerror=u=>{let p=null;typeof ErrorEvent<"u"&&u instanceof ErrorEvent?p=u.error:p="There was an error with the transport",this._logger.log(d.Information,`(WebSockets transport) ${p}.`)},a.onmessage=u=>{if(this._logger.log(d.Trace,`(WebSockets transport) data received. ${Te(u.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(u.data)}catch(p){this._close(p);return}},a.onclose=u=>{if(c)this._close(u);else{let p=null;typeof ErrorEvent<"u"&&u instanceof ErrorEvent?p=u.error:p="WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled.",i(new Error(p))}}})}send(t){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(d.Trace,`(WebSockets transport) sending data. ${Te(t,this._logMessageContent)}.`),this._webSocket.send(t),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(t){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(d.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(t)&&(t.wasClean===!1||t.code!==1e3)?this.onclose(new Error(`WebSocket closed with status code: ${t.code} (${t.reason||"no reason given"}).`)):t instanceof Error?this.onclose(t):this.onclose())}_isCloseEvent(t){return t&&typeof t.wasClean=="boolean"&&typeof t.code=="number"}};var ls=100,ko=class{constructor(t,e={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,v.isRequired(t,"url"),this._logger=cs(e.logger),this.baseUrl=this._resolveUrl(t),e=e||{},e.logMessageContent=e.logMessageContent===void 0?!1:e.logMessageContent,typeof e.withCredentials=="boolean"||e.withCredentials===void 0)e.withCredentials=e.withCredentials===void 0?!0:e.withCredentials;else throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");e.timeout=e.timeout===void 0?100*1e3:e.timeout;let o=null,r=null;if(b.isNode&&typeof We<"u"){let i=typeof __webpack_require__=="function"?__non_webpack_require__:We;o=i("ws"),r=i("eventsource")}!b.isNode&&typeof WebSocket<"u"&&!e.WebSocket?e.WebSocket=WebSocket:b.isNode&&!e.WebSocket&&o&&(e.WebSocket=o),!b.isNode&&typeof EventSource<"u"&&!e.EventSource?e.EventSource=EventSource:b.isNode&&!e.EventSource&&typeof r<"u"&&(e.EventSource=r),this._httpClient=new fo(e.httpClient||new xo(this._logger),e.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=e,this.onreceive=null,this.onclose=null}async start(t){if(t=t||y.Binary,v.isIn(t,y,"transferFormat"),this._logger.log(d.Debug,`Starting connection with transfer format '${y[t]}'.`),this._connectionState!=="Disconnected")return Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(t),await this._startInternalPromise,this._connectionState==="Disconnecting"){let e="Failed to start the HttpConnection before stop() was called.";return this._logger.log(d.Error,e),await this._stopPromise,Promise.reject(new R(e))}else if(this._connectionState!=="Connected"){let e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(d.Error,e),Promise.reject(new R(e))}this._connectionStarted=!0}send(t){return this._connectionState!=="Connected"?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new It(this.transport)),this._sendQueue.send(t))}async stop(t){if(this._connectionState==="Disconnected")return this._logger.log(d.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnected state.`),Promise.resolve();if(this._connectionState==="Disconnecting")return this._logger.log(d.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(t),await this._stopPromise}async _stopInternal(t){this._stopError=t;try{await this._startInternalPromise}catch{}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(d.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(d.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(t){let e=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===D.WebSockets)this.transport=this._constructTransport(D.WebSockets),await this._startTransport(e,t);else throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let o=null,r=0;do{if(o=await this._getNegotiationResponse(e),this._connectionState==="Disconnecting"||this._connectionState==="Disconnected")throw new R("The connection was stopped during negotiation.");if(o.error)throw new Error(o.error);if(o.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(o.url&&(e=o.url),o.accessToken){let i=o.accessToken;this._accessTokenFactory=()=>i,this._httpClient._accessToken=i,this._httpClient._accessTokenFactory=void 0}r++}while(o.url&&r<ls);if(r===ls&&o.url)throw new Error("Negotiate redirection limit exceeded.");await this._createTransport(e,this._options.transport,o,t)}this.transport instanceof Vt&&(this.features.inherentKeepAlive=!0),this._connectionState==="Connecting"&&(this._logger.log(d.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(o){return this._logger.log(d.Error,"Failed to start the connection: "+o),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(o)}}async _getNegotiationResponse(t){let e={},[o,r]=se();e[o]=r;let i=this._resolveNegotiateUrl(t);this._logger.log(d.Debug,`Sending negotiation request: ${i}.`);try{let a=await this._httpClient.post(i,{content:"",headers:{...e,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(a.statusCode!==200)return Promise.reject(new Error(`Unexpected status code returned from negotiate '${a.statusCode}'`));let s=JSON.parse(a.content);return(!s.negotiateVersion||s.negotiateVersion<1)&&(s.connectionToken=s.connectionId),s}catch(a){let s="Failed to complete negotiation with the server: "+a;return a instanceof z&&a.statusCode===404&&(s=s+" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(d.Error,s),Promise.reject(new uo(s))}}_createConnectUrl(t,e){return e?t+(t.indexOf("?")===-1?"?":"&")+`id=${e}`:t}async _createTransport(t,e,o,r){let i=this._createConnectUrl(t,o.connectionToken);if(this._isITransport(e)){this._logger.log(d.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,await this._startTransport(i,r),this.connectionId=o.connectionId;return}let a=[],s=o.availableTransports||[],c=o;for(let u of s){let p=this._resolveTransportOrError(u,e,r);if(p instanceof Error)a.push(`${u.transport} failed:`),a.push(p);else if(this._isITransport(p)){if(this.transport=p,!c){try{c=await this._getNegotiationResponse(t)}catch(l){return Promise.reject(l)}i=this._createConnectUrl(t,c.connectionToken)}try{await this._startTransport(i,r),this.connectionId=c.connectionId;return}catch(l){if(this._logger.log(d.Error,`Failed to start the transport '${u.transport}': ${l}`),c=void 0,a.push(new co(`${u.transport} failed: ${l}`,D[u.transport])),this._connectionState!=="Connecting"){let h="Failed to select transport before stop() was called.";return this._logger.log(d.Debug,h),Promise.reject(new R(h))}}}}return a.length>0?Promise.reject(new po(`Unable to connect to the server with any of the available transports. ${a.join(" ")}`,a)):Promise.reject(new Error("None of the transports supported by the client are supported by the server."))}_constructTransport(t){switch(t){case D.WebSockets:if(!this._options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new To(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case D.ServerSentEvents:if(!this._options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new _o(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case D.LongPolling:return new Vt(this._httpClient,this._logger,this._options);default:throw new Error(`Unknown transport: ${t}.`)}}_startTransport(t,e){return this.transport.onreceive=this.onreceive,this.transport.onclose=o=>this._stopConnection(o),this.transport.connect(t,e)}_resolveTransportOrError(t,e,o){let r=D[t.transport];if(r==null)return this._logger.log(d.Debug,`Skipping transport '${t.transport}' because it is not supported by this client.`),new Error(`Skipping transport '${t.transport}' because it is not supported by this client.`);if(Cu(e,r))if(t.transferFormats.map(a=>y[a]).indexOf(o)>=0){if(r===D.WebSockets&&!this._options.WebSocket||r===D.ServerSentEvents&&!this._options.EventSource)return this._logger.log(d.Debug,`Skipping transport '${D[r]}' because it is not supported in your environment.'`),new ao(`'${D[r]}' is not supported in your environment.`,r);this._logger.log(d.Debug,`Selecting transport '${D[r]}'.`);try{return this._constructTransport(r)}catch(a){return a}}else return this._logger.log(d.Debug,`Skipping transport '${D[r]}' because it does not support the requested transfer format '${y[o]}'.`),new Error(`'${D[r]}' does not support ${y[o]}.`);else return this._logger.log(d.Debug,`Skipping transport '${D[r]}' because it was disabled by the client.`),new so(`'${D[r]}' is disabled by the client.`,r)}_isITransport(t){return t&&typeof t=="object"&&"connect"in t}_stopConnection(t){if(this._logger.log(d.Debug,`HttpConnection.stopConnection(${t}) called while in state ${this._connectionState}.`),this.transport=void 0,t=this._stopError||t,this._stopError=void 0,this._connectionState==="Disconnected"){this._logger.log(d.Debug,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is already in the disconnected state.`);return}if(this._connectionState==="Connecting")throw this._logger.log(d.Warning,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is still in the connecting state.`),new Error(`HttpConnection.stopConnection(${t}) was called while the connection is still in the connecting state.`);if(this._connectionState==="Disconnecting"&&this._stopPromiseResolver(),t?this._logger.log(d.Error,`Connection disconnected with error '${t}'.`):this._logger.log(d.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(d.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(t)}catch(e){this._logger.log(d.Error,`HttpConnection.onclose(${t}) threw error '${e}'.`)}}}_resolveUrl(t){if(t.lastIndexOf("https://",0)===0||t.lastIndexOf("http://",0)===0)return t;if(!b.isBrowser)throw new Error(`Cannot resolve '${t}'.`);let e=window.document.createElement("a");return e.href=t,this._logger.log(d.Information,`Normalizing '${t}' to '${e.href}'.`),e.href}_resolveNegotiateUrl(t){let e=t.indexOf("?"),o=t.substring(0,e===-1?t.length:e);return o[o.length-1]!=="/"&&(o+="/"),o+="negotiate",o+=e===-1?"":t.substring(e),o.indexOf("negotiateVersion")===-1&&(o+=e===-1?"?":"&",o+="negotiateVersion="+this._negotiateVersion),o}};function Cu(n,t){return!n||(t&n)!==0}var It=class{constructor(t){this._transport=t,this._buffer=[],this._executing=!0,this._sendBufferedData=new ot,this._transportResult=new ot,this._sendLoopPromise=this._sendLoop()}send(t){return this._bufferData(t),this._transportResult||(this._transportResult=new ot),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(t){if(this._buffer.length&&typeof this._buffer[0]!=typeof t)throw new Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof t}`);this._buffer.push(t),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new ot;let t=this._transportResult;this._transportResult=void 0;let e=typeof this._buffer[0]=="string"?this._buffer.join(""):It._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(e),t.resolve()}catch(o){t.reject(o)}}}static _concatBuffers(t){let e=t.map(i=>i.byteLength).reduce((i,a)=>i+a),o=new Uint8Array(e),r=0;for(let i of t)o.set(new Uint8Array(i),r),r+=i.byteLength;return o.buffer}},ot=class{constructor(){this.promise=new Promise((t,e)=>[this._resolver,this._rejecter]=[t,e])}resolve(){this._resolver()}reject(t){this._rejecter(t)}};var Mu="json",vo=class{constructor(){this.name=Mu,this.version=1,this.transferFormat=y.Text}parseMessages(t,e){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)return[];e===null&&(e=ae.instance);let o=I.parse(t),r=[];for(let i of o){let a=JSON.parse(i);if(typeof a.type!="number")throw new Error("Invalid payload.");switch(a.type){case _.Invocation:this._isInvocationMessage(a);break;case _.StreamItem:this._isStreamItemMessage(a);break;case _.Completion:this._isCompletionMessage(a);break;case _.Ping:break;case _.Close:break;default:e.log(d.Information,"Unknown message type '"+a.type+"' ignored.");continue}r.push(a)}return r}writeMessage(t){return I.write(JSON.stringify(t))}_isInvocationMessage(t){this._assertNotEmptyString(t.target,"Invalid payload for Invocation message."),t.invocationId!==void 0&&this._assertNotEmptyString(t.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(t){if(this._assertNotEmptyString(t.invocationId,"Invalid payload for StreamItem message."),t.item===void 0)throw new Error("Invalid payload for StreamItem message.")}_isCompletionMessage(t){if(t.result&&t.error)throw new Error("Invalid payload for Completion message.");!t.result&&t.error&&this._assertNotEmptyString(t.error,"Invalid payload for Completion message."),this._assertNotEmptyString(t.invocationId,"Invalid payload for Completion message.")}_assertNotEmptyString(t,e){if(typeof t!="string"||t==="")throw new Error(e)}};var Du={trace:d.Trace,debug:d.Debug,info:d.Information,information:d.Information,warn:d.Warning,warning:d.Warning,error:d.Error,critical:d.Critical,none:d.None};function yu(n){let t=Du[n.toLowerCase()];if(typeof t<"u")return t;throw new Error(`Unknown log level: ${n}`)}var Wt=class{configureLogging(t){if(v.isRequired(t,"logging"),Lu(t))this.logger=t;else if(typeof t=="string"){let e=yu(t);this.logger=new Pe(e)}else this.logger=new Pe(t);return this}withUrl(t,e){return v.isRequired(t,"url"),v.isNotEmpty(t,"url"),this.url=t,typeof e=="object"?this.httpConnectionOptions={...this.httpConnectionOptions,...e}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:e},this}withHubProtocol(t){return v.isRequired(t,"protocol"),this.protocol=t,this}withAutomaticReconnect(t){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return t?Array.isArray(t)?this.reconnectPolicy=new Pt(t):this.reconnectPolicy=t:this.reconnectPolicy=new Pt,this}build(){let t=this.httpConnectionOptions||{};if(t.logger===void 0&&(t.logger=this.logger),!this.url)throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let e=new ko(this.url,t);return Ve.create(e,this.logger||ae.instance,this.protocol||new vo,this.reconnectPolicy)}};function Lu(n){return n.log!==void 0}var Bu=new Map([[S.Connected,"Connected"],[S.Connecting,"Connecting"],[S.Reconnecting,"Connecting"],[S.Disconnected,"Disconnected"],[S.Disconnecting,"Disconnecting"]]),bo=class extends B{constructor(e){super();this.hub=new Wt().withAutomaticReconnect().withUrl(e,D.WebSockets).build(),this.hub.onclose(()=>this.dispatchEvent(new Qn)),this.hub.onreconnecting(r=>this.dispatchEvent(new Yn(r))),this.hub.onreconnected(()=>this.dispatchEvent(new Zn)),this.hub.on("userJoined",(r,i)=>this.dispatchEvent(new eo(r,i))),this.hub.on("iceReceived",(r,i)=>this.dispatchEvent(new to(r,i))),this.hub.on("offerReceived",(r,i)=>this.dispatchEvent(new no(r,i))),this.hub.on("answerReceived",(r,i)=>this.dispatchEvent(new oo(r,i))),this.hub.on("userLeft",r=>this.dispatchEvent(new ro(r)));let o=new io;this.hub.on("chat",(r,i)=>{o.set(r,i),this.dispatchEvent(o)}),window.addEventListener("unload",()=>this.stop())}start(){return this.hub.start()}stop(){return this.hub.stop()}invoke(e,...o){return this.hub.invoke(e,...o)}get connectionState(){return Bu.get(this.hub.state)}};var Qr=class extends vn{constructor(e){super(e);this.hubName=null;Object.seal(this)}async init(e){if(this.hubName=e.get("hub"),!this.hubName)throw new Error("Missing hub parameter");await super.init(e)}setConferenceInfo(e,o,r){return this.log("connect",{userName:o,meetingID:r,userType:e}),super.setConferenceInfo(e,o,r)}createConference(){return new Kn(this.env.audio,this.env.microphones,this.env.webcams,new bo(this.hubName))}};export{Qr as default};
