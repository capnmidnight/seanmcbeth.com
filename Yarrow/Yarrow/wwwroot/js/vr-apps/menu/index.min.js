function $(e,t,o){return typeof e===t||e instanceof o}function v(e){return $(e,"function",Function)}function u(e){return $(e,"string",String)}function D(e){return $(e,"boolean",Boolean)}function A(e){return $(e,"number",Number)}function Ko(e){return d(e)||!Number.isFinite(e)||Number.isNaN(e)}function mt(e){return A(e)&&!Ko(e)}function I(e){return a(e)&&$(e,"object",Object)}function Jt(e){return e instanceof Array}function d(e){return e==null}function a(e){return!d(e)}function Le(e){return I(e)&&"compareTo"in e&&v(e.compareTo)}function Fe(e,...t){let o=null;u(e)?o=e:(o="ascending",t.unshift(e));let n=o==="ascending"?1:-1;return Object.assign((i,s)=>{if(i===s)return 0;for(let p of t){let c=d(i)?null:p(i),l=d(s)?null:p(s),x=c===l?0:u(c)&&u(l)?n*c.localeCompare(l):Le(c)&&Le(l)?n*c.compareTo(l):o==="ascending"&&c>l||o==="descending"&&c<l?1:-1;if(x!==0)return x}return 0},{direction:o})}function Yo(e,t,o,n="search"){let r=0,i=e.length-1;for(;r<=i;){let s=r+i>>1,p=o(e[s],t);if(p===0){if(n!=="search"){let c=n==="append"?1:-1;for(c>0&&(s+=c);0<=s&&s<e.length&&(p=o(e[s],t))===0;)s+=c;c<0&&(s-=c)}return s}else p<0?r=s-p:i=s-p}return-r-1}function $t(e,t,o,n="search"){let r=n!=="set";n==="set"&&(n="search");let i=null;if(A(o)?i=o:i=Yo(e,t,o,n),i<0)i=-i-1;else if(!r)return-1;return Kt(e,t,i),i}function E(e){return e.splice(0)}function Be(e,t){for(let o=0;o<e.length;++o)if(e[o]!==t[o])return o;return-1}function Kt(e,t,o){e.splice(o,0,t)}function S(e,t){let o=e.indexOf(t);return o>-1?(Yt(e,o),!0):!1}function Yt(e,t){return e.splice(t,1)[0]}function je(e,...t){e.splice(0,e.length,...t)}function Zo(e,t,o){let n=e?0:t.length-1,r=e?t.length:-1,i=e?1:-1;for(let s of o)for(let p=n;p!=r;p+=i){let c=t[p];if(s(c))return c}return null}function xt(e,...t){return Zo(!0,e,t)}var ut=class{constructor(t){if(this.items=new Map,this.defaultItems=new Array,a(t))for(let[o,n]of t)this.add(o,n)}add(t,...o){for(let n of o)if(d(t))this.defaultItems.push(n);else{let r=this.items.get(t);d(r)&&this.items.set(t,r=[]),r.push(n)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let t of this.defaultItems)yield t;for(let t of this.items.values())for(let o of t)yield o}has(t){return a(t)?this.items.has(t):this.defaultItems.length>0}get(t){return d(t)?this.defaultItems:this.items.get(t)||[]}count(t){if(d(t))return this.defaultItems.length;let o=this.get(t);return a(o)?o.length:0}get size(){let t=this.defaultItems.length;for(let o of this.items.values())t+=o.length;return t}delete(t){return d(t)?E(this.defaultItems).length>0:this.items.delete(t)}remove(t,o){if(d(t))S(this.defaultItems,o);else{let n=this.items.get(t);a(n)&&(S(n,o),n.length===0&&this.items.delete(t))}}clear(){this.items.clear(),E(this.defaultItems)}};function Qo(e){return e[0]}function tn(e){return e.shift()}function en(e){return e[e.length-1]}function on(e){return e.pop()}var _t=class{constructor(t){this.value=t,this._forward=new Array,this._reverse=new Array}connectSorted(t,o){if(a(o)){let n=Fe(r=>o(r.value));$t(this._forward,t,n),$t(t._reverse,this,n)}else this.connectTo(t)}connectTo(t){this.connectAt(t,this._forward.length)}connectAt(t,o){Kt(this._forward,t,o),t._reverse.push(this)}disconnectFrom(t){S(this._forward,t),S(t._reverse,this)}isConnectedTo(t){return this._forward.indexOf(t)>=0||this._reverse.indexOf(t)>=0}flatten(){let t=new Set,o=[this];for(;o.length>0;){let n=o.shift();a(n)&&!t.has(n)&&(t.add(n),o.push(...n._forward))}return Array.from(t)}*traverse(t){let o=new Set,n=[this],r=t?Qo:en,i=t?tn:on;for(;n.length>0;){let s=r(n);o.has(s)?t||(i(n),yield s):(o.add(s),t&&(i(n),yield s),s._forward.length>0&&n.push(...s._forward))}}breadthFirst(){return this.traverse(!0)}depthFirst(){return this.traverse(!1)}search(t,o=!0){for(let n of this.traverse(o))if(t(n))return n;return null}*searchAll(t,o=!0){for(let n of this.traverse(o))t(n)&&(yield n)}find(t,o=!0){return this.search(n=>n.value===t,o)}findAll(t,o=!0){return this.searchAll(n=>n.value===t,o)}contains(t,o=!0){for(let n of this.traverse(o))if(n===t)return!0;return!1}containsValue(t,o=!0){for(let n of this.traverse(o))if(n.value===t)return!0;return!1}get _isEntryPoint(){return this._reverse.length===0}get _isExitPoint(){return this._forward.length===0}get isDisconnected(){return this._isEntryPoint&&this._isExitPoint}get isConnected(){return!this._isExitPoint||!this._isEntryPoint}get isTerminus(){return this._isEntryPoint||this._isExitPoint}get isInternal(){return!this._isEntryPoint&&!this._isExitPoint}};function ft(e){return e}function We(e,t,o){return new Map(e.map(n=>[t(n),o(n)]))}function Zt(e,t){return We(e,t,ft)}function ze(e,t,o){let n=s=>a(s)&&a(o)&&o(s),r=new ht(null),i=new Map;for(let s of e){let p=new ht(s);i.set(s,p)}for(let s of i.values()){let p=t(s.value);(p!=null&&i.has(p)?i.get(p):r).connectSorted(s,n)}return r}var ht=class extends _t{get depth(){let t=0,o=this.parent;for(;a(o);)++t,o=o.parent;return t}removeFromParent(){for(;this.parent;)this.parent.disconnectFrom(this)}connectTo(t){t.removeFromParent(),super.connectTo(t)}connectAt(t,o){t.removeFromParent(),super.connectAt(t,o)}connectSorted(t,o){t.removeFromParent(),super.connectSorted(t,o)}get parent(){return this._reverse.length===0?null:this._reverse[0]}get children(){return this._forward}get isRoot(){return this._isEntryPoint}get isChild(){return!this._isEntryPoint}get isLeaf(){return this._isExitPoint}get hasChildren(){return!this._isExitPoint}};var K=class{constructor(){this.listeners=new Map,this.listenerOptions=new Map,this.bubblers=new Set,this.scopes=new WeakMap}addBubbler(t){this.bubblers.add(t)}removeBubbler(t){this.bubblers.delete(t)}addScopedEventListener(t,o,n,r){this.scopes.has(t)||this.scopes.set(t,[]),this.scopes.get(t).push([o,n]),this.addEventListener(o,n,r)}removeScope(t){let o=this.scopes.get(t);if(o){this.scopes.delete(t);for(let[n,r]of o)this.removeEventListener(n,r)}}addEventListener(t,o,n){let r=this.listeners.get(t);r||(r=new Array,this.listeners.set(t,r)),r.find(i=>i===o)||(r.push(o),n&&this.listenerOptions.set(o,n))}removeEventListener(t,o){let n=this.listeners.get(t);n&&this.removeListener(n,o)}clearEventListeners(t){for(let[o,n]of this.listeners)if(d(t)||t===o){for(let r of n)this.removeEventListener(t,r);E(n),this.listeners.delete(o)}}removeListener(t,o){let n=t.findIndex(r=>r===o);n>=0&&(Yt(t,n),this.listenerOptions.has(o)&&this.listenerOptions.delete(o))}dispatchEvent(t){let o=this.listeners.get(t.type);if(o)for(let n of o){let r=this.listenerOptions.get(n);a(r)&&!D(r)&&r.once&&this.removeListener(o,n),v(n)?n.call(this,t):n.handleEvent(t)}if(t.defaultPrevented)return!1;for(let n of this.bubblers)if(!n.dispatchEvent(t))return!1;return!0}};var j=class{constructor(t=!0){this.autoStart=t,this.onThens=new Array,this.onCatches=new Array,this._result=void 0,this._error=void 0,this._executionState="waiting",this._resultState="none",this.resolve=o=>{if(this.running){this._result=o,this._resultState="resolved";for(let n of this.onThens)n(o);this.clear(),this._executionState="finished"}},this.reject=o=>{if(this.running){this._error=o,this._resultState="errored";for(let n of this.onCatches)n(o);this.clear(),this._executionState="finished"}},this.autoStart&&this.start()}clear(){E(this.onThens),E(this.onCatches)}start(){this._executionState="running"}resolver(t){return()=>this.resolve(t)}resolveOn(t,o,n){let r=this.resolver(n);t.addEventListener(o,r),this.finally(()=>t.removeEventListener(o,r))}get result(){if(a(this.error))throw this.error;return this._result}get error(){return this._error}get executionState(){return this._executionState}get waiting(){return this.executionState==="waiting"}get started(){return this.executionState!=="waiting"}get running(){return this.executionState==="running"}get finished(){return this.executionState==="finished"}get resultState(){return this._resultState}get resolved(){return this.resultState==="resolved"}get errored(){return this.resultState==="errored"}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((t,o)=>{this.finished?this.errored?o(this.error):t(this.result):(this.onThens.push(t),this.onCatches.push(o))})}then(t,o){return this.project().then(t,o)}catch(t){return this.project().catch(t)}finally(t){return this.project().finally(t)}reset(){this._reset(this.autoStart)}restart(){this._reset(!0)}_reset(t){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._executionState="waiting",this._resultState="none",t&&this.start()}};var Ne=/([^\/]+)\/(.+)/,nn=/(?:([^\.]+)\.)?([^\+;]+)(?:\+([^;]+))?((?:; *([^=]+)=([^;]+))*)/;var Y=class e{constructor(t,o,n){this._type=t,this._fullSubType=o,this._primaryExtension=null,this.depMessage=null;let r=new Map;this._parameters=r;let i=this._fullSubType.match(nn);this._tree=i[1],this._subType=i[2],this._suffix=i[3];let s=i[4];if(this._value=this._fullValue=this._type+"/",a(this._tree)&&(this._value=this._fullValue+=this._tree+"."),this._value=this._fullValue+=this._subType,a(this._suffix)&&(this._value=this._fullValue+="+"+this._suffix),a(s)){let p=s.split(";").map(c=>c.trim()).filter(c=>c.length>0).map(c=>c.split("="));for(let[c,...l]of p){let x=l.join("=");r.set(c,x);let g=`; ${c}=${x}`;this._fullValue+=g,c!=="q"&&(this._value+=g)}}this._extensions=n||[],this._primaryExtension=this._extensions[0]||null}static parse(t){if(!t)return null;let o=t.match(Ne);if(!o)return null;let n=o[1],r=o[2];return new e(n,r)}deprecate(t){return this.depMessage=t,this}check(){a(this.depMessage)&&console.warn(`${this._value} is deprecated ${this.depMessage}`)}matches(t){if(d(t))return!1;if(this.typeName==="*"&&this.subTypeName==="*")return!0;let o=null,n=null;if(u(t)){let r=t.match(Ne);if(!r)return!1;o=r[1],n=r[2]}else o=t.typeName,n=t._fullSubType;return this.typeName===o&&(this._fullSubType==="*"||this._fullSubType===n)}withParameter(t,o){let n=`${this._fullSubType}; ${t}=${o}`;return new e(this.typeName,n,this.extensions)}get typeName(){return this.check(),this._type}get tree(){return this.check(),this._tree}get suffix(){return this._suffix}get subTypeName(){return this.check(),this._subType}get value(){return this.check(),this._value}__getValueUnsafe(){return this._value}get fullValue(){return this.check(),this._fullValue}get parameters(){return this.check(),this._parameters}get extensions(){return this.check(),this._extensions}__getExtensionsUnsafe(){return this._extensions}get primaryExtension(){return this.check(),this._primaryExtension}toString(){return this.parameters.get("q")==="1"?this.value:this.fullValue}toFileSystemAPIAccepts(){return{[this.value]:this.extensions.map(t=>"."+t)}}addExtension(t){if(!t)throw new Error("File name is not defined");return this.primaryExtension&&(t=e.removeExtension(t),t=`${t}.${this.primaryExtension}`),t}static removeExtension(t){let o=t.lastIndexOf(".");return o>-1&&(t=t.substring(0,o)),t}};function rn(e,t,...o){return new Y(e,t,o)}function b(e){return rn.bind(null,e)}var Ge=b("image");var gt=Ge("jpeg","jpeg","jpg","jpe");var Qt=Ge("png","png");var He=new Map,vt=class{constructor(t,o,n,...r){this.key=t,this.value=o,this.bySetAttribute=n,this.tags=r.map(i=>i.toLocaleUpperCase()),Object.freeze(this)}applyToElement(t){if(this.tags.length>0&&this.tags.indexOf(t.tagName)===-1){let o=He.get(t.tagName);o||He.set(t.tagName,o=new Set),o.has(this.key)||(o.add(this.key),console.warn(`Element ${t.tagName} does not support Attribute ${this.key}`))}this.bySetAttribute?t.setAttribute(this.key,this.value.toString()):this.key in t?t[this.key]=this.value:this.value===!1?t.removeAttribute(this.key):this.value===!0?t.setAttribute(this.key,""):v(this.value)?this.value(t):t.setAttribute(this.key,this.value.toString())}};function W(e,t,o,...n){return new vt(e,t,o,...n)}function Ue(e){return e instanceof vt}function qe(...e){return e=e.filter(ft),W("CLASS_LIST",t=>t.classList.add(...e),!1)}function Je(e){return W("height",e,!1,"canvas","embed","iframe","img","input","object","video")}function sn(e){return e instanceof URL&&(e=e.href),e}function te(e){return W("src",sn(e),!1,"audio","embed","iframe","img","input","script","source","track","video")}function $e(e){return W("title",e,!1)}function Ke(e){return u(e)||(e=e.value),W("type",e,!1,"button","input","command","embed","link","object","script","source","style","menu")}function Ye(e){return W("width",e,!1,"canvas","embed","iframe","img","input","object","video")}function Ze(e){return`${e}px`}function ee(e){return I(e)?e.element instanceof Element:!1}function oe(e){return ee(e)?e.element:u(e)?ln(e):e}function cn(e){return I(e)&&"applyToElement"in e&&v(e.applyToElement)}function At(e,t,o=""){e=oe(e),t?(e.style.removeProperty("display"),getComputedStyle(e).display==="none"&&(e.style.display=o||"block")):e.style.display="none"}function bt(e){return e=oe(e),e.style.display!=="none"}function wt(e,...t){let o=e instanceof Element||e instanceof ShadowRoot?e:u(e)?document.querySelector(e):e.element,n=o instanceof HTMLTemplateElement?o.content:o;for(let r of t)a(r)&&(r instanceof Node?n.appendChild(r):ee(r)?n.appendChild(oe(r)):cn(r)?o instanceof ShadowRoot||r.applyToElement(o):n.appendChild(document.createTextNode(r.toLocaleString())));return o}function ln(e){return document.querySelector(e)}function ne(e,...t){let o=null,n=t.filter(Ue).filter(r=>r.key==="id"||r.key==="query");for(let r of n)r.key==="query"?(o=r.value,S(t,r)):r.key==="id"&&(o=document.getElementById(r.value),o&&S(t,r));return o&&o.tagName!==e.toUpperCase()&&console.warn(`Expected a "${e.toUpperCase()}" element but found a "${o.tagName}".`),o||(o=document.createElement(e)),wt(o,...t),o}function Qe(e){return I(e)&&"disabled"in e&&D(e.disabled)}function dn(...e){return ne("button",...e)}function mn(...e){return dn(...e,Ke("button"))}function to(...e){return mn(...e,qe("btn","btn-primary"))}function eo(...e){return ne("canvas",...e)}function re(...e){return ne("img",...e)}var C=class extends Event{get type(){return super.type}constructor(t,o){super(t,o)}},M=class extends K{addBubbler(t){super.addBubbler(t)}removeBubbler(t){super.removeBubbler(t)}addScopedEventListener(t,o,n,r){super.addScopedEventListener(t,o,n,r)}addEventListener(t,o,n){super.addEventListener(t,o,n)}removeEventListener(t,o){super.removeEventListener(t,o)}clearEventListeners(t){return super.clearEventListeners(t)}};function oo(e){if(e.status>=400)throw new Error("Resource could not be retrieved: "+e.requestPath);return e}function k(e){let{content:t}=oo(e);return t}var Vt=class extends M{constructor(){super(...arguments),this.attached=new Array,this.soFar=null,this.total=null,this.msg=null,this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(t,o,n,r){this.soFar=t,this.total=o,this.msg=n,this.est=r;for(let i of this.attached)i.report(t,o,n,r)}attach(t){this.attached.push(t),t.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(t){this.report(0,1,t||"starting")}end(t){this.report(1,1,t||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,E(this.attached)}};var Z=class extends Vt{constructor(t,o){super(),this.i=t,this.prog=o}report(t,o,n,r){super.report(t,o,n,r),this.prog.update(this.i,t,o,n)}};var yt=class{constructor(t){this.prog=t,this.weightTotal=0,this.subProgressCallbacks=new Array,this.subProgressWeights=new Array,this.subProgressValues=new Array,this.start=performance.now();for(let o=0;o<this.subProgressWeights.length;++o)this.subProgressValues[o]=0,this.subProgressCallbacks[o]=new Z(o,this)}addSubProgress(t){t=t||1,this.weightTotal+=t,this.subProgressWeights.push(t),this.subProgressValues.push(0);let o=new Z(this.subProgressCallbacks.length,this);return this.subProgressCallbacks.push(o),o}update(t,o,n,r){if(this.prog){this.subProgressValues[t]=o/n;let i=0;for(let l=0;l<this.subProgressWeights.length;++l)i+=this.subProgressValues[l]*this.subProgressWeights[l];let s=performance.now(),p=s-this.start,c=this.start-s+p*this.weightTotal/i;this.prog.report(i,this.weightTotal,r,c)}}};function z(e,t){return new ie(t,e).subProgressCallbacks}var ie=class extends yt{constructor(t,o){super(o);for(let n of t)this.addSubProgress(n)}};function St(e,t,o){let n=t.map(()=>1),r=z(e,n);return Promise.all(t.map(async(i,s)=>{let p=r[s];p.start();let c=await o(i,p,s);return p.end(),c}))}async function Q(e,t){let o=new Array(t.length),n=new Array(t.length);for(let s=0;s<t.length;++s){let p=t[s];o[s]=p[0],n[s]=p[1]}let r=z(e,o),i=new Array(t.length);for(let s=0;s<t.length;++s)i[s]=n[s](r[s]);return await Promise.all(i)}function se(e,...t){if(!I(e))return!1;e=e;for(let o of t){if(!(o in e))return!1;let n=e[o];if(!v(n))return!1}return!0}function xn(e){return se(e,"dispose")}function un(e){return se(e,"destroy")}function _n(e){return se(e,"close")}function O(e){xn(e)&&e.dispose(),_n(e)&&e.close(),un(e)&&e.destroy()}var tt="HTMLCanvasElement"in globalThis,_s="HTMLImageElement"in globalThis,no=!1,pe=!no&&"OffscreenCanvas"in globalThis,fn=!no&&"createImageBitmap"in globalThis;function ae(e){return tt&&e instanceof HTMLCanvasElement}function ce(e){return pe&&e instanceof OffscreenCanvas}function ro(e){return fn&&e instanceof ImageBitmap}function io(e){return e instanceof ImageData}function hn(e){return ae(e)||ce(e)}function so(e,t){let o=e.getContext("2d");if(d(o))throw new Error("Could not create 2d context for canvas");o.drawImage(t,0,0)}function po(e,t){let o=e.getContext("2d");if(d(o))throw new Error("Could not create 2d context for canvas");o.putImageData(t,0,0)}function gn(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var le=pe&&gn(),de=le&&me||tt&&Et||null,ao=tt?Et:de;function vn(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var fs=pe&&vn();function me(e,t){return new OffscreenCanvas(e,t)}function Et(e,t){return eo(Ye(e),Je(t))}function An(e){let t=me(e.width,e.height);return so(t,e),t}function bn(e){let t=Et(e.width,e.height);return so(t,e),t}var co=le&&An||tt&&bn||null;function wn(e){let t=me(e.width,e.height);return po(t,e),t}function Vn(e){let t=Et(e.width,e.height);return po(t,e),t}var lo=le&&wn||tt&&Vn||null;function mo(e,t,o,n=1){return t=Math.floor(t*n),o=Math.floor(o*n),e.width!=t||e.height!=o?(e.width=t,e.height=o,!0):!1}function yn(e){return a(e.textBaseline)}function Sn(e,t,o,n=1){let r=e.imageSmoothingEnabled,i=e.textBaseline,s=e.textAlign,p=e.font,c=mo(e.canvas,t,o,n);return c&&(e.imageSmoothingEnabled=r,e.textBaseline=i,e.textAlign=s,e.font=p),c}function xe(e,t,o,n=1){return yn(e)?Sn(e,t,o,n):mo(e.canvas,t,o,n)}function et(e){hn(e)?e.width=e.height=0:O(e)}var Mt=Math.PI,ue=.5*Mt,vs=2*Mt;var En=864e13,As=-En;function Rt(e,t,o){return Math.min(o,Math.max(t,e))}function Tt(e,t){let o=e*Mt;return .5*(1-Math.cos(o))-t*Math.sin(2*o)}function N(e,t){let o=globalThis,n=o[e];if(d(n)){if(d(t))throw new Error(`No value ${e} found`);n=t(),o[e]=n}return n}var{ACESFilmicToneMapping:Es,AddEquation:Ms,AddOperation:Rs,AdditiveAnimationBlendMode:Ts,AdditiveBlending:Cs,AlphaFormat:Is,AlwaysDepth:ks,AlwaysStencilFunc:Ps,AmbientLight:Xs,AmbientLightProbe:Ds,AnimationClip:Os,AnimationLoader:Ls,AnimationMixer:Fs,AnimationObjectGroup:Bs,AnimationUtils:js,ArcCurve:Ws,ArrayCamera:zs,ArrowHelper:Ns,Audio:Gs,AudioAnalyser:Hs,AudioContext:Us,AudioListener:qs,AudioLoader:Js,AxesHelper:$s,BackSide:Ks,BasicDepthPacking:Ys,BasicShadowMap:Zs,Bone:Qs,BooleanKeyframeTrack:tp,Box2:ep,Box3:op,Box3Helper:np,BoxBufferGeometry:rp,BoxGeometry:ip,BoxHelper:sp,BufferAttribute:pp,BufferGeometry:ap,BufferGeometryLoader:cp,ByteType:lp,Cache:dp,Camera:mp,CameraHelper:xp,CanvasTexture:up,CapsuleBufferGeometry:_p,CapsuleGeometry:fp,CatmullRomCurve3:hp,CineonToneMapping:gp,CircleBufferGeometry:vp,CircleGeometry:Ap,ClampToEdgeWrapping:bp,Clock:wp,Color:Mn,ColorKeyframeTrack:Vp,ColorManagement:yp,CompressedArrayTexture:Sp,CompressedTexture:Ep,CompressedTextureLoader:Mp,ConeBufferGeometry:Rp,ConeGeometry:Tp,CubeCamera:Cp,CubeReflectionMapping:Ip,CubeRefractionMapping:kp,CubeTexture:Pp,CubeTextureLoader:Xp,CubeUVReflectionMapping:Dp,CubicBezierCurve:Op,CubicBezierCurve3:Lp,CubicInterpolant:Fp,CullFaceBack:Bp,CullFaceFront:jp,CullFaceFrontBack:Wp,CullFaceNone:zp,Curve:Np,CurvePath:Gp,CustomBlending:Hp,CustomToneMapping:Up,CylinderBufferGeometry:qp,CylinderGeometry:Jp,Cylindrical:$p,Data3DTexture:Kp,DataArrayTexture:Yp,DataTexture:Zp,DataTextureLoader:Qp,DataUtils:ta,DecrementStencilOp:ea,DecrementWrapStencilOp:oa,DefaultLoadingManager:na,DepthFormat:ra,DepthStencilFormat:ia,DepthTexture:sa,DirectionalLight:pa,DirectionalLightHelper:aa,DiscreteInterpolant:ca,DisplayP3ColorSpace:la,DodecahedronBufferGeometry:da,DodecahedronGeometry:ma,DoubleSide:xa,DstAlphaFactor:ua,DstColorFactor:_a,DynamicCopyUsage:fa,DynamicDrawUsage:ha,DynamicReadUsage:ga,EdgesGeometry:va,EllipseCurve:Aa,EqualDepth:ba,EqualStencilFunc:wa,EquirectangularReflectionMapping:Va,EquirectangularRefractionMapping:ya,Euler:Sa,EventDispatcher:Ea,ExtrudeBufferGeometry:Ma,ExtrudeGeometry:Ra,FileLoader:Ta,Float16BufferAttribute:Ca,Float32BufferAttribute:Ia,Float64BufferAttribute:ka,FloatType:Pa,Fog:Xa,FogExp2:Da,FramebufferTexture:Oa,FrontSide:La,Frustum:Fa,GLBufferAttribute:Ba,GLSL1:ja,GLSL3:Wa,GreaterDepth:za,GreaterEqualDepth:Na,GreaterEqualStencilFunc:Ga,GreaterStencilFunc:Ha,GridHelper:Ua,Group:qa,HalfFloatType:Ja,HemisphereLight:$a,HemisphereLightHelper:Ka,HemisphereLightProbe:Ya,IcosahedronBufferGeometry:Za,IcosahedronGeometry:Qa,ImageBitmapLoader:tc,ImageLoader:ec,ImageUtils:oc,IncrementStencilOp:nc,IncrementWrapStencilOp:rc,InstancedBufferAttribute:ic,InstancedBufferGeometry:sc,InstancedInterleavedBuffer:pc,InstancedMesh:ac,Int16BufferAttribute:cc,Int32BufferAttribute:lc,Int8BufferAttribute:dc,IntType:mc,InterleavedBuffer:xc,InterleavedBufferAttribute:uc,Interpolant:_c,InterpolateDiscrete:fc,InterpolateLinear:hc,InterpolateSmooth:gc,InvertStencilOp:vc,KeepStencilOp:Ac,KeyframeTrack:bc,LOD:wc,LatheBufferGeometry:Vc,LatheGeometry:yc,Layers:Sc,LessDepth:Ec,LessEqualDepth:Mc,LessEqualStencilFunc:Rc,LessStencilFunc:Tc,Light:Cc,LightProbe:Ic,Line:kc,Line3:Pc,LineBasicMaterial:Rn,LineCurve:Xc,LineCurve3:Dc,LineDashedMaterial:Oc,LineLoop:Lc,LineSegments:Fc,LinearEncoding:Bc,LinearFilter:jc,LinearInterpolant:Wc,LinearMipMapLinearFilter:zc,LinearMipMapNearestFilter:Nc,LinearMipmapLinearFilter:Gc,LinearMipmapNearestFilter:Hc,LinearSRGBColorSpace:Uc,LinearToneMapping:qc,Loader:Jc,LoaderUtils:$c,LoadingManager:Kc,LoopOnce:Yc,LoopPingPong:Zc,LoopRepeat:Qc,LuminanceAlphaFormat:tl,LuminanceFormat:el,MOUSE:ol,Material:nl,MaterialLoader:rl,MathUtils:il,Matrix3:sl,Matrix4:Ct,MaxEquation:pl,Mesh:_e,MeshBasicMaterial:xo,MeshDepthMaterial:al,MeshDistanceMaterial:cl,MeshLambertMaterial:ll,MeshMatcapMaterial:dl,MeshNormalMaterial:ml,MeshPhongMaterial:Tn,MeshPhysicalMaterial:xl,MeshStandardMaterial:ul,MeshToonMaterial:_l,MinEquation:fl,MirroredRepeatWrapping:hl,MixOperation:gl,MultiplyBlending:vl,MultiplyOperation:Al,NearestFilter:bl,NearestMipMapLinearFilter:wl,NearestMipMapNearestFilter:Vl,NearestMipmapLinearFilter:yl,NearestMipmapNearestFilter:Sl,NeverDepth:El,NeverStencilFunc:Ml,NoBlending:Rl,NoColorSpace:Tl,NoToneMapping:Cl,NormalAnimationBlendMode:Il,NormalBlending:kl,NotEqualDepth:Pl,NotEqualStencilFunc:Xl,NumberKeyframeTrack:Dl,Object3D:G,ObjectLoader:Ol,ObjectSpaceNormalMap:Ll,OctahedronBufferGeometry:Fl,OctahedronGeometry:Bl,OneFactor:jl,OneMinusDstAlphaFactor:Wl,OneMinusDstColorFactor:zl,OneMinusSrcAlphaFactor:Nl,OneMinusSrcColorFactor:Gl,OrthographicCamera:Hl,PCFShadowMap:Ul,PCFSoftShadowMap:ql,PMREMGenerator:Jl,Path:$l,PerspectiveCamera:Kl,Plane:Yl,PlaneBufferGeometry:Zl,PlaneGeometry:uo,PlaneHelper:Ql,PointLight:td,PointLightHelper:ed,Points:od,PointsMaterial:nd,PolarGridHelper:rd,PolyhedronBufferGeometry:id,PolyhedronGeometry:sd,PositionalAudio:pd,PropertyBinding:ad,PropertyMixer:cd,QuadraticBezierCurve:ld,QuadraticBezierCurve3:dd,Quaternion:_o,QuaternionKeyframeTrack:md,QuaternionLinearInterpolant:xd,RED_GREEN_RGTC2_Format:ud,RED_RGTC1_Format:_d,REVISION:fd,RGBADepthPacking:hd,RGBAFormat:gd,RGBAIntegerFormat:vd,RGBA_ASTC_10x10_Format:Ad,RGBA_ASTC_10x5_Format:bd,RGBA_ASTC_10x6_Format:wd,RGBA_ASTC_10x8_Format:Vd,RGBA_ASTC_12x10_Format:yd,RGBA_ASTC_12x12_Format:Sd,RGBA_ASTC_4x4_Format:Ed,RGBA_ASTC_5x4_Format:Md,RGBA_ASTC_5x5_Format:Rd,RGBA_ASTC_6x5_Format:Td,RGBA_ASTC_6x6_Format:Cd,RGBA_ASTC_8x5_Format:Id,RGBA_ASTC_8x6_Format:kd,RGBA_ASTC_8x8_Format:Pd,RGBA_BPTC_Format:Xd,RGBA_ETC2_EAC_Format:Dd,RGBA_PVRTC_2BPPV1_Format:Od,RGBA_PVRTC_4BPPV1_Format:Ld,RGBA_S3TC_DXT1_Format:Fd,RGBA_S3TC_DXT3_Format:Bd,RGBA_S3TC_DXT5_Format:jd,RGB_ETC1_Format:Wd,RGB_ETC2_Format:zd,RGB_PVRTC_2BPPV1_Format:Nd,RGB_PVRTC_4BPPV1_Format:Gd,RGB_S3TC_DXT1_Format:Hd,RGFormat:Ud,RGIntegerFormat:qd,RawShaderMaterial:Jd,Ray:$d,Raycaster:Kd,RectAreaLight:Yd,RedFormat:Zd,RedIntegerFormat:Qd,ReinhardToneMapping:tm,RepeatWrapping:em,ReplaceStencilOp:om,ReverseSubtractEquation:nm,RingBufferGeometry:rm,RingGeometry:im,SIGNED_RED_GREEN_RGTC2_Format:sm,SIGNED_RED_RGTC1_Format:pm,SRGBColorSpace:am,Scene:cm,ShaderChunk:lm,ShaderLib:ot,ShaderMaterial:fo,ShadowMaterial:dm,Shape:mm,ShapeBufferGeometry:xm,ShapeGeometry:um,ShapePath:_m,ShapeUtils:fm,ShortType:hm,Skeleton:gm,SkeletonHelper:vm,SkinnedMesh:Am,Source:bm,Sphere:wm,SphereBufferGeometry:Vm,SphereGeometry:ym,Spherical:Sm,SphericalHarmonics3:Em,SplineCurve:Mm,SpotLight:Rm,SpotLightHelper:Tm,Sprite:Cm,SpriteMaterial:Cn,SrcAlphaFactor:Im,SrcAlphaSaturateFactor:km,SrcColorFactor:Pm,StaticCopyUsage:Xm,StaticDrawUsage:Dm,StaticReadUsage:Om,StereoCamera:Lm,StreamCopyUsage:Fm,StreamDrawUsage:Bm,StreamReadUsage:jm,StringKeyframeTrack:Wm,SubtractEquation:zm,SubtractiveBlending:Nm,TOUCH:Gm,TangentSpaceNormalMap:Hm,TetrahedronBufferGeometry:Um,TetrahedronGeometry:qm,Texture:ho,TextureLoader:Jm,TorusBufferGeometry:$m,TorusGeometry:Km,TorusKnotBufferGeometry:Ym,TorusKnotGeometry:Zm,Triangle:Qm,TriangleFanDrawMode:tx,TriangleStripDrawMode:ex,TrianglesDrawMode:ox,TubeBufferGeometry:nx,TubeGeometry:rx,TwoPassDoubleSide:ix,UVMapping:sx,Uint16BufferAttribute:px,Uint32BufferAttribute:ax,Uint8BufferAttribute:cx,Uint8ClampedBufferAttribute:lx,Uniform:dx,UniformsGroup:mx,UniformsLib:nt,UniformsUtils:fe,UnsignedByteType:xx,UnsignedInt248Type:ux,UnsignedIntType:_x,UnsignedShort4444Type:fx,UnsignedShort5551Type:hx,UnsignedShortType:gx,VSMShadowMap:vx,Vector2:go,Vector3:H,Vector4:vo,VectorKeyframeTrack:Ax,VideoTexture:Ao,WebGL1Renderer:bx,WebGL3DRenderTarget:wx,WebGLArrayRenderTarget:Vx,WebGLCubeRenderTarget:yx,WebGLMultipleRenderTargets:Sx,WebGLRenderTarget:Ex,WebGLRenderer:Mx,WebGLUtils:Rx,WireframeGeometry:Tx,WrapAroundEnding:Cx,ZeroCurvatureEnding:Ix,ZeroFactor:kx,ZeroSlopeEnding:Px,ZeroStencilOp:Xx,_SRGBAFormat:Dx,sRGBEncoding:Ox}=THREE;function rt(e){return a(e)&&e.isMesh}function bo(e){return a(e)&&e.isMaterial}function In(e,t){return bo(t)&&t.type===e}function wo(e){return In("MeshBasicMaterial",e)}function Vo(e){return a(e)&&e.isObject3D}function yo(e){return a(e)&&Vo(e.object)}function P(e){return yo(e)?e.object:e}function it(e,t){return e=P(e),e.visible=t,t}function he(e){if(!e)return!1;for(e=P(e);e;){if(!e.visible)return!1;e=e.parent}return!0}function w(e,...t){let o=t.filter(a).map(P);return o.length>0&&P(e).add(...o),e}function It(e,...t){let o=new G;return o.name=e,w(o,...t),o}function So(e,t){e=P(e),Qe(e)&&(e.disabled=!t)}function Eo(e,t,o){let n=new _e(t,o);return n.name=e,n}var U=N("Juniper:ScaledItems",()=>new Map),Mo=1,kn=1.1;var ge=class{constructor(t){this.target=t,this.obj=P(this.target),this.base=this.obj.scale.clone(),this.p=0,this.dir=0,this.running=!1,this.wasDisabled=this.disabled,this.target.addScopedEventListener(this,"enter",o=>{o.pointer.type!=="nose"&&this.run(1)}),this.target.addScopedEventListener(this,"exit",o=>{o.pointer.type!=="nose"&&this.run(-1)}),this.obj.traverse(o=>{rt(o)&&this.target.addMesh(o)})}get disabled(){return this.target.disabled}run(t){(!this.disabled||t===-1||this.p>0)&&(this.dir=t,this.running=!0)}updateScaling(t){if(this.disabled!==this.wasDisabled&&(this.wasDisabled=this.disabled,this.disabled&&this.run(-1)),this.running){this.p+=this.dir*t,(this.dir>0&&this.p>=1||this.dir<0&&this.p<0)&&(this.p=Math.max(0,Math.min(1,this.p)),this.running=!1);let o=Tt(this.p,1.1);this.obj.scale.copy(this.base).multiplyScalar(o*(kn-Mo)+Mo)}}dispose(){this.target.removeScope(this)}};function Ro(e){let t=U.get(e);t&&(U.delete(e),O(t))}function To(e,t){let o=U.has(e);if(t!=o)if(t)U.set(e,new ge(e));else{let n=U.get(e);O(n),U.delete(e)}}function st(e){let t=new Array,o=new Set;for(t.push(e);t.length>0;){let n=t.shift();n&&!o.has(n)&&(o.add(n),n.isMesh&&t.push(n.material,n.geometry),n.isMaterial&&t.push(...Object.values(n)),n.isObject3D&&(t.push(...n.children),n.clear(),Ro(n)),Jt(n)&&t.push(...n),et(n))}o.clear()}var q=class extends C{constructor(t,o){super(t),this.app=o}},ve=class extends q{constructor(t,o){super("joinroom",t),this.roomName=o}},Ae=class extends q{constructor(t){super("quit",t)}},be=class extends q{constructor(t){super("shown",t)}},we=class extends q{constructor(t){super("hidden",t)}},kt=class extends M{constructor(t){super(),this.env=t,this.dataLogger=null}quit(){this.dispatchEvent(new Ae(this))}join(t){this.dispatchEvent(new ve(this,t)),this.env.avatar.reset()}async show(t){await this.showing(t),this.dispatchEvent(new be(this))}hide(){this.hiding(),this.dispatchEvent(new we(this))}init(t){return this.dataLogger=t.get("dataLogger"),Promise.resolve()}log(t,o){a(this.dataLogger)&&this.dataLogger.log(t,o)}error(t,o,n){a(this.dataLogger)&&this.dataLogger.error(t,o,n)}onError(t,o){return this.error.bind(this,t,o)}};var Pn="The quick brown fox jumps over the lazy dog",Co=N("juniper::loadedFonts",()=>[]);function Ve(e){let t=[];return e.fontStyle&&e.fontStyle!=="normal"&&t.push(e.fontStyle),e.fontVariant&&e.fontVariant!=="normal"&&t.push(e.fontVariant),e.fontWeight&&e.fontWeight!=="normal"&&t.push(e.fontWeight),t.push(Ze(e.fontSize)),t.push(e.fontFamily),t.join(" ")}async function Io(e,t=null,o){if(u(e)||(e=Ve(e)),Co.indexOf(e)===-1){t=t||Pn,o&&o.start(e);let n=await document.fonts.load(e,t);o&&o.end(e),n.length===0?console.warn(`Failed to load font "${e}". If this is a system font, just set the object's \`value\` property, instead of calling \`loadFontAndSetText\`.`):Co.push(e)}}var ye=class{get result(){if(a(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}constructor(t,o){this.path=t,this.type=o,this._result=null,this._error=null,this._started=!1,this._finished=!1,this.resolve=null,this.reject=null,this.promise=new Promise((n,r)=>{this.resolve=i=>{this._result=i,this._finished=!0,n(i)},this.reject=i=>{this._error=i,this._finished=!0,r(i)}})}async getSize(t){try{let{contentLength:o}=await t.head(this.path).accept(this.type).exec();return[this,o||1]}catch(o){return console.warn(o),[this,1]}}async fetch(t,o){try{let n=await this.getResult(t,o);this.resolve(n)}catch(n){this.reject(n)}}get[Symbol.toStringTag](){return this.promise.toString()}then(t,o){return this.promise.then(t,o)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}};var Se=class extends ye{constructor(t,o,n){let r;D(o)?n=o:r=o,super(t,r),this.useCache=!!n}getResult(t,o){return this.getRequest(t,o).then(k)}getRequest(t,o){let n=t.get(this.path).useCache(this.useCache).progress(o);return this.getResponse(n)}};var X=class extends Se{getResponse(t){return t.image(this.type)}};function ko(e){return!e.started||e.finished}var Ee=class extends j{constructor(){super(!1),this.time=0,this.duration=0,this.onTick=null}begin(t,o,n){this.restart(),this.time=-t,this.duration=o,this.onTick=n,this.onTick(0)}update(t){ko(this)||(this.time+=t/this.duration,this.time>=1?(this.onTick(1),this.resolve()):this.time>=0&&this.onTick(this.time))}},Pt=class{constructor(){this.animations=new Array}update(t){t=.001*t;for(let o of this.animations)o.update(t)}clear(){for(let t of this.animations)t.resolve()}start(t,o,n){let r=xt(this.animations,ko);return r||this.animations.push(r=new Ee),r.begin(t,o,n),r}};function Xt(e){return e instanceof HTMLVideoElement?e.videoWidth:e instanceof VideoFrame?e.displayWidth:e.width}function Dt(e){return e instanceof HTMLVideoElement?e.videoHeight:e instanceof VideoFrame?e.displayHeight:e.height}var Po=304.79999999999995,gu=Po*3,Xn=10*100,Dn=Po*16.5,On=Dn*40,vu=Xn*1e3,Au=On*8,Xo=2.54*4,Do=Xo*3,bu=Do*3,Ln=Do*16.5,Fn=Ln*40,wu=100*1e3,Vu=Fn*8,Me=4*3,Bn=Me*3,pt=100/2.54,jn=Me*16.5,Wn=jn*40,yu=pt*1e3,Su=Wn*8,Eu=3*3,zn=100/Xo,Nn=3*16.5,Gn=Nn*40,Mu=zn*1e3,Ru=Gn*8,Oo=pt/Me,Hn=16.5*40,Tu=Oo*1e3,Cu=Hn*8,Un=pt/Bn,qn=16.5/3,Jn=qn*40,Iu=Un*1e3,ku=Jn*8,Lo=16.5/Oo,Fo=Lo*40,Pu=Fo*8,Xu=1e3/Lo,Du=40*8,$n=1e3/Fo,Ou=8/$n;function Bo(e){return e/pt}function jo(e){return e*pt}var Re=new uo(1,1,1,1);Re.name="PlaneGeom";var Kn=new Ct,Ot=new H,Wo=new vo,zo=new _o;function Te(e,t,o){return Kn.copy(e.matrixWorld).invert().multiply(t.matrixWorld).decompose(Ot,zo,o),Wo.set(Ot.x,Ot.y,Ot.z,1),new XRRigidTransform(Wo,zo)}nt.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new go(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};ot.line={uniforms:fe.merge([nt.common,nt.fog,nt.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segements overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <encodings_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};var Lt=class extends fo{constructor(t){super({type:"LineMaterial",uniforms:fe.clone(ot.line.uniforms),vertexShader:ot.line.vertexShader,fragmentShader:ot.line.fragmentShader,clipping:!0}),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(o){this.uniforms.diffuse.value=o}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(o){o===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(o){this.uniforms.linewidth.value=o}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(o){!!o!="USE_DASH"in this.defines&&(this.needsUpdate=!0),o===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(o){this.uniforms.dashScale.value=o}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(o){this.uniforms.dashSize.value=o}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(o){this.uniforms.dashOffset.value=o}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(o){this.uniforms.gapSize.value=o}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(o){this.uniforms.opacity.value=o}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(o){this.uniforms.resolution.value.copy(o)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(o){!!o!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),o===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(t)}};Lt.prototype.isLineMaterial=!0;var Ce=N("Juniper:Three:Materials",()=>new Map);function Yn(e,t){t in e&&delete e[t]}function Zn(e,t,o){let n=`${e}_${Object.keys(o).map(r=>`${r}:${o[r]}`).join(",")}`;return Ce.has(n)||(Yn(o,"name"),Ce.set(n,new t(o))),Ce.get(n)}function Qn(e){return Object.assign(e,{transparent:!0})}function No(e){return Zn("solidTransparent",xo,Qn(e))}var J=new H,tr=0,h=class extends G{constructor(t,o,n,r=null){if(super(),this.webXRLayerType=n,this.lastMatrixWorld=new Ct,this._imageWidth=0,this._imageHeight=0,this.forceUpdate=!1,this.wasUsingLayer=!1,this.layer=null,this.curImage=null,this.lastImage=null,this.lastWidth=null,this.lastHeight=null,this.env=null,this.mesh=null,this.stereoLayoutName="mono",this.sizeMode="none",t){this.setEnvAndName(t,o);let i=wo(r)?r:No(Object.assign({},r,{name:this.name}));w(this,this.mesh=Eo(o+"-Mesh",Re,i))}}copy(t,o=!0){return super.copy(t,o),this.webXRLayerType=t.webXRLayerType,this.setImageSize(t.imageWidth,t.imageHeight),this.setEnvAndName(t.env,t.name+ ++tr),this.mesh=xt(this.children,rt),d(this.mesh)&&(this.mesh=t.mesh.clone(),w(this,this.mesh)),this.setTextureMap(t.curImage),this}dispose(){this.env.removeScope(this),this.disposeImage(),st(this.mesh)}disposeImage(){this.removeWebXRLayer(),st(this.mesh.material.map),this.curImage=null}setImageSize(t,o){if(t!==this.imageWidth||o!==this.imageHeight){let{objectWidth:n,objectHeight:r}=this;this._imageWidth=t,this._imageHeight=o,this.sizeMode!=="none"&&(this.sizeMode==="fixed-width"?this.objectWidth=n:this.objectHeight=r)}}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get imageAspectRatio(){return this.imageWidth/this.imageHeight}get objectWidth(){return this.scale.x}set objectWidth(t){this.scale.set(t,this.scale.y=t/this.imageAspectRatio,1)}get objectHeight(){return this.scale.y}set objectHeight(t){this.scale.set(this.imageAspectRatio*t,t,1)}get pixelDensity(){let t=jo(this.objectWidth);return this.imageWidth/t}set pixelDensity(t){let o=this.imageWidth/t,n=Bo(o);this.objectWidth=n}setEnvAndName(t,o){this.env=t,this.name=o,this.env.addScopedEventListener(this,"update",n=>this.checkWebXRLayer(n.frame))}get needsLayer(){return!he(this)||d(this.mesh.material.map)||d(this.curImage)?!1:this.curImage instanceof HTMLVideoElement?!this.curImage.paused||this.curImage.currentTime>0:!0}removeWebXRLayer(){if(a(this.layer)){this.wasUsingLayer=!1,this.env.removeWebXRLayer(this.layer),this.mesh.visible=!0;let t=this.layer;this.layer=null,setTimeout(()=>et(t),100)}}setTextureMap(t){this.curImage&&this.disposeImage(),t&&(ro(t)?t=co(t):io(t)&&(t=lo(t)),ce(t)&&(t=t),this.curImage=t,this.setImageSize(Xt(t),Dt(t)),t instanceof HTMLVideoElement?this.mesh.material.map=new Ao(t):(this.mesh.material.map=new ho(t),this.mesh.material.map.needsUpdate=!0)),this.mesh.material.needsUpdate=!0}get isVideo(){return this.curImage instanceof HTMLVideoElement}updateTexture(){if(a(this.curImage)){let t=Xt(this.curImage),o=Dt(this.curImage);if(this.imageWidth!==t||this.imageHeight!==o){let n=this.curImage;this.disposeImage(),this.setTextureMap(n)}else this.mesh.material.map.needsUpdate=this.forceUpdate=!0}}checkWebXRLayer(t){if(this.mesh.material.map&&this.curImage){let n=this.webXRLayerType!=="none"&&this.env.hasXRCompositionLayers&&this.env.showWebXRLayers&&a(t)&&(this.isVideo&&a(this.env.xrMediaBinding)||!this.isVideo&&a(this.env.xrBinding))&&this.needsLayer,r=n!==this.wasUsingLayer,i=this.curImage!==this.lastImage||this.mesh.material.needsUpdate||this.mesh.material.map.needsUpdate||this.forceUpdate,s=this.imageWidth!==this.lastWidth||this.imageHeight!==this.lastHeight;if(this.wasUsingLayer=n,this.lastImage=this.curImage,this.lastWidth=this.imageWidth,this.lastHeight=this.imageHeight,(r||s)&&((!n||s)&&this.layer&&this.removeWebXRLayer(),n)){let p=this.env.referenceSpace,c=Te(this.env.stage,this.mesh,J);this.lastMatrixWorld.copy(this.matrixWorld);let l=J.x/2,x=J.y/2,g=this.stereoLayoutName==="mono"?"mono":this.stereoLayoutName==="left-right"||this.stereoLayoutName==="right-left"?"stereo-left-right":"stereo-top-bottom";if(this.isVideo){let R=this.stereoLayoutName==="right-left"||this.stereoLayoutName==="bottom-top";this.layer=this.env.xrMediaBinding.createQuadLayer(this.curImage,{space:p,layout:g,invertStereo:R,transform:c,width:l,height:x})}else this.layer=this.env.xrBinding.createQuadLayer({space:p,layout:g,textureType:"texture",isStatic:this.webXRLayerType==="static",viewPixelWidth:Xt(this.curImage),viewPixelHeight:Dt(this.curImage),transform:c,width:l,height:x});this.env.addWebXRLayer(this.layer,500),this.mesh.visible=!1}if(this.layer){if(i||this.layer.needsRedraw){let p=this.env.gl,c=this.env.xrBinding.getSubImage(this.layer,t);p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),p.bindTexture(p.TEXTURE_2D,c.colorTexture),p.texSubImage2D(p.TEXTURE_2D,0,0,0,p.RGBA,p.UNSIGNED_BYTE,this.curImage),p.generateMipmap(p.TEXTURE_2D),p.bindTexture(p.TEXTURE_2D,null),this.forceUpdate=!1}Be(this.matrixWorld.elements,this.lastMatrixWorld.elements)>=0&&(this.layer.transform=Te(this.env.stage,this.mesh,J),this.lastMatrixWorld.copy(this.matrixWorld),this.layer.width=J.x/2,this.layer.height=J.y/2)}else this.forceUpdate=!1}}};var Ft=class extends M{constructor(t,o,n){super(),this._scale=250,this._visible=!0,this.wasVisible=null,this.redrawnEvt=new C("redrawn"),a(n)&&a(n.scale)&&(this._scale=n.scale),this._canvas=ao(t,o),this._g=this.canvas.getContext("2d")}fillRect(t,o,n,r,i,s){this.g.fillStyle=t,this.g.fillRect(o+s,n+s,r-2*s,i-2*s)}drawText(t,o,n,r){this.g.textAlign=r,this.g.strokeText(t,o,n),this.g.fillText(t,o,n)}redraw(){(this.visible||this.wasVisible)&&this.onRedraw()&&(this.wasVisible=this.visible,this.dispatchEvent(this.redrawnEvt))}onClear(){this.g.clearRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.onClear(),this.dispatchEvent(this.redrawnEvt)}get canvas(){return this._canvas}get g(){return this._g}get imageWidth(){return this.canvas.width}get imageHeight(){return this.canvas.height}get aspectRatio(){return this.imageWidth/this.imageHeight}get width(){return this.imageWidth/this.scale}get height(){return this.imageHeight/this.scale}get scale(){return this._scale}set scale(t){this.scale!==t&&(this._scale=t,this.redraw())}get visible(){return this._visible}set visible(t){this.visible!==t&&(this.wasVisible=this._visible,this._visible=t,this.redraw())}};var at=class extends Ft{constructor(t){super(10,10,t),this.trueWidth=null,this.trueHeight=null,this.trueFontSize=null,this.dx=null,this._minWidth=null,this._maxWidth=null,this._minHeight=null,this._maxHeight=null,this._freezeDimensions=!1,this._dimensionsFrozen=!1,this._bgFillColor=null,this._bgStrokeColor=null,this._bgStrokeSize=null,this._textStrokeColor=null,this._textStrokeSize=null,this._textFillColor="black",this._textDirection="horizontal",this._fontStyle="normal",this._fontVariant="normal",this._fontWeight="normal",this._fontFamily="sans-serif",this._fontSize=20,this._value=null,this.lastValue=null,a(t)&&(a(t.minWidth)&&(this._minWidth=t.minWidth),a(t.maxWidth)&&(this._maxWidth=t.maxWidth),a(t.minHeight)&&(this._minHeight=t.minHeight),a(t.maxHeight)&&(this._maxHeight=t.maxHeight),a(t.freezeDimensions)&&(this._freezeDimensions=t.freezeDimensions),a(t.textStrokeColor)&&(this._textStrokeColor=t.textStrokeColor),a(t.textStrokeSize)&&(this._textStrokeSize=t.textStrokeSize),a(t.bgFillColor)&&(this._bgFillColor=t.bgFillColor),a(t.bgStrokeColor)&&(this._bgStrokeColor=t.bgStrokeColor),a(t.bgStrokeSize)&&(this._bgStrokeSize=t.bgStrokeSize),a(t.value)&&(this._value=t.value),a(t.textFillColor)&&(this._textFillColor=t.textFillColor),a(t.textDirection)&&(this._textDirection=t.textDirection),a(t.fontStyle)&&(this._fontStyle=t.fontStyle),a(t.fontVariant)&&(this._fontVariant=t.fontVariant),a(t.fontWeight)&&(this._fontWeight=t.fontWeight),a(t.fontFamily)&&(this._fontFamily=t.fontFamily),a(t.fontSize)&&(this._fontSize=t.fontSize),a(t.padding)&&(A(t.padding)?this._padding={left:t.padding,right:t.padding,top:t.padding,bottom:t.padding}:this._padding=t.padding)),d(this._padding)&&(this._padding={top:0,right:0,bottom:0,left:0}),this.redraw()}get minWidth(){return this._minWidth}set minWidth(t){this.minWidth!==t&&(this._minWidth=t,this.redraw())}get maxWidth(){return this._maxWidth}set maxWidth(t){this.maxWidth!==t&&(this._maxWidth=t,this.redraw())}get minHeight(){return this._minHeight}set minHeight(t){this.minHeight!==t&&(this._minHeight=t,this.redraw())}get maxHeight(){return this._maxHeight}set maxHeight(t){this.maxHeight!==t&&(this._maxHeight=t,this.redraw())}get padding(){return this._padding}set padding(t){if(t instanceof Array)throw new Error("Invalid padding");(this.padding.top!==t.top||this.padding.right!=t.right||this.padding.bottom!=t.bottom||this.padding.left!=t.left)&&(this._padding=t,this.redraw())}get textDirection(){return this._textDirection}set textDirection(t){this.textDirection!==t&&(this._textDirection=t,this.redraw())}get fontStyle(){return this._fontStyle}set fontStyle(t){this.fontStyle!==t&&(this._fontStyle=t,this.redraw())}get fontVariant(){return this._fontVariant}set fontVariant(t){this.fontVariant!==t&&(this._fontVariant=t,this.redraw())}get fontWeight(){return this._fontWeight}set fontWeight(t){this.fontWeight!==t&&(this._fontWeight=t,this.redraw())}get fontSize(){return this._fontSize}set fontSize(t){this.fontSize!==t&&(this._fontSize=t,this.redraw())}get fontFamily(){return this._fontFamily}set fontFamily(t){this.fontFamily!==t&&(this._fontFamily=t,this.redraw())}get textFillColor(){return this._textFillColor}set textFillColor(t){this.textFillColor!==t&&(this._textFillColor=t,this.redraw())}get textStrokeColor(){return this._textStrokeColor}set textStrokeColor(t){this.textStrokeColor!==t&&(this._textStrokeColor=t,this.redraw())}get textStrokeSize(){return this._textStrokeSize}set textStrokeSize(t){this.textStrokeSize!==t&&(this._textStrokeSize=t,this.redraw())}get bgFillColor(){return this._bgFillColor}set bgFillColor(t){this.bgFillColor!==t&&(this._bgFillColor=t,this.redraw())}get bgStrokeColor(){return this._bgStrokeColor}set bgStrokeColor(t){this.bgStrokeColor!==t&&(this._bgStrokeColor=t,this.redraw())}get bgStrokeSize(){return this._bgStrokeSize}set bgStrokeSize(t){this.bgStrokeSize!==t&&(this._bgStrokeSize=t,this.redraw())}get value(){return this._value}set value(t){this.value!==t&&(this._value=t,this.redraw())}split(t){return t.replace(/\r\n/g,`
`).split(`
`)}unfreeze(){this._dimensionsFrozen=!1}onRedraw(){if(this.onClear(),this.visible&&this.fontFamily&&this.fontSize&&(this.textFillColor||this.textStrokeColor&&this.textStrokeSize)&&this.value&&this.value!==this.lastValue){let t=this.split(this.value),o=this.textDirection&&this.textDirection.indexOf("vertical")===0;if(this.trueWidth===null||this.trueHeight===null||this.dx===null||this.trueFontSize===null||!this._dimensionsFrozen){this._dimensionsFrozen=this._freezeDimensions;let r=this.minWidth!=null||this.maxWidth!=null||this.minHeight!=null||this.maxHeight!=null,i=((this.minWidth||0)-this.padding.right-this.padding.left)*this.scale,s=((this.maxWidth||4096)-this.padding.right-this.padding.left)*this.scale,p=((this.minHeight||0)-this.padding.top-this.padding.bottom)*this.scale,c=((this.maxHeight||4096)-this.padding.top-this.padding.bottom)*this.scale,l=o?p:i,x=o?c:s,g=o?i:p,R=o?s:c,lt=[];this.trueWidth=0,this.trueHeight=0,this.dx=0;let V=!1,f=!1,L=1e4,F=0;this.trueFontSize=Rt(this.fontSize*this.scale,F,L);let B=null,dt=Number.MAX_VALUE;do{let T=this.fontSize;this._fontSize=this.trueFontSize;let y=Ve(this);this._fontSize=T,this.g.textAlign="center",this.g.textBaseline="middle",this.g.font=y,this.trueWidth=0,this.trueHeight=0;for(let m of t){let _=this.g.measureText(m);this.trueWidth=Math.max(this.trueWidth,_.width),this.trueHeight+=this.trueFontSize,A(_.actualBoundingBoxLeft)&&A(_.actualBoundingBoxRight)&&A(_.actualBoundingBoxAscent)&&A(_.actualBoundingBoxDescent)&&(r||(this.trueWidth=_.actualBoundingBoxLeft+_.actualBoundingBoxRight,this.trueHeight=_.actualBoundingBoxAscent+_.actualBoundingBoxDescent,this.dx=(_.actualBoundingBoxLeft-this.trueWidth/2)/2))}if(r){let m=this.trueWidth-l,_=this.trueWidth-x,Xe=this.trueHeight-g,De=this.trueHeight-R,Uo=Math.abs(m),qo=Math.abs(_),Jo=Math.abs(Xe),$o=Math.abs(De);V=_>1||De>1,f=m<-1&&Xe<-1;let Oe=Math.min(Uo,Math.min(qo,Math.min(Jo,$o)));Oe<dt&&(dt=Oe,B=this.g.font),(V||f)&&lt.indexOf(this.g.font)>-1&&B&&(this.g.font=B,V=!1,f=!1),V?(L=this.trueFontSize,this.trueFontSize=(F+this.trueFontSize)/2):f&&(F=this.trueFontSize,this.trueFontSize=(this.trueFontSize+L)/2)}lt.push(this.g.font)}while(V||f);r&&(this.trueWidth<l?this.trueWidth=l:this.trueWidth>x&&(this.trueWidth=x),this.trueHeight<g?this.trueHeight=g:this.trueHeight>R&&(this.trueHeight=R));let Ut=this.trueWidth+this.scale*(this.padding.right+this.padding.left),qt=this.trueHeight+this.scale*(this.padding.top+this.padding.bottom);try{xe(this.g,Ut,qt)}catch(T){throw console.error(T),T}}this.bgFillColor?(this.g.fillStyle=this.bgFillColor,this.g.fillRect(0,0,this.canvas.width,this.canvas.height)):this.g.clearRect(0,0,this.canvas.width,this.canvas.height),this.textStrokeColor&&this.textStrokeSize&&(this.g.lineWidth=this.textStrokeSize*this.scale,this.g.strokeStyle=this.textStrokeColor),this.textFillColor&&(this.g.fillStyle=this.textFillColor);let n=.5*(t.length-1);for(let r=0;r<t.length;++r){let i=t[r],s=(r-n)*this.trueFontSize,p=this.dx+this.trueWidth/2+this.scale*this.padding.left,c=s+this.trueHeight/2+this.scale*this.padding.top;this.textStrokeColor&&this.textStrokeSize&&this.g.strokeText(i,p,c),this.textFillColor&&this.g.fillText(i,p,c)}if(this.bgStrokeColor&&this.bgStrokeSize){this.g.strokeStyle=this.bgStrokeColor,this.g.lineWidth=this.bgStrokeSize*this.scale;let r=this.bgStrokeSize/2;this.g.strokeRect(r,r,this.canvas.width-this.bgStrokeSize,this.canvas.height-this.bgStrokeSize)}if(o){let r=de(this.canvas.height,this.canvas.width),i=r.getContext("2d");i?(i.translate(r.width/2,r.height/2),this.textDirection==="vertical"||this.textDirection==="vertical-left"?i.rotate(ue):this.textDirection==="vertical-right"&&i.rotate(-ue),i.translate(-this.canvas.width/2,-this.canvas.height/2),i.drawImage(this.canvas,0,0),xe(this.g,r.width,r.height)):console.warn("Couldn't rotate the TextImage"),this.g.drawImage(r,0,0)}return this.lastValue=this.value,!0}else{let t=this.value!==this.lastValue;return this.lastValue=this.value,t}}};var er={type:"redrawn"},Bt=class extends h{get object(){return this}get element(){return ae(this.image.canvas)?this.image.canvas:null}get canvas(){return this._image.canvas}constructor(t,o,n,r,i){super(t,o,n,i),this._image=null,this.image=r}onRedrawn(){this.updateTexture(),this.dispatchEvent(er)}get image(){return this._image}set image(t){this.image&&this.image.removeScope(this),this._image=t,this.image&&(this.image.addScopedEventListener(this,"redrawn",()=>this.onRedrawn()),this.setTextureMap(this.image.canvas),this.onRedrawn())}get imageWidth(){return this.image.width}get imageHeight(){return this.image.height}copy(t,o=!0){return super.copy(t,o),this.image=t.image,this}get isVisible(){return bt(this)}set isVisible(t){At(this,t,"inline-block"),it(this,t),it(this.mesh,t),this.image.visible=t}};var ct=class extends Bt{constructor(t,o,n,r,i){let s;r instanceof at?s=r:s=new at(r),super(t,o,n,s,i)}onRedrawn(){this.objectHeight=this.imageHeight,super.onRedrawn()}};var Ie="Juniper:ThreeJS:EventSystem:RayTarget",jt=class extends M{constructor(t){super(),this.object=t,this.meshes=new Array,this._disabled=!1,this._clickable=!1,this._draggable=!1,this._navigable=!1,this.object.userData[Ie]=this}addMesh(t){return t.userData[Ie]=this,this.meshes.push(t),this}removeMesh(t){return S(this.meshes,t)&&delete t.userData[Ie],this}addMeshes(...t){for(let o of t)this.addMesh(o);return this}removeMeshes(...t){for(let o of t)this.removeMesh(o);return this}get disabled(){return this._disabled}set disabled(t){this._disabled=t}get enabled(){return!this.disabled}set enabled(t){this.disabled=!t}get clickable(){return this._clickable}set clickable(t){this._clickable=t}get draggable(){return this._draggable}set draggable(t){this._draggable=t}get navigable(){return this._navigable}set navigable(t){this._navigable=t}};var Wt=class extends jt{constructor(t,o,n,r,i){super(It(`MenuItem-${n}`)),this.front=r,this.back=i,this.startX=0,this.back&&(this.back=i,this.back.renderOrder=0,this.back.position.z=-.05,this.addMesh(this.back.mesh)),this.front&&(this.front=r,this.front.renderOrder=5,this.back||this.addMesh(this.front.mesh)),this.back.scale.x=t,this.back.scale.y=o,w(this,this.back,this.front)}get disabled(){return super.disabled}set disabled(t){t!==this.disabled&&(super.disabled=t,this.updateHover())}get clickable(){return super.clickable}set clickable(t){t!==this.clickable&&(super.clickable=t,this.updateHover())}updateHover(){To(this,this.clickable&&this.enabled)}get width(){return this.back.scale.x}get height(){return this.back.scale.y}};var or=new H(0,0,0),Go=5,zt=class extends G{constructor(t){super(),this.env=t,this.logo=null,this.animator=new Pt,this.lastMenuIndex=new Map,this.buttons=new Array,this.menuFont=null,this.curBlowout=Promise.resolve(),this.name="Menu",this.defaultButtonImage=new h(this.env,"DefaultButton","none"),this.logo={name:"Logo",noLabel:!0,back:new h(this.env,"LogoBack","none"),width:1,clickable:!1},this.backButton={name:"Back",back:new h(this.env,"BackButton","none")},this.nextButton={name:"Next",back:new h(this.env,"NextButton","none"),width:.25,textDirection:"vertical",textPosition:"middle",enabled:!0},this.prevButton={name:"Previous",back:new h(this.env,"PrevButton","none"),width:.25,height:1,textDirection:"vertical",textPosition:"top",enabled:!0},this.menuTitle={name:"Menu",back:new h(this.env,"MenuTitle","none"),width:.25,textDirection:"vertical",textPosition:"top",clickable:!1}}async load(t,o){this.menuFont=t.font;let n=t.images,r=new X(n.backButton,gt,!this.env.DEBUG),i=new X(n.defaultButton,gt,!this.env.DEBUG),s=new X(n.title,gt,!this.env.DEBUG),p=new X(n.logo.back,Qt,!this.env.DEBUG),c=null;n.logo.front&&(c=new X(n.logo.front,Qt,!this.env.DEBUG),this.logo.front=new h(this.env,"LogoFront","none",{transparent:!0})),await Q(o,[[1,l=>Io(this.menuFont,null,l)],[5,l=>this.env.fetcher.assets(l,r,i,s,p,c)]]),this.backButton.back.setTextureMap(r.result),this.defaultButtonImage.setTextureMap(i.result),this.menuTitle.back.setTextureMap(s.result),this.nextButton.back.setTextureMap(s.result),this.prevButton.back.setTextureMap(s.result),this.logo.back.setTextureMap(p.result),n.logo.front&&(this.logo.front.setTextureMap(c.result),this.logo.front.width=1)}async showMenu(t,o,n,r,i,s){let p=Go;do{let l=n.length%p;if(l===0||l===p-1||p===Math.ceil(Go/2))break;--p}while(!0);let c=this.lastMenuIndex.get(t)||0;await this.showMenuInternal(t,o,n,p,c,r,i,s)}disableAll(){setTimeout(()=>{for(let t of this.buttons)t.disabled=!0},10)}async showMenuInternal(t,o,n,r,i,s,p,c){this.lastMenuIndex.set(t,i),await this.curBlowout,this.clear(),this.menuTitle.text=o;let l=[this.logo,this.menuTitle];i>0&&l.push(this.prevButton),l.push(...n.slice(i,i+Math.min(r,n.length-i))),i<n.length-r&&l.push(this.nextButton);let x=s;if(s=m=>{this.disableAll(),x(m)},p){l.push(this.backButton);let m=p;p=()=>{this.disableAll(),m()}}let g=()=>{this.disableAll(),this.showMenuInternal(t,o,n,r,i-r,s,p)},R=()=>{this.disableAll(),this.showMenuInternal(t,o,n,r,i+r,s,p)},lt=await St(c,l,(m,_)=>m===this.backButton?this.createMenuItem(m,p,_):m===this.prevButton?this.createMenuItem(m,g,_):m===this.nextButton?this.createMenuItem(m,R,_):this.createMenuItem(m,s,_));je(this.buttons,...lt);let V=.05,f=3,L=(this.buttons.length-1)/2,F=Math.ceil(L),B=Math.floor(L+1),dt=this.buttons.slice(0,F).reverse(),Ut=this.buttons.slice(F,B),qt=this.buttons.slice(B,this.buttons.length),T=0,y=0;for(let m of Ut)T+=m.width+V,this.setButtonPosition(m,y,f);T/=2,y=-T/f;for(let m of dt)y-=.5*(m.width+V)/f,this.setButtonPosition(m,y,f),y-=.5*(m.width+V)/f;y=T/f;for(let m of qt)y+=.5*(m.width+V)/f,this.setButtonPosition(m,y,f),y+=.5*(m.width+V)/f;w(this,...this.buttons),await this.blowOut(!1);for(let m of this.buttons)m.back.frustumCulled=!0}update(t){this.animator.update(t)}setButtonPosition(t,o,n){let r=n*Math.sin(o),i=-n*Math.cos(o);t.object.position.set(r,0,i),t.object.lookAt(or),t.startX=r,t.object.position.x=r-10}async createMenuItem(t,o,n){if(!t.back){if(t.filePath){t.back=new h(this.env,`${t.name}-Background`,"none");let s=await this.env.fetcher.get(t.filePath).progress(n).image().then(k);t.back.setTextureMap(s)}else t.back=this.defaultButtonImage.clone();t.back.frustumCulled=!1}mt(t.width)||(t.width=.5),mt(t.height)||(t.height=1),u(t.textDirection)||(t.textDirection="horizontal"),u(t.textPosition)||(t.textPosition="bottom"),u(t.text)||(t.text=t.name);let r=t.enabled!==!1;if(t.text.length>0){if(!t.front&&!t.noLabel){let s={textFillColor:r?"white":"dimgray",textDirection:t.textDirection,padding:{top:.025,right:.05,bottom:.025,left:.05},scale:400,fontFamily:this.menuFont.fontFamily,fontSize:this.menuFont.fontSize,fontStyle:this.menuFont.fontStyle,fontVariant:this.menuFont.fontVariant,fontWeight:this.menuFont.fontWeight,maxWidth:t.width,maxHeight:t.height},p=new ct(this.env,t.text,"none",s);p.mesh.renderOrder=1,p.addEventListener("redrawn",()=>{let c=(p.image.height-t.height+.025)/2;t.textPosition==="bottom"?p.position.y=c:p.position.y=-c}),p.position.z=-.01,t.front=p}t.front&&(t.front.frustumCulled=!1,t.front instanceof ct&&(t.front.image.value=t.text))}let i=new Wt(t.width,t.height,t.name,t.front,t.back);return i.clickable=t.clickable!==!1,i.enabled=r,i.clickable&&v(o)&&i.addEventListener("click",()=>{this.curBlowout=this.blowOut(!0),o(t)}),n&&n.end("button loaded"),i}async blowOut(t){await Promise.all(this.buttons.map((o,n)=>this.blowOutChild(o,n,t))),this.animator.clear()}async blowOutChild(t,o,n){let r=t.disabled;t.disabled=!0,await this.animator.start(.125*o,.5,i=>{let s=Rt(n?i:1-i,0,1);t.object.position.x=t.startX-10*Tt(s,.15)}),t.disabled=r}};function Ho(e,t){e.element instanceof HTMLButtonElement&&(e.element.disabled=!t),So(e,t)}var Nt=class{constructor(t,o,n){this.element=t,this.object=o,this.displayType=n}get name(){return this.object.name}addEventListener(t,o,n){this.element.addEventListener(t,o,n)}dispatchEvent(t){return this.element.dispatchEvent(t)}removeEventListener(t,o,n){this.element.removeEventListener(t,o,n)}click(){this.element.click()}get visible(){return bt(this)}set visible(t){At(this,t,this.displayType),this.object.visible=t}};var Gt=class extends Nt{constructor(t,o,n){let r=$e(`${o} ${n}`);super(to(r,re(r,te(t.getImageSrc(o,n)))),It(`${name}-button`),"inline-block"),this.mesh=null,this.load(t,o,n)}async load(t,o,n){this.mesh=await t.getMeshButton(o,n,.2),this.mesh.disabled=this.disabled,w(this,this.mesh),this.mesh.object.visible=this.visible,this.mesh.addEventListener("click",()=>{this.element.click()})}get disabled(){return this.element.disabled}set disabled(t){this.element.disabled=t,this.mesh&&(this.mesh.disabled=t)}get visible(){return super.visible}set visible(t){super.visible=t,this.mesh&&it(this.mesh,t)}};var ke=class extends C{constructor(o){super("select");this.scenarioID=o}},Pe=class extends C{constructor(){super("lobby")}},Ht=class extends kt{menu;node2MenuItem=new Map;menuItem2Node=new Map;images=new Map;lobbyButton=null;menuDesc=null;curMenu=null;menuRoot=null;constructor(t){super(t),this.lobbyButton=new Gt(this.env.uiButtons,"ui","lobby"),this.menu=new zt(this.env),this.env.addScopedEventListener(this,"update",o=>this.menu.update(o.dt)),this.env.addScopedEventListener(this,"dialogshowing",o=>Ho(this.lobbyButton,!o.showing)),this.lobbyButton.addEventListener("click",()=>this.env.withConfirmation("Confirm return to lobby","Are you sure you want to return to the lobby?",()=>this.dispatchEvent(new Pe))),Object.seal(this)}async init(t){this.menuDesc=t.get("config"),await super.init(t)}async load(t){await Q(t,[[5,o=>this.menu.load(this.menuDesc,o)],[1,o=>this.loadMenuData(o)]]),w(this.env.worldUISpace,this.menu),this.env.xrUI.addItem(this.lobbyButton,{x:1,y:1,scale:.5}),wt(this.env.screenUISpace.topRight,this.lobbyButton)}async loadMenuData(t){this.destroyMenuItems();let o=await this.env.fetcher.get("/vr/menu"+(location.search.includes("all")?"/1":"")).progress(t).object().then(k);for(let s of o)a(s.audioElementCount)&&this.env.audio.preparePool(s.audioElementCount);let n=Array.from(new Set(o.map(s=>s.organizationName))),r=new Map;if(n.length>1){let s=o.filter(c=>d(c.parentID)),p=new ut;for(let c of s)p.add(c.organizationName,c);for(let c=0;c<n.length;++c){let l=n[c],x=-(c+1),g={id:x,label:l,order:c,organizationName:l};r.set(l,x),o.push(g);for(let R of p.get(l))R.parentID=x}}let i=Zt(o,s=>s.id);this.menuRoot=ze(o,s=>i.get(s.parentID),s=>s&&s.order||-1);for(let s of this.menuRoot.breadthFirst()){let p=s.value;if(p!==null){let c={name:p.label,filePath:p.filePath,enabled:!0};this.node2MenuItem.set(s,c),this.menuItem2Node.set(c,s)}}}async loadMenuItems(t,o){let n=Array.from(new Set(t.children.map(r=>r.value.filePath))).filter(r=>a(r)&&!this.images.has(r));await St(o,n,async(r,i)=>this.images.set(r,await this.env.fetcher.get(r).progress(i).image().then(k)));for(let r of t.children){let i=this.node2MenuItem.get(r);if(d(i.back)&&this.images.has(i.filePath)){let s=new h(this.env,i.filePath+i.name,"none");s.setTextureMap(this.images.get(i.filePath)),s.mesh.frustumCulled=!1,i.back=s}}}async showing(t){let o=this.curMenu||this.menuRoot;await Q(t,[[10,async n=>{this.env.skybox.rotation=null;let r=await this.env.fetcher.get("/vr/LandingPageImage").progress(n).image().then(k);return this.env.skybox.setImage("/vr/LandingPageImage",r)}],[1,n=>this.showMenuSelection(o,n)]]),this.menu.visible=!0,this.lobbyButton.visible=!1,this.join("lobby")}hiding(){this.menu.visible=!1,this.lobbyButton.visible=!0}get visible(){return this.menu.visible}dispose(){this.env.removeScope(this),this.env.worldUISpace.remove(this.menu),st(this.menu),this.menu.removeFromParent(),this.destroyMenuItems()}destroyMenuItems(){for(let t of this.images.values())O(t);this.images.clear(),this.node2MenuItem.clear(),this.menuItem2Node.clear()}async showMenuSelection(t,o){this.curMenu=t;let[n,r]=z(o,[10,1]);await this.loadMenuItems(t,n);let i=t.children.map(l=>this.node2MenuItem.get(l)),s=t.isRoot?null:()=>this.selectMenuItem(t.parent),p=0,c="Menu";t.value&&(p=t.value.id,c=t.value.label),await this.menu.showMenu(p,c,i,l=>{let x=this.menuItem2Node.get(l);this.selectMenuItem(x)},s,r)}async selectMenuItem(t,o){t.isLeaf?this.dispatchEvent(new ke(t.value.scenarioID)):await this.showMenuSelection(t,o)}};var jf=Ht;export{jf as default};
