function xe(t){return t}function Y(t,n,e){return typeof t===n||t instanceof e}function S(t){return Y(t,"function",Function)}function h(t){return Y(t,"string",String)}function R(t){return Y(t,"boolean",Boolean)}function C(t){return Y(t,"number",Number)}function zn(t){return m(t)||!Number.isFinite(t)||Number.isNaN(t)}function fe(t){return C(t)&&!zn(t)}function H(t){return l(t)&&Y(t,"object",Object)}function qe(t){return t instanceof Array}function m(t){return t==null}function l(t){return!m(t)}function Nn(t){return t}function Un(t,n,e){let o=0,r=t.length,i=Math.floor((o+r)/2),s=!1;for(;o<r&&i<t.length;){let a=t[i],p=m(a)?null:e(a);l(p)&&n<p?r=i:(n===p&&(s=!0),o=i+1),i=Math.floor((o+r)/2)}return s||(i+=.5),i}function Kn(t,n,e){e=e||Nn;let o=e(n);return Un(t,o,e)}function V(t){return t.splice(0)}function Lt(t,n){for(let e=0;e<t.length;++e)if(t[e]!==n[e])return e;return-1}function Je(t,n,e){t.splice(e,0,n)}function I(t,n){let e=t.indexOf(n);return e>-1?($e(t,e),!0):!1}function $e(t,n){return t.splice(n,1)[0]}function Dt(t,...n){t.splice(0,t.length,...n)}function qn(t,n,e){let o=t?0:n.length-1,r=t?n.length:-1,i=t?1:-1;for(let s of e)for(let a=o;a!=r;a+=i){let p=n[a];if(s(p))return p}return null}function Z(t,...n){return qn(!0,t,n)}function Ye(t,n,e,o){let r;return S(e)?r=e:R(e)&&(o=e),m(o)&&(o=!0),Jn(t,n,r,o)}function Jn(t,n,e,o){let r=Kn(t,n,e),i=r%1===0;return r=r|0,(!i||o)&&Je(t,n,r),r}var _e=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(n,e,o){if(S(e)){let r=this.listeners.get(n);r||(r=new Array,this.listeners.set(n,r)),r.find(i=>i===e)||(r.push(e),o&&this.listenerOptions.set(e,o))}}removeEventListener(n,e){if(S(e)){let o=this.listeners.get(n);o&&this.removeListener(o,e)}}clearEventListeners(n){for(let[e,o]of this.listeners)if(m(n)||n===e){for(let r of o)this.removeEventListener(n,r);V(o),this.listeners.delete(e)}}removeListener(n,e){let o=n.findIndex(r=>r===e);o>=0&&($e(n,o),this.listenerOptions.has(e)&&this.listenerOptions.delete(e))}dispatchEvent(n){let e=this.listeners.get(n.type);if(e)for(let o of e){let r=this.listenerOptions.get(o);l(r)&&!R(r)&&r.once&&this.removeListener(e,o),o.call(this,n)}return!n.defaultPrevented}},k=class extends Event{get type(){return super.type}constructor(n,e){super(n,e)}},w=class extends _e{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(e){this.bubblers.add(e)}removeBubbler(e){this.bubblers.delete(e)}addEventListener(e,o,r){super.addEventListener(e,o,r)}removeEventListener(e,o){super.removeEventListener(e,o)}clearEventListeners(e){return super.clearEventListeners(e)}addScopedEventListener(e,o,r,i){this.scopes.has(e)||this.scopes.set(e,[]),this.scopes.get(e).push([o,r]),this.addEventListener(o,r,i)}removeScope(e){let o=this.scopes.get(e);if(o){this.scopes.delete(e);for(let[r,i]of o)this.removeEventListener(r,i)}}dispatchEvent(e){if(!super.dispatchEvent(e))return!1;if(!e.cancelBubble){for(let o of this.bubblers)if(!o.dispatchEvent(e))return!1}return!0}};var W=class{constructor(n=!0){this.autoStart=n;this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._executionState="waiting";this._resultState="none";this.resolve=e=>{if(this.running){this._result=e,this._resultState="resolved";for(let o of this.onThens)o(e);this.clear(),this._executionState="finished"}},this.reject=e=>{if(this.running){this._error=e,this._resultState="errored";for(let o of this.onCatches)o(e);this.clear(),this._executionState="finished"}},this.autoStart&&this.start()}clear(){V(this.onThens),V(this.onCatches)}start(){this._executionState="running"}resolver(n){return()=>this.resolve(n)}resolveOn(n,e,o){let r=this.resolver(o);n.addEventListener(e,r),this.finally(()=>n.removeEventListener(e,r))}get result(){if(l(this.error))throw this.error;return this._result}get error(){return this._error}get executionState(){return this._executionState}get waiting(){return this.executionState==="waiting"}get started(){return this.executionState!=="waiting"}get running(){return this.executionState==="running"}get finished(){return this.executionState==="finished"}get resultState(){return this._resultState}get resolved(){return this.resultState==="resolved"}get errored(){return this.resultState==="errored"}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((n,e)=>{this.finished?this.errored?e(this.error):n(this.result):(this.onThens.push(n),this.onCatches.push(e))})}then(n,e){return this.project().then(n,e)}catch(n){return this.project().catch(n)}finally(n){return this.project().finally(n)}reset(){this._reset(this.autoStart)}restart(){this._reset(!0)}_reset(n){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._executionState="waiting",this._resultState="none",n&&this.start()}};var T=class{constructor(n,e,o,...r){this.key=n;this.value=e;this.bySetAttribute=o;this.tags=r.map(i=>i.toLocaleUpperCase()),Object.freeze(this)}applyToElement(n){let e=this.key.startsWith("data-");if(!(this.tags.length===0||this.tags.indexOf(n.tagName)>-1||e))console.warn(`Element ${n.tagName} does not support Attribute ${this.key}`);else if(e){let r=this.key.substring(5);n.dataset[r]=this.value}else if(this.key==="style")Object.assign(n.style,this.value);else if(this.key==="classList"){let r=this.value.filter(xe);r.length>0&&r.forEach(i=>n.classList.add(i))}else this.bySetAttribute?n.setAttribute(this.key,this.value):this.key in n?n[this.key]=this.value:this.value===!1?n.removeAttribute(this.key):this.value===!0?n.setAttribute(this.key,""):n.setAttribute(this.key,this.value)}};function Ot(...t){return new T("classList",t,!1)}function Xt(t){return new T("height",t,!1,"canvas","embed","iframe","img","input","object","video")}function $n(t){return t instanceof URL&&(t=t.href),t}function Ze(t){return new T("src",$n(t),!1,"audio","embed","iframe","img","input","script","source","track","video")}function Bt(t){return new T("title",t,!1)}function Ft(t){return h(t)||(t=t.value),new T("type",t,!1,"button","input","command","embed","link","object","script","source","style","menu")}function jt(t){return new T("width",t,!1,"canvas","embed","iframe","img","input","object","video")}function Gt(t){return`${t}px`}function Qe(t){return H(t)?t.element instanceof Element:!1}function ge(t){return Qe(t)?t.element:h(t)?Qn(t):t}function Zn(t){return H(t)&&"applyToElement"in t&&S(t.applyToElement)}function he(t,n,e=""){t=ge(t),t.style.display=n?e:"none"}function ve(t){return t=ge(t),t.style.display!=="none"}function be(t,...n){t=ge(t);for(let e of n)l(e)&&(e instanceof Node?t.append(e):Qe(e)?t.append(ge(e)):Zn(e)?e.applyToElement(t):t.append(document.createTextNode(e.toLocaleString())));return t}function Qn(t){return document.querySelector(t)}function et(t,...n){let e=null;for(let o of n)if(o instanceof T&&o.key==="id"){e=document.getElementById(o.value);break}return e==null&&(e=document.createElement(t)),be(e,...n),e}function Ht(t){return H(t)&&"disabled"in t&&R(t.disabled)}function eo(...t){return et("button",...t)}function to(...t){return eo(...t,Ft("button"))}function Wt(...t){return to(...t,Ot("btn","btn-primary"))}function zt(...t){return et("canvas",...t)}function tt(...t){return et("img",...t)}function Nt(t){if(t.status>=400)throw new Error("Resource could not be retrieved: "+t.requestPath);return t}function L(t){let{content:n}=Nt(t);return n}var Ut=/([^\/]+)\/(.+)/,no=/(?:([^\.]+)\.)?([^\+;]+)(?:\+([^;]+))?((?:; *([^=]+)=([^;]+))*)/;var D=class{constructor(n,e,o){this._type=n;this._fullSubType=e;this._primaryExtension=null;this.depMessage=null;let r=new Map;this._parameters=r;let i=this._fullSubType.match(no);this._tree=i[1],this._subType=i[2],this._suffix=i[3];let s=i[4];if(this._value=this._fullValue=this._type+"/",l(this._tree)&&(this._value=this._fullValue+=this._tree+"."),this._value=this._fullValue+=this._subType,l(this._suffix)&&(this._value=this._fullValue+="+"+this._suffix),l(s)){let a=s.split(";").map(p=>p.trim()).filter(p=>p.length>0).map(p=>p.split("="));for(let[p,...c]of a){let d=c.join("=");r.set(p,d);let f=`; ${p}=${d}`;this._fullValue+=f,p!=="q"&&(this._value+=f)}}this._extensions=o||[],this._primaryExtension=this._extensions[0]||null}static parse(n){if(!n)return null;let e=n.match(Ut);if(!e)return null;let o=e[1],r=e[2];return new D(o,r)}deprecate(n){return this.depMessage=n,this}check(){l(this.depMessage)&&console.warn(`${this._value} is deprecated ${this.depMessage}`)}matches(n){if(m(n))return!1;if(this.typeName==="*"&&this.subTypeName==="*")return!0;let e=null,o=null;if(h(n)){let r=n.match(Ut);if(!r)return!1;e=r[1],o=r[2]}else e=n.typeName,o=n._fullSubType;return this.typeName===e&&(this._fullSubType==="*"||this._fullSubType===o)}withParameter(n,e){let o=`${this._fullSubType}; ${n}=${e}`;return new D(this.typeName,o,this.extensions)}get typeName(){return this.check(),this._type}get tree(){return this.check(),this._tree}get suffix(){return this._suffix}get subTypeName(){return this.check(),this._subType}get value(){return this.check(),this._value}__getValueUnsafe(){return this._value}get fullValue(){return this.check(),this._fullValue}get parameters(){return this.check(),this._parameters}get extensions(){return this.check(),this._extensions}__getExtensionsUnsafe(){return this._extensions}get primaryExtension(){return this.check(),this._primaryExtension}toString(){return this.parameters.get("q")==="1"?this.value:this.fullValue}addExtension(n){if(!n)throw new Error("File name is not defined");if(this.primaryExtension){let e=n.lastIndexOf(".");if(e>-1){let o=n.substring(e+1);this.extensions.indexOf(o)>-1&&(n=n.substring(0,e))}n=`${n}.${this.primaryExtension}`}return n}};function oo(t,n,...e){return new D(t,n,e)}function v(t){return oo.bind(null,t)}var Kt=v("image");var Se=Kt("jpeg","jpeg","jpg","jpe");var nt=Kt("png","png");function ot(t,...n){if(!H(t))return!1;t=t;for(let e of n){if(!(e in t))return!1;let o=t[e];if(!S(o))return!1}return!0}function ro(t){return ot(t,"dispose")}function io(t){return ot(t,"destroy")}function so(t){return ot(t,"close")}function B(t){ro(t)&&t.dispose(),so(t)&&t.close(),io(t)&&t.destroy()}var Q="HTMLCanvasElement"in globalThis,Li="HTMLImageElement"in globalThis,qt=!1,rt=!qt&&"OffscreenCanvas"in globalThis,ao=!qt&&"createImageBitmap"in globalThis;function ee(t){return Q&&t instanceof HTMLCanvasElement}function it(t){return rt&&t instanceof OffscreenCanvas}function Jt(t){return ao&&t instanceof ImageBitmap}function $t(t){return t instanceof ImageData}function po(t){return ee(t)||it(t)}function Yt(t,n){let e=t.getContext("2d");if(m(e))throw new Error("Could not create 2d context for canvas");e.drawImage(n,0,0)}function Zt(t,n){let e=t.getContext("2d");if(m(e))throw new Error("Could not create 2d context for canvas");e.putImageData(n,0,0)}function lo(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var st=rt&&lo(),at=st&&pt||Q&&Ae||null,Qt=Q?Ae:at;function co(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var Di=rt&&co();function pt(t,n){return new OffscreenCanvas(t,n)}function Ae(t,n){return zt(jt(t),Xt(n))}function mo(t){let n=pt(t.width,t.height);return Yt(n,t),n}function uo(t){let n=Ae(t.width,t.height);return Yt(n,t),n}var en=st&&mo||Q&&uo||null;function xo(t){let n=pt(t.width,t.height);return Zt(n,t),n}function fo(t){let n=Ae(t.width,t.height);return Zt(n,t),n}var tn=st&&xo||Q&&fo||null;function nn(t,n,e,o=1){return n=Math.floor(n*o),e=Math.floor(e*o),t.width!=n||t.height!=e?(t.width=n,t.height=e,!0):!1}function _o(t){return l(t.textBaseline)}function go(t,n,e,o=1){let r=t.imageSmoothingEnabled,i=t.textBaseline,s=t.textAlign,a=t.font,p=nn(t.canvas,n,e,o);return p&&(t.imageSmoothingEnabled=r,t.textBaseline=i,t.textAlign=s,t.font=a),p}function lt(t,n,e,o=1){return _o(t)?go(t,n,e,o):nn(t.canvas,n,e,o)}function te(t){po(t)?t.width=t.height=0:B(t)}var ye=Math.PI,ct=.5*ye,Bi=2*ye;var ho=864e13,Fi=-ho;function Ce(t,n,e){return Math.min(e,Math.max(n,t))}function Ee(t,n){let e=t*ye;return .5*(1-Math.cos(e))-n*Math.sin(2*e)}function z(t,n){let e=globalThis,o=e[t];if(m(o)){if(m(n))throw new Error(`No value ${t} found`);o=n(),e[t]=o}return o}var{ACESFilmicToneMapping:Ni,AddEquation:Ui,AddOperation:Ki,AdditiveAnimationBlendMode:qi,AdditiveBlending:Ji,AlphaFormat:$i,AlwaysDepth:Yi,AlwaysStencilFunc:Zi,AmbientLight:Qi,AmbientLightProbe:es,AnimationClip:ts,AnimationLoader:ns,AnimationMixer:os,AnimationObjectGroup:rs,AnimationUtils:is,ArcCurve:ss,ArrayCamera:as,ArrowHelper:ps,Audio:ls,AudioAnalyser:cs,AudioContext:ms,AudioListener:ds,AudioLoader:us,AxesHelper:xs,BackSide:fs,BasicDepthPacking:_s,BasicShadowMap:gs,Bone:hs,BooleanKeyframeTrack:vs,Box2:bs,Box3:Ss,Box3Helper:As,BoxBufferGeometry:ys,BoxGeometry:Cs,BoxHelper:Es,BufferAttribute:Vs,BufferGeometry:ws,BufferGeometryLoader:Ts,ByteType:Ms,Cache:Ps,Camera:Rs,CameraHelper:Is,CanvasTexture:ks,CapsuleBufferGeometry:Ls,CapsuleGeometry:Ds,CatmullRomCurve3:Os,CineonToneMapping:Xs,CircleBufferGeometry:Bs,CircleGeometry:Fs,ClampToEdgeWrapping:js,Clock:Gs,Color:vo,ColorKeyframeTrack:Hs,ColorManagement:Ws,CompressedArrayTexture:zs,CompressedTexture:Ns,CompressedTextureLoader:Us,ConeBufferGeometry:Ks,ConeGeometry:qs,CubeCamera:Js,CubeReflectionMapping:$s,CubeRefractionMapping:Ys,CubeTexture:Zs,CubeTextureLoader:Qs,CubeUVReflectionMapping:ea,CubicBezierCurve:ta,CubicBezierCurve3:na,CubicInterpolant:oa,CullFaceBack:ra,CullFaceFront:ia,CullFaceFrontBack:sa,CullFaceNone:aa,Curve:pa,CurvePath:la,CustomBlending:ca,CustomToneMapping:ma,CylinderBufferGeometry:da,CylinderGeometry:ua,Cylindrical:xa,Data3DTexture:fa,DataArrayTexture:_a,DataTexture:ga,DataTextureLoader:ha,DataUtils:va,DecrementStencilOp:ba,DecrementWrapStencilOp:Sa,DefaultLoadingManager:Aa,DepthFormat:ya,DepthStencilFormat:Ca,DepthTexture:Ea,DirectionalLight:Va,DirectionalLightHelper:wa,DiscreteInterpolant:Ta,DisplayP3ColorSpace:Ma,DodecahedronBufferGeometry:Pa,DodecahedronGeometry:Ra,DoubleSide:Ia,DstAlphaFactor:ka,DstColorFactor:La,DynamicCopyUsage:Da,DynamicDrawUsage:Oa,DynamicReadUsage:Xa,EdgesGeometry:Ba,EllipseCurve:Fa,EqualDepth:ja,EqualStencilFunc:Ga,EquirectangularReflectionMapping:Ha,EquirectangularRefractionMapping:Wa,Euler:za,EventDispatcher:Na,ExtrudeBufferGeometry:Ua,ExtrudeGeometry:Ka,FileLoader:qa,Float16BufferAttribute:Ja,Float32BufferAttribute:$a,Float64BufferAttribute:Ya,FloatType:Za,Fog:Qa,FogExp2:ep,FramebufferTexture:tp,FrontSide:np,Frustum:op,GLBufferAttribute:rp,GLSL1:ip,GLSL3:sp,GreaterDepth:ap,GreaterEqualDepth:pp,GreaterEqualStencilFunc:lp,GreaterStencilFunc:cp,GridHelper:mp,Group:dp,HalfFloatType:up,HemisphereLight:xp,HemisphereLightHelper:fp,HemisphereLightProbe:_p,IcosahedronBufferGeometry:gp,IcosahedronGeometry:hp,ImageBitmapLoader:vp,ImageLoader:bp,ImageUtils:Sp,IncrementStencilOp:Ap,IncrementWrapStencilOp:yp,InstancedBufferAttribute:Cp,InstancedBufferGeometry:Ep,InstancedInterleavedBuffer:Vp,InstancedMesh:wp,Int16BufferAttribute:Tp,Int32BufferAttribute:Mp,Int8BufferAttribute:Pp,IntType:Rp,InterleavedBuffer:Ip,InterleavedBufferAttribute:kp,Interpolant:Lp,InterpolateDiscrete:Dp,InterpolateLinear:Op,InterpolateSmooth:Xp,InvertStencilOp:Bp,KeepStencilOp:Fp,KeyframeTrack:jp,LOD:Gp,LatheBufferGeometry:Hp,LatheGeometry:Wp,Layers:zp,LessDepth:Np,LessEqualDepth:Up,LessEqualStencilFunc:Kp,LessStencilFunc:qp,Light:Jp,LightProbe:$p,Line:Yp,Line3:Zp,LineBasicMaterial:bo,LineCurve:Qp,LineCurve3:el,LineDashedMaterial:tl,LineLoop:nl,LineSegments:ol,LinearEncoding:rl,LinearFilter:il,LinearInterpolant:sl,LinearMipMapLinearFilter:al,LinearMipMapNearestFilter:pl,LinearMipmapLinearFilter:ll,LinearMipmapNearestFilter:cl,LinearSRGBColorSpace:ml,LinearToneMapping:dl,Loader:ul,LoaderUtils:xl,LoadingManager:fl,LoopOnce:_l,LoopPingPong:gl,LoopRepeat:hl,LuminanceAlphaFormat:vl,LuminanceFormat:bl,MOUSE:Sl,Material:Al,MaterialLoader:yl,MathUtils:Cl,Matrix3:El,Matrix4:Ve,MaxEquation:Vl,Mesh:mt,MeshBasicMaterial:on,MeshDepthMaterial:wl,MeshDistanceMaterial:Tl,MeshLambertMaterial:Ml,MeshMatcapMaterial:Pl,MeshNormalMaterial:Rl,MeshPhongMaterial:So,MeshPhysicalMaterial:Il,MeshStandardMaterial:kl,MeshToonMaterial:Ll,MinEquation:Dl,MirroredRepeatWrapping:Ol,MixOperation:Xl,MultiplyBlending:Bl,MultiplyOperation:Fl,NearestFilter:jl,NearestMipMapLinearFilter:Gl,NearestMipMapNearestFilter:Hl,NearestMipmapLinearFilter:Wl,NearestMipmapNearestFilter:zl,NeverDepth:Nl,NeverStencilFunc:Ul,NoBlending:Kl,NoColorSpace:ql,NoToneMapping:Jl,NormalAnimationBlendMode:$l,NormalBlending:Yl,NotEqualDepth:Zl,NotEqualStencilFunc:Ql,NumberKeyframeTrack:ec,Object3D:N,ObjectLoader:tc,ObjectSpaceNormalMap:nc,OctahedronBufferGeometry:oc,OctahedronGeometry:rc,OneFactor:ic,OneMinusDstAlphaFactor:sc,OneMinusDstColorFactor:ac,OneMinusSrcAlphaFactor:pc,OneMinusSrcColorFactor:lc,OrthographicCamera:cc,PCFShadowMap:mc,PCFSoftShadowMap:dc,PMREMGenerator:uc,Path:xc,PerspectiveCamera:fc,Plane:_c,PlaneBufferGeometry:gc,PlaneGeometry:rn,PlaneHelper:hc,PointLight:vc,PointLightHelper:bc,Points:Sc,PointsMaterial:Ac,PolarGridHelper:yc,PolyhedronBufferGeometry:Cc,PolyhedronGeometry:Ec,PositionalAudio:Vc,PropertyBinding:wc,PropertyMixer:Tc,QuadraticBezierCurve:Mc,QuadraticBezierCurve3:Pc,Quaternion:sn,QuaternionKeyframeTrack:Rc,QuaternionLinearInterpolant:Ic,RED_GREEN_RGTC2_Format:kc,RED_RGTC1_Format:Lc,REVISION:Dc,RGBADepthPacking:Oc,RGBAFormat:Xc,RGBAIntegerFormat:Bc,RGBA_ASTC_10x10_Format:Fc,RGBA_ASTC_10x5_Format:jc,RGBA_ASTC_10x6_Format:Gc,RGBA_ASTC_10x8_Format:Hc,RGBA_ASTC_12x10_Format:Wc,RGBA_ASTC_12x12_Format:zc,RGBA_ASTC_4x4_Format:Nc,RGBA_ASTC_5x4_Format:Uc,RGBA_ASTC_5x5_Format:Kc,RGBA_ASTC_6x5_Format:qc,RGBA_ASTC_6x6_Format:Jc,RGBA_ASTC_8x5_Format:$c,RGBA_ASTC_8x6_Format:Yc,RGBA_ASTC_8x8_Format:Zc,RGBA_BPTC_Format:Qc,RGBA_ETC2_EAC_Format:em,RGBA_PVRTC_2BPPV1_Format:tm,RGBA_PVRTC_4BPPV1_Format:nm,RGBA_S3TC_DXT1_Format:om,RGBA_S3TC_DXT3_Format:rm,RGBA_S3TC_DXT5_Format:im,RGB_ETC1_Format:sm,RGB_ETC2_Format:am,RGB_PVRTC_2BPPV1_Format:pm,RGB_PVRTC_4BPPV1_Format:lm,RGB_S3TC_DXT1_Format:cm,RGFormat:mm,RGIntegerFormat:dm,RawShaderMaterial:um,Ray:xm,Raycaster:fm,RectAreaLight:_m,RedFormat:gm,RedIntegerFormat:hm,ReinhardToneMapping:vm,RepeatWrapping:bm,ReplaceStencilOp:Sm,ReverseSubtractEquation:Am,RingBufferGeometry:ym,RingGeometry:Cm,SIGNED_RED_GREEN_RGTC2_Format:Em,SIGNED_RED_RGTC1_Format:Vm,SRGBColorSpace:wm,Scene:Tm,ShaderChunk:Mm,ShaderLib:ne,ShaderMaterial:an,ShadowMaterial:Pm,Shape:Rm,ShapeBufferGeometry:Im,ShapeGeometry:km,ShapePath:Lm,ShapeUtils:Dm,ShortType:Om,Skeleton:Xm,SkeletonHelper:Bm,SkinnedMesh:Fm,Source:jm,Sphere:Gm,SphereBufferGeometry:Hm,SphereGeometry:Wm,Spherical:zm,SphericalHarmonics3:Nm,SplineCurve:Um,SpotLight:Km,SpotLightHelper:qm,Sprite:Jm,SpriteMaterial:Ao,SrcAlphaFactor:$m,SrcAlphaSaturateFactor:Ym,SrcColorFactor:Zm,StaticCopyUsage:Qm,StaticDrawUsage:ed,StaticReadUsage:td,StereoCamera:nd,StreamCopyUsage:od,StreamDrawUsage:rd,StreamReadUsage:id,StringKeyframeTrack:sd,SubtractEquation:ad,SubtractiveBlending:pd,TOUCH:ld,TangentSpaceNormalMap:cd,TetrahedronBufferGeometry:md,TetrahedronGeometry:dd,Texture:pn,TextureLoader:ud,TorusBufferGeometry:xd,TorusGeometry:fd,TorusKnotBufferGeometry:_d,TorusKnotGeometry:gd,Triangle:hd,TriangleFanDrawMode:vd,TriangleStripDrawMode:bd,TrianglesDrawMode:Sd,TubeBufferGeometry:Ad,TubeGeometry:yd,TwoPassDoubleSide:Cd,UVMapping:Ed,Uint16BufferAttribute:Vd,Uint32BufferAttribute:wd,Uint8BufferAttribute:Td,Uint8ClampedBufferAttribute:Md,Uniform:Pd,UniformsGroup:Rd,UniformsLib:oe,UniformsUtils:dt,UnsignedByteType:Id,UnsignedInt248Type:kd,UnsignedIntType:Ld,UnsignedShort4444Type:Dd,UnsignedShort5551Type:Od,UnsignedShortType:Xd,VSMShadowMap:Bd,Vector2:ln,Vector3:U,Vector4:cn,VectorKeyframeTrack:Fd,VideoTexture:mn,WebGL1Renderer:jd,WebGL3DRenderTarget:Gd,WebGLArrayRenderTarget:Hd,WebGLCubeRenderTarget:Wd,WebGLMultipleRenderTargets:zd,WebGLRenderTarget:Nd,WebGLRenderer:Ud,WebGLUtils:Kd,WireframeGeometry:qd,WrapAroundEnding:Jd,ZeroCurvatureEnding:$d,ZeroFactor:Yd,ZeroSlopeEnding:Zd,ZeroStencilOp:Qd,_SRGBAFormat:eu,sRGBEncoding:tu}=THREE;function re(t){return l(t)&&t.isMesh}function dn(t){return l(t)&&t.isMaterial}function yo(t,n){return dn(n)&&n.type===t}function un(t){return yo("MeshBasicMaterial",t)}function xn(t){return l(t)&&t.isObject3D}function fn(t){return l(t)&&xn(t.object)}function O(t){return fn(t)?t.object:t}function ie(t,n){return t=O(t),t.visible=n,n}function ut(t){if(!t)return!1;for(t=O(t);t;){if(!t.visible)return!1;t=t.parent}return!0}function b(t,...n){let e=n.filter(l).map(O);return e.length>0&&O(t).add(...e),t}function we(t,...n){let e=new N;return e.name=t,b(e,...n),e}function _n(t,n){t=O(t),Ht(t)&&(t.disabled=!n)}function gn(t,n,e){let o=new mt(n,e);return o.name=t,o}var K=z("Juniper:ScaledItems",()=>new Map),hn=1,Co=1.1;var xt=class{constructor(n){this.target=n;this.obj=O(this.target),this.base=this.obj.scale.clone(),this.p=0,this.dir=0,this.running=!1,this.wasDisabled=this.disabled,this.target.addScopedEventListener(this,"enter",e=>{e.pointer.type!=="nose"&&this.run(1)}),this.target.addScopedEventListener(this,"exit",e=>{e.pointer.type!=="nose"&&this.run(-1)}),this.obj.traverse(e=>{re(e)&&this.target.addMesh(e)})}get disabled(){return this.target.disabled}run(n){(!this.disabled||n===-1||this.p>0)&&(this.dir=n,this.running=!0)}updateScaling(n){if(this.disabled!==this.wasDisabled&&(this.wasDisabled=this.disabled,this.disabled&&this.run(-1)),this.running){this.p+=this.dir*n,(this.dir>0&&this.p>=1||this.dir<0&&this.p<0)&&(this.p=Math.max(0,Math.min(1,this.p)),this.running=!1);let e=Ee(this.p,1.1);this.obj.scale.copy(this.base).multiplyScalar(e*(Co-hn)+hn)}}dispose(){this.target.removeScope(this)}};function vn(t){let n=K.get(t);n&&(K.delete(t),B(n))}function bn(t,n){let e=K.has(t);if(n!=e)if(n)K.set(t,new xt(t));else{let o=K.get(t);B(o),K.delete(t)}}function se(t){let n=new Array,e=new Set;for(n.push(t);n.length>0;){let o=n.shift();o&&!e.has(o)&&(e.add(o),o.isMesh&&n.push(o.material,o.geometry),o.isMaterial&&n.push(...Object.values(o)),o.isObject3D&&(n.push(...o.children),o.clear(),vn(o)),qe(o)&&n.push(...o),te(o))}e.clear()}var q=class extends k{constructor(e,o){super(e);this.app=o}},ft=class extends q{constructor(e,o){super("joinroom",e);this.roomName=o}},_t=class extends q{constructor(n){super("quit",n)}},gt=class extends q{constructor(n){super("shown",n)}},ht=class extends q{constructor(n){super("hidden",n)}},Te=class extends w{constructor(e){super();this.env=e;this.dataLogger=null}quit(){this.dispatchEvent(new _t(this))}join(e){this.dispatchEvent(new ft(this,e)),this.env.avatar.reset()}async show(e){await this.showing(e),this.dispatchEvent(new gt(this))}hide(){this.hiding(),this.dispatchEvent(new ht(this))}init(e){return this.dataLogger=e.get("dataLogger"),Promise.resolve()}log(e,o){l(this.dataLogger)&&this.dataLogger.log(e,o)}error(e,o,r){l(this.dataLogger)&&this.dataLogger.error(e,o,r)}onError(e,o){return this.error.bind(this,e,o)}};var Eo="The quick brown fox jumps over the lazy dog",Sn=z("juniper::loadedFonts",()=>[]);function vt(t){let n=[];return t.fontStyle&&t.fontStyle!=="normal"&&n.push(t.fontStyle),t.fontVariant&&t.fontVariant!=="normal"&&n.push(t.fontVariant),t.fontWeight&&t.fontWeight!=="normal"&&n.push(t.fontWeight),n.push(Gt(t.fontSize)),n.push(t.fontFamily),n.join(" ")}async function An(t,n=null,e){if(h(t)||(t=vt(t)),Sn.indexOf(t)===-1){n=n||Eo,e&&e.start(t);let o=await document.fonts.load(t,n);e&&e.end(t),o.length===0?console.warn(`Failed to load font "${t}". If this is a system font, just set the object's \`value\` property, instead of calling \`loadFontAndSetText\`.`):Sn.push(t)}}var bt=class{constructor(n,e){this.path=n;this.type=e;this._result=null;this._error=null;this._started=!1;this._finished=!1;this.resolve=null;this.reject=null;this.promise=new Promise((o,r)=>{this.resolve=i=>{this._result=i,this._finished=!0,o(i)},this.reject=i=>{this._error=i,this._finished=!0,r(i)}})}get result(){if(l(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}async getSize(n){try{let{contentLength:e}=await n.head(this.path).accept(this.type).exec();return[this,e||1]}catch(e){return console.warn(e),[this,1]}}async fetch(n,e){try{let o=await this.getResult(n,e);this.resolve(o)}catch(o){this.reject(o)}}get[Symbol.toStringTag](){return this.promise.toString()}then(n,e){return this.promise.then(n,e)}catch(n){return this.promise.catch(n)}finally(n){return this.promise.finally(n)}};var St=class extends bt{constructor(e,o,r){let i;R(o)?r=o:i=o;super(e,i);this.useCache=!!r}getResult(e,o){return this.getRequest(e,o).then(L)}getRequest(e,o){let r=e.get(this.path).useCache(this.useCache).progress(o);return this.getResponse(r)}};var X=class extends St{getResponse(n){return n.image(this.type)}};function yn(t){return!t.started||t.finished}var At=class extends W{constructor(){super(!1);this.time=0;this.duration=0;this.onTick=null}begin(e,o,r){this.restart(),this.time=-e,this.duration=o,this.onTick=r,this.onTick(0)}update(e){yn(this)||(this.time+=e/this.duration,this.time>=1?(this.onTick(1),this.resolve()):this.time>=0&&this.onTick(this.time))}},Me=class{constructor(){this.animations=new Array}update(n){n=.001*n;for(let e of this.animations)e.update(n)}clear(){for(let n of this.animations)n.resolve()}start(n,e,o){let r=Z(this.animations,yn);return r||this.animations.push(r=new At),r.begin(n,e,o),r}};var Pe=class extends w{constructor(){super(...arguments);this.attached=new Array;this.soFar=null;this.total=null;this.msg=null;this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(e,o,r,i){this.soFar=e,this.total=o,this.msg=r,this.est=i;for(let s of this.attached)s.report(e,o,r,i)}attach(e){this.attached.push(e),e.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(e){this.report(0,1,e||"starting")}end(e){this.report(1,1,e||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,V(this.attached)}};var ae=class extends Pe{constructor(e,o){super();this.i=e;this.prog=o}report(e,o,r,i){super.report(e,o,r,i),this.prog.update(this.i,e,o,r)}};var Re=class{constructor(n){this.prog=n;this.weightTotal=0;this.subProgressCallbacks=new Array;this.subProgressWeights=new Array;this.subProgressValues=new Array;this.start=performance.now();for(let e=0;e<this.subProgressWeights.length;++e)this.subProgressValues[e]=0,this.subProgressCallbacks[e]=new ae(e,this)}addSubProgress(n){n=n||1,this.weightTotal+=n,this.subProgressWeights.push(n),this.subProgressValues.push(0);let e=new ae(this.subProgressCallbacks.length,this);return this.subProgressCallbacks.push(e),e}update(n,e,o,r){if(this.prog){this.subProgressValues[n]=e/o;let i=0;for(let c=0;c<this.subProgressWeights.length;++c)i+=this.subProgressValues[c]*this.subProgressWeights[c];let s=performance.now(),a=s-this.start,p=this.start-s+a*this.weightTotal/i;this.prog.report(i,this.weightTotal,r,p)}}};function J(t,n){return new yt(n,t).subProgressCallbacks}var yt=class extends Re{constructor(n,e){super(e);for(let o of n)this.addSubProgress(o)}};function Ie(t,n,e){let o=n.map(()=>1),r=J(t,o);return Promise.all(n.map(async(i,s)=>{let a=r[s];a.start();let p=await e(i,a,s);return a.end(),p}))}async function pe(t,n){let e=new Array(n.length),o=new Array(n.length);for(let s=0;s<n.length;++s){let a=n[s];e[s]=a[0],o[s]=a[1]}let r=J(t,e),i=new Array(n.length);for(let s=0;s<n.length;++s)i[s]=o[s](r[s]);return await Promise.all(i)}var Cn=304.79999999999995,nx=Cn*3,Vo=10*100,wo=Cn*16.5,To=wo*40,ox=Vo*1e3,rx=To*8,En=2.54*4,Vn=En*3,ix=Vn*3,Mo=Vn*16.5,Po=Mo*40,sx=100*1e3,ax=Po*8,Ct=4*3,Ro=Ct*3,le=100/2.54,Io=Ct*16.5,ko=Io*40,px=le*1e3,lx=ko*8,cx=3*3,Lo=100/En,Do=3*16.5,Oo=Do*40,mx=Lo*1e3,dx=Oo*8,wn=le/Ct,Xo=16.5*40,ux=wn*1e3,xx=Xo*8,Bo=le/Ro,Fo=16.5/3,jo=Fo*40,fx=Bo*1e3,_x=jo*8,Tn=16.5/wn,Mn=Tn*40,gx=Mn*8,hx=1e3/Tn,vx=40*8,Go=1e3/Mn,bx=8/Go;function Pn(t){return t/le}function Rn(t){return t*le}var Ho=new Ve,ke=new U,In=new cn,kn=new sn;function Et(t,n,e){return Ho.copy(t.matrixWorld).invert().multiply(n.matrixWorld).decompose(ke,kn,e),In.set(ke.x,ke.y,ke.z,1),new XRRigidTransform(In,kn)}oe.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new ln(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};ne.line={uniforms:dt.merge([oe.common,oe.fog,oe.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segements overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <encodings_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};var Le=class extends an{constructor(n){super({type:"LineMaterial",uniforms:dt.clone(ne.line.uniforms),vertexShader:ne.line.vertexShader,fragmentShader:ne.line.fragmentShader,clipping:!0}),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(e){!!e!="USE_DASH"in this.defines&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){!!e!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),e===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(n)}};Le.prototype.isLineMaterial=!0;var Vt=z("Juniper:Three:Materials",()=>new Map);function Wo(t,n){n in t&&delete t[n]}function zo(t,n,e){let o=`${t}_${Object.keys(e).map(r=>`${r}:${e[r]}`).join(",")}`;return Vt.has(o)||(Wo(e,"name"),Vt.set(o,new n(e))),Vt.get(o)}function No(t){return Object.assign(t,{transparent:!0})}function Ln(t){return zo("solidTransparent",on,No(t))}var wt=new rn(1,1,1,1);wt.name="PlaneGeom";var $=new U,Uo=0,g=class extends N{constructor(e,o,r,i=null){super();this.webXRLayerType=r;this.lastMatrixWorld=new Ve;this._imageWidth=0;this._imageHeight=0;this.forceUpdate=!1;this.wasUsingLayer=!1;this.layer=null;this.curImage=null;this.lastImage=null;this.lastWidth=null;this.lastHeight=null;this.env=null;this.mesh=null;this.stereoLayoutName="mono";this.sizeMode="none";if(e){this.setEnvAndName(e,o);let s=un(i)?i:Ln(Object.assign({},i,{name:this.name}));b(this,this.mesh=gn(o+"-Mesh",wt,s))}}copy(e,o=!0){return super.copy(e,o),this.webXRLayerType=e.webXRLayerType,this.setImageSize(e.imageWidth,e.imageHeight),this.setEnvAndName(e.env,e.name+ ++Uo),this.mesh=Z(this.children,re),m(this.mesh)&&(this.mesh=e.mesh.clone(),b(this,this.mesh)),this.setTextureMap(e.curImage),this}dispose(){this.env.removeScope(this),this.disposeImage(),se(this.mesh)}disposeImage(){this.removeWebXRLayer(),se(this.mesh.material.map),this.curImage=null}setImageSize(e,o){if(e!==this.imageWidth||o!==this.imageHeight){let{objectWidth:r,objectHeight:i}=this;this._imageWidth=e,this._imageHeight=o,this.sizeMode!=="none"&&(this.sizeMode==="fixed-width"?this.objectWidth=r:this.objectHeight=i)}}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get imageAspectRatio(){return this.imageWidth/this.imageHeight}get objectWidth(){return this.scale.x}set objectWidth(e){this.scale.set(e,this.scale.y=e/this.imageAspectRatio,1)}get objectHeight(){return this.scale.y}set objectHeight(e){this.scale.set(this.imageAspectRatio*e,e,1)}get pixelDensity(){let e=Rn(this.objectWidth);return this.imageWidth/e}set pixelDensity(e){let o=this.imageWidth/e,r=Pn(o);this.objectWidth=r}setEnvAndName(e,o){this.env=e,this.name=o,this.env.addScopedEventListener(this,"update",r=>this.checkWebXRLayer(r.frame))}get needsLayer(){return!ut(this)||m(this.mesh.material.map)||m(this.curImage)?!1:this.curImage instanceof HTMLVideoElement?!this.curImage.paused||this.curImage.currentTime>0:!0}removeWebXRLayer(){if(l(this.layer)){this.wasUsingLayer=!1,this.env.removeWebXRLayer(this.layer),this.mesh.visible=!0;let e=this.layer;this.layer=null,setTimeout(()=>te(e),100)}}setTextureMap(e){this.curImage&&this.disposeImage(),e&&(Jt(e)?e=en(e):$t(e)&&(e=tn(e)),it(e)&&(e=e),this.curImage=e,e instanceof HTMLVideoElement?(this.setImageSize(e.videoWidth,e.videoHeight),this.mesh.material.map=new mn(e)):(this.setImageSize(e.width,e.height),this.mesh.material.map=new pn(e),this.mesh.material.map.needsUpdate=!0)),this.mesh.material.needsUpdate=!0}get isVideo(){return this.curImage instanceof HTMLVideoElement}updateTexture(){if(l(this.curImage)){let e=this.curImage,o=this.isVideo?e.videoWidth:this.curImage.width,r=this.isVideo?e.videoHeight:this.curImage.height;if(this.imageWidth!==o||this.imageHeight!==r){let i=this.curImage;this.disposeImage(),this.setTextureMap(i)}else this.mesh.material.map.needsUpdate=this.forceUpdate=!0}}checkWebXRLayer(e){if(this.mesh.material.map&&this.curImage){let r=this.webXRLayerType!=="none"&&this.env.hasXRCompositionLayers&&this.env.showWebXRLayers&&l(e)&&(this.isVideo&&l(this.env.xrMediaBinding)||!this.isVideo&&l(this.env.xrBinding))&&this.needsLayer,i=r!==this.wasUsingLayer,s=this.curImage!==this.lastImage||this.mesh.material.needsUpdate||this.mesh.material.map.needsUpdate||this.forceUpdate,a=this.imageWidth!==this.lastWidth||this.imageHeight!==this.lastHeight;if(this.wasUsingLayer=r,this.lastImage=this.curImage,this.lastWidth=this.imageWidth,this.lastHeight=this.imageHeight,(i||a)&&((!r||a)&&this.layer&&this.removeWebXRLayer(),r)){let p=this.env.referenceSpace,c=Et(this.env.stage,this.mesh,$);this.lastMatrixWorld.copy(this.matrixWorld);let d=$.x/2,f=$.y/2,E=this.stereoLayoutName==="mono"?"mono":this.stereoLayoutName==="left-right"||this.stereoLayoutName==="right-left"?"stereo-left-right":"stereo-top-bottom";if(this.isVideo){let M=this.stereoLayoutName==="right-left"||this.stereoLayoutName==="bottom-top";this.layer=this.env.xrMediaBinding.createQuadLayer(this.curImage,{space:p,layout:E,invertStereo:M,transform:c,width:d,height:f})}else this.layer=this.env.xrBinding.createQuadLayer({space:p,layout:E,textureType:"texture",isStatic:this.webXRLayerType==="static",viewPixelWidth:this.curImage.width,viewPixelHeight:this.curImage.height,transform:c,width:d,height:f});this.env.addWebXRLayer(this.layer,500),this.mesh.visible=!1}if(this.layer){if(s||this.layer.needsRedraw){let p=this.env.gl,c=this.env.xrBinding.getSubImage(this.layer,e);p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),p.bindTexture(p.TEXTURE_2D,c.colorTexture),p.texSubImage2D(p.TEXTURE_2D,0,0,0,p.RGBA,p.UNSIGNED_BYTE,this.curImage),p.generateMipmap(p.TEXTURE_2D),p.bindTexture(p.TEXTURE_2D,null),this.forceUpdate=!1}Lt(this.matrixWorld.elements,this.lastMatrixWorld.elements)>=0&&(this.layer.transform=Et(this.env.stage,this.mesh,$),this.lastMatrixWorld.copy(this.matrixWorld),this.layer.width=$.x/2,this.layer.height=$.y/2)}else this.forceUpdate=!1}}};var De=class extends w{constructor(e,o,r){super();this._scale=250;this._visible=!0;this.wasVisible=null;this.redrawnEvt=new k("redrawn");this.element=null;l(r)&&l(r.scale)&&(this._scale=r.scale),this._canvas=Qt(e,o),this._g=this.canvas.getContext("2d"),ee(this._canvas)&&(this.element=this._canvas)}fillRect(e,o,r,i,s,a){this.g.fillStyle=e,this.g.fillRect(o+a,r+a,i-2*a,s-2*a)}drawText(e,o,r,i){this.g.textAlign=i,this.g.strokeText(e,o,r),this.g.fillText(e,o,r)}redraw(){(this.visible||this.wasVisible)&&this.onRedraw()&&(this.wasVisible=this.visible,this.dispatchEvent(this.redrawnEvt))}onClear(){this.g.clearRect(0,0,this.canvas.width,this.canvas.height)}clear(){this.onClear(),this.dispatchEvent(this.redrawnEvt)}get canvas(){return this._canvas}get g(){return this._g}get imageWidth(){return this.canvas.width}get imageHeight(){return this.canvas.height}get aspectRatio(){return this.imageWidth/this.imageHeight}get width(){return this.imageWidth/this.scale}get height(){return this.imageHeight/this.scale}get scale(){return this._scale}set scale(e){this.scale!==e&&(this._scale=e,this.redraw())}get visible(){return this._visible}set visible(e){this.visible!==e&&(this.wasVisible=this._visible,this._visible=e,this.redraw())}};var ce=class extends De{constructor(e){super(10,10,e);this.trueWidth=null;this.trueHeight=null;this.trueFontSize=null;this.dx=null;this._minWidth=null;this._maxWidth=null;this._minHeight=null;this._maxHeight=null;this._freezeDimensions=!1;this._dimensionsFrozen=!1;this._bgFillColor=null;this._bgStrokeColor=null;this._bgStrokeSize=null;this._textStrokeColor=null;this._textStrokeSize=null;this._textFillColor="black";this._textDirection="horizontal";this._fontStyle="normal";this._fontVariant="normal";this._fontWeight="normal";this._fontFamily="sans-serif";this._fontSize=20;this._value=null;this.lastValue=null;l(e)&&(l(e.minWidth)&&(this._minWidth=e.minWidth),l(e.maxWidth)&&(this._maxWidth=e.maxWidth),l(e.minHeight)&&(this._minHeight=e.minHeight),l(e.maxHeight)&&(this._maxHeight=e.maxHeight),l(e.freezeDimensions)&&(this._freezeDimensions=e.freezeDimensions),l(e.textStrokeColor)&&(this._textStrokeColor=e.textStrokeColor),l(e.textStrokeSize)&&(this._textStrokeSize=e.textStrokeSize),l(e.bgFillColor)&&(this._bgFillColor=e.bgFillColor),l(e.bgStrokeColor)&&(this._bgStrokeColor=e.bgStrokeColor),l(e.bgStrokeSize)&&(this._bgStrokeSize=e.bgStrokeSize),l(e.value)&&(this._value=e.value),l(e.textFillColor)&&(this._textFillColor=e.textFillColor),l(e.textDirection)&&(this._textDirection=e.textDirection),l(e.fontStyle)&&(this._fontStyle=e.fontStyle),l(e.fontVariant)&&(this._fontVariant=e.fontVariant),l(e.fontWeight)&&(this._fontWeight=e.fontWeight),l(e.fontFamily)&&(this._fontFamily=e.fontFamily),l(e.fontSize)&&(this._fontSize=e.fontSize),l(e.padding)&&(C(e.padding)?this._padding={left:e.padding,right:e.padding,top:e.padding,bottom:e.padding}:this._padding=e.padding)),m(this._padding)&&(this._padding={top:0,right:0,bottom:0,left:0}),this.redraw()}get minWidth(){return this._minWidth}set minWidth(e){this.minWidth!==e&&(this._minWidth=e,this.redraw())}get maxWidth(){return this._maxWidth}set maxWidth(e){this.maxWidth!==e&&(this._maxWidth=e,this.redraw())}get minHeight(){return this._minHeight}set minHeight(e){this.minHeight!==e&&(this._minHeight=e,this.redraw())}get maxHeight(){return this._maxHeight}set maxHeight(e){this.maxHeight!==e&&(this._maxHeight=e,this.redraw())}get padding(){return this._padding}set padding(e){if(e instanceof Array)throw new Error("Invalid padding");(this.padding.top!==e.top||this.padding.right!=e.right||this.padding.bottom!=e.bottom||this.padding.left!=e.left)&&(this._padding=e,this.redraw())}get textDirection(){return this._textDirection}set textDirection(e){this.textDirection!==e&&(this._textDirection=e,this.redraw())}get fontStyle(){return this._fontStyle}set fontStyle(e){this.fontStyle!==e&&(this._fontStyle=e,this.redraw())}get fontVariant(){return this._fontVariant}set fontVariant(e){this.fontVariant!==e&&(this._fontVariant=e,this.redraw())}get fontWeight(){return this._fontWeight}set fontWeight(e){this.fontWeight!==e&&(this._fontWeight=e,this.redraw())}get fontSize(){return this._fontSize}set fontSize(e){this.fontSize!==e&&(this._fontSize=e,this.redraw())}get fontFamily(){return this._fontFamily}set fontFamily(e){this.fontFamily!==e&&(this._fontFamily=e,this.redraw())}get textFillColor(){return this._textFillColor}set textFillColor(e){this.textFillColor!==e&&(this._textFillColor=e,this.redraw())}get textStrokeColor(){return this._textStrokeColor}set textStrokeColor(e){this.textStrokeColor!==e&&(this._textStrokeColor=e,this.redraw())}get textStrokeSize(){return this._textStrokeSize}set textStrokeSize(e){this.textStrokeSize!==e&&(this._textStrokeSize=e,this.redraw())}get bgFillColor(){return this._bgFillColor}set bgFillColor(e){this.bgFillColor!==e&&(this._bgFillColor=e,this.redraw())}get bgStrokeColor(){return this._bgStrokeColor}set bgStrokeColor(e){this.bgStrokeColor!==e&&(this._bgStrokeColor=e,this.redraw())}get bgStrokeSize(){return this._bgStrokeSize}set bgStrokeSize(e){this.bgStrokeSize!==e&&(this._bgStrokeSize=e,this.redraw())}get value(){return this._value}set value(e){this.value!==e&&(this._value=e,this.redraw())}split(e){return e.replace(/\r\n/g,`
`).split(`
`)}unfreeze(){this._dimensionsFrozen=!1}onRedraw(){if(this.onClear(),this.visible&&this.fontFamily&&this.fontSize&&(this.textFillColor||this.textStrokeColor&&this.textStrokeSize)&&this.value&&this.value!==this.lastValue){let e=this.split(this.value),o=this.textDirection&&this.textDirection.indexOf("vertical")===0;if(this.trueWidth===null||this.trueHeight===null||this.dx===null||this.trueFontSize===null||!this._dimensionsFrozen){this._dimensionsFrozen=this._freezeDimensions;let i=this.minWidth!=null||this.maxWidth!=null||this.minHeight!=null||this.maxHeight!=null,s=((this.minWidth||0)-this.padding.right-this.padding.left)*this.scale,a=((this.maxWidth||4096)-this.padding.right-this.padding.left)*this.scale,p=((this.minHeight||0)-this.padding.top-this.padding.bottom)*this.scale,c=((this.maxHeight||4096)-this.padding.top-this.padding.bottom)*this.scale,d=o?p:s,f=o?c:a,E=o?s:p,M=o?a:c,de=[];this.trueWidth=0,this.trueHeight=0,this.dx=0;let A=!1,_=!1,F=1e4,j=0;this.trueFontSize=Ce(this.fontSize*this.scale,j,F);let G=null,ue=Number.MAX_VALUE;do{let P=this.fontSize;this._fontSize=this.trueFontSize;let y=vt(this);this._fontSize=P,this.g.textAlign="center",this.g.textBaseline="middle",this.g.font=y,this.trueWidth=0,this.trueHeight=0;for(let u of e){let x=this.g.measureText(u);this.trueWidth=Math.max(this.trueWidth,x.width),this.trueHeight+=this.trueFontSize,C(x.actualBoundingBoxLeft)&&C(x.actualBoundingBoxRight)&&C(x.actualBoundingBoxAscent)&&C(x.actualBoundingBoxDescent)&&(i||(this.trueWidth=x.actualBoundingBoxLeft+x.actualBoundingBoxRight,this.trueHeight=x.actualBoundingBoxAscent+x.actualBoundingBoxDescent,this.dx=(x.actualBoundingBoxLeft-this.trueWidth/2)/2))}if(i){let u=this.trueWidth-d,x=this.trueWidth-f,Rt=this.trueHeight-E,It=this.trueHeight-M,jn=Math.abs(u),Gn=Math.abs(x),Hn=Math.abs(Rt),Wn=Math.abs(It);A=x>1||It>1,_=u<-1&&Rt<-1;let kt=Math.min(jn,Math.min(Gn,Math.min(Hn,Wn)));kt<ue&&(ue=kt,G=this.g.font),(A||_)&&de.indexOf(this.g.font)>-1&&G&&(this.g.font=G,A=!1,_=!1),A?(F=this.trueFontSize,this.trueFontSize=(j+this.trueFontSize)/2):_&&(j=this.trueFontSize,this.trueFontSize=(this.trueFontSize+F)/2)}de.push(this.g.font)}while(A||_);i&&(this.trueWidth<d?this.trueWidth=d:this.trueWidth>f&&(this.trueWidth=f),this.trueHeight<E?this.trueHeight=E:this.trueHeight>M&&(this.trueHeight=M));let Ue=this.trueWidth+this.scale*(this.padding.right+this.padding.left),Ke=this.trueHeight+this.scale*(this.padding.top+this.padding.bottom);try{lt(this.g,Ue,Ke)}catch(P){throw console.error(P),P}}this.bgFillColor?(this.g.fillStyle=this.bgFillColor,this.g.fillRect(0,0,this.canvas.width,this.canvas.height)):this.g.clearRect(0,0,this.canvas.width,this.canvas.height),this.textStrokeColor&&this.textStrokeSize&&(this.g.lineWidth=this.textStrokeSize*this.scale,this.g.strokeStyle=this.textStrokeColor),this.textFillColor&&(this.g.fillStyle=this.textFillColor);let r=.5*(e.length-1);for(let i=0;i<e.length;++i){let s=e[i],a=(i-r)*this.trueFontSize,p=this.dx+this.trueWidth/2+this.scale*this.padding.left,c=a+this.trueHeight/2+this.scale*this.padding.top;this.textStrokeColor&&this.textStrokeSize&&this.g.strokeText(s,p,c),this.textFillColor&&this.g.fillText(s,p,c)}if(this.bgStrokeColor&&this.bgStrokeSize){this.g.strokeStyle=this.bgStrokeColor,this.g.lineWidth=this.bgStrokeSize*this.scale;let i=this.bgStrokeSize/2;this.g.strokeRect(i,i,this.canvas.width-this.bgStrokeSize,this.canvas.height-this.bgStrokeSize)}if(o){let i=at(this.canvas.height,this.canvas.width),s=i.getContext("2d");s?(s.translate(i.width/2,i.height/2),this.textDirection==="vertical"||this.textDirection==="vertical-left"?s.rotate(ct):this.textDirection==="vertical-right"&&s.rotate(-ct),s.translate(-this.canvas.width/2,-this.canvas.height/2),s.drawImage(this.canvas,0,0),lt(this.g,i.width,i.height)):console.warn("Couldn't rotate the TextImage"),this.g.drawImage(i,0,0)}return this.lastValue=this.value,!0}else{let e=this.value!==this.lastValue;return this.lastValue=this.value,e}}};var Ko={type:"redrawn"},Oe=class extends g{constructor(e,o,r,i,s){super(e,o,r,s);this._image=null;this.image=i}get object(){return this}get element(){return ee(this.image.canvas)?this.image.canvas:null}onRedrawn(){this.updateTexture(),this.dispatchEvent(Ko)}get image(){return this._image}set image(e){this.image&&this.image.removeScope(this),this._image=e,this.image&&(this.image.addScopedEventListener(this,"redrawn",()=>this.onRedrawn()),this.setTextureMap(this.image.canvas),this.onRedrawn())}get imageWidth(){return this.image.width}get imageHeight(){return this.image.height}copy(e,o=!0){return super.copy(e,o),this.image=e.image,this}get isVisible(){return ve(this)}set isVisible(e){he(this,e,"inline-block"),ie(this,e),ie(this.mesh,e),this.image.visible=e}};var me=class extends Oe{constructor(n,e,o,r,i){let s;r instanceof ce?s=r:s=new ce(r),super(n,e,o,s,i)}onRedrawn(){this.objectHeight=this.imageHeight,super.onRedrawn()}};var Tt="Juniper:ThreeJS:EventSystem:RayTarget",Xe=class extends w{constructor(e){super();this.object=e;this.meshes=new Array;this._disabled=!1;this._clickable=!1;this._draggable=!1;this._navigable=!1;this.object.userData[Tt]=this}addMesh(e){return e.userData[Tt]=this,this.meshes.push(e),this}removeMesh(e){return I(this.meshes,e)&&delete e.userData[Tt],this}addMeshes(...e){for(let o of e)this.addMesh(o);return this}removeMeshes(...e){for(let o of e)this.removeMesh(o);return this}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get enabled(){return!this.disabled}set enabled(e){this.disabled=!e}get clickable(){return this._clickable}set clickable(e){this._clickable=e}get draggable(){return this._draggable}set draggable(e){this._draggable=e}get navigable(){return this._navigable}set navigable(e){this._navigable=e}};var Be=class extends Xe{constructor(e,o,r,i,s){super(we(`MenuItem-${r}`));this.front=i;this.back=s;this.startX=0;this.back&&(this.back=s,this.back.renderOrder=0,this.back.position.z=-.05,this.addMesh(this.back.mesh)),this.front&&(this.front=i,this.front.renderOrder=5,this.back||this.addMesh(this.front.mesh)),this.back.scale.x=e,this.back.scale.y=o,b(this,this.back,this.front)}get disabled(){return super.disabled}set disabled(e){e!==this.disabled&&(super.disabled=e,this.updateHover())}get clickable(){return super.clickable}set clickable(e){e!==this.clickable&&(super.clickable=e,this.updateHover())}updateHover(){bn(this,this.clickable&&this.enabled)}get width(){return this.back.scale.x}get height(){return this.back.scale.y}};var qo=new U(0,0,0),Dn=5,Fe=class extends N{constructor(e){super();this.env=e;this.logo=null;this.animator=new Me;this.lastMenuIndex=new Map;this.buttons=new Array;this.menuFont=null;this.curBlowout=Promise.resolve();this.name="Menu",this.defaultButtonImage=new g(this.env,"DefaultButton","none"),this.logo={name:"Logo",noLabel:!0,back:new g(this.env,"LogoBack","none"),width:1,clickable:!1},this.backButton={name:"Back",back:new g(this.env,"BackButton","none")},this.nextButton={name:"Next",back:new g(this.env,"NextButton","none"),width:.25,textDirection:"vertical",textPosition:"middle",enabled:!0},this.prevButton={name:"Previous",back:new g(this.env,"PrevButton","none"),width:.25,height:1,textDirection:"vertical",textPosition:"top",enabled:!0},this.menuTitle={name:"Menu",back:new g(this.env,"MenuTitle","none"),width:.25,textDirection:"vertical",textPosition:"top",clickable:!1}}async load(e,o){this.menuFont=e.font;let r=e.images,i=new X(r.backButton,Se,!this.env.DEBUG),s=new X(r.defaultButton,Se,!this.env.DEBUG),a=new X(r.title,Se,!this.env.DEBUG),p=new X(r.logo.back,nt,!this.env.DEBUG),c=null;r.logo.front&&(c=new X(r.logo.front,nt,!this.env.DEBUG),this.logo.front=new g(this.env,"LogoFront","none",{transparent:!0})),await pe(o,[[1,d=>An(this.menuFont,null,d)],[5,d=>this.env.fetcher.assets(d,i,s,a,p,c)]]),this.backButton.back.setTextureMap(i.result),this.defaultButtonImage.setTextureMap(s.result),this.menuTitle.back.setTextureMap(a.result),this.nextButton.back.setTextureMap(a.result),this.prevButton.back.setTextureMap(a.result),this.logo.back.setTextureMap(p.result),r.logo.front&&(this.logo.front.setTextureMap(c.result),this.logo.front.width=1)}async showMenu(e,o,r,i,s,a){let p=Dn;do{let d=r.length%p;if(d===0||d===p-1||p===Math.ceil(Dn/2))break;--p}while(!0);let c=this.lastMenuIndex.get(e)||0;await this.showMenuInternal(e,o,r,p,c,i,s,a)}disableAll(){setTimeout(()=>{for(let e of this.buttons)e.disabled=!0},10)}async showMenuInternal(e,o,r,i,s,a,p,c){this.lastMenuIndex.set(e,s),await this.curBlowout,this.clear(),this.menuTitle.text=o;let d=[this.logo,this.menuTitle];s>0&&d.push(this.prevButton),d.push(...r.slice(s,s+Math.min(i,r.length-s))),s<r.length-i&&d.push(this.nextButton);let f=a;if(a=u=>{this.disableAll(),f(u)},p){d.push(this.backButton);let u=p;p=()=>{this.disableAll(),u()}}let E=()=>{this.disableAll(),this.showMenuInternal(e,o,r,i,s-i,a,p)},M=()=>{this.disableAll(),this.showMenuInternal(e,o,r,i,s+i,a,p)},de=await Ie(c,d,(u,x)=>u===this.backButton?this.createMenuItem(u,p,x):u===this.prevButton?this.createMenuItem(u,E,x):u===this.nextButton?this.createMenuItem(u,M,x):this.createMenuItem(u,a,x));Dt(this.buttons,...de);let A=.05,_=3,F=(this.buttons.length-1)/2,j=Math.ceil(F),G=Math.floor(F+1),ue=this.buttons.slice(0,j).reverse(),Ue=this.buttons.slice(j,G),Ke=this.buttons.slice(G,this.buttons.length),P=0,y=0;for(let u of Ue)P+=u.width+A,this.setButtonPosition(u,y,_);P/=2,y=-P/_;for(let u of ue)y-=.5*(u.width+A)/_,this.setButtonPosition(u,y,_),y-=.5*(u.width+A)/_;y=P/_;for(let u of Ke)y+=.5*(u.width+A)/_,this.setButtonPosition(u,y,_),y+=.5*(u.width+A)/_;b(this,...this.buttons),await this.blowOut(!1);for(let u of this.buttons)u.back.frustumCulled=!0}update(e){this.animator.update(e)}setButtonPosition(e,o,r){let i=r*Math.sin(o),s=-r*Math.cos(o);e.object.position.set(i,0,s),e.object.lookAt(qo),e.startX=i,e.object.position.x=i-10}async createMenuItem(e,o,r){if(!e.back){if(e.filePath){e.back=new g(this.env,`${e.name}-Background`,"none");let a=await this.env.fetcher.get(e.filePath).progress(r).image().then(L);e.back.setTextureMap(a)}else e.back=this.defaultButtonImage.clone();e.back.frustumCulled=!1}fe(e.width)||(e.width=.5),fe(e.height)||(e.height=1),h(e.textDirection)||(e.textDirection="horizontal"),h(e.textPosition)||(e.textPosition="bottom"),h(e.text)||(e.text=e.name);let i=e.enabled!==!1;if(e.text.length>0){if(!e.front&&!e.noLabel){let a={textFillColor:i?"white":"dimgray",textDirection:e.textDirection,padding:{top:.025,right:.05,bottom:.025,left:.05},scale:400,fontFamily:this.menuFont.fontFamily,fontSize:this.menuFont.fontSize,fontStyle:this.menuFont.fontStyle,fontVariant:this.menuFont.fontVariant,fontWeight:this.menuFont.fontWeight,maxWidth:e.width,maxHeight:e.height},p=new me(this.env,e.text,"none",a);p.mesh.renderOrder=1,p.addEventListener("redrawn",()=>{let c=(p.image.height-e.height+.025)/2;e.textPosition==="bottom"?p.position.y=c:p.position.y=-c}),p.position.z=-.01,e.front=p}e.front&&(e.front.frustumCulled=!1,e.front instanceof me&&(e.front.image.value=e.text))}let s=new Be(e.width,e.height,e.name,e.front,e.back);return s.clickable=e.clickable!==!1,s.enabled=i,s.clickable&&S(o)&&s.addEventListener("click",()=>{this.curBlowout=this.blowOut(!0),o(e)}),r&&r.end("button loaded"),s}async blowOut(e){await Promise.all(this.buttons.map((o,r)=>this.blowOutChild(o,r,e))),this.animator.clear()}async blowOutChild(e,o,r){let i=e.disabled;e.disabled=!0,await this.animator.start(.125*o,.5,s=>{let a=Ce(r?s:1-s,0,1);e.object.position.x=e.startX-10*Ee(a,.15)}),e.disabled=i}};function On(t,n){t.element instanceof HTMLButtonElement&&(t.element.disabled=!n),_n(t,n)}var je=class{constructor(n,e,o){this.element=n;this.object=e;this.displayType=o}get name(){return this.object.name}addEventListener(n,e,o){this.element.addEventListener(n,e,o)}dispatchEvent(n){return this.element.dispatchEvent(n)}removeEventListener(n,e,o){this.element.removeEventListener(n,e,o)}click(){this.element.click()}get visible(){return ve(this)}set visible(n){he(this,n,this.displayType),this.object.visible=n}};var Ge=class extends je{constructor(e,o,r){let i=Bt(`${o} ${r}`);super(Wt(i,tt(i,Ze(e.getImageSrc(o,r)))),we(`${name}-button`),"inline-block");this.mesh=null;this.load(e,o,r)}async load(e,o,r){this.mesh=await e.getMeshButton(o,r,.2),this.mesh.disabled=this.disabled,b(this,this.mesh),this.mesh.object.visible=this.visible,this.mesh.addEventListener("click",()=>{this.element.click()})}get disabled(){return this.element.disabled}set disabled(e){this.element.disabled=e,this.mesh&&(this.mesh.disabled=e)}get visible(){return super.visible}set visible(e){super.visible=e,this.mesh&&ie(this.mesh,e)}};var He=class{constructor(n){this.items=new Map;this.defaultItems=new Array;if(l(n))for(let[e,o]of n)this.add(e,o)}add(n,...e){for(let o of e)if(m(n))this.defaultItems.push(o);else{let r=this.items.get(n);m(r)&&this.items.set(n,r=[]),r.push(o)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let n of this.defaultItems)yield n;for(let n of this.items.values())for(let e of n)yield e}has(n){return l(n)?this.items.has(n):this.defaultItems.length>0}get(n){return m(n)?this.defaultItems:this.items.get(n)||[]}count(n){if(m(n))return this.defaultItems.length;let e=this.get(n);return l(e)?e.length:0}get size(){let n=this.defaultItems.length;for(let e of this.items.values())n+=e.length;return n}delete(n){return m(n)?V(this.defaultItems).length>0:this.items.delete(n)}remove(n,e){if(m(n))I(this.defaultItems,e);else{let o=this.items.get(n);l(o)&&(I(o,e),o.length===0&&this.items.delete(n))}}clear(){this.items.clear(),V(this.defaultItems)}};function Jo(t){return t[0]}function $o(t){return t.shift()}function Yo(t){return t[t.length-1]}function Zo(t){return t.pop()}var We=class{constructor(n){this.value=n;this._forward=new Array;this._reverse=new Array}connectSorted(n,e){l(e)?(Ye(this._forward,n,o=>e(o.value)),Ye(n._reverse,this,o=>e(o.value))):this.connectTo(n)}connectTo(n){this.connectAt(n,this._forward.length)}connectAt(n,e){Je(this._forward,n,e),n._reverse.push(this)}disconnectFrom(n){I(this._forward,n),I(n._reverse,this)}isConnectedTo(n){return this._forward.indexOf(n)>=0||this._reverse.indexOf(n)>=0}flatten(){let n=new Set,e=[this];for(;e.length>0;){let o=e.shift();l(o)&&!n.has(o)&&(n.add(o),e.push(...o._forward))}return Array.from(n)}*traverse(n){let e=new Set,o=[this],r=n?Jo:Yo,i=n?$o:Zo;for(;o.length>0;){let s=r(o);e.has(s)?n||(i(o),yield s):(e.add(s),n&&(i(o),yield s),s._forward.length>0&&o.push(...s._forward))}}breadthFirst(){return this.traverse(!0)}depthFirst(){return this.traverse(!1)}search(n,e=!0){for(let o of this.traverse(e))if(n(o))return o;return null}*searchAll(n,e=!0){for(let o of this.traverse(e))n(o)&&(yield o)}find(n,e=!0){return this.search(o=>o.value===n,e)}findAll(n,e=!0){return this.searchAll(o=>o.value===n,e)}contains(n,e=!0){for(let o of this.traverse(e))if(o===n)return!0;return!1}containsValue(n,e=!0){for(let o of this.traverse(e))if(o.value===n)return!0;return!1}get _isEntryPoint(){return this._reverse.length===0}get _isExitPoint(){return this._forward.length===0}get isDisconnected(){return this._isEntryPoint&&this._isExitPoint}get isConnected(){return!this._isExitPoint||!this._isEntryPoint}get isTerminus(){return this._isEntryPoint||this._isExitPoint}get isInternal(){return!this._isEntryPoint&&!this._isExitPoint}};function Xn(t,n,e){let o=s=>l(s)&&l(e)&&e(s),r=new ze(null),i=new Map;for(let s of t){let a=new ze(s);i.set(s,a)}for(let s of i.values()){let a=n(s.value);(a!=null&&i.has(a)?i.get(a):r).connectSorted(s,o)}return r}var ze=class extends We{get depth(){let n=0,e=this.parent;for(;l(e);)++n,e=e.parent;return n}removeFromParent(){for(;this.parent;)this.parent.disconnectFrom(this)}connectTo(n){n.removeFromParent(),super.connectTo(n)}connectAt(n,e){n.removeFromParent(),super.connectAt(n,e)}connectSorted(n,e){n.removeFromParent(),super.connectSorted(n,e)}get parent(){return this._reverse.length===0?null:this._reverse[0]}get children(){return this._forward}get isRoot(){return this._isEntryPoint}get isChild(){return!this._isEntryPoint}get isLeaf(){return this._isExitPoint}get hasChildren(){return!this._isExitPoint}};function Bn(t,n,e){return new Map(t.map(o=>[n(o),e(o)]))}function Fn(t,n){return Bn(t,n,xe)}var Mt=class extends k{constructor(e){super("select");this.scenarioID=e}},Pt=class extends k{constructor(){super("lobby")}},Ne=class extends Te{constructor(e){super(e);this.node2MenuItem=new Map;this.menuItem2Node=new Map;this.images=new Map;this.lobbyButton=null;this.menuDesc=null;this.curMenu=null;this.menuRoot=null;this.lobbyButton=new Ge(this.env.uiButtons,"ui","lobby"),this.menu=new Fe(this.env),this.env.addScopedEventListener(this,"update",o=>this.menu.update(o.dt)),this.env.addScopedEventListener(this,"dialogshowing",o=>On(this.lobbyButton,!o.showing)),this.lobbyButton.addEventListener("click",()=>this.env.withConfirmation("Confirm return to lobby","Are you sure you want to return to the lobby?",()=>this.dispatchEvent(new Pt))),Object.seal(this)}async init(e){this.menuDesc=e.get("config"),await super.init(e)}async load(e){await pe(e,[[5,o=>this.menu.load(this.menuDesc,o)],[1,o=>this.loadMenuData(o)]]),b(this.env.worldUISpace,this.menu),this.env.xrUI.addItem(this.lobbyButton,{x:1,y:1,scale:.5}),be(this.env.screenUISpace.topRight,this.lobbyButton)}async loadMenuData(e){this.destroyMenuItems();let o=await this.env.fetcher.get("/vr/menu"+(location.search.includes("all")?"/1":"")).progress(e).object().then(L);for(let a of o)l(a.audioElementCount)&&this.env.audio.preparePool(a.audioElementCount);let r=Array.from(new Set(o.map(a=>a.organizationName))),i=new Map;if(r.length>1){let a=o.filter(c=>m(c.parentID)),p=new He;for(let c of a)p.add(c.organizationName,c);for(let c=0;c<r.length;++c){let d=r[c],f=-(c+1),E={id:f,label:d,order:c,organizationName:d};i.set(d,f),o.push(E);for(let M of p.get(d))M.parentID=f}}let s=Fn(o,a=>a.id);this.menuRoot=Xn(o,a=>s.get(a.parentID),a=>a&&a.order||-1);for(let a of this.menuRoot.breadthFirst()){let p=a.value;if(p!==null){let c={name:p.label,filePath:p.filePath,enabled:!0};this.node2MenuItem.set(a,c),this.menuItem2Node.set(c,a)}}}async loadMenuItems(e,o){let r=Array.from(new Set(e.children.map(i=>i.value.filePath))).filter(i=>l(i)&&!this.images.has(i));await Ie(o,r,async(i,s)=>this.images.set(i,await this.env.fetcher.get(i).progress(s).image().then(L)));for(let i of e.children){let s=this.node2MenuItem.get(i);if(m(s.back)&&this.images.has(s.filePath)){let a=new g(this.env,s.filePath+s.name,"none");a.setTextureMap(this.images.get(s.filePath)),a.mesh.frustumCulled=!1,s.back=a}}}async showing(e){let o=this.curMenu||this.menuRoot;await pe(e,[[10,async r=>{this.env.skybox.rotation=null;let i=await this.env.fetcher.get("/vr/LandingPageImage").progress(r).image().then(L);return this.env.skybox.setImage("/vr/LandingPageImage",i)}],[1,r=>this.showMenuSelection(o,r)]]),this.menu.visible=!0,this.lobbyButton.visible=!1,this.join("lobby")}hiding(){this.menu.visible=!1,this.lobbyButton.visible=!0}get visible(){return this.menu.visible}dispose(){this.env.removeScope(this),this.env.worldUISpace.remove(this.menu),se(this.menu),this.menu.removeFromParent(),this.destroyMenuItems()}destroyMenuItems(){for(let e of this.images.values())B(e);this.images.clear(),this.node2MenuItem.clear(),this.menuItem2Node.clear()}async showMenuSelection(e,o){this.curMenu=e;let[r,i]=J(o,[10,1]);await this.loadMenuItems(e,r);let s=e.children.map(d=>this.node2MenuItem.get(d)),a=e.isRoot?null:()=>this.selectMenuItem(e.parent),p=0,c="Menu";e.value&&(p=e.value.id,c=e.value.label),await this.menu.showMenu(p,c,s,d=>{let f=this.menuItem2Node.get(d);this.selectMenuItem(f)},a,i)}async selectMenuItem(e,o){e.isLeaf?this.dispatchEvent(new Mt(e.value.scenarioID)):await this.showMenuSelection(e,o)}};var cg=Ne;export{cg as default};
