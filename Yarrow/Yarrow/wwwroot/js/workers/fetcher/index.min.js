function O(n,e,t){return typeof n===e||n instanceof t}function C(n){return O(n,"function",Function)}function v(n){return O(n,"string",String)}function re(n){return O(n,"boolean",Boolean)}function ne(n){return O(n,"number",Number)}function he(n){return l(n)&&O(n,"object",Object)}function G(n){return n instanceof Array}function me(n,e){throw new Error((e||"Unexpected object: ")+n)}function m(n){return n==null}function l(n){return!m(n)}function Te(n){return n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Int8Array||n instanceof Uint16Array||n instanceof Int16Array||n instanceof Uint32Array||n instanceof Int32Array||n instanceof Float32Array||n instanceof Float64Array||"BigUint64Array"in globalThis&&n instanceof globalThis.BigUint64Array||"BigInt64Array"in globalThis&&n instanceof globalThis.BigInt64Array}function ye(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function I(n){return n.splice(0)}function ge(n,e){for(let t=0;t<n.length;++t)if(n[t]!==e[t])return t;return-1}function se(n,e){let t=n.indexOf(e);return t>-1?(oe(n,t),!0):!1}function oe(n,e){return n.splice(e,1)[0]}function q(n){return n}function be(){return!0}function ve(){return!1}function Ie(n,e,t){return new Map(n.map(r=>[e(r),t(r)]))}function xe(n,e){return Ie(n,e,q)}var D=class{constructor(e){this.items=new Map;this.defaultItems=new Array;if(l(e))for(let[t,r]of e)this.add(t,r)}add(e,...t){for(let r of t)if(m(e))this.defaultItems.push(r);else{let s=this.items.get(e);m(s)&&this.items.set(e,s=[]),s.push(r)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let e of this.defaultItems)yield e;for(let e of this.items.values())for(let t of e)yield t}has(e){return l(e)?this.items.has(e):this.defaultItems.length>0}get(e){return m(e)?this.defaultItems:this.items.get(e)||[]}count(e){if(m(e))return this.defaultItems.length;let t=this.get(e);return l(t)?t.length:0}get size(){let e=this.defaultItems.length;for(let t of this.items.values())e+=t.length;return e}delete(e){return m(e)?I(this.defaultItems).length>0:this.items.delete(e)}remove(e,t){if(m(e))se(this.defaultItems,t);else{let r=this.items.get(e);l(r)&&(se(r,t),r.length===0&&this.items.delete(e))}}clear(){this.items.clear(),I(this.defaultItems)}};var K=class{constructor(e){this.items=new Map;if(l(e))for(let[t,r,s]of e)this.add(t,r,s)}add(e,t,r){let s=this.items.get(e);return m(s)&&this.items.set(e,s=new Map),s.set(t,r),this}*entries(){for(let[e,t]of this.items)for(let[r,s]of t)yield[e,r,s]}keys(e){return m(e)?this.items.keys():this.items.get(e).keys()}*values(){for(let e of this.items.values())for(let t of e.values())yield t}has(e,t){return this.items.has(e)&&(m(t)||this.items.get(e).has(t))}get(e,t){return m(t)?this.items.get(e):this.items.has(e)?this.items.get(e).get(t):null}count(e){return this.items.has(e)?this.items.get(e).size:null}get size(){let e=0;for(let t of this.items.values())e+=t.size;return e}delete(e,t){if(m(t))return this.items.delete(e);if(this.items.has(e)){let r=this.items.get(e),s=r.delete(t);return r.size===0&&this.items.delete(e),s}else return!1}clear(){this.items.clear()}};var F=class extends Error{constructor(t,r=null){super(t);this.innerError=r}};var U=class{constructor(){this.listeners=new Map;this.listenerOptions=new Map}addEventListener(e,t,r){if(C(t)){let s=this.listeners.get(e);s||(s=new Array,this.listeners.set(e,s)),s.find(o=>o===t)||(s.push(t),r&&this.listenerOptions.set(t,r))}}removeEventListener(e,t){if(C(t)){let r=this.listeners.get(e);r&&this.removeListener(r,t)}}clearEventListeners(e){for(let[t,r]of this.listeners)if(m(e)||e===t){for(let s of r)this.removeEventListener(e,s);I(r),this.listeners.delete(t)}}removeListener(e,t){let r=e.findIndex(s=>s===t);r>=0&&(oe(e,r),this.listenerOptions.has(t)&&this.listenerOptions.delete(t))}dispatchEvent(e){let t=this.listeners.get(e.type);if(t)for(let r of t){let s=this.listenerOptions.get(r);l(s)&&!re(s)&&s.once&&this.removeListener(t,r),r.call(this,e)}return!e.defaultPrevented}};var W=class extends U{constructor(){super(...arguments);this.bubblers=new Set;this.scopes=new WeakMap}addBubbler(t){this.bubblers.add(t)}removeBubbler(t){this.bubblers.delete(t)}addEventListener(t,r,s){super.addEventListener(t,r,s)}removeEventListener(t,r){super.removeEventListener(t,r)}clearEventListeners(t){return super.clearEventListeners(t)}addScopedEventListener(t,r,s,o){this.scopes.has(t)||this.scopes.set(t,[]),this.scopes.get(t).push([r,s]),this.addEventListener(r,s,o)}removeScope(t){let r=this.scopes.get(t);if(r){this.scopes.delete(t);for(let[s,o]of r)this.removeEventListener(s,o)}}dispatchEvent(t){if(!super.dispatchEvent(t))return!1;if(!t.cancelBubble){for(let r of this.bubblers)if(!r.dispatchEvent(t))return!1}return!0}};var x=class{constructor(e=!0){this.autoStart=e;this.onThens=new Array;this.onCatches=new Array;this._result=void 0;this._error=void 0;this._executionState="waiting";this._resultState="none";this.resolve=t=>{if(this.running){this._result=t,this._resultState="resolved";for(let r of this.onThens)r(t);this.clear(),this._executionState="finished"}},this.reject=t=>{if(this.running){this._error=t,this._resultState="errored";for(let r of this.onCatches)r(t);this.clear(),this._executionState="finished"}},this.autoStart&&this.start()}clear(){I(this.onThens),I(this.onCatches)}start(){this._executionState="running"}resolver(e){return()=>this.resolve(e)}resolveOn(e,t,r){let s=this.resolver(r);e.addEventListener(t,s),this.finally(()=>e.removeEventListener(t,s))}get result(){if(l(this.error))throw this.error;return this._result}get error(){return this._error}get executionState(){return this._executionState}get waiting(){return this.executionState==="waiting"}get started(){return this.executionState!=="waiting"}get running(){return this.executionState==="running"}get finished(){return this.executionState==="finished"}get resultState(){return this._resultState}get resolved(){return this.resultState==="resolved"}get errored(){return this.resultState==="errored"}get[Symbol.toStringTag](){return this.toString()}project(){return new Promise((e,t)=>{this.finished?this.errored?t(this.error):e(this.result):(this.onThens.push(e),this.onCatches.push(t))})}then(e,t){return this.project().then(e,t)}catch(e){return this.project().catch(e)}finally(e){return this.project().finally(e)}reset(){this._reset(this.autoStart)}restart(){this._reset(!0)}_reset(e){this.running&&this.reject("Resetting previous invocation"),this.clear(),this._result=void 0,this._error=void 0,this._executionState="waiting",this._resultState="none",e&&this.start()}};function Re(n,e){return"on"+e in n}function B(n,e,t,...r){m(r)&&(r=[]);let s;if(v(t)?r.unshift(t):ne(t)&&(s=t),!(n instanceof U)){if(!Re(n,e))throw new F(`Target does not have a ${e} rejection event`);for(let u of r)if(!Re(n,u))throw new F(`Target does not have a ${u} rejection event`)}let o=new x;if(ne(s)){let u=setTimeout(o.reject,s,`'${e}' has timed out.`);o.finally(clearTimeout.bind(globalThis,u))}let i=(u,c)=>{n.addEventListener(u,c),o.finally(()=>n.removeEventListener(u,c))};i(e,u=>o.resolve(u));let a=u=>o.reject(u);for(let u of r)i(u,a);return o}function w(n){return n.then(be).catch(ve)}function ie(n,...e){if(!he(n))return!1;n=n;for(let t of e){if(!(t in n))return!1;let r=n[t];if(!C(r))return!1}return!0}function Se(n){return ie(n,"dispose")}function De(n){return ie(n,"destroy")}function ke(n){return ie(n,"close")}function _(n){Se(n)&&n.dispose(),ke(n)&&n.close(),De(n)&&n.destroy()}function Pe(n,e){try{return e(n)}finally{_(n)}}var N=class{constructor(e){this.db=e}static delete(e){let t=indexedDB.deleteDatabase(e),r=B(t,"success","error","blocked");return w(r)}static async open(e,...t){let r=xe(t,T=>T.name),s=new K(t.filter(T=>l(T.indexes)).flatMap(T=>T.indexes.map(b=>[T.name,b.name,b]))),o=new Array,i=new Array,a=new Array,u=new D,c=new D,f=null,P=indexedDB.open(e);if(await w(B(P,"success","error","blocked"))){let T=P.result;f=T.version;let b=new Array;for(let y of T.objectStoreNames)r.has(y)||i.push(y);for(let y of r.keys())T.objectStoreNames.contains(y)?b.push(y):o.push(y);if(b.length>0){let y=T.transaction(b),g=B(y,"complete","error","abort"),M=w(g);for(let p of b){let S=y.objectStore(p),fe=r.get(p);l(fe.options)&&S.keyPath!==fe.options.keyPath&&(i.push(p),o.push(p));for(let E of S.indexNames)s.has(p,E)||(a.indexOf(p)===-1&&a.push(p),c.add(p,E));if(s.has(p))for(let E of s.get(p).keys())if(!S.indexNames.contains(E))a.indexOf(p)===-1&&a.push(p),u.add(p,E);else{let A=s.get(p,E),L=S.index(E);(v(A.keyPath)!==v(L.keyPath)||v(A.keyPath)&&v(L.keyPath)&&A.keyPath!==L.keyPath||G(A.keyPath)&&G(L.keyPath)&&ge(A.keyPath,L.keyPath))&&(a.indexOf(p)===-1&&a.push(p),c.add(p,E),u.add(p,E))}}y.commit(),await M}_(T)}else{f=0,o.push(...r.keys());for(let T of t)if(l(T.indexes))for(let b of T.indexes)u.add(T.name,b.name)}(o.length>0||i.length>0||u.size>0||c.size>0)&&++f;let d=new x,h=l(f)?indexedDB.open(e,f):indexedDB.open(e),k=B(h,"success","error","blocked"),j=w(d),Be=w(k),pe=d.resolver(!1);if(h.addEventListener("success",pe),h.addEventListener("upgradeneeded",()=>{let T=B(h.transaction,"complete","error","abort"),b=h.result;for(let g of i)b.deleteObjectStore(g);let y=new Map;for(let g of o){let M=r.get(g),p=b.createObjectStore(g,M.options);y.set(g,p)}for(let g of a){let M=h.transaction.objectStore(g);y.set(g,M)}for(let[g,M]of y){for(let p of c.get(g))M.deleteIndex(p);for(let p of u.get(g)){let S=s.get(g,p);M.createIndex(p,S.keyPath,S.options)}}w(T).then(d.resolve).catch(d.reject).finally(()=>h.removeEventListener("success",pe))}),!await j)throw d.error;if(!await Be)throw k.error;return new N(h.result)}dispose(){_(this.db)}get name(){return this.db.name}get version(){return this.db.version}get storeNames(){return Array.from(this.db.objectStoreNames)}getStore(e){return new ae(this.db,e)}},ae=class{constructor(e,t){this.db=e;this.storeName=t}async request(e,t){let r=this.db.transaction(this.storeName,t),s=B(r,"complete","error"),o=r.objectStore(this.storeName),i=e(o),a=B(i,"success","error");if(!await w(a))throw r.abort(),a.error;if(r.commit(),!await w(s))throw s.error;return i.result}add(e,t){return this.request(r=>r.add(e,t),"readwrite")}clear(){return this.request(e=>e.clear(),"readwrite")}getCount(e){return this.request(t=>t.count(e),"readonly")}async has(e){return await this.getCount(e)>0}delete(e){return this.request(t=>t.delete(e),"readwrite")}get(e){return this.request(t=>t.get(e),"readonly")}getAll(){return this.request(e=>e.getAll(),"readonly")}getAllKeys(){return this.request(e=>e.getAllKeys(),"readonly")}getKey(e){return this.request(t=>t.getKey(e),"readonly")}openCursor(e,t){return this.request(r=>r.openCursor(e,t),"readonly")}openKeyCursor(e,t){return this.request(r=>r.openKeyCursor(e,t),"readonly")}put(e,t){return this.request(r=>r.put(e,t),"readwrite")}};function Ee(n,...e){for(let t of e)if(l(t))for(let[r,s]of t)n.set(r,s);return n}var le=class extends x{constructor(t){super(!1);this.milliseconds=t;this._timer=null}start(){super.start(),this._timer=setTimeout(()=>{this._timer=null,this.resolve()},this.milliseconds)}reset(){super.reset(),l(this._timer)&&(clearTimeout(this._timer),this._timer=null)}};function we(n){let e=new le(n);return e.start(),e}function X(n,e){return async()=>{let t=null,r=500;for(let s=0;s<=n;++s)try{return s>0&&(await we(r),r*=2),await e()}catch(o){t=o}throw t}}var V=class extends W{constructor(){super(...arguments);this.attached=new Array;this.soFar=null;this.total=null;this.msg=null;this.est=null}get p(){return this.total>0?this.soFar/this.total:0}report(t,r,s,o){this.soFar=t,this.total=r,this.msg=s,this.est=o;for(let i of this.attached)i.report(t,r,s,o)}attach(t){this.attached.push(t),t.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(t){this.report(0,1,t||"starting")}end(t){this.report(1,1,t||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,I(this.attached)}};var H=class extends V{constructor(t,r){super();this.i=t;this.prog=r}report(t,r,s,o){super.report(t,r,s,o),this.prog.update(this.i,t,r,s)}};var z=class{constructor(e){this.prog=e;this.weightTotal=0;this.subProgressCallbacks=new Array;this.subProgressWeights=new Array;this.subProgressValues=new Array;this.start=performance.now();for(let t=0;t<this.subProgressWeights.length;++t)this.subProgressValues[t]=0,this.subProgressCallbacks[t]=new H(t,this)}addSubProgress(e){e=e||1,this.weightTotal+=e,this.subProgressWeights.push(e),this.subProgressValues.push(0);let t=new H(this.subProgressCallbacks.length,this);return this.subProgressCallbacks.push(t),t}update(e,t,r,s){if(this.prog){this.subProgressValues[e]=t/r;let o=0;for(let c=0;c<this.subProgressWeights.length;++c)o+=this.subProgressValues[c]*this.subProgressWeights[c];let i=performance.now(),a=i-this.start,u=this.start-i+a*this.weightTotal/o;this.prog.report(o,this.weightTotal,s,u)}}};function Ce(n,e){return new ue(e,n).subProgressCallbacks}function Me(n,e){let t=new Array(e);for(let r=0;r<e;++r)t[r]=1;return Ce(n,t)}var ue=class extends z{constructor(e,t){super(t);for(let r of e)this.addSubProgress(r)}};async function R(n,e){let{status:t,requestPath:r,responsePath:s,content:o,contentType:i,contentLength:a,fileName:u,headers:c,date:f}=n;return{status:t,requestPath:r,responsePath:s,content:l(e)?await e(o):void 0,contentType:i,contentLength:a,fileName:u,headers:c,date:f}}function Ke(n){return v(n)||Te(n)||n instanceof Blob||n instanceof FormData||ye(n)||"Document"in globalThis&&n instanceof Document}function $(n,e,t,r,s,o){let i=!o;o&&o.then(()=>i=!0);let a=!1,u=s,c=new x;t.addEventListener("loadstart",()=>{i&&!a&&r&&r.start(n)}),t.addEventListener("progress",P=>{if(i&&!a){let d=P;r&&r.report(d.loaded,Math.max(d.loaded,d.total),n),d.loaded===d.total&&(u=!0,a&&c.resolve())}}),t.addEventListener("load",()=>{i&&!a&&(r&&r.end(n),a=!0,u&&c.resolve())});let f=P=>()=>{i&&c.reject(`${P} (${e.status})`)};return t.addEventListener("error",f("error")),t.addEventListener("abort",f("abort")),t.addEventListener("timeout",f("timeout")),c}function de(n,e,t,r,s,o){if(n.open(e,t),n.responseType="blob",n.timeout=r,s)for(let[i,a]of s)n.setRequestHeader(i,a);l(o)?n.send(o):n.send()}function J(n,e,t){if(!n.has(e))return null;let r=n.get(e);try{let s=t(r);return n.delete(e),s}catch(s){console.warn(e,s)}return null}var Ne=/filename=\"(.+)\"(;|$)/,Ve="Juniper:Fetcher:Cache",Z=class{constructor(){this.cache=null;this.store=null;this.tasks=new K;this.cacheReady=this.openCache()}async drawImageToCanvas(e,t,r){let s=await this.sendNothingGetSomething("blob",e,r),o=s.content;return Pe(await createImageBitmap(o,{imageOrientation:"from-image"}),i=>(t.width=i.width,t.height=i.height,t.getContext("2d").drawImage(i,0,0),R(s)))}async openCache(){let e={keyPath:"requestPath"};this.cache=await N.open(Ve,{name:"files",options:e}),this.store=await this.cache.getStore("files")}async clearCache(){await this.cacheReady,await this.store.clear()}async evict(e){await this.cacheReady,this.store.has(e)&&await this.store.delete(e)}async readResponseHeaders(e,t){let r=t.getAllResponseHeaders().split(/[\r\n]+/).map(d=>d.trim()).filter(d=>d.length>0).map(d=>{let h=d.split(": "),k=h.shift().toLowerCase(),j=h.join(": ");return[k,j]}),s=new D(r),o=Array.from(s.keys()).map(d=>[d,s.get(d).join(", ")]),i=new Map(o),a=J(i,"content-type",q),u=J(i,"content-length",parseFloat),c=J(i,"date",d=>new Date(d)),f=J(i,"content-disposition",d=>{if(l(d)){let h=d.match(Ne);if(l(h))return h[1]}return null});return{status:t.status,requestPath:e,responsePath:t.responseURL,content:void 0,contentType:a,contentLength:u,fileName:f,date:c,headers:i}}async readResponse(e,t){let{responsePath:r,status:s,contentType:o,contentLength:i,fileName:a,date:u,headers:c}=await this.readResponseHeaders(e,t),f={requestPath:e,responsePath:r,status:s,contentType:o,contentLength:i,fileName:a,date:u,headers:c,content:t.response};return l(f.content)&&(f.contentType=f.contentType||f.content.type,f.contentLength=f.contentLength||f.content.size),f}async decodeContent(e,t){return R(t,async r=>{if(e==="")return null;if(m(t.contentType)){let s=Array.from(t.headers.entries()).map(o=>o.join(": ")).join(`
  `);throw new Error(`No content type found in headers: 
  `+s)}else{if(e==="blob")return r;if(e==="arraybuffer")return await r.arrayBuffer();if(e==="json"){let s=await r.text();return s.length>0?JSON.parse(s):null}else if(e==="document"){let s=new DOMParser;if(t.contentType==="application/xhtml+xml"||t.contentType==="text/html"||t.contentType==="application/xml"||t.contentType==="image/svg+xml"||t.contentType==="text/xml")return s.parseFromString(await r.text(),t.contentType);throw new Error("Couldn't parse document")}else{if(e==="text")return await r.text();me(e)}}})}async withCachedTask(e,t){return e.method!=="GET"&&e.method!=="HEAD"&&e.method!=="OPTIONS"?await t():(this.tasks.has(e.method,e.path)||this.tasks.add(e.method,e.path,t().finally(()=>this.tasks.delete(e.method,e.path))),this.tasks.get(e.method,e.path))}sendNothingGetNothing(e){return this.withCachedTask(e,X(e.retryCount,async()=>{let t=new XMLHttpRequest,r=$(`requesting: ${e.path}`,t,t,null,!0);return de(t,e.method,e.path,e.timeout,e.headers),await r,await this.readResponseHeaders(e.path,t)}))}sendNothingGetSomething(e,t,r){return this.withCachedTask(t,X(t.retryCount,async()=>{let s=null,o=t.useCache&&t.method==="GET";o&&(l(r)&&r.start(),await this.cacheReady,s=await this.store.get(t.path));let i=m(s);if(i){let u=new XMLHttpRequest,c=$(`requesting: ${t.path}`,u,u,r,!0);de(u,t.method,t.path,t.timeout,t.headers),await c,s=await this.readResponse(t.path,u),o&&await this.store.add(s)}let a=await this.decodeContent(e,s);return i&&l(r)&&r.end(),a}))}sendSomethingGetSomething(e,t,r,s){let o=null,i=Ee(new Map,r,t.headers);if(t.body instanceof FormData&&l(i)){let d=new Array;for(let h of i.keys())h.toLowerCase()==="content-type"&&d.push(h);for(let h of d)i.delete(h)}Ke(t.body)&&!v(t.body)?o=t.body:l(t.body)&&(o=JSON.stringify(t.body));let a=l(o),u=Me(s,a?2:1),[c,f]=u,P=async()=>{let d=new XMLHttpRequest,h=a?$("uploading",d,d.upload,c,!1):Promise.resolve(),k=$("saving",d,d,f,!0,h);de(d,t.method,t.path,t.timeout,i,o),await h,await k;let j=await this.readResponse(t.path,d);return await this.decodeContent(e,j)};return X(t.retryCount,P)()}};var Q=class{constructor(e){this.impl=e;this.defaultPostHeaders=new Map}setRequestVerificationToken(e){this.defaultPostHeaders.set("RequestVerificationToken",e)}clearCache(){return this.impl.clearCache()}evict(e){return this.impl.evict(e)}sendNothingGetNothing(e){return this.impl.sendNothingGetNothing(e)}sendNothingGetBlob(e,t){return this.impl.sendNothingGetSomething("blob",e,t)}sendObjectGetBlob(e,t){return this.impl.sendSomethingGetSomething("blob",e,this.defaultPostHeaders,t)}sendNothingGetBuffer(e,t){return this.impl.sendNothingGetSomething("arraybuffer",e,t)}sendObjectGetBuffer(e,t){return this.impl.sendSomethingGetSomething("arraybuffer",e,this.defaultPostHeaders,t)}sendNothingGetText(e,t){return this.impl.sendNothingGetSomething("text",e,t)}sendObjectGetText(e,t){return this.impl.sendSomethingGetSomething("text",e,this.defaultPostHeaders,t)}sendNothingGetObject(e,t){return this.impl.sendNothingGetSomething("json",e,t)}sendObjectGetObject(e,t){return this.impl.sendSomethingGetSomething("json",e,this.defaultPostHeaders,t)}sendObjectGetNothing(e,t){return this.impl.sendSomethingGetSomething("",e,this.defaultPostHeaders,t)}drawImageToCanvas(e,t,r){return this.impl.drawImageToCanvas(e,t,r)}async sendNothingGetFile(e,t){return R(await this.sendNothingGetBlob(e,t),URL.createObjectURL)}async sendObjectGetFile(e,t){return R(await this.sendObjectGetBlob(e,t),URL.createObjectURL)}async sendNothingGetXml(e,t){return R(await this.impl.sendNothingGetSomething("document",e,t),r=>r.documentElement)}async sendObjectGetXml(e,t){return R(await this.impl.sendSomethingGetSomething("document",e,this.defaultPostHeaders,t),r=>r.documentElement)}async sendNothingGetImageBitmap(e,t){return R(await this.sendNothingGetBlob(e,t),createImageBitmap)}async sendObjectGetImageBitmap(e,t){return R(await this.sendObjectGetBlob(e,t),createImageBitmap)}};var ce=class extends V{constructor(t,r){super();this.server=t;this.taskID=r}report(t,r,s,o){let i={type:"progress",taskID:this.taskID,soFar:t,total:r,msg:s,est:o};this.server.postMessage(i)}},Y=class{constructor(e){this.self=e;this.methods=new Map;this.self.addEventListener("message",t=>{let r=t.data;this.callMethod(r)})}postMessage(e,t){l(t)?this.self.postMessage(e,t):this.self.postMessage(e)}callMethod(e){let t=this.methods.get(e.methodName);if(t)try{G(e.params)?t(e.taskID,...e.params):l(e.params)?t(e.taskID,e.params):t(e.taskID)}catch(r){this.onError(e.taskID,`method invocation error: ${e.methodName}(${r.message||r})`)}else this.onError(e.taskID,`method not found: ${e.methodName}`)}onError(e,t){let r={type:"error",taskID:e,errorMessage:t};this.postMessage(r)}onReturn(e,t,r){let s=null;if(t===void 0?s={type:"return",taskID:e}:s={type:"return",taskID:e,returnValue:t},l(r)){let o=r(t);this.postMessage(s,o)}else this.postMessage(s)}addMethodInternal(e,t,r){if(this.methods.has(e))throw new Error(`${e} method has already been mapped.`);this.methods.set(e,async(s,...o)=>{let i=new ce(this,s);try{let a=await t(...o,i);this.onReturn(s,a,r)}catch(a){console.error(a),this.onError(s,a.message||a)}})}addFunction(e,t,r){this.addMethodInternal(e,t,r)}addVoidFunction(e,t){this.addMethodInternal(e,t)}addMethod(e,t,r,s){this.addFunction(t,r.bind(e),s)}addVoidMethod(e,t,r){this.addVoidFunction(t,r.bind(e))}addEvent(e,t,r,s){e.addEventListener(t,o=>{let i=null;if(l(r)?i={type:"event",eventName:t,data:r(o)}:i={type:"event",eventName:t},i.data!==void 0&&l(s)){let a=s(i.data);this.postMessage(i,a)}else this.postMessage(i)})}};var te=class extends Y{constructor(e,t){super(e);let r=new Q(t);je(this,r)}};function ee(n){return[n.content]}function je(n,e){n.addVoidMethod(e,"setRequestVerificationToken",e.setRequestVerificationToken),n.addMethod(e,"clearCache",e.clearCache),n.addMethod(e,"evict",e.evict),n.addMethod(e,"sendNothingGetNothing",e.sendNothingGetNothing),n.addMethod(e,"sendNothingGetBuffer",e.sendNothingGetBuffer,ee),n.addMethod(e,"sendNothingGetImageBitmap",e.sendNothingGetImageBitmap,ee),n.addMethod(e,"sendNothingGetObject",e.sendNothingGetObject),n.addMethod(e,"sendNothingGetFile",e.sendNothingGetFile),n.addMethod(e,"sendNothingGetText",e.sendNothingGetText),n.addMethod(e,"sendObjectGetNothing",e.sendObjectGetNothing),n.addMethod(e,"sendObjectGetImageBitmap",e.sendObjectGetImageBitmap,ee),n.addMethod(e,"sendObjectGetBuffer",e.sendObjectGetBuffer,ee),n.addMethod(e,"sendObjectGetObject",e.sendObjectGetObject),n.addMethod(e,"sendObjectGetFile",e.sendObjectGetFile),n.addMethod(e,"sendObjectGetText",e.sendObjectGetText),n.addMethod(e,"drawImageToCanvas",e.drawImageToCanvas)}globalThis.server=new te(globalThis,new Z);
