<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      body, html{
        margin:0;
        padding:0;
        width:100%;
        background-color:black;
      }
      #front-buffer{
        display:block;
        margin:auto;
      }
      #back-buffer{
        display:none;
      }
    </style>
    <script type="text/javascript" src="lib.js"></script>
    <script type="text/javascript" src="mob.js"></script>
    <script type="text/javascript" src="ship.js"></script>
    <script type="text/javascript" src="stars.js"></script>
    <script type="text/javascript">
var WIDTH = 1024, HEIGHT = 768;
var HALF_WIDTH = WIDTH/2, HALF_HEIGHT = HEIGHT/2;
var canv1, canv2, front, back;
var targetT = Math.floor(1000/60);
var da = Math.PI / 50000, spd = 0.006, drag = 0.01;
var anaglyph = false;
var enemyX = WIDTH/2, enemyY = HEIGHT/2, dx, dy;
var half_angle, anaglyph_x, anaglyph_y, i, j;

function init(){
  canv1 = makeCanvas("front-buffer", WIDTH, HEIGHT);
  canv2 = makeCanvas("back-buffer", WIDTH, HEIGHT);
  document.body.appendChild(canv1);
  document.body.appendChild(canv2);
  front = canv1.getContext("2d");
  back = canv2.getContext("2d");
  back.globalCompositeOperation = "lighter";
  makeStars(WIDTH * 4, HEIGHT * 4, 200);
  lib.keyHandler.setup(document);
  lib.pump.start(update, draw, targetT);
}

lib.keyHandler.add(192, 500, function(dt){
  anaglyph = !anaglyph;
});

function update(dt){
  ship.update(dt);  
  for(i = 0; i < numPings; ++i){
    if(pingAge[i] > 0){
      pingR[i] += dt * pingD[i];
      pingAge[i] -= dt;
      if(pingD[i] > 0){
        dx = pingX[i] - enemyX;
        dy = pingY[i] - enemyY;
        if(Math.abs(pingR[i] - Math.sqrt(dx * dx + dy * dy)) <= 10){
          pingD[i] = 0;
        }
      }
    }
  }
  for(i = 0; i < numBullets; ++i){
    if(bullet[i].ttl > 0){
      bullet[i].update(dt);
      dx = bullet[i].x - enemyX;
      dy = bullet[i].y - enemyY;
      if((dx * dx + dy * dy) <= 100){
        alert("BOOM!");
      }
    }
  }
}

function draw(){
  back.clearRect(0, 0, WIDTH, HEIGHT);
  back.fillStyle = "#000000";
  back.fillRect(0, 0, WIDTH, HEIGHT);
  if(anaglyph){
    eye(-1, "rgba(127, 0, 0, ");
    eye(1, "rgba(0, 127, 255, ");
  }
  else{
    eye(0, "rgba(255, 0, 255, ");
  }
}
function eye(side, color){
  half_angle = ship.a*0.5;
  anaglyph_x = side * lib.cos(half_angle);
  anaglyph_y = side * lib.sin(half_angle);
  back.lineWidth = 2;
  back.save();
  back.translate(HALF_WIDTH, HALF_HEIGHT);
  back.rotate(-half_angle);
  back.translate(-ship.x, -ship.y);
  for(i = 0; i < star.length; ++i){
    back.strokeStyle = color + (20 - star[i].z) / 30 + ")";
    star[i].draw(back, anaglyph_x, anaglyph_y);
  }
  back.strokeStyle = color + "1)";
  for(i = 0; i < numBullets; ++i){
    if(bullet[i].ttl > 0){
      bullet[i].draw(back, anaglyph_x, anaglyph_y);
    }
  }
  ship.draw(back, anaglyph_x, anaglyph_y);
  if(side >= 0){
    for(i = 0; i < numPings; ++i){
      if(pingAge[i] > 0){
        j = pingAge[i]%256;
        back.fillStyle = "rgba(" + ((255 - j)>>1) + ", 0, " + j + ", 0.33)";
        back.beginPath();
        back.arc(pingX[i], pingY[i], pingR[i], 0, 6.28319, false);
        back.fill();
      }
    }
  }
  back.restore();
  front.drawImage(canv2, 0, 0);
}
    </script>
  </head>
  <body onload="init()">
  </body>
</html>